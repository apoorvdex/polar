"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const RepoDocInfos_1 = require("../RepoDocInfos");
const Strings_1 = require("../../../../web/js/util/Strings");
const RendererAnalytics_1 = require("../../../../web/js/ga/RendererAnalytics");
const Tags_1 = require("../../../../web/js/tags/Tags");
const Preconditions_1 = require("../../../../web/js/Preconditions");
const Sets_1 = require("../../../../web/js/util/Sets");
const FilteredTags_1 = require("../FilteredTags");
class FilteredRepoDocInfoIndex {
    constructor(onRefreshed, repoDocInfosProvider) {
        this.onRefreshed = onRefreshed;
        this.repoDocInfosProvider = repoDocInfosProvider;
        this.filters = {
            flagged: false,
            archived: false,
            title: "",
            filteredTags: new FilteredTags_1.FilteredTags()
        };
    }
    onToggleFlaggedOnly(value) {
        this.filters.flagged = value;
        this.refresh();
    }
    onToggleFilterArchived(value) {
        this.filters.archived = value;
        this.refresh();
    }
    onFilterByTitle(title) {
        this.filters.title = title;
        this.refresh();
    }
    refresh() {
        this.onRefreshed(this.filter(this.repoDocInfosProvider()));
    }
    filter(repoDocInfos) {
        repoDocInfos = this.doFilterValid(repoDocInfos);
        repoDocInfos = this.doFilterByTitle(repoDocInfos);
        repoDocInfos = this.doFilterFlagged(repoDocInfos);
        repoDocInfos = this.doFilterArchived(repoDocInfos);
        repoDocInfos = this.doFilterByTags(repoDocInfos);
        return repoDocInfos;
    }
    doFilterValid(repoDocs) {
        return repoDocs.filter(current => RepoDocInfos_1.RepoDocInfos.isValid(current));
    }
    doFilterByTitle(repoDocs) {
        if (!Strings_1.Strings.empty(this.filters.title)) {
            return repoDocs.filter(current => current.title &&
                current.title.toLowerCase().indexOf(this.filters.title.toLowerCase()) >= 0);
        }
        return repoDocs;
    }
    doFilterFlagged(repoDocs) {
        if (this.filters.flagged) {
            return repoDocs.filter(current => current.flagged);
        }
        return repoDocs;
    }
    doFilterArchived(repoDocs) {
        if (!this.filters.archived) {
            return repoDocs.filter(current => !current.archived);
        }
        return repoDocs;
    }
    doFilterByTags(repoDocs) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'user', action: 'filter-by-tags' });
        const tags = Tags_1.Tags.toIDs(this.filters.filteredTags.get());
        return repoDocs.filter(current => {
            if (tags.length === 0) {
                return true;
            }
            if (!Preconditions_1.isPresent(current.docInfo.tags)) {
                return false;
            }
            const intersection = Sets_1.Sets.intersection(tags, Tags_1.Tags.toIDs(Object.values(current.docInfo.tags)));
            return intersection.length === tags.length;
        });
    }
}
exports.FilteredRepoDocInfoIndex = FilteredRepoDocInfoIndex;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmlsdGVyZWRSZXBvRG9jSW5mb0luZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRmlsdGVyZWRSZXBvRG9jSW5mb0luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esa0RBQTZDO0FBQzdDLDZEQUF3RDtBQUN4RCwrRUFBMEU7QUFDMUUsdURBQWtEO0FBQ2xELG9FQUEyRDtBQUMzRCx1REFBa0Q7QUFDbEQsa0RBQTZDO0FBTzdDLE1BQWEsd0JBQXdCO0lBSWpDLFlBQW9CLFdBQThCLEVBQzlCLG9CQUE2QztRQUQ3QyxnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFDOUIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF5QjtRQUU3RCxJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ1gsT0FBTyxFQUFFLEtBQUs7WUFDZCxRQUFRLEVBQUUsS0FBSztZQUNmLEtBQUssRUFBRSxFQUFFO1lBQ1QsWUFBWSxFQUFFLElBQUksMkJBQVksRUFBRTtTQUNuQyxDQUFDO0lBRU4sQ0FBQztJQUVNLG1CQUFtQixDQUFDLEtBQWM7UUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRU0sc0JBQXNCLENBQUMsS0FBYztRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFTSxlQUFlLENBQUMsS0FBYTtRQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDM0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFHTSxPQUFPO1FBQ1YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMvRCxDQUFD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b2NJbmZvJztcbmltcG9ydCB7UmVwb0RvY0luZm9zfSBmcm9tICcuLi9SZXBvRG9jSW5mb3MnO1xuaW1wb3J0IHtTdHJpbmdzfSBmcm9tICcuLi8uLi8uLi8uLi93ZWIvanMvdXRpbC9TdHJpbmdzJztcbmltcG9ydCB7UmVuZGVyZXJBbmFseXRpY3N9IGZyb20gJy4uLy4uLy4uLy4uL3dlYi9qcy9nYS9SZW5kZXJlckFuYWx5dGljcyc7XG5pbXBvcnQge1RhZ3N9IGZyb20gJy4uLy4uLy4uLy4uL3dlYi9qcy90YWdzL1RhZ3MnO1xuaW1wb3J0IHtpc1ByZXNlbnR9IGZyb20gJy4uLy4uLy4uLy4uL3dlYi9qcy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7U2V0c30gZnJvbSAnLi4vLi4vLi4vLi4vd2ViL2pzL3V0aWwvU2V0cyc7XG5pbXBvcnQge0ZpbHRlcmVkVGFnc30gZnJvbSAnLi4vRmlsdGVyZWRUYWdzJztcbmltcG9ydCB7UHJvdmlkZXJ9IGZyb20gJy4uLy4uLy4uLy4uL3dlYi9qcy91dGlsL1Byb3ZpZGVycyc7XG5cbi8qKlxuICogS2VlcHMgdHJhY2sgb2YgdGhlIGRvYyBpbmRleCBzbyB0aGF0IHdlIGNhbiBmaWx0ZXIgaXQgaW4gdGhlIFVJIGFuZCBoYXZlXG4gKiB0aGUgZmlsdGVyIGV2ZW50cyBzZW5kIHRvIHRoZSBpbmRleCBhbmQgdGhlbiB1cGRhdGUgY29tcG9uZW50IHN0YXRlIGRpcmVjdGx5LlxuICovXG5leHBvcnQgY2xhc3MgRmlsdGVyZWRSZXBvRG9jSW5mb0luZGV4IHtcblxuICAgIHB1YmxpYyByZWFkb25seSBmaWx0ZXJzOiBGaWx0ZXJzO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBvblJlZnJlc2hlZDogUmVmcmVzaGVkQ2FsbGJhY2ssXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZXBvRG9jSW5mb3NQcm92aWRlcjogUHJvdmlkZXI8UmVwb0RvY0luZm9bXT4pIHtcblxuICAgICAgICB0aGlzLmZpbHRlcnMgPSB7XG4gICAgICAgICAgICBmbGFnZ2VkOiBmYWxzZSxcbiAgICAgICAgICAgIGFyY2hpdmVkOiBmYWxzZSxcbiAgICAgICAgICAgIHRpdGxlOiBcIlwiLFxuICAgICAgICAgICAgZmlsdGVyZWRUYWdzOiBuZXcgRmlsdGVyZWRUYWdzKClcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBvblRvZ2dsZUZsYWdnZWRPbmx5KHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZmlsdGVycy5mbGFnZ2VkID0gdmFsdWU7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblRvZ2dsZUZpbHRlckFyY2hpdmVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZmlsdGVycy5hcmNoaXZlZCA9IHZhbHVlO1xuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25GaWx0ZXJCeVRpdGxlKHRpdGxlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzLnRpdGxlID0gdGl0bGU7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH1cblxuXG4gICAgcHVibGljIHJlZnJlc2goKSB7XG4gICAgICAgIHRoaXMub25SZWZyZXNoZWQodGhpcy5maWx0ZXIodGhpcy5yZXBvRG9jSW5mb3NQcm92aWRlcigpKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaWx0ZXIocmVwb0RvY0luZm9zOiBSZXBvRG9jSW5mb1tdKTogUmVwb0RvY0luZm9bXSB7XG5cbiAgICAgICAgLy8gYWx3YXlzIGZpbHRlciB2YWxpZCB0byBtYWtlIHN1cmUgbm90aGluZyBjb3JydXB0cyB0aGUgc3RhdGUuICBTb21lXG4gICAgICAgIC8vIG90aGVyIGJ1ZyBtaWdodCBpbmplY3QgYSBwcm9ibGVtIG90aGVyd2lzZS5cbiAgICAgICAgcmVwb0RvY0luZm9zID0gdGhpcy5kb0ZpbHRlclZhbGlkKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJCeVRpdGxlKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJGbGFnZ2VkKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJBcmNoaXZlZChyZXBvRG9jSW5mb3MpO1xuICAgICAgICByZXBvRG9jSW5mb3MgPSB0aGlzLmRvRmlsdGVyQnlUYWdzKHJlcG9Eb2NJbmZvcyk7XG5cbiAgICAgICAgcmV0dXJuIHJlcG9Eb2NJbmZvcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJWYWxpZChyZXBvRG9jczogUmVwb0RvY0luZm9bXSk6IFJlcG9Eb2NJbmZvW10ge1xuICAgICAgICByZXR1cm4gcmVwb0RvY3MuZmlsdGVyKGN1cnJlbnQgPT4gUmVwb0RvY0luZm9zLmlzVmFsaWQoY3VycmVudCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJCeVRpdGxlKHJlcG9Eb2NzOiBSZXBvRG9jSW5mb1tdKTogUmVwb0RvY0luZm9bXSB7XG5cbiAgICAgICAgaWYgKCEgU3RyaW5ncy5lbXB0eSh0aGlzLmZpbHRlcnMudGl0bGUpKSB7XG5cbiAgICAgICAgICAgIHJldHVybiByZXBvRG9jcy5maWx0ZXIoY3VycmVudCA9PiBjdXJyZW50LnRpdGxlICYmXG4gICAgICAgICAgICAgICAgY3VycmVudC50aXRsZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGhpcy5maWx0ZXJzLnRpdGxlLnRvTG93ZXJDYXNlKCkpID49IDApO1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0RvY3M7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRvRmlsdGVyRmxhZ2dlZChyZXBvRG9jczogUmVwb0RvY0luZm9bXSk6IFJlcG9Eb2NJbmZvW10ge1xuXG4gICAgICAgIGlmICh0aGlzLmZpbHRlcnMuZmxhZ2dlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9Eb2NzLmZpbHRlcihjdXJyZW50ID0+IGN1cnJlbnQuZmxhZ2dlZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0RvY3M7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRvRmlsdGVyQXJjaGl2ZWQocmVwb0RvY3M6IFJlcG9Eb2NJbmZvW10pOiBSZXBvRG9jSW5mb1tdIHtcblxuICAgICAgICBpZiAoISB0aGlzLmZpbHRlcnMuYXJjaGl2ZWQpIHtcbiAgICAgICAgICAgIHJldHVybiByZXBvRG9jcy5maWx0ZXIoY3VycmVudCA9PiAhY3VycmVudC5hcmNoaXZlZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0RvY3M7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRvRmlsdGVyQnlUYWdzKHJlcG9Eb2NzOiBSZXBvRG9jSW5mb1tdKTogUmVwb0RvY0luZm9bXSB7XG5cbiAgICAgICAgUmVuZGVyZXJBbmFseXRpY3MuZXZlbnQoe2NhdGVnb3J5OiAndXNlcicsIGFjdGlvbjogJ2ZpbHRlci1ieS10YWdzJ30pO1xuXG4gICAgICAgIGNvbnN0IHRhZ3MgPSBUYWdzLnRvSURzKHRoaXMuZmlsdGVycy5maWx0ZXJlZFRhZ3MuZ2V0KCkpO1xuXG4gICAgICAgIHJldHVybiByZXBvRG9jcy5maWx0ZXIoY3VycmVudCA9PiB7XG5cbiAgICAgICAgICAgIGlmICh0YWdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIC8vIHRoZXJlIGlzIG5vIGZpbHRlciBpbiBwbGFjZS4uLlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoISBpc1ByZXNlbnQoY3VycmVudC5kb2NJbmZvLnRhZ3MpKSB7XG4gICAgICAgICAgICAgICAgLy8gdGhlIGRvY3VtZW50IHdlJ3JlIHNlYXJjaGluZyBvdmVyIGhhcyBub3QgdGFncy5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9XG4gICAgICAgICAgICAgICAgU2V0cy5pbnRlcnNlY3Rpb24odGFncywgVGFncy50b0lEcyhPYmplY3QudmFsdWVzKGN1cnJlbnQuZG9jSW5mby50YWdzISkpKTtcblxuICAgICAgICAgICAgcmV0dXJuIGludGVyc2VjdGlvbi5sZW5ndGggPT09IHRhZ3MubGVuZ3RoO1xuXG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cblxuaW50ZXJmYWNlIEZpbHRlcnMge1xuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCBvbmx5IHNob3cgZmxhZ2dlZCBkb2N1bWVudHMuXG4gICAgICovXG4gICAgZmxhZ2dlZDogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqICBXaGVuIHRydWUsIHNob3cgYm90aCBhcmNoaXZlZCBhbmQgbm9uLWFyY2hpdmVkIGRvY3VtZW50cy5cbiAgICAgKi9cbiAgICBhcmNoaXZlZDogYm9vbGVhbjtcblxuICAgIHRpdGxlOiBzdHJpbmc7XG5cbiAgICBmaWx0ZXJlZFRhZ3M6IEZpbHRlcmVkVGFncztcblxufVxuXG5leHBvcnQgdHlwZSBSZWZyZXNoZWRDYWxsYmFjayA9IChyZXBvRG9jSW5mb3M6IFJlcG9Eb2NJbmZvW10pID0+IHZvaWQ7XG5cbiJdfQ==