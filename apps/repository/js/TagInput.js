"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const React = __importStar(require("react"));
const Creatable_1 = __importDefault(require("react-select/lib/Creatable"));
const Blackout_1 = require("../../../web/js/ui/blackout/Blackout");
const Optional_1 = require("../../../web/js/util/ts/Optional");
const TagSelectOptions_1 = require("./TagSelectOptions");
const Tags_1 = require("../../../web/js/tags/Tags");
const Logger_1 = require("../../../web/js/logger/Logger");
const Button_1 = __importDefault(require("reactstrap/lib/Button"));
const Popover_1 = __importDefault(require("reactstrap/lib/Popover"));
const PopoverBody_1 = __importDefault(require("reactstrap/lib/PopoverBody"));
let SEQUENCE = 0;
const log = Logger_1.Logger.create();
const Styles = {
    popover: {
        width: '500px !important',
        maxWidth: '9999px !important'
    },
    label: {
        fontWeight: 'bold'
    },
    relatedTags: {
        marginTop: '5px',
        display: 'flex',
    },
    relatedTagsLabel: {
        marginTop: 'auto',
        marginBottom: 'auto'
    },
    relatedTag: {
        display: 'inline-block',
        backgroundColor: '#e5e5e5',
        color: 'hsl(0,0%,20%)',
        fontSize: '12px',
        padding: '3px',
        marginTop: 'auto',
        marginBottom: 'auto'
    }
};
class TagInput extends React.PureComponent {
    constructor(props, context) {
        super(props, context);
        this.id = "popover-" + SEQUENCE++;
        this.toggle = this.toggle.bind(this);
        this.handleChange = this.handleChange.bind(this);
        this.state = {
            open: false,
            tags: []
        };
    }
    toggle() {
        const open = !this.state.open;
        Blackout_1.Blackout.toggle(open);
        const tags = TagSelectOptions_1.TagSelectOptions.fromTags(this.props.existingTags || []);
        this.setState(Object.assign({}, this.state, { open, tags }));
    }
    render() {
        const availableTagOptions = TagSelectOptions_1.TagSelectOptions.fromTags(this.props.availableTags);
        const existingTags = Optional_1.Optional.of(this.props.existingTags).getOrElse([]);
        const defaultValue = TagSelectOptions_1.TagSelectOptions.fromTags(existingTags)
            .sort((a, b) => a.label.localeCompare(b.label));
        const relatedTags = this.props.relatedTags.compute(this.state.tags.map(current => current.label))
            .map(current => current.tag);
        const RelatedTagsItems = () => {
            return React.createElement("span", null, relatedTags.map(item => React.createElement(Button_1.default, { className: "mr-1", key: item, style: Styles.relatedTag, color: "light", size: "sm", onClick: () => this.addTag(item) }, item)));
        };
        const RelatedTagsWidget = () => {
            if (relatedTags.length === 0) {
                return React.createElement("div", null);
            }
            return React.createElement("div", { style: Styles.relatedTags },
                React.createElement("div", { className: "mr-1", style: Styles.relatedTagsLabel },
                    React.createElement("strong", null, "Related tags: ")),
                React.createElement(RelatedTagsItems, null));
        };
        return (React.createElement("div", null,
            React.createElement("i", { id: this.id, onClick: this.toggle, className: "fa fa-tag doc-button doc-button-inactive" }),
            React.createElement(Popover_1.default, { placement: "auto", isOpen: this.state.open, target: this.id, trigger: "legacy", toggle: this.toggle, className: "tag-input-popover shadow" },
                React.createElement(PopoverBody_1.default, { style: Styles.popover },
                    React.createElement("div", { className: "pt-1 pb-1" },
                        React.createElement("strong", null, "Assign tags to document:")),
                    React.createElement(Creatable_1.default, { isMulti: true, isClearable: true, autoFocus: true, onKeyDown: event => this.onKeyDown(event), className: "basic-multi-select", classNamePrefix: "select", onChange: (selectedOptions) => this.handleChange(selectedOptions), value: this.state.tags, defaultValue: defaultValue, placeholder: "Create or select tags ...", options: availableTagOptions },
                        React.createElement("div", null, "this is the error")),
                    React.createElement("div", null,
                        React.createElement(RelatedTagsWidget, null))))));
    }
    addTag(tag) {
        const newTag = { value: tag, label: tag };
        const tags = [...this.state.tags, newTag];
        this.setState(Object.assign({}, this.state, { tags }));
        this.handleChange(tags);
    }
    onKeyDown(event) {
        if (event.key === "Escape") {
            this.toggle();
        }
        if (event.getModifierState("Control") && event.key === "Enter") {
            this.toggle();
        }
    }
    save() {
    }
    handleChange(selectedOptions) {
        const tags = TagSelectOptions_1.TagSelectOptions.toTags(selectedOptions);
        const validTags = Tags_1.Tags.findValidTags(...tags);
        const invalidTags = Tags_1.Tags.findInvalidTags(...tags);
        this.setState(Object.assign({}, this.state, { tags: TagSelectOptions_1.TagSelectOptions.fromTags(validTags) }));
        if (this.props.onChange) {
            this.props.onChange(validTags);
            if (invalidTags.length > 0) {
                log.warn("Some tags were invalid", invalidTags);
            }
        }
    }
}
exports.TagInput = TagInput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFnSW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUYWdJbnB1dC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsNkNBQStCO0FBQy9CLDJFQUF5RDtBQUN6RCxtRUFBOEQ7QUFFOUQsK0RBQTBEO0FBRTFELHlEQUFvRDtBQUNwRCxvREFBK0M7QUFDL0MsMERBQXFEO0FBR3JELG1FQUEyQztBQUMzQyxxRUFBNkM7QUFDN0MsNkVBQXFEO0FBRXJELElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztBQUVqQixNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFHNUIsTUFBTSxNQUFNLEdBQWM7SUFFdEIsT0FBTyxFQUFFO1FBQ0wsS0FBSyxFQUFFLGtCQUFrQjtRQUN6QixRQUFRLEVBQUUsbUJBQW1CO0tBQ2hDO0lBRUQsS0FBSyxFQUFFO1FBQ0gsVUFBVSxFQUFFLE1BQU07S0FDckI7SUFFRCxXQUFXLEVBQUU7UUFDVCxTQUFTLEVBQUUsS0FBSztRQUNoQixPQUFPLEVBQUUsTUFBTTtLQUNsQjtJQUVELGdCQUFnQixFQUFFO1FBQ2QsU0FBUyxFQUFFLE1BQU07UUFDakIsWUFBWSxFQUFFLE1BQU07S0FDdkI7SUFFRCxVQUFVLEVBQUU7UUFDUixPQUFPLEVBQUUsY0FBYztRQUN2QixlQUFlLEVBQUUsU0FBUztRQUMxQixLQUFLLEVBQUUsZUFBZTtRQUN0QixRQUFRLEVBQUUsTUFBTTtRQUNoQixPQUFPLEVBQUUsS0FBSztRQUNkLFNBQVMsRUFBRSxNQUFNO1FBQ2pCLFlBQVksRUFBRSxNQUFNO0tBQ3ZCO0NBRUosQ0FBQztBQUdGLE1BQWEsUUFBUyxTQUFRLEtBQUssQ0FBQyxhQUE2QjtJQUk3RCxZQUFZLEtBQWEsRUFBRSxPQUFZO1FBQ25DLEtBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFIVCxPQUFFLEdBQUcsVUFBVSxHQUFHLFFBQVEsRUFBRSxDQUFDO1FBSzFDLElB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QUM7UUFDckMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU1QixDQUFDO0lBRU8sU0FBUyxDQUFDLEtBQXVDO1FBRXJELElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDeEIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2pCO1FBRUQsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxPQUFPLEVBQUU7WUFDNUQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2pCO0lBRUwsQ0FBQztJQUVPLElBQUk7SUFFWixDQUFDO0lBRU8sWUFBWSxDQUFDLGVBQWtDO1FBRW5ELE1BQU0sSUFBSSxHQUFHLG1DQUFnQixDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUV0RCxNQUFNLFNBQVMsR0FBRyxXQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDOUMsTUFBTSxXQUFXLEdBQUcsV0FBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRWxELElBQUksQ0FBQyxRQUFRLG1CQUFLLElBQUksQ0FBQyxLQUFLLElBQUUsSUFBSSxFQUFFLG1DQUFnQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBRSxDQUFDO1FBRTNFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFJckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFL0IsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDeEIsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQzthQUNuRDtTQUVKO0lBRUwsQ0FBQztDQUVKO0FBekxELDRCQXlMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBDcmVhdGFibGVTZWxlY3QgZnJvbSAncmVhY3Qtc2VsZWN0L2xpYi9DcmVhdGFibGUnO1xuaW1wb3J0IHtCbGFja291dH0gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL3VpL2JsYWNrb3V0L0JsYWNrb3V0JztcbmltcG9ydCB7VGFnfSBmcm9tICcuLi8uLi8uLi93ZWIvanMvdGFncy9UYWcnO1xuaW1wb3J0IHtPcHRpb25hbH0gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL3V0aWwvdHMvT3B0aW9uYWwnO1xuaW1wb3J0IHtUYWdTZWxlY3RPcHRpb259IGZyb20gJy4vVGFnU2VsZWN0T3B0aW9uJztcbmltcG9ydCB7VGFnU2VsZWN0T3B0aW9uc30gZnJvbSAnLi9UYWdTZWxlY3RPcHRpb25zJztcbmltcG9ydCB7VGFnc30gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL3RhZ3MvVGFncyc7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtJU3R5bGVNYXB9IGZyb20gJy4uLy4uLy4uL3dlYi9qcy9yZWFjdC9JU3R5bGVNYXAnO1xuaW1wb3J0IHtSZWxhdGVkVGFnc30gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL3RhZ3MvcmVsYXRlZC9SZWxhdGVkVGFncyc7XG5pbXBvcnQgQnV0dG9uIGZyb20gJ3JlYWN0c3RyYXAvbGliL0J1dHRvbic7XG5pbXBvcnQgUG9wb3ZlciBmcm9tICdyZWFjdHN0cmFwL2xpYi9Qb3BvdmVyJztcbmltcG9ydCBQb3BvdmVyQm9keSBmcm9tICdyZWFjdHN0cmFwL2xpYi9Qb3BvdmVyQm9keSc7XG5cbmxldCBTRVFVRU5DRSA9IDA7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuXG5jb25zdCBTdHlsZXM6IElTdHlsZU1hcCA9IHtcblxuICAgIHBvcG92ZXI6IHtcbiAgICAgICAgd2lkdGg6ICc1MDBweCAhaW1wb3J0YW50JyxcbiAgICAgICAgbWF4V2lkdGg6ICc5OTk5cHggIWltcG9ydGFudCdcbiAgICB9LFxuXG4gICAgbGFiZWw6IHtcbiAgICAgICAgZm9udFdlaWdodDogJ2JvbGQnXG4gICAgfSxcblxuICAgIHJlbGF0ZWRUYWdzOiB7XG4gICAgICAgIG1hcmdpblRvcDogJzVweCcsXG4gICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICB9LFxuXG4gICAgcmVsYXRlZFRhZ3NMYWJlbDoge1xuICAgICAgICBtYXJnaW5Ub3A6ICdhdXRvJyxcbiAgICAgICAgbWFyZ2luQm90dG9tOiAnYXV0bydcbiAgICB9LFxuXG4gICAgcmVsYXRlZFRhZzoge1xuICAgICAgICBkaXNwbGF5OiAnaW5saW5lLWJsb2NrJyxcbiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAnI2U1ZTVlNScsXG4gICAgICAgIGNvbG9yOiAnaHNsKDAsMCUsMjAlKScsXG4gICAgICAgIGZvbnRTaXplOiAnMTJweCcsXG4gICAgICAgIHBhZGRpbmc6ICczcHgnLFxuICAgICAgICBtYXJnaW5Ub3A6ICdhdXRvJyxcbiAgICAgICAgbWFyZ2luQm90dG9tOiAnYXV0bydcbiAgICB9XG5cbn07XG5cblxuZXhwb3J0IGNsYXNzIFRhZ0lucHV0IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBpZCA9IFwicG9wb3Zlci1cIiArIFNFUVVFTkNFKys7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzLCBjb250ZXh0OiBhbnkpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgICAgIHRoaXMudG9nZ2xlID0gdGhpcy50b2dnbGUuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5oYW5kbGVDaGFuZ2UgPSB0aGlzLmhhbmRsZUNoYW5nZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgb3BlbjogZmFsc2UsXG4gICAgICAgICAgICB0YWdzOiBbXVxuICAgICAgICB9O1xuXG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZSgpIHtcblxuICAgICAgICBjb25zdCBvcGVuID0gIXRoaXMuc3RhdGUub3BlbjtcblxuICAgICAgICBCbGFja291dC50b2dnbGUob3Blbik7XG5cbiAgICAgICAgY29uc3QgdGFncyA9IFRhZ1NlbGVjdE9wdGlvbnMuZnJvbVRhZ3ModGhpcy5wcm9wcy5leGlzdGluZ1RhZ3MgfHwgW10pO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoey4uLnRoaXMuc3RhdGUsIG9wZW4sIHRhZ3N9KTtcblxuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG5cbiAgICAgICAgY29uc3QgYXZhaWxhYmxlVGFnT3B0aW9uczogVGFnU2VsZWN0T3B0aW9uW11cbiAgICAgICAgICAgID0gVGFnU2VsZWN0T3B0aW9ucy5mcm9tVGFncyh0aGlzLnByb3BzLmF2YWlsYWJsZVRhZ3MpO1xuXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nVGFnczogVGFnW10gPSBPcHRpb25hbC5vZih0aGlzLnByb3BzLmV4aXN0aW5nVGFncykuZ2V0T3JFbHNlKFtdKTtcblxuICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWU6IFRhZ1NlbGVjdE9wdGlvbltdID1cbiAgICAgICAgICAgIFRhZ1NlbGVjdE9wdGlvbnMuZnJvbVRhZ3MoZXhpc3RpbmdUYWdzKVxuICAgICAgICAgICAgICAgIC5zb3J0KChhLCBiKSA9PiBhLmxhYmVsLmxvY2FsZUNvbXBhcmUoYi5sYWJlbCkpO1xuXG4gICAgICAgIGNvbnN0IHJlbGF0ZWRUYWdzOiBzdHJpbmdbXVxuICAgICAgICAgICAgPSB0aGlzLnByb3BzLnJlbGF0ZWRUYWdzLmNvbXB1dGUodGhpcy5zdGF0ZS50YWdzLm1hcChjdXJyZW50ID0+IGN1cnJlbnQubGFiZWwpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChjdXJyZW50ID0+IGN1cnJlbnQudGFnKTtcblxuICAgICAgICBjb25zdCBSZWxhdGVkVGFnc0l0ZW1zID0gKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIDxzcGFuPlxuICAgICAgICAgICAgICAgIHtyZWxhdGVkVGFncy5tYXAoaXRlbSA9PlxuICAgICAgICAgICAgICAgICAgICAgPEJ1dHRvbiBjbGFzc05hbWU9XCJtci0xXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtpdGVtfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17U3R5bGVzLnJlbGF0ZWRUYWd9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPVwibGlnaHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPVwic21cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB0aGlzLmFkZFRhZyhpdGVtKX0+e2l0ZW19PC9CdXR0b24+KX1cbiAgICAgICAgICAgIDwvc3Bhbj47XG5cbiAgICAgICAgfTtcblxuXG4gICAgICAgIGNvbnN0IFJlbGF0ZWRUYWdzV2lkZ2V0ID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAocmVsYXRlZFRhZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxkaXY+PC9kaXY+O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gPGRpdiBzdHlsZT17U3R5bGVzLnJlbGF0ZWRUYWdzfT5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm1yLTFcIiBzdHlsZT17U3R5bGVzLnJlbGF0ZWRUYWdzTGFiZWx9PlxuICAgICAgICAgICAgICAgICAgICA8c3Ryb25nPlJlbGF0ZWQgdGFnczogPC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPFJlbGF0ZWRUYWdzSXRlbXMvPlxuICAgICAgICAgICAgPC9kaXY+O1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIChcblxuICAgICAgICAgICAgPGRpdj5cblxuICAgICAgICAgICAgICAgIDxpIGlkPXt0aGlzLmlkfSBvbkNsaWNrPXt0aGlzLnRvZ2dsZX1cbiAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJmYSBmYS10YWcgZG9jLWJ1dHRvbiBkb2MtYnV0dG9uLWluYWN0aXZlXCIvPlxuXG5cbiAgICAgICAgICAgICAgICB7Lyp0YWctaW5wdXQtcG9wb3ZlciB7Ki99XG4gICAgICAgICAgICAgICAgey8qd2lkdGg6IDUwMHB4ICFpbXBvcnRhbnQ7Ki99XG4gICAgICAgICAgICAgICAgey8qbWF4LXdpZHRoOiA5OTk5cHggIWltcG9ydGFudDsqL31cbiAgICAgICAgICAgIHsvKn0qL31cblxuICAgICAgICAgICAgICAgIHsvKi50YWctaW5wdXQtcG9wb3ZlciBsYWJlbCB7Ki99XG4gICAgICAgICAgICAgICAgey8qZm9udC13ZWlnaHQ6IGJvbGQ7Ki99XG4gICAgICAgICAgICB7Lyp9Ki99XG5cbiAgICAgICAgICAgICAgICA8UG9wb3ZlciBwbGFjZW1lbnQ9XCJhdXRvXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICBpc09wZW49e3RoaXMuc3RhdGUub3Blbn1cbiAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ9e3RoaXMuaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgdHJpZ2dlcj1cImxlZ2FjeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlPXt0aGlzLnRvZ2dsZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJ0YWctaW5wdXQtcG9wb3ZlciBzaGFkb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgey8qPFBvcG92ZXJIZWFkZXI+UG9wb3ZlciBUaXRsZTwvUG9wb3ZlckhlYWRlcj4qL31cblxuICAgICAgICAgICAgICAgICAgICB7LypzdHlsZT17e2JvcmRlcldpZHRoOiAnMXB4JywgYmFja2dyb3VuZENvbG9yOiB0cnVlID8gXCIjYjk0YTQ4XCIgOiBcIiNhYWFcIn19Ki99XG4gICAgICAgICAgICAgICAgICAgIDxQb3BvdmVyQm9keSBzdHlsZT17U3R5bGVzLnBvcG92ZXJ9PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInB0LTEgcGItMVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzdHJvbmc+QXNzaWduIHRhZ3MgdG8gZG9jdW1lbnQ6PC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPENyZWF0YWJsZVNlbGVjdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzTXVsdGlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0NsZWFyYWJsZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uS2V5RG93bj17ZXZlbnQgPT4gdGhpcy5vbktleURvd24oZXZlbnQpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cImJhc2ljLW11bHRpLXNlbGVjdFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lUHJlZml4PVwic2VsZWN0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17KHNlbGVjdGVkT3B0aW9ucykgPT4gdGhpcy5oYW5kbGVDaGFuZ2Uoc2VsZWN0ZWRPcHRpb25zIGFzIFRhZ1NlbGVjdE9wdGlvbltdKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS50YWdzfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZT17ZGVmYXVsdFZhbHVlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwiQ3JlYXRlIG9yIHNlbGVjdCB0YWdzIC4uLlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucz17YXZhaWxhYmxlVGFnT3B0aW9uc30gPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj50aGlzIGlzIHRoZSBlcnJvcjwvZGl2PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8L0NyZWF0YWJsZVNlbGVjdD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxSZWxhdGVkVGFnc1dpZGdldC8+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgICAgIDwvUG9wb3ZlckJvZHk+XG4gICAgICAgICAgICAgICAgPC9Qb3BvdmVyPlxuXG4gICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICApO1xuXG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGFkZFRhZyh0YWc6IHN0cmluZykge1xuXG4gICAgICAgIGNvbnN0IG5ld1RhZzogVGFnU2VsZWN0T3B0aW9uID0ge3ZhbHVlOiB0YWcsIGxhYmVsOiB0YWd9O1xuICAgICAgICBjb25zdCB0YWdzID0gWy4uLnRoaXMuc3RhdGUudGFncywgbmV3VGFnXTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7Li4udGhpcy5zdGF0ZSwgdGFnc30pO1xuICAgICAgICB0aGlzLmhhbmRsZUNoYW5nZSh0YWdzKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgb25LZXlEb3duKGV2ZW50OiBSZWFjdC5LZXlib2FyZEV2ZW50PEhUTUxFbGVtZW50Pikge1xuXG4gICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiRXNjYXBlXCIpIHtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZShcIkNvbnRyb2xcIikgJiYgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlKCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgc2F2ZSgpIHtcbiAgICAgICAgLy8gbm9vcFxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ2hhbmdlKHNlbGVjdGVkT3B0aW9uczogVGFnU2VsZWN0T3B0aW9uW10pIHtcblxuICAgICAgICBjb25zdCB0YWdzID0gVGFnU2VsZWN0T3B0aW9ucy50b1RhZ3Moc2VsZWN0ZWRPcHRpb25zKTtcblxuICAgICAgICBjb25zdCB2YWxpZFRhZ3MgPSBUYWdzLmZpbmRWYWxpZFRhZ3MoLi4udGFncyk7XG4gICAgICAgIGNvbnN0IGludmFsaWRUYWdzID0gVGFncy5maW5kSW52YWxpZFRhZ3MoLi4udGFncyk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7Li4udGhpcy5zdGF0ZSwgdGFnczogVGFnU2VsZWN0T3B0aW9ucy5mcm9tVGFncyh2YWxpZFRhZ3MpfSk7XG5cbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25DaGFuZ2UpIHtcblxuICAgICAgICAgICAgLy8gaW1wb3J0YW50IHRvIGFsd2F5cyBjYWxsIG9uQ2hhbmdlIGV2ZW4gaWYgd2UgaGF2ZSBubyB2YWxpZCB0YWdzXG4gICAgICAgICAgICAvLyBhcyB0aGlzIGlzIGFjY2VwdGFibGUgYW5kIHdlIHdhbnQgdG8gc2F2ZSB0aGVzZSB0byBkaXNrLlxuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkNoYW5nZSh2YWxpZFRhZ3MpO1xuXG4gICAgICAgICAgICBpZiAoaW52YWxpZFRhZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGxvZy53YXJuKFwiU29tZSB0YWdzIHdlcmUgaW52YWxpZFwiLCBpbnZhbGlkVGFncyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVByb3BzIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSB0YWdzIHRoYXQgY2FuIGJlIHNlbGVjdGVkLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGF2YWlsYWJsZVRhZ3M6IFRhZ1tdO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGV4aXN0aW5nIHRhZ3Mgb24gdGhpcyBpdGVtLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGV4aXN0aW5nVGFncz86IFRhZ1tdO1xuXG4gICAgLyoqXG4gICAgICogVGhlIHJlbGF0ZWRUYWdzIGluZGV4IHdoaWNoIGlzIHVwZGF0ZWQgYXMgdGhlIHVzZXIgc2VsZWN0cyBuZXcgdGFncy5cbiAgICAgKi9cbiAgICByZWFkb25seSByZWxhdGVkVGFnczogUmVsYXRlZFRhZ3M7XG5cbiAgICByZWFkb25seSBvbkNoYW5nZT86ICh2YWx1ZXM6IFRhZ1tdKSA9PiB2b2lkO1xuXG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuXG4gICAgcmVhZG9ubHkgb3BlbjogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgdGFncy5cbiAgICAgKi9cbiAgICByZWFkb25seSB0YWdzOiBUYWdTZWxlY3RPcHRpb25bXTtcblxufVxuXG5cblxuXG4iXX0=