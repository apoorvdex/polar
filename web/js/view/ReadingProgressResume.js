"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Elements_1 = require("../util/Elements");
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const Rects_1 = require("../Rects");
const Reducers_1 = require("../util/Reducers");
class ReadingProgressResume {
    static resume(docMeta) {
        const targetPagemark = this.computeTargetPagemark(docMeta);
        if (!targetPagemark) {
            return false;
        }
        const pages = document.querySelectorAll(".page");
        const pageNum = targetPagemark.pageNum;
        const pageElement = pages[pageNum - 1];
        const scrollParent = this.getScrollParent(pageElement);
        const pageOffset = Elements_1.Elements.getRelativeOffsetRect(pageElement, scrollParent);
        const pageTop = pageOffset.top;
        const pageHeight = Math.floor(pageElement.clientHeight);
        const computePagemarkHeight = () => {
            const docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
            if (docFormat.name === 'pdf') {
                const pagemarkBottom = Math.floor(Rects_1.Rects.createFromBasicRect(targetPagemark.pagemark.rect).bottom);
                const pagemarkBottomPerc = pagemarkBottom / 100;
                return pageHeight * pagemarkBottomPerc;
            }
            else {
                const pagemarkElements = Array.from(pageElement.querySelectorAll(".pagemark"));
                const pagemarkElement = pagemarkElements.sort((a, b) => a.getBoundingClientRect().bottom - b.getBoundingClientRect().bottom)
                    .reduce(Reducers_1.Reducers.LAST);
                if (pagemarkElement) {
                    return pagemarkElement.clientHeight;
                }
                else {
                    throw new Error("No pagemarkElement");
                }
            }
        };
        const pagemarkHeight = computePagemarkHeight();
        const windowDelta = window.innerHeight * (0.2);
        const newScrollTop = pageTop + pagemarkHeight - windowDelta;
        scrollParent.scrollTop = newScrollTop;
        return true;
    }
    static getScrollParent(element) {
        const docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        if (docFormat.name === 'pdf') {
            return document.querySelector("#viewerContainer");
        }
        if (docFormat.name === 'html') {
            return document.querySelector(".polar-viewer");
        }
        return Elements_1.Elements.getScrollParent(element);
    }
    static computePagemarks(docMeta) {
        const result = [];
        for (const pageMeta of Object.values(docMeta.pageMetas)) {
            const pagemarks = Object.values(pageMeta.pagemarks || {});
            const pagemarkHolders = pagemarks.map(pagemark => {
                return {
                    pageNum: pageMeta.pageInfo.num,
                    pagemark
                };
            });
            result.push(...pagemarkHolders);
        }
        return result;
    }
    static computeTargetPagemark(docMeta) {
        const pagemarkHolders = this.computePagemarks(docMeta);
        let result;
        const comparePagemarks = (p0, p1) => {
            if (!p0) {
                return p1;
            }
            if (p0.pageNum < p1.pageNum) {
                return p1;
            }
            if (p0.pageNum === p1.pageNum) {
                if (Rects_1.Rects.createFromBasicRect(p0.pagemark.rect).bottom <
                    Rects_1.Rects.createFromBasicRect(p1.pagemark.rect).bottom) {
                    return p1;
                }
            }
            return p0;
        };
        for (const pagemarkHolder of pagemarkHolders) {
            result = comparePagemarks(result, pagemarkHolder);
        }
        return result;
    }
}
exports.ReadingProgressResume = ReadingProgressResume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhZGluZ1Byb2dyZXNzUmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUmVhZGluZ1Byb2dyZXNzUmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0NBQTBDO0FBQzFDLG9FQUErRDtBQUcvRCxvQ0FBK0I7QUFDL0IsK0NBQTBDO0FBRTFDLE1BQWEscUJBQXFCO0lBRXZCLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBZ0I7UUFFakMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTNELElBQUksQ0FBRSxjQUFjLEVBQUU7WUFDbEIsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFFRCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFakQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQztRQUV2QyxNQUFNLFdBQVcsR0FBaUIsS0FBSyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUVyRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXZELE1BQU0sVUFBVSxHQUFHLG1CQUFRLENBQUMscUJBQXFCLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRTdFLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFDL0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFeEQsTUFBTSxxQkFBcUIsR0FBRyxHQUFXLEVBQUU7WUFFdkMsTUFBTSxTQUFTLEdBQUcsbUNBQWdCLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFakQsSUFBSSxTQUFTLENBQUMsSUFBSSxLQUFLLEtBQUssRUFBRTtnQkFFMUIsTUFBTSxjQUFjLEdBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFLLENBQUMs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QyxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRTtnQkFDekIsT0FBTyxFQUFFLENBQUM7YUFDYjtZQUVELElBQUksRUFBRSxDQUFDLE9BQU8sS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFFO2dCQUkzQixJQUFJLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07b0JBQ2xELGFBQUssQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRTtvQkFFcEQsT0FBTyxFQUFFLENBQUM7aUJBRWI7YUFFSjtZQUVELE9BQU8sRUFBRSxDQUFDO1FBRWQsQ0FBQyxDQUFDO1FBR0YsS0FBSyxNQUFNLGNBQWMsSUFBSSxlQUFlLEVBQUU7WUFDMUMsTUFBTSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQztTQUNyRDtRQUVELE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7Q0FFSjtBQWxLRCxzREFrS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0VsZW1lbnRzfSBmcm9tICcuLi91dGlsL0VsZW1lbnRzJztcbmltcG9ydCB7RG9jRm9ybWF0RmFjdG9yeX0gZnJvbSAnLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdEZhY3RvcnknO1xuaW1wb3J0IHtEb2NNZXRhfSBmcm9tICcuLi9tZXRhZGF0YS9Eb2NNZXRhJztcbmltcG9ydCB7UGFnZW1hcmt9IGZyb20gJy4uL21ldGFkYXRhL1BhZ2VtYXJrJztcbmltcG9ydCB7UmVjdHN9IGZyb20gJy4uL1JlY3RzJztcbmltcG9ydCB7UmVkdWNlcnN9IGZyb20gJy4uL3V0aWwvUmVkdWNlcnMnO1xuXG5leHBvcnQgY2xhc3MgUmVhZGluZ1Byb2dyZXNzUmVzdW1lIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgcmVzdW1lKGRvY01ldGE6IERvY01ldGEpIHtcblxuICAgICAgICBjb25zdCB0YXJnZXRQYWdlbWFyayA9IHRoaXMuY29tcHV0ZVRhcmdldFBhZ2VtYXJrKGRvY01ldGEpO1xuXG4gICAgICAgIGlmICghIHRhcmdldFBhZ2VtYXJrKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIucGFnZVwiKTtcblxuICAgICAgICBjb25zdCBwYWdlTnVtID0gdGFyZ2V0UGFnZW1hcmsucGFnZU51bTtcblxuICAgICAgICBjb25zdCBwYWdlRWxlbWVudCA9IDxIVE1MRWxlbWVudD4gcGFnZXNbcGFnZU51bSAtIDFdO1xuXG4gICAgICAgIGNvbnN0IHNjcm9sbFBhcmVudCA9IHRoaXMuZ2V0U2Nyb2xsUGFyZW50KHBhZ2VFbGVtZW50KTtcblxuICAgICAgICBjb25zdCBwYWdlT2Zmc2V0ID0gRWxlbWVudHMuZ2V0UmVsYXRpdmVPZmZzZXRSZWN0KHBhZ2VFbGVtZW50LCBzY3JvbGxQYXJlbnQpO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VUb3AgPSBwYWdlT2Zmc2V0LnRvcDtcbiAgICAgICAgY29uc3QgcGFnZUhlaWdodCA9IE1hdGguZmxvb3IocGFnZUVsZW1lbnQuY2xpZW50SGVpZ2h0KTtcblxuICAgICAgICBjb25zdCBjb21wdXRlUGFnZW1hcmtIZWlnaHQgPSAoKTogbnVtYmVyID0+IHtcblxuICAgICAgICAgICAgY29uc3QgZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgICAgICAgICBpZiAoZG9jRm9ybWF0Lm5hbWUgPT09ICdwZGYnKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBwYWdlbWFya0JvdHRvbVxuICAgICAgICAgICAgICAgICAgICA9IE1hdGguZmxvb3IoUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdCh0YXJnZXRQYWdlbWFyay5wYWdlbWFyay5yZWN0KS5ib3R0b20pO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcGFnZW1hcmtCb3R0b21QZXJjID0gcGFnZW1hcmtCb3R0b20gLyAxMDA7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcGFnZUhlaWdodCAqIHBhZ2VtYXJrQm90dG9tUGVyYztcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHBhZ2VtYXJrRWxlbWVudHNcbiAgICAgICAgICAgICAgICAgICAgPSBBcnJheS5mcm9tKHBhZ2VFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIucGFnZW1hcmtcIikpO1xuXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIGJlIGJ5IHRpbWUgYW5kIG5vdCBieSBwb3NpdGlvbi5cbiAgICAgICAgICAgICAgICBjb25zdCBwYWdlbWFya0VsZW1lbnQgPVxuICAgICAgICAgICAgICAgICAgICBwYWdlbWFya0VsZW1lbnRzLnNvcnQoKGEsIGIpID0+IGEuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gYi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20pXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVkdWNlKFJlZHVjZXJzLkxBU1QpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VtYXJrRWxlbWVudCkge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGluIEhUTUwgbW9kZSBvciBQREZzIHdpdGggc21hbGxlclxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYWdlbWFya0VsZW1lbnQuY2xpZW50SGVpZ2h0O1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gcGFnZW1hcmtFbGVtZW50XCIpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbm93IGNvbXB1dGUgdGhlIGhlaWdodCBvZiB0aGUgcGFnZW1hcmsgc28gdGhhdCB3ZSBzY3JvbGwgdG8gdGhhdFxuICAgICAgICAvLyBwb2ludC5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtIZWlnaHQgPSBjb21wdXRlUGFnZW1hcmtIZWlnaHQoKTtcblxuICAgICAgICAvLyBidXQgYWRqdXN0IGl0IGEgYml0IHNvIHRoYXQgdGhlIGJvdHRvbSBwb3J0aW9uIG9mIHRoZSBwYWdlbWFyayBpc1xuICAgICAgICAvLyB2aXNpYmxlIGJ5IGNvbXB1dGluZyB0aGUgaGVpZ2h0IG9mIHRoZSB3aW5kb3cgYW5kIHNoaWZ0aW5nIGl0XG4gICAgICAgIGNvbnN0IHdpbmRvd0RlbHRhID0gd2luZG93LmlubmVySGVpZ2h0ICogKDAuMik7XG5cbiAgICAgICAgY29uc3QgbmV3U2Nyb2xsVG9wID0gcGFnZVRvcCArIHBhZ2VtYXJrSGVpZ2h0IC0gd2luZG93RGVsdGE7XG5cbiAgICAgICAgc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCA9IG5ld1Njcm9sbFRvcDtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldFNjcm9sbFBhcmVudChlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGNvbnN0IGRvY0Zvcm1hdCA9IERvY0Zvcm1hdEZhY3RvcnkuZ2V0SW5zdGFuY2UoKTtcblxuICAgICAgICBpZiAoZG9jRm9ybWF0Lm5hbWUgPT09ICdwZGYnKSB7XG4gICAgICAgICAgICByZXR1cm4gPEhUTUxFbGVtZW50PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3ZpZXdlckNvbnRhaW5lclwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkb2NGb3JtYXQubmFtZSA9PT0gJ2h0bWwnKSB7XG4gICAgICAgICAgICByZXR1cm4gPEhUTUxFbGVtZW50PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBvbGFyLXZpZXdlclwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAgPEhUTUxFbGVtZW50PiBFbGVtZW50cy5nZXRTY3JvbGxQYXJlbnQoZWxlbWVudCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBjb21wdXRlUGFnZW1hcmtzKGRvY01ldGE6IERvY01ldGEpIHtcblxuICAgICAgICBjb25zdCByZXN1bHQ6IFBhZ2VtYXJrSG9sZGVyW10gPSBbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IHBhZ2VNZXRhIG9mIE9iamVjdC52YWx1ZXMoZG9jTWV0YS5wYWdlTWV0YXMpKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VtYXJrcyA9IE9iamVjdC52YWx1ZXMocGFnZU1ldGEucGFnZW1hcmtzIHx8IHt9KTtcblxuICAgICAgICAgICAgY29uc3QgcGFnZW1hcmtIb2xkZXJzID1cbiAgICAgICAgICAgICAgICBwYWdlbWFya3MubWFwKCBwYWdlbWFyayA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlTnVtOiBwYWdlTWV0YS5wYWdlSW5mby5udW0sXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlbWFya1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXN1bHQucHVzaCguLi5wYWdlbWFya0hvbGRlcnMpO1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY29tcHV0ZVRhcmdldFBhZ2VtYXJrKGRvY01ldGE6IERvY01ldGEpOiBQYWdlbWFya0hvbGRlciB8IHVuZGVmaW5lZCB7XG5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtIb2xkZXJzID0gdGhpcy5jb21wdXRlUGFnZW1hcmtzKGRvY01ldGEpO1xuXG4gICAgICAgIGxldCByZXN1bHQ6IFBhZ2VtYXJrSG9sZGVyIHwgdW5kZWZpbmVkO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb21wYXJlIHR3byBwYWdlbWFya3MgYW5kIHJldHVybiB0aGUgb25lIHRoYXQgaXMgZmFydGhlc3QgZG93biB0aGVcbiAgICAgICAgICogcGFnZS5cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IGNvbXBhcmVQYWdlbWFya3MgPSAocDA6IFBhZ2VtYXJrSG9sZGVyIHwgdW5kZWZpbmVkLCBwMTogUGFnZW1hcmtIb2xkZXIpID0+IHtcblxuICAgICAgICAgICAgaWYgKCFwMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHAwLnBhZ2VOdW0gPCBwMS5wYWdlTnVtKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocDAucGFnZU51bSA9PT0gcDEucGFnZU51bSkge1xuXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIGJlIGJ5IHRpbWUgYW5kIG5vdCBieSBwb3NpdGlvbi5cblxuICAgICAgICAgICAgICAgIGlmIChSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHAwLnBhZ2VtYXJrLnJlY3QpLmJvdHRvbSA8XG4gICAgICAgICAgICAgICAgICAgIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QocDEucGFnZW1hcmsucmVjdCkuYm90dG9tKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAxO1xuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBwMDtcblxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFRPRE86IHRoaXMgY291bGQgYmUgY2xlYW5lciB2aWEgYSBzb3J0ICsgcmVkdWNlL2xhc3RcbiAgICAgICAgZm9yIChjb25zdCBwYWdlbWFya0hvbGRlciBvZiBwYWdlbWFya0hvbGRlcnMpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGNvbXBhcmVQYWdlbWFya3MocmVzdWx0LCBwYWdlbWFya0hvbGRlcik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBUYXJnZXRQYWdlbWFyayB7XG4gICAgcmVhZG9ubHkgcGFnZU51bTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgUGFnZW1hcmtIb2xkZXIge1xuICAgIHJlYWRvbmx5IHBhZ2VOdW06IG51bWJlcjtcbiAgICByZWFkb25seSBwYWdlbWFyazogUGFnZW1hcms7XG59XG5cbiJdfQ==