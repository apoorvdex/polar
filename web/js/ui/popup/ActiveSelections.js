"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("../../logger/Logger");
const Selections_1 = require("../../highlights/text/selection/Selections");
const Ranges_1 = require("../../highlights/text/selection/Ranges");
const log = Logger_1.Logger.create();
class ActiveSelections {
    static addEventListener(listener, target = document.body) {
        let originPoint;
        let activeSelection;
        let eventFired = 'none';
        const handleDestroyedSelection = () => {
            listener(Object.assign({}, activeSelection, { type: 'destroyed' }));
            activeSelection = undefined;
            eventFired = 'destroyed';
        };
        target.addEventListener('mousedown', (event) => {
            if (!activeSelection) {
                originPoint = this.eventToPoint(event);
            }
        });
        target.addEventListener('mouseup', (event) => {
            const handleMouseEvent = () => {
                let hasActiveTextSelection = false;
                eventFired = 'none';
                try {
                    const view = event.view;
                    const selection = view.getSelection();
                    hasActiveTextSelection = this.hasActiveTextSelection(selection);
                    const point = this.eventToPoint(event);
                    const element = this.targetElementForEvent(event);
                    if (!element) {
                        log.warn("No target element: ", event.target);
                        return;
                    }
                    if (activeSelection) {
                        handleDestroyedSelection();
                    }
                    if (hasActiveTextSelection) {
                        const mouseDirection = point.y - originPoint.y < 0 ? 'up' : 'down';
                        const range = selection.getRangeAt(0);
                        const boundingClientRect = range.getBoundingClientRect();
                        activeSelection = {
                            element,
                            originPoint: originPoint,
                            mouseDirection,
                            boundingClientRect,
                            selection,
                            view,
                            type: 'created'
                        };
                        listener(activeSelection);
                        eventFired = 'created';
                    }
                }
                finally {
                }
            };
            this.withTimeout(() => handleMouseEvent());
        });
    }
    static withTimeout(callback) {
        setTimeout(() => callback(), 1);
    }
    static targetElementForEvent(event) {
        if (event.target instanceof Node) {
            if (event.target instanceof HTMLElement) {
                return event.target;
            }
            else {
                return event.target.parentElement;
            }
        }
        else {
            log.warn("Event target is not node: ", event.target);
        }
        return undefined;
    }
    static hasActiveTextSelection(selection) {
        const ranges = Selections_1.Selections.toRanges(selection);
        for (const range of ranges) {
            if (Ranges_1.Ranges.hasText(range)) {
                return true;
            }
        }
        return false;
    }
    static eventToPoint(event) {
        return {
            x: event.offsetX,
            y: event.offsetY
        };
    }
}
exports.ActiveSelections = ActiveSelections;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWN0aXZlU2VsZWN0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFjdGl2ZVNlbGVjdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFJQSxnREFBMkM7QUFFM0MsMkVBQXNFO0FBQ3RFLG1FQUE4RDtBQUU5RCxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFLNUIsTUFBYSxnQkFBZ0I7SUFFbEIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQWlDLEVBQ2pDLFNBQXNCLFFBQVEsQ0FBQyxJQUFJO1FBRTlELElBQUksV0FBOEIsQ0FBQztRQUVuQyxJQUFJLGVBQTRDLENBQUM7UUFJakQsSUFBSSxVQUFVLEdBQWUsTUFBTSxDQUFDO1FBV3BDLE1BQU0sd0JBQXdCLEdBQUcsR0FBRyxFQUFFO1lBRWxDLFFBQVEsbUJBQU0sZUFBZ0IsSUFBRSxJQUFJLEVBQUUsV0FBVyxJQUFHLENBQUM7WUFDckQsZUFBZSxHQUFHLFNBQVMsQ0FBQztZQUU1QixVQUFVLEdBQUcsV0FBVyxDQUFDO1FBRTdCLENBQUMsQ0FBQztRQUVGLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFpQixFQUFFLEVBQUU7WUFFdkQsSUFBSSxDQUFDLGVBQWUsRUFBRTtnQkFDbEIsV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDMUM7UUFFTCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxLQUFpQixFQUFFLEVBQUU7WUFFckQsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLEVBQUU7Z0JBRTFCLElBQUksc0JBQXNCLEdBQVksS0FBSyxDQUFDO2dCQUM1QyxVQUFVLEdBQUcsTUFBTSxDQUFDO2dCQUVwQixJQUFJO29CQUVBLE1BQU0sSUFBSSxHQUFXLEtBQUssQ0FBQyxJQUFJLENBQUM7b0JBQ2hDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFFdEMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUVoRSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBRWxELElBQUksQ0FBRSxPQUFPLEVBQUU7d0JBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQzlDLE9BQU87cUJBQ1Y7b0JBRUQsSUFBSSxlQUFlLEVBQUU7d0JBQ2pCLHdCQUF3QixFQUFFLENBQUM7cUJBQzlCO29CQUVELElBQUksc0JBQXNCLEVBQUU7d0JBRXhCLE1BQU0sY0FBYyxHQUFtQixLQUFLLENBQUMsQ0FBQyxHQUFHLFdBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQzt3QkFFcEYsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFFdEMsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMscUJBQXFCLEVBQUUsQ0FBQzt3QkFFekQsZUFBZSxHQUFHOzRCQUNkLE9BQU87NEJBQ1AsV0FBVyxFQUFFLFdBQVk7NEJBQ3pCLGNBQWM7NEJBQ2Qsa0JBQWtCOzRCQUNsQixTQUFTOzRCQUNULElBQUk7NEJBQ0osSUFBSSxFQUFFLFNBQVM7eUJBQ2xCLENBQUM7d0JBRUYsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDO3dCQUUxQixVQUFVLEdBQUcsU0FBUyxDQUFDO3FCQUUxQjtpQkFFSjt3QkFBUztpQkFFVDtZQUVMLENBQUMsQ0FBQztZQUVGLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBRS9DLENBQUMsQ0FBQyxDQUFDO0lBK0JQLENBQUM7SUFRTyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQW9CO1FBQzNDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRU8sTUFBTSxDQUFDLHFCQUFxQixDQUFDLEtBQWlCO1FBRWxELElBQUksS0FBSyxDQUFDLE1BQU0sWUFBWSxJQUFJLEVBQUU7WUFFOUIsSUFBSSxLQUFLLENBQUMsTUFBTSxZQUFZLFdBQVcsRUFBRTtnQkFDckMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNILE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFjLENBQUM7YUFDdEM7U0FFSjthQUFNO1lBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEQ7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUVyQixDQUFDO0lBRU8sTUFBTSxDQUFDLHNCQUFzQixDQUFDLFNBQW9CO1FBRXRELE1BQU0sTUFBTSxHQUFHLHVCQUFVLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlDLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQ3hCLElBQUksZUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdkIsT0FBTyxJQUFJLENBQUM7YUFDZjtTQUNKO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFFakIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBaUI7UUFFekMsT0FBTztZQUNILENBQUMsRUFBRSxLQUFLLENBQUMsT0FBTztZQUNoQixDQUFDLEVBQUUsS0FBSyxDQUFDLE9BQU87U0FDbkIsQ0FBQztJQUVOLENBQUM7Q0FHSjtBQXRMRCw0Q0FzTEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1BvaW50fSBmcm9tICcuLi8uLi9Qb2ludCc7XG5pbXBvcnQge01vdXNlRGlyZWN0aW9ufSBmcm9tICcuL1BvcHVwJztcbmltcG9ydCB7U2ltdWxhdGV9IGZyb20gJ3JlYWN0LWRvbS90ZXN0LXV0aWxzJztcbmltcG9ydCBtb3VzZU1vdmUgPSBTaW11bGF0ZS5tb3VzZU1vdmU7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAnLi4vLi4vbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge2lzUHJlc2VudH0gZnJvbSAnLi4vLi4vUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1NlbGVjdGlvbnN9IGZyb20gJy4uLy4uL2hpZ2hsaWdodHMvdGV4dC9zZWxlY3Rpb24vU2VsZWN0aW9ucyc7XG5pbXBvcnQge1Jhbmdlc30gZnJvbSAnLi4vLi4vaGlnaGxpZ2h0cy90ZXh0L3NlbGVjdGlvbi9SYW5nZXMnO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbi8qKlxuICogTGlzdGVucyBmb3Igd2hlbiBhIG5ldyB0ZXh0IHNlbGVjdGlvbiBoYXMgYmVlbiBjcmVhdGVkXG4gKi9cbmV4cG9ydCBjbGFzcyBBY3RpdmVTZWxlY3Rpb25zIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgYWRkRXZlbnRMaXN0ZW5lcihsaXN0ZW5lcjogQWN0aXZlU2VsZWN0aW9uTGlzdGVuZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogSFRNTEVsZW1lbnQgPSBkb2N1bWVudC5ib2R5KTogdm9pZCB7XG5cbiAgICAgICAgbGV0IG9yaWdpblBvaW50OiBQb2ludCB8IHVuZGVmaW5lZDtcblxuICAgICAgICBsZXQgYWN0aXZlU2VsZWN0aW9uOiBBY3RpdmVTZWxlY3Rpb24gfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgdHlwZSBFdmVudEZpcmVkID0gJ25vbmUnIHwgJ2NyZWF0ZWQnIHwgJ2Rlc3Ryb3llZCc7XG5cbiAgICAgICAgbGV0IGV2ZW50RmlyZWQ6IEV2ZW50RmlyZWQgPSAnbm9uZSc7XG5cbiAgICAgICAgLy8gVE9ETzogdGhpcyBjb2RlIGhhcyB0aGUgZm9sbG93aW5nIGtub3duIGlzc3VlczpcbiAgICAgICAgLy9cbiAgICAgICAgLy8gLSB3aGVuIGxlYXZpbmcgYW5kIHJlZW50ZXJpbmcgdGhlIHRhcmdldCBhbmQgcmVsZWFzaW5nIHRoZSBtb3VzZVxuICAgICAgICAvLyAgIHdlIGRvbid0IGRldGVjdCB0aGlzIGFuZCBkb24ndCBicmluZyB1cCB0aGUgc2VsZWN0aW9uIHdoZW4gdGhlIG1vdXNlXG4gICAgICAgIC8vICAgZW50ZXJzIGFnYWluLiAgSSB0aGluayB0aGlzIGNvdWxkIGJlIG1pdGlnYXRlZFxuICAgICAgICAvL1xuICAgICAgICAvLyAtIGlmIHdlIGNsaWNrIG91dHNpZGUgb2YgdGhlIG1haW4gaWZyYW1lIHRoZW4gd2UgZG9uJ3QgZ2V0IHRoZSBmb2xsb3dcbiAgICAgICAgLy8gICBvbiBldmVudHMuXG5cbiAgICAgICAgY29uc3QgaGFuZGxlRGVzdHJveWVkU2VsZWN0aW9uID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBsaXN0ZW5lcih7IC4uLmFjdGl2ZVNlbGVjdGlvbiEsIHR5cGU6ICdkZXN0cm95ZWQnIH0pO1xuICAgICAgICAgICAgYWN0aXZlU2VsZWN0aW9uID0gdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICBldmVudEZpcmVkID0gJ2Rlc3Ryb3llZCc7XG5cbiAgICAgICAgfTtcblxuICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG5cbiAgICAgICAgICAgIGlmICghYWN0aXZlU2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgb3JpZ2luUG9pbnQgPSB0aGlzLmV2ZW50VG9Qb2ludChldmVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgaGFuZGxlTW91c2VFdmVudCA9ICgpID0+IHtcblxuICAgICAgICAgICAgICAgIGxldCBoYXNBY3RpdmVUZXh0U2VsZWN0aW9uOiBib29sZWFuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZXZlbnRGaXJlZCA9ICdub25lJztcblxuICAgICAgICAgICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmlldzogV2luZG93ID0gZXZlbnQudmlldztcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gdmlldy5nZXRTZWxlY3Rpb24oKTtcblxuICAgICAgICAgICAgICAgICAgICBoYXNBY3RpdmVUZXh0U2VsZWN0aW9uID0gdGhpcy5oYXNBY3RpdmVUZXh0U2VsZWN0aW9uKHNlbGVjdGlvbik7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSB0aGlzLmV2ZW50VG9Qb2ludChldmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLnRhcmdldEVsZW1lbnRGb3JFdmVudChldmVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCEgZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9nLndhcm4oXCJObyB0YXJnZXQgZWxlbWVudDogXCIsIGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZlU2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVEZXN0cm95ZWRTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNBY3RpdmVUZXh0U2VsZWN0aW9uKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vdXNlRGlyZWN0aW9uOiBNb3VzZURpcmVjdGlvbiA9IHBvaW50LnkgLSBvcmlnaW5Qb2ludCEueSA8IDAgPyAndXAnIDogJ2Rvd24nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBib3VuZGluZ0NsaWVudFJlY3QgPSByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luUG9pbnQ6IG9yaWdpblBvaW50ISxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZURpcmVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3VuZGluZ0NsaWVudFJlY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NyZWF0ZWQnXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcihhY3RpdmVTZWxlY3Rpb24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudEZpcmVkID0gJ2NyZWF0ZWQnO1xuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBtb3VzZXVwOiBoYXNBY3RpdmVUZXh0U2VsZWN0aW9uOiAke2hhc0FjdGl2ZVRleHRTZWxlY3Rpb259LCBldmVudEZpcmVkOiAke2V2ZW50RmlyZWR9YCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLndpdGhUaW1lb3V0KCgpID0+IGhhbmRsZU1vdXNlRXZlbnQoKSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVE9ETzogSSBwbGF5ZWQgd2l0aCBjbG9zaW5nIHRoZSBhbm5vdGF0aW9uIGJhciBvbiByaWdodCBjbGljayBidXRcbiAgICAgICAgLy8gaXQgd2FzIGRpZmZpY3VsdCB0byBzZXR1cC4gSXQgaGFkIHRoZSBmb2xsb3dpbmcgcHJvYmxlbXM6XG4gICAgICAgIC8vXG4gICAgICAgIC8vXG4gICAgICAgIC8vIDEuIFdoZW4gdGhlIHNlbGVjdGlvbiB3YXMgYWN0aXZlLCBhbmQgd2UgcmlnaHQgY2xpY2ssIHRoZSBzZWxlY3Rpb25cbiAgICAgICAgLy8gICAgZG9lcyBub3QgZ28gYXdheS4gIFdoaWNoIG1lYW5zIHRoYXQgdGhlIGFubm90YXRpb24gYmFyIHNob3VsZCBzdGlsbFxuICAgICAgICAvLyAgICBiZSB1cC5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gMi4gVGhlcmUgd2FzIGluY29uc2lzdGVudCBiZWhhdmlvci4gIElmIHdlIHJpZ2h0IGNsaWNrIHRoZW4gdGhlXG4gICAgICAgIC8vICAgIHNlbGVjdGlvbiBnb2VzIGF3YXkgaWYgd2UgY2xpY2sgb3V0c2lkZSBidXQgc3RheXMgaWYgd2UgY2xpY2sgaW5zaWRlXG4gICAgICAgIC8vICAgIHRoZSBzZWxlY3Rpb24uXG4gICAgICAgIC8vXG4gICAgICAgIC8vICAzLiBUaGlzIGlzbid0IGEgTUFTU0lWRSBwcm9ibGVtIHNvIHByb2JhYmx5IHNob3VsZG4ndCBzcGVuZCBtdWNoIHRpbWVcbiAgICAgICAgLy8gICAgb24gaXQuXG5cbiAgICAgICAgLy8gdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgIC8vXG4gICAgICAgIC8vICAgICBjb25zdCBoYW5kbGVNb3VzZUV2ZW50ID0gKCkgPT4ge1xuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgICAgIGlmIChhY3RpdmVTZWxlY3Rpb24pIHtcbiAgICAgICAgLy8gICAgICAgICAgICAgaGFuZGxlRGVzdHJveWVkU2VsZWN0aW9uKCk7XG4gICAgICAgIC8vICAgICAgICAgfVxuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgfTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gICAgIHRoaXMud2l0aFRpbWVvdXQoKCkgPT4gaGFuZGxlTW91c2VFdmVudCgpKTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gfSk7XG5cbiAgICB9XG5cbiAgICAvLyBuZWVkcyB0byBiZSBjYWxsZWQgdmlhIHNldFRpbWVvdXQgYmVjdWFzZSBpZiB3ZSBjbGljayAnb24nIHRoZVxuICAgIC8vIHNlbGVjdGlvbiB0aGVyZSdzIGEgYnVnIHdoZXJlIHRoZSBzZWxlY3Rpb24gaXMgc3RpbGwgcHJlc2VudCBhbmRcbiAgICAvLyBpc24ndCByZW1vdmVkLiAgQWxsb3dpbmcgdGhlIGV2ZW50IHRvIGNvbXBsZXRlIGJ5IHRha2luZyB0aGlzXG4gICAgLy8gZXZlbnQgaGFuZGxlciBhbmQgcHVzaGluZyBpdCBvbiB0aGUgZXZlbnQgcXVldWUgYWxsb3dzIHRoZVxuICAgIC8vIHNlbGVjdGlvbiB0byBiZSByZW1vdmVkIGJ5IHRoZSBkZWZhdWx0IGhhbmRsZXIgb25jZSBpdCBidWJibGVzXG4gICAgLy8gdXAuXG4gICAgcHJpdmF0ZSBzdGF0aWMgd2l0aFRpbWVvdXQoY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjYWxsYmFjaygpLCAxKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyB0YXJnZXRFbGVtZW50Rm9yRXZlbnQoZXZlbnQ6IE1vdXNlRXZlbnQpOiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZCB7XG5cbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCBpbnN0YW5jZW9mIE5vZGUpIHtcblxuICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldC5wYXJlbnRFbGVtZW50ITtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLndhcm4oXCJFdmVudCB0YXJnZXQgaXMgbm90IG5vZGU6IFwiLCBldmVudC50YXJnZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGhhc0FjdGl2ZVRleHRTZWxlY3Rpb24oc2VsZWN0aW9uOiBTZWxlY3Rpb24pIHtcblxuICAgICAgICBjb25zdCByYW5nZXMgPSBTZWxlY3Rpb25zLnRvUmFuZ2VzKHNlbGVjdGlvbik7XG5cbiAgICAgICAgZm9yIChjb25zdCByYW5nZSBvZiByYW5nZXMpIHtcbiAgICAgICAgICAgIGlmIChSYW5nZXMuaGFzVGV4dChyYW5nZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGV2ZW50VG9Qb2ludChldmVudDogTW91c2VFdmVudCkge1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB4OiBldmVudC5vZmZzZXRYLFxuICAgICAgICAgICAgeTogZXZlbnQub2Zmc2V0WVxuICAgICAgICB9O1xuXG4gICAgfVxuXG5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBBY3RpdmVTZWxlY3Rpb25MaXN0ZW5lciB7XG4gICAgLy8gbm9pbnNwZWN0aW9uIFRzTGludFxuICAgIChldmVudDogQWN0aXZlU2VsZWN0aW9uRXZlbnQpOiB2b2lkO1xufVxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aXZlU2VsZWN0aW9uIHtcblxuICAgIHJlYWRvbmx5IGVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICAgIHJlYWRvbmx5IG9yaWdpblBvaW50OiBQb2ludDtcbiAgICByZWFkb25seSBtb3VzZURpcmVjdGlvbjogTW91c2VEaXJlY3Rpb247XG4gICAgcmVhZG9ubHkgYm91bmRpbmdDbGllbnRSZWN0OiBDbGllbnRSZWN0IHwgRE9NUmVjdDtcblxuICAgIC8qKlxuICAgICAqIFRoZSBhY3R1YWwgc2VsZWN0aW9uIG9iamVjdCB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aC5cbiAgICAgKi9cbiAgICByZWFkb25seSBzZWxlY3Rpb246IFNlbGVjdGlvbjtcblxuICAgIHJlYWRvbmx5IHZpZXc6IFdpbmRvdztcblxuICAgIHJlYWRvbmx5IHR5cGU6IEFjdGl2ZVNlbGVjdGlvblR5cGU7XG5cbn1cblxuZXhwb3J0IHR5cGUgQWN0aXZlU2VsZWN0aW9uVHlwZSA9ICdjcmVhdGVkJyB8ICdkZXN0cm95ZWQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGl2ZVNlbGVjdGlvbkV2ZW50IGV4dGVuZHMgQWN0aXZlU2VsZWN0aW9uIHtcblxufVxuIl19