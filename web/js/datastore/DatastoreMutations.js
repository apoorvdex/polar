"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const DatastoreMutation_1 = require("./DatastoreMutation");
class DatastoreMutations {
    constructor(consistency) {
        this.consistency = consistency;
    }
    static create(consistency) {
        return new DatastoreMutations(consistency);
    }
    batched(dm0, dm1, target) {
        this.batchPromises(dm0.written.get(), dm1.written.get(), target.written);
        if (this.consistency === 'committed') {
            this.batchPromises(dm0.committed.get(), dm1.committed.get(), target.committed);
        }
    }
    handle(promise, target, converter) {
        promise.then((result) => {
            try {
                target.written.resolve(converter(result));
                target.committed.resolve(converter(result));
            }
            catch (err) {
                console.error("Unable to resolve: ", err);
            }
        }).catch(err => {
            try {
                target.written.reject(err);
                target.committed.reject(err);
            }
            catch (err) {
                console.error("Unable to reject: ", err);
            }
        });
    }
    pipe(source, target, converter) {
        this.pipeLatch(source.written, target.written, converter);
        this.pipeLatch(source.committed, target.committed, converter);
    }
    executeBatchedWrite(datastoreMutation, remoteSync, localSync, remoteCoordinator = new DatastoreMutation_1.DefaultDatastoreMutation(), localCoordinator = new DatastoreMutation_1.DefaultDatastoreMutation()) {
        return __awaiter(this, void 0, void 0, function* () {
            return new Promise((resolve, reject) => {
                remoteSync(remoteCoordinator)
                    .catch((err) => reject(err));
                remoteCoordinator.written.get()
                    .then(() => {
                    localSync(localCoordinator)
                        .catch(err => reject(err));
                })
                    .catch((err) => reject(err));
                this.batched(remoteCoordinator, localCoordinator, datastoreMutation);
                if (this.consistency === 'committed') {
                    datastoreMutation.committed.get()
                        .then(() => resolve())
                        .catch((err) => reject(err));
                }
                else {
                    datastoreMutation.written.get()
                        .then(() => resolve())
                        .catch((err) => reject(err));
                }
            });
        });
    }
    pipeLatch(source, target, converter) {
        source.get()
            .then((value) => target.resolve(converter(value)))
            .catch(err => target.reject(err));
    }
    batchPromises(promise0, promise1, latch) {
        const batch = Promise.all([promise0, promise1]);
        batch.then((result) => {
            latch.resolve(result[0]);
        }).catch(err => {
            latch.reject(err);
        });
    }
}
exports.DatastoreMutations = DatastoreMutations;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YXN0b3JlTXV0YXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRGF0YXN0b3JlTXV0YXRpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFDQSwyREFBZ0Y7QUFHaEYsTUFBYSxrQkFBa0I7SUFJM0IsWUFBb0IsV0FBaUM7UUFDakQsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDbkMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBaUM7UUFDbEQsT0FBTyxJQUFJLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTSxPQUFPLENBQUksR0FBeUIsRUFBRSxHQUF5QixFQUFFLE1BQTRCO1FBRWhHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV6RSxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssV0FBVyxFQUFFO1lBQ2xDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsRjtJQUVMLENBQUM7SUFFTSxNQUFNLENBQU8sT0FBbUIsRUFBRSxNQUE0QixFQUFFLFNBQTBCO1FBRTdGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUVwQixJQUFJO2dCQUVBLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUMxQyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzthQUUvQztZQUFDLE9BQU8s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QUFDO0lBRU8sYUFBYSxDQUFJLFFBQW9CLEVBQUUsUUFBb0IsRUFBRSxLQUFlO1FBRWhGLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUVoRCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDbEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDWCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQztDQUVKO0FBdkpELGdEQXVKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TGF0Y2h9IGZyb20gJy4uL3V0aWwvTGF0Y2gnO1xuaW1wb3J0IHtEYXRhc3RvcmVNdXRhdGlvbiwgRGVmYXVsdERhdGFzdG9yZU11dGF0aW9ufSBmcm9tICcuL0RhdGFzdG9yZU11dGF0aW9uJztcbmltcG9ydCB7RGF0YXN0b3JlQ29uc2lzdGVuY3l9IGZyb20gJy4vRGF0YXN0b3JlJztcblxuZXhwb3J0IGNsYXNzIERhdGFzdG9yZU11dGF0aW9ucyB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnNpc3RlbmN5OiBEYXRhc3RvcmVDb25zaXN0ZW5jeTtcblxuICAgIHByaXZhdGUgY29uc3RydWN0b3IoY29uc2lzdGVuY3k6IERhdGFzdG9yZUNvbnNpc3RlbmN5KSB7XG4gICAgICAgIHRoaXMuY29uc2lzdGVuY3kgPSBjb25zaXN0ZW5jeTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZShjb25zaXN0ZW5jeTogRGF0YXN0b3JlQ29uc2lzdGVuY3kpOiBEYXRhc3RvcmVNdXRhdGlvbnMge1xuICAgICAgICByZXR1cm4gbmV3IERhdGFzdG9yZU11dGF0aW9ucyhjb25zaXN0ZW5jeSk7XG4gICAgfVxuXG4gICAgcHVibGljIGJhdGNoZWQ8VD4oZG0wOiBEYXRhc3RvcmVNdXRhdGlvbjxUPiwgZG0xOiBEYXRhc3RvcmVNdXRhdGlvbjxUPiwgdGFyZ2V0OiBEYXRhc3RvcmVNdXRhdGlvbjxUPiApIHtcblxuICAgICAgICB0aGlzLmJhdGNoUHJvbWlzZXMoZG0wLndyaXR0ZW4uZ2V0KCksIGRtMS53cml0dGVuLmdldCgpLCB0YXJnZXQud3JpdHRlbik7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uc2lzdGVuY3kgPT09ICdjb21taXR0ZWQnKSB7XG4gICAgICAgICAgICB0aGlzLmJhdGNoUHJvbWlzZXMoZG0wLmNvbW1pdHRlZC5nZXQoKSwgZG0xLmNvbW1pdHRlZC5nZXQoKSwgdGFyZ2V0LmNvbW1pdHRlZCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBoYW5kbGU8ViwgVD4ocHJvbWlzZTogUHJvbWlzZTxWPiwgdGFyZ2V0OiBEYXRhc3RvcmVNdXRhdGlvbjxUPiwgY29udmVydGVyOiAoaW5wdXQ6IFYpID0+IFQpOiB2b2lkIHtcblxuICAgICAgICBwcm9taXNlLnRoZW4oKHJlc3VsdCkgPT4ge1xuXG4gICAgICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICAgICAgdGFyZ2V0LndyaXR0ZW4ucmVzb2x2ZShjb252ZXJ0ZXIocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LmNvbW1pdHRlZC5yZXNvbHZlKGNvbnZlcnRlcihyZXN1bHQpKTtcblxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlVuYWJsZSB0byByZXNvbHZlOiBcIiwgZXJyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuXG4gICAgICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICAgICAgdGFyZ2V0LndyaXR0ZW4ucmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LmNvbW1pdHRlZC5yZWplY3QoZXJyKTtcblxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlVuYWJsZSB0byByZWplY3Q6IFwiLCBlcnIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGlwZSB0aGUgcmVzb2x2ZSBhbmQgcmVqZWN0IHN0YXR1cyBvZiB0aGUgbGF0Y2hlcyB0byB0aGUgdGFyZ2V0LlxuICAgICAqL1xuICAgIHB1YmxpYyBwaXBlPFQsIFY+KHNvdXJjZTogRGF0YXN0b3JlTXV0YXRpb248VD4sXG4gICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBEYXRhc3RvcmVNdXRhdGlvbjxWPixcbiAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZXI6IChpbnB1dDogVCkgPT4gVik6IHZvaWQge1xuXG4gICAgICAgIHRoaXMucGlwZUxhdGNoKHNvdXJjZS53cml0dGVuLCB0YXJnZXQud3JpdHRlbiwgY29udmVydGVyKTtcbiAgICAgICAgdGhpcy5waXBlTGF0Y2goc291cmNlLmNvbW1pdHRlZCwgdGFyZ2V0LmNvbW1pdHRlZCwgY29udmVydGVyKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gYSB3cml0ZSB3aGlsZSBjb29yZGluYXRpbmcgdGhlIHJlbW90ZSBhbmQgbG9jYWwgd3JpdGVzLlxuICAgICAqXG4gICAgICogVGhlIHJlbW90ZSBvcGVyYXRpb24gZXhlY3V0ZXMgYW5kIGNvbXBsZXRlcyB3cml0dGVuIG9uY2UgaXQncyB3cml0dGVuXG4gICAgICogbG9jYWxseSBidXQgcG90ZW50aWFsbHkgc3RpbGwgdW5zYWZlIGFzIGl0J3Mgbm90ICdjb21taXR0ZWQnLiAgT25jZSBpdCdzXG4gICAgICogY29tbWl0dGVkIGxvY2FsbHkgKGFuZCBzYWZlKSB0aGVuIHdlIGNhbiBwZXJmb3JtIHRoZSBsb2NhbCBvcGVyYXRpb25cbiAgICAgKiB3aGljaCBpcyBhbHNvIGF0b21pYyAoYW5kIHNhZmUpLlxuICAgICAqXG4gICAgICogVGhlbiB3ZSBwZXJmb3JtIEJPVEggYmF0Y2hlZCBvcGVyYXRpb25zIGFuZCBtYWtlIHN1cmUgdGhleSdyZSBhbGwgYm90aFxuICAgICAqIHdyaXR0ZW4gYW5kIGNvbW1pdHRlZCBiZWZvcmUgcmV0dXJuaW5nLlxuICAgICAqXG4gICAgICogVGhlIGNhbGxlciBET0VTIE5PVCBuZWVkIHRvIHdhaXQgZm9yIHRoZSBwcm9taXNlIHRvIGNvbXBsZXRlLiAgSXQgY291bGRcbiAgICAgKiBwdXQgdGhlbSBpbnRvIHF1ZXVlcyBvciBqdXN0IGxvb2sgYXQgdGhlIHdyaXR0ZW4gYW5kIGNvbW1pdHRlZCB2YWx1ZXNcbiAgICAgKiBvbiB0aGUgZGF0YXN0b3JlTXV0YXRpb24gYXMgaXQncyBtb3ZpbmcgZm9yd2FyZC4gIFRoaXMgYWxsb3dzIHVzIHRvXG4gICAgICogaGF2ZSBhIHByb2dyZXNzIGJhciBpbnRlZ3JhdGVkIHNob3dpbmcgdGhhdCB0aGUgc3luYyBvcGVyYXRpb25zIGFyZW4ndFxuICAgICAqIGNvbXBsZXRlZCB5ZXQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVtb3RlQ29vcmRpbmF0b3JcbiAgICAgKiBAcGFyYW0gbG9jYWxDb29yZGluYXRvclxuICAgICAqIEBwYXJhbSBkYXRhc3RvcmVNdXRhdGlvblxuICAgICAqIEBwYXJhbSByZW1vdGVTeW5jXG4gICAgICogQHBhcmFtIGxvY2FsU3luY1xuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQmF0Y2hlZFdyaXRlPFQ+KGRhdGFzdG9yZU11dGF0aW9uOiBEYXRhc3RvcmVNdXRhdGlvbjxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVTeW5jOiAocmVtb3RlQ29vcmRpbmF0b3I6IERhdGFzdG9yZU11dGF0aW9uPFQ+KSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3luYzogKGxvY2FsQ29vcmRpbmF0b3I6IERhdGFzdG9yZU11dGF0aW9uPFQ+KSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZUNvb3JkaW5hdG9yOiBEYXRhc3RvcmVNdXRhdGlvbjxUPiA9IG5ldyBEZWZhdWx0RGF0YXN0b3JlTXV0YXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbENvb3JkaW5hdG9yOiBEYXRhc3RvcmVNdXRhdGlvbjxUPiA9IG5ldyBEZWZhdWx0RGF0YXN0b3JlTXV0YXRpb24oKSk6IFByb21pc2U8dm9pZD4ge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIHJlbW90ZVN5bmMocmVtb3RlQ29vcmRpbmF0b3IpXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcblxuICAgICAgICAgICAgcmVtb3RlQ29vcmRpbmF0b3Iud3JpdHRlbi5nZXQoKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICBsb2NhbFN5bmMobG9jYWxDb29yZGluYXRvcilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xuXG4gICAgICAgICAgICB0aGlzLmJhdGNoZWQocmVtb3RlQ29vcmRpbmF0b3IsIGxvY2FsQ29vcmRpbmF0b3IsIGRhdGFzdG9yZU11dGF0aW9uKTtcblxuICAgICAgICAgICAgLy8gb25seSByZXR1cm4gb25jZSB0aGUgcmVtb3RlIGFuZCBsb2NhbCBwcm9taXNlcyAvIG9wZXJhdGlvbnMgaGF2ZVxuICAgICAgICAgICAgLy8gYmVlbiBjb21wbGV0ZWQuLi5cblxuICAgICAgICAgICAgaWYgKHRoaXMuY29uc2lzdGVuY3kgPT09ICdjb21taXR0ZWQnKSB7XG5cbiAgICAgICAgICAgICAgICBkYXRhc3RvcmVNdXRhdGlvbi5jb21taXR0ZWQuZ2V0KClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgZGF0YXN0b3JlTXV0YXRpb24ud3JpdHRlbi5nZXQoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiByZXNvbHZlKCkpXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcblxuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBwaXBlTGF0Y2g8VCwgVj4oc291cmNlOiBMYXRjaDxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IExhdGNoPFY+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRlcjogKGlucHV0OiBUKSA9PiBWKTogdm9pZCB7XG5cbiAgICAgICAgc291cmNlLmdldCgpXG4gICAgICAgICAgICAudGhlbigodmFsdWU6IFQpID0+IHRhcmdldC5yZXNvbHZlKGNvbnZlcnRlcih2YWx1ZSkpKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0YXJnZXQucmVqZWN0KGVycikpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBiYXRjaFByb21pc2VzPFQ+KHByb21pc2UwOiBQcm9taXNlPFQ+LCBwcm9taXNlMTogUHJvbWlzZTxUPiwgbGF0Y2g6IExhdGNoPFQ+KTogdm9pZCB7XG5cbiAgICAgICAgY29uc3QgYmF0Y2ggPSBQcm9taXNlLmFsbChbcHJvbWlzZTAsIHByb21pc2UxXSk7XG5cbiAgICAgICAgYmF0Y2gudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBsYXRjaC5yZXNvbHZlKHJlc3VsdFswXSk7XG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBsYXRjaC5yZWplY3QoZXJyKTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cbiJdfQ==