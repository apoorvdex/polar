"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const DocMetaRef_1 = require("./DocMetaRef");
const Backend_1 = require("./Backend");
const DatastoreMutation_1 = require("./DatastoreMutation");
const AsyncWorkQueues_1 = require("../util/AsyncWorkQueues");
const DocMetas_1 = require("../metadata/DocMetas");
const DatastoreMutations_1 = require("./DatastoreMutations");
class AbstractDatastore {
    constructor() {
        this.datastoreMutations = DatastoreMutations_1.DatastoreMutations.create('written');
    }
    writeDocMeta(docMeta, datastoreMutation = new DatastoreMutation_1.DefaultDatastoreMutation()) {
        return __awaiter(this, void 0, void 0, function* () {
            const data = DocMetas_1.DocMetas.serialize(docMeta);
            const docInfo = docMeta.docInfo;
            const syncMutation = new DatastoreMutation_1.DefaultDatastoreMutation();
            this.datastoreMutations.pipe(syncMutation, datastoreMutation, () => docInfo);
            yield this.write(docMeta.docInfo.fingerprint, data, docInfo, syncMutation);
            return docInfo;
        });
    }
    synchronizeDocs(...docMetaRefs) {
        return __awaiter(this, void 0, void 0, function* () {
        });
    }
    deactivate() {
        return __awaiter(this, void 0, void 0, function* () {
        });
    }
    createBackup() {
        return __awaiter(this, void 0, void 0, function* () {
        });
    }
}
exports.AbstractDatastore = AbstractDatastore;
class DocMetaSnapshotEvents {
    static format(ev) {
        let batch = "NO BATCH";
        if (ev.batch) {
            batch = `(id: ${ev.batch.id}, terminated: ${ev.batch.terminated})`;
        }
        const progress = ev.progress.progress;
        const nrMutations = ev.docMetaMutations.length;
        return `${ev.datastore} ${progress}% (consistency: ${ev.consistency}, nr mutations: ${nrMutations}, batch: ${batch})`;
    }
    static toDocInfos(docMetaSnapshotEvent) {
        return __awaiter(this, void 0, void 0, function* () {
            return AsyncWorkQueues_1.AsyncWorkQueues
                .awaitPromises(docMetaSnapshotEvent.docMetaMutations.map(current => current.docInfoProvider()));
        });
    }
    static toSyncDocs(docMetaSnapshotEvent) {
        return __awaiter(this, void 0, void 0, function* () {
            const promises = docMetaSnapshotEvent.docMetaMutations.map(docMetaMutation => {
                return () => __awaiter(this, void 0, void 0, function* () {
                    const docInfo = yield docMetaMutation.docInfoProvider();
                    return SyncDocs.fromDocInfo(docInfo, docMetaMutation.mutationType);
                });
            }).map(current => current());
            return yield AsyncWorkQueues_1.AsyncWorkQueues.awaitPromises(promises);
        });
    }
}
exports.DocMetaSnapshotEvents = DocMetaSnapshotEvents;
class SyncDocMaps {
    static putAll(syncDocMap, syncDocs) {
        for (const syncDoc of syncDocs) {
            syncDocMap[syncDoc.fingerprint] = syncDoc;
        }
    }
    static fromArray(syncDocs) {
        const result = {};
        for (const syncDoc of syncDocs) {
            result[syncDoc.fingerprint] = syncDoc;
        }
        return result;
    }
}
exports.SyncDocMaps = SyncDocMaps;
class SyncDocs {
    static fromDocInfo(docInfo, mutationType) {
        const files = [];
        if (docInfo.filename) {
            const stashFile = {
                backend: Backend_1.Backend.STASH,
                ref: {
                    name: docInfo.filename,
                    hashcode: docInfo.hashcode
                }
            };
            files.push(stashFile);
        }
        return {
            fingerprint: docInfo.fingerprint,
            docMetaFileRef: DocMetaRef_1.DocMetaFileRefs.createFromDocInfo(docInfo),
            mutationType,
            uuid: docInfo.uuid,
            files
        };
    }
}
exports.SyncDocs = SyncDocs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRGF0YXN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFDQSw2Q0FBeUU7QUFHekUsdUNBQWtDO0FBTWxDLDJEQUFnRjtBQU1oRiw2REFBd0Q7QUFDeEQsbURBQThDO0FBQzlDLDZEQUF3RDtBQThHeEQsTUFBc0IsaUJBQWlCO0lBSW5DO1FBQ0ksSUFBSSxDQUFDLGtCQUFrQixHQUFHLHVDQUFrQixDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUVuRSxDQUFDO0lBQ1ksWUFBWSxDQUFDLE9BQWdCLEVBQ2hCLG9CQUFnRCxJQUFJLDRDQUF3QixFQUFFOztZQUVwRyxNQUFNLElBQUksR0FBRyxtQkFBUSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN6QyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1lBRWhDLE1BQU0sWUFBWSxHQUFHLElBQUksNENBQXdCLEVBQVcsQ0FBQztZQUM3RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxpQkFBaUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUU3RSxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQztZQUMzRSxPQUFPLE9BQU8sQ0FBQztRQUVuQixDQUFDO0tBQUE7SUFPWSxlQUFlLENBQUMsR0FBRyxXQUF5Qjs7UUFFekQsQ0FBQztLQUFBO0lBRVksVUFBVTs7UUFFdkIsQ0FBQztLQUFBO0lBRVksWUFBWTs7UUFNekIsQ0FBQztLQUFBO0NBRUo7QUEzQ0QsOENBMkNDO0FBdUxELE1BQWEscUJBQXFCO0lBRXZCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBd0I7UUFFekMsSUFBSSxLQUFLLEdBQUcsVUFBVSxDQUFD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dGVudCI6WyIvLyBBIGRhdGFzdG9yZSB0aGF0IHN1cHBvcnRzIGxlZGdlcnMgYW5kIGNoZWNrcG9pbnRzLlxuaW1wb3J0IHtEb2NNZXRhRmlsZVJlZiwgRG9jTWV0YUZpbGVSZWZzLCBEb2NNZXRhUmVmfSBmcm9tICcuL0RvY01ldGFSZWYnO1xuaW1wb3J0IHtEZWxldGVSZXN1bHR9IGZyb20gJy4vRGF0YXN0b3JlJztcbmltcG9ydCB7RGlyZWN0b3JpZXN9IGZyb20gJy4vRGlyZWN0b3JpZXMnO1xuaW1wb3J0IHtCYWNrZW5kfSBmcm9tICcuL0JhY2tlbmQnO1xuaW1wb3J0IHtEb2NGaWxlTWV0YX0gZnJvbSAnLi9Eb2NGaWxlTWV0YSc7XG5pbXBvcnQge09wdGlvbmFsfSBmcm9tICcuLi91dGlsL3RzL09wdGlvbmFsJztcbmltcG9ydCB7RG9jSW5mbywgSURvY0luZm99IGZyb20gJy4uL21ldGFkYXRhL0RvY0luZm8nO1xuaW1wb3J0IHtGaWxlSGFuZGxlfSBmcm9tICcuLi91dGlsL0ZpbGVzJztcbmltcG9ydCB7U2ltdWxhdGV9IGZyb20gJ3JlYWN0LWRvbS90ZXN0LXV0aWxzJztcbmltcG9ydCB7RGF0YXN0b3JlTXV0YXRpb24sIERlZmF1bHREYXRhc3RvcmVNdXRhdGlvbn0gZnJvbSAnLi9EYXRhc3RvcmVNdXRhdGlvbic7XG5pbXBvcnQge0RvY01ldGF9IGZyb20gJy4uL21ldGFkYXRhL0RvY01ldGEnO1xuaW1wb3J0IHtIYXNoY29kZX0gZnJvbSAnLi4vbWV0YWRhdGEvSGFzaGNvZGUnO1xuaW1wb3J0IHtQcm9ncmVzc30gZnJvbSAnLi4vdXRpbC9Qcm9ncmVzc1RyYWNrZXInO1xuaW1wb3J0IHtBc3luY1Byb3ZpZGVyfSBmcm9tICcuLi91dGlsL1Byb3ZpZGVycyc7XG5pbXBvcnQge1VVSUR9IGZyb20gJy4uL21ldGFkYXRhL1VVSUQnO1xuaW1wb3J0IHtBc3luY1dvcmtRdWV1ZXN9IGZyb20gJy4uL3V0aWwvQXN5bmNXb3JrUXVldWVzJztcbmltcG9ydCB7RG9jTWV0YXN9IGZyb20gJy4uL21ldGFkYXRhL0RvY01ldGFzJztcbmltcG9ydCB7RGF0YXN0b3JlTXV0YXRpb25zfSBmcm9tICcuL0RhdGFzdG9yZU11dGF0aW9ucyc7XG5pbXBvcnQge0lFdmVudERpc3BhdGNoZXIsIFNpbXBsZVJlYWN0b3J9IGZyb20gJy4uL3JlYWN0b3IvU2ltcGxlUmVhY3Rvcic7XG5pbXBvcnQge0lTT0RhdGVUaW1lU3RyaW5nfSBmcm9tICcuLi9tZXRhZGF0YS9JU09EYXRlVGltZVN0cmluZ3MnO1xuaW1wb3J0IHtQcmVmc30gZnJvbSAnLi4vdXRpbC9wcmVmcy9QcmVmcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YXN0b3JlIGV4dGVuZHMgQmluYXJ5RGF0YXN0b3JlLCBXcml0YWJsZURhdGFzdG9yZSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhpcyBkYXRhc3RvcmUuXG4gICAgICovXG4gICAgcmVhZG9ubHkgaWQ6IERhdGFzdG9yZUlEO1xuXG4gICAgLyoqXG4gICAgICogSW5pdCB0aGUgZGF0YXN0b3JlLCBwb3RlbnRpYWxseSByZWFkaW5nIGZpbGVzIG9mIGRpc2ssIHRoZSBuZXR3b3JrLCBldGMuXG4gICAgICovXG4gICAgaW5pdChlcnJvckxpc3RlbmVyPzogRXJyb3JMaXN0ZW5lciwgb3B0cz86IERhdGFzdG9yZUluaXRPcHRzKTogUHJvbWlzZTxJbml0UmVzdWx0PjtcblxuICAgIHN0b3AoKTogUHJvbWlzZTx2b2lkPjtcblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0cnVlIGlmIHRoZSBEaXNrRGF0YXN0b3JlIGNvbnRhaW5zIGEgZG9jdW1lbnQgZm9yIHRoZSBnaXZlblxuICAgICAqIGZpbmdlcnByaW50LlxuICAgICAqL1xuICAgIGNvbnRhaW5zKGZpbmdlcnByaW50OiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+O1xuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBkYXRhIGZvciB0aGUgRG9jTWV0YSBvYmplY3Qgd2UgY3VycmVudGx5IGluIHRoZSBkYXRhc3RvcmUgZm9yXG4gICAgICogdGhpcyBnaXZlbiBmaW5nZXJwcmludCBvciBudWxsIGlmIGl0IGRvZXMgbm90IGV4aXN0LlxuICAgICAqIEByZXR1cm4ge3N0cmluZ30gQSBKU09OIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIERvY01ldGEgd2hpY2ggaXMgZGVjb2RlZFxuICAgICAqIGJ5IHRoZSBQZXJzaXN0ZW5jZUxheWVyLlxuICAgICAqL1xuICAgIGdldERvY01ldGEoZmluZ2VycHJpbnQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD47XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gYW4gYXJyYXkgb2Yge0RvY01ldGFSZWZ9cyBjdXJyZW50bHkgaW4gdGhlIHJlcG9zaXRvcnkuXG4gICAgICovXG4gICAgZ2V0RG9jTWV0YVJlZnMoKTogUHJvbWlzZTxEb2NNZXRhUmVmW10+O1xuXG4gICAgLyoqXG4gICAgICogR2V0IGEgY3VycmVudCBzbmFwc2hvdCBvZiB0aGUgaW50ZXJuYWwgc3RhdGUgb2YgdGhlIERhdGFzdG9yZSBieVxuICAgICAqIHJlY2VpdmluZyBEb2NNZXRhU25hcHNob3RFdmVudCBvbiB0aGUgaW5pdGlhbCBzdGF0ZS5cbiAgICAgKi9cbiAgICBzbmFwc2hvdChkb2NNZXRhU25hcHNob3RFdmVudExpc3RlbmVyOiBEb2NNZXRhU25hcHNob3RFdmVudExpc3RlbmVyLFxuICAgICAgICAgICAgIGVycm9yTGlzdGVuZXI/OiBFcnJvckxpc3RlbmVyKTogUHJvbWlzZTxTbmFwc2hvdFJlc3VsdD47XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudCBsaXN0ZW5lciB0byBsaXN0ZW4gdG8gdGhlIGRhdGFzdG9yZSB3aGlsZSBvcGVyYXRpbmcgb24gYm90aFxuICAgICAqIHRoZSB1bmRlcmx5aW5nIGRhdGFzdG9yZXMgdG8gZGlzY292ZXIgd2hlbiBkb2N1bWVudHMgYXJlIGRpc2NvdmVyZWRcbiAgICAgKiB3aXRob3V0IGhhdmluZyB0byByZS1yZWFkIHRoZSBkYXRhc3RvcmUgYWZ0ZXIgaXQncyBiZWVuIGluaXRpYWxpemVkLlxuICAgICAqL1xuICAgIGFkZERvY01ldGFTbmFwc2hvdEV2ZW50TGlzdGVuZXIoZG9jTWV0YVNuYXBzaG90RXZlbnRMaXN0ZW5lcjogRG9jTWV0YVNuYXBzaG90RXZlbnRMaXN0ZW5lcik6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBEZWFjdGl2YXRlIHVzaW5nIHRoaXMgZGF0YXNvdXJjZS4gRm9yIG1vc3QgZGF0YXNvdXJjZXMgdGhpcyBpcyBub3QgdXNlZFxuICAgICAqIGJ1dCBmb3IgY2xvdWQgc291cmNlcyB0aGlzIHdvdWxkIGxvZ291dCBhbmQgcGVyZm9ybSBvdGhlciB0YXNrcy5cbiAgICAgKi9cbiAgICBkZWFjdGl2YXRlKCk6IFByb21pc2U8dm9pZD47XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYW4gb3ZlcnZpZXcgb2YgdGhlIGRhdGFzdG9yZSBpbmNsdWRpbmcgdGhlIHRpbWUgaXQgd2FzIGNyZWF0ZWQgYXNcbiAgICAgKiB3ZWxsIGFzIG90aGVyIHN0YXRzIGluY2x1ZGluZyB0aGUgbnVtYmVyIG9mIGRvY3MuXG4gICAgICovXG4gICAgb3ZlcnZpZXcoKTogUHJvbWlzZTxEYXRhc3RvcmVPdmVydmlldyB8IHVuZGVmaW5lZD47XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBQcmVmcyBvYmplY3QgdGhhdCBzdXBwb3J0cyByZWFkaW5nIGFuZCB3cml0aW5nIGtleS92YWx1ZXMgdG8gYVxuICAgICAqIHNpbXBsZSBwcmVmcyBzdG9yZS5cbiAgICAgKi9cbiAgICBnZXRQcmVmcygpOiBQcmVmc1Byb3ZpZGVyO1xuXG4gICAgLy8gVE9ETzogd2UgbmVlZCBhIG5ldyBtZXRob2Qgd2l0aCB0aGUgZm9sbG93aW5nIHNlbWFudGljczpcblxuICAgIC8vIC0gd2UgY2FuIGFkZCBpdCBBRlRFUiB0aGUgaW5pdCgpXG4gICAgLy9cbiAgICAvLyAtIGl0IHN0YXJ0cyB3b3JraW5nIGltbWVkaWF0ZWx5IGFuZCBpbiBvZmZsaW5lIG1vZGUgYW5kIHRoZW4gY29udGludWVzXG4gICAgLy8gICB0byB3b3JrIHdoZW4gd2UgZ2V0IG9ubGluZSBzbmFwc2hvdHNcbiAgICAvL1xuICAgIC8vIC0gaXQgZ2l2ZSB1cyBGVUxMIHZpc2liaWxpdHkgaW50byB0aGUgbGlmZXN0eWxlIG9mIGEgZG9jdW1lbnQgaW5jbHVkaW5nXG4gICAgLy8gICBjcmVhdGUsIHVwZGF0ZSwgYW5kIGRlbGV0ZS5cbiAgICAvL1xuICAgIC8vIC0gdGhpcyBpcyBWRVJZIHNpbWlsYXIgKGJ1dCBzb21ld2hhdCBkaWZmZXJlbnQpIHRoYW4gdGhlIGZpcmViYXNlXG4gICAgLy8gc25hcHNob3Qgc3VwcG9ydFxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YXN0b3JlSW5mbyB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdGltZSB0aGUgZGF0YXN0b3JlIHdhcyBjcmVhdGVkLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGNyZWF0ZWQ6IElTT0RhdGVUaW1lU3RyaW5nO1xuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YXN0b3JlT3ZlcnZpZXcge1xuXG4gICAgLyoqXG4gICAgICogVGhlIHRpbWUgdGhlIGRhdGFzdG9yZSB3YXMgY3JlYXRlZC4gIFJpZ2h0IG5vdyB3ZSBkb24ndCBhbHdheXMga25vd1xuICAgICAqIHdoZW4gdGhlIGRhdGFzdG9yZSB3YXMgY3JlYXRlZCBkdWUgdG8gYWRkaW5nIHRoaXMgZmVhdHVyZSBsYXRlciAoc3RvcmluZ1xuICAgICAqIHRoZSBjcmVhdGlvbiB0aW1lKSBsYXRlci5cbiAgICAgKi9cbiAgICByZWFkb25seSBjcmVhdGVkPzogSVNPRGF0ZVRpbWVTdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbnVtYmVyIG9mIGRvY3VtZW50cyBpbiB0aGUgZGF0YXN0b3JlLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5yRG9jczogbnVtYmVyO1xuXG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBYnN0cmFjdERhdGFzdG9yZSB7XG5cbiAgICBwcm90ZWN0ZWQgZGF0YXN0b3JlTXV0YXRpb25zOiBEYXRhc3RvcmVNdXRhdGlvbnM7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5kYXRhc3RvcmVNdXRhdGlvbnMgPSBEYXRhc3RvcmVNdXRhdGlvbnMuY3JlYXRlKCd3cml0dGVuJyk7XG5cbiAgICB9XG4gICAgcHVibGljIGFzeW5jIHdyaXRlRG9jTWV0YShkb2NNZXRhOiBEb2NNZXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXN0b3JlTXV0YXRpb246IERhdGFzdG9yZU11dGF0aW9uPERvY0luZm8+ID0gbmV3IERlZmF1bHREYXRhc3RvcmVNdXRhdGlvbigpKTogUHJvbWlzZTxEb2NJbmZvPiB7XG5cbiAgICAgICAgY29uc3QgZGF0YSA9IERvY01ldGFzLnNlcmlhbGl6ZShkb2NNZXRhKTtcbiAgICAgICAgY29uc3QgZG9jSW5mbyA9IGRvY01ldGEuZG9jSW5mbztcblxuICAgICAgICBjb25zdCBzeW5jTXV0YXRpb24gPSBuZXcgRGVmYXVsdERhdGFzdG9yZU11dGF0aW9uPGJvb2xlYW4+KCk7XG4gICAgICAgIHRoaXMuZGF0YXN0b3JlTXV0YXRpb25zLnBpcGUoc3luY011dGF0aW9uLCBkYXRhc3RvcmVNdXRhdGlvbiwgKCkgPT4gZG9jSW5mbyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53cml0ZShkb2NNZXRhLmRvY0luZm8uZmluZ2VycHJpbnQsIGRhdGEsIGRvY0luZm8sIHN5bmNNdXRhdGlvbik7XG4gICAgICAgIHJldHVybiBkb2NJbmZvO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGFic3RyYWN0IHdyaXRlKGZpbmdlcnByaW50OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jSW5mbzogSURvY0luZm8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzdG9yZU11dGF0aW9uPzogRGF0YXN0b3JlTXV0YXRpb248Ym9vbGVhbj4pOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgcHVibGljIGFzeW5jIHN5bmNocm9uaXplRG9jcyguLi5kb2NNZXRhUmVmczogRG9jTWV0YVJlZltdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIG5vb3BcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZGVhY3RpdmF0ZSgpIHtcbiAgICAgICAgLy8gbm9vcFxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVCYWNrdXAoKTogUHJvbWlzZTx2b2lkPiB7XG5cbiAgICAgICAgLy8gb25seSBzdXBwb3J0ZWQgd2l0aCB0aGUgZGlzayBkYXRhc3RvcmUuXG4gICAgICAgIC8vIFRPRE8gKHdlYmFwcCkgSSB0aGluayB0aGlzIG5lZWRzIHRvIGJlIGVuYWJsZWQgZm9yIEZpcmViYXNlP1xuICAgICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoXCJOb3Qgc3VwcG9ydGVkIHdpdGggdGhpcyBkYXRhdG9yZVwiKTtcblxuICAgIH1cblxufVxuXG5pbnRlcmZhY2UgV3JpdGFibGVEYXRhc3RvcmUge1xuXG4gICAgLyoqXG4gICAgICogRGVsZXRlIHRoZSBEb2NNZXRhIGZpbGUgYW5kIHRoZSB1bmRlcmx5aW5nIGRvYyBmcm9tIHRoZSBzdGFzaC4gIERlbGV0ZXNcbiAgICAgKiBNVVNUIGJlIGlkZW1wb3RlbnQuXG4gICAgICpcbiAgICAgKi9cbiAgICBkZWxldGUoZG9jTWV0YUZpbGVSZWY6IERvY01ldGFGaWxlUmVmLCBkYXRhc3RvcmVNdXRhdGlvbj86IERhdGFzdG9yZU11dGF0aW9uPGJvb2xlYW4+KTogUHJvbWlzZTxSZWFkb25seTxEZWxldGVSZXN1bHQ+PjtcblxuICAgIHdyaXRlRG9jTWV0YShkb2NNZXRhOiBEb2NNZXRhLCBkYXRhc3RvcmVNdXRhdGlvbj86IERhdGFzdG9yZU11dGF0aW9uPERvY0luZm8+KTogUHJvbWlzZTxEb2NJbmZvPjtcblxuICAgIC8qKlxuICAgICAqIFdyaXRlIHRoZSBkYXRhc3RvcmUgdG8gZGlzay4gIFdyaXRlcyBzaG91bGQgYmUgaWRlbXBvdGVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaW5nZXJwcmludCBUaGUgZmluZ2VycHJpbnQgb2YgdGhlIGRhdGEgd2Ugc2hvdWxkIGJlIHdvcmtpbmcgd2l0aC5cbiAgICAgKiBAcGFyYW0gZGF0YSBUaGUgUkFXIGRhdGEgdG8gZGVjb2RlIGJ5IHRoZSBQZXJzaXN0ZW5jZUxheWVyXG4gICAgICogQHBhcmFtIGRvY0luZm8gVGhlIERvY0luZm8gZm9yIHRoaXMgZG9jdW1lbnQgdGhhdCB3ZSdyZSB3cml0aW5nXG4gICAgICovXG4gICAgd3JpdGUoZmluZ2VycHJpbnQ6IHN0cmluZywgZGF0YTogYW55LCBkb2NJbmZvOiBJRG9jSW5mbywgZGF0YXN0b3JlTXV0YXRpb24/OiBEYXRhc3RvcmVNdXRhdGlvbjxib29sZWFuPik6IFByb21pc2U8dm9pZD47XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIHN1cmUgdGhlIGRvY3Mgd2l0aCB0aGUgZ2l2ZW4gZmluZ2VycHJpbnRzIGFyZSBzeW5jaHJvbml6ZWQgd2l0aFxuICAgICAqIHRoaXMgZGF0YXN0b3JlLiBPbmx5IGltcGxlbWVudGVkIGluIGNsb3VkIGRhdGFzdG9yZXMuXG4gICAgICovXG4gICAgc3luY2hyb25pemVEb2NzKC4uLmRvY01ldGFSZWZzOiBEb2NNZXRhUmVmW10pOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgY3JlYXRlQmFja3VwKCk6IFByb21pc2U8dm9pZD47XG5cbn1cblxuLyoqXG4gKiBBIGRhdGFzdG9yZSB0aGF0IHN1cHBvcnQgc3RvcmFnZSBvZiBiaW5hcnkgZGF0YSAoaW1hZ2VzLCB2aWRlb3MsIFBERnMsIGV0YykuXG4gKi9cbmludGVyZmFjZSBCaW5hcnlEYXRhc3RvcmUgZXh0ZW5kcyBSZWFkYWJsZUJpbmFyeURhdGFzdG9yZSwgV3JpdGFibGVCaW5hcnlEYXRhc3RvcmUge1xuXG59XG5cbmludGVyZmFjZSBSZWFkYWJsZUJpbmFyeURhdGFzdG9yZSB7XG5cbiAgICBjb250YWluc0ZpbGUoYmFja2VuZDogQmFja2VuZCwgcmVmOiBGaWxlUmVmKTogUHJvbWlzZTxib29sZWFuPjtcblxuICAgIGdldEZpbGUoYmFja2VuZDogQmFja2VuZCwgcmVmOiBGaWxlUmVmKTogUHJvbWlzZTxPcHRpb25hbDxEb2NGaWxlTWV0YT4+O1xuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV3JpdGFibGVCaW5hcnlEYXRhc3RvcmUge1xuXG4gICAgLyoqXG4gICAgICogQWRkIGZpbGUgZGF0YSB0byB0aGUgZGF0YXN0b3JlLiAgVGhpcyBpcyB1c2VkIGZvciBiaW5hcnkgZGF0YSBvciBvdGhlclxuICAgICAqIGRhdGEgdHlwZXMgdGhhdCBuZWVkIHRvIGJlIHN0b3JlZC4gVGhpcyBpcyBwcmltYXJpbHkgZGVzaWduZWQgZm9yIHZpZGVvLFxuICAgICAqIGF1ZGlvLCBhbmQgZG9jdW1lbnRzIGxpa2UgUERGLCBlUHViLCBldGMuXG4gICAgICovXG4gICAgd3JpdGVGaWxlKGJhY2tlbmQ6IEJhY2tlbmQsXG4gICAgICAgICAgICAgIHJlZjogRmlsZVJlZixcbiAgICAgICAgICAgICAgZGF0YTogQmluYXJ5RmlsZURhdGEsXG4gICAgICAgICAgICAgIG1ldGE/OiBGaWxlTWV0YSk6IFByb21pc2U8RG9jRmlsZU1ldGE+O1xuXG4gICAgZGVsZXRlRmlsZShiYWNrZW5kOiBCYWNrZW5kLCByZWY6IEZpbGVSZWYpOiBQcm9taXNlPHZvaWQ+O1xuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV3JpdGFibGVCaW5hcnlNZXRhRGF0YXN0b3JlIHtcbiAgICB3cml0ZUZpbGVNZXRhKGJhY2tlbmQ6IEJhY2tlbmQsIHJlZjogRmlsZVJlZiwgZG9jRmlsZU1ldGE6IERvY0ZpbGVNZXRhKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IHR5cGUgQmluYXJ5RmlsZURhdGEgPSBGaWxlSGFuZGxlIHwgQnVmZmVyIHwgc3RyaW5nIHwgQmxvYjtcblxuZXhwb3J0IGludGVyZmFjZSBGaWxlUmVmIHtcblxuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBoYXNoY29kZSBmb3IgdGhlIGNvbnRlbnQuICBGb3Igbm93IHRoZSBoYXNoY29kZSBpcyBTVFJPTkdMWSBwcmVmZXJyZWRcbiAgICAgKiBidXQgbm90IHJlcXVpcmVkLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGhhc2hjb2RlPzogSGFzaGNvZGU7XG5cbn1cblxuLy8gbm9pbnNwZWN0aW9uIFRzTGludFxuZXhwb3J0IHR5cGUgRmlsZU1ldGEgPSB7XG4gICAgLy8gVE9ETzogSSBzaG91bGQgYWxzbyBpbmNsdWRlIHRoZSBTdG9yYWdlU2V0dGluZ3MgZnJvbSBGaXJlYmFzZSBoZXJlIHRvXG4gICAgLy8gZ2l2ZSBpdCBhIHNldCBvZiBzdGFuZGFyZGl6ZWQgZmllbGRzIGxpa2UgY29udGVudFR5cGUgYXMgc2NyZWVuc2hvdHNcbiAgICAvLyBuZWVkcyB0byBiZSBhZGRlZCB3aXRoIGEgZmlsZSB0eXBlLlxuXG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nXG59O1xuXG4vKipcbiAqXG4gKiBBIGRhdGFzdG9yZSB0aGF0IHByb3ZpZGVzIGV2ZW50cyBhYm91dCBjaGFuZ2VzIGJlaW5nIG1hZGUgdG8gdGhlIGRhdGFzdG9yZS5cbiAqXG4gKiBUaGlzIGluY2x1ZGVzIHRoZSBncmFudWxhcml0eSB3ZSBuZWVkIGZvciByZXBsaWNhdGluZyB0aGUgZGF0YSB0byBhIGxvY2FsXG4gKiBkYXRhc3RvcmUgYnkgZmV0Y2hpbmcgdGhlIGRhdGEgYW5kIHdyaXRpbmcgaXQgYmFjayBvdXQgb24gdGhlIG11dGF0aW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFN5bmNocm9uaXppbmdEYXRhc3RvcmUgZXh0ZW5kcyBEYXRhc3RvcmUge1xuXG4gICAgLyoqXG4gICAgICogTGlzdGVucyBmb3IgbXV0YXRpb25zIHRvIGJpbmFyaWVzLlxuICAgICAqL1xuICAgIGFkZEZpbGVTeW5jaHJvbml6YXRpb25FdmVudExpc3RlbmVyKGZpbGVTeW5jaHJvbml6YXRpb25FdmVudExpc3RlbmVyOiBGaWxlU3luY2hyb25pemF0aW9uRXZlbnRMaXN0ZW5lcik6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW5zIG9ubHkgZm9yIG5ldyBzeW5jaHJvbml6ZWQgZG9jdW1lbnRzIGFuZCBpZ25vcmVzIGV4aXN0aW5nXG4gICAgICogZG9jdW1lbnRzLiAgVGhpcyBhbGxvd3MgdXMgdG8gZmluZCByZXBsaWNhdGVkIGRvY3VtZW50cyBhcyB0aGV5XG4gICAgICogY2hhbmdlLlxuICAgICAqL1xuICAgIGFkZFN5bmNocm9uaXphdGlvbkV2ZW50TGlzdGVuZXIoc3luY2hyb25pemF0aW9uRXZlbnRMaXN0ZW5lcjogU3luY2hyb25pemF0aW9uRXZlbnRMaXN0ZW5lcik6IHZvaWQ7XG5cbiAgICAvLyAvKipcbiAgICAvLyAgKiBNYXJrIHRoYXQgd2UndmUgcHJvcGVybHkgdHJhbnNmZXJyZWQgdGhlIGRpc2sgZGF0YXN0b3JlIGludG8gdGhlIGNsb3VkXG4gICAgLy8gICogZGF0YXN0b3JlIGFuZCBub3cgdGhlIGNsb3VkIGRhdGFzdG9yZSBpcyB0aGUgcHJpbWFyeSBzb3VyY2UuXG4gICAgLy8gICpcbiAgICAvLyAgKi9cbiAgICAvLyBtYXJrTWVyZ2VkKHRyYW5zZmVycmVkOiBib29sZWFuKTogUHJvbWlzZTx2b2lkPjtcblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN5bmNocm9uaXphdGlvbkV2ZW50IGV4dGVuZHMgRG9jTWV0YVNuYXBzaG90RXZlbnQge1xuXG4gICAgLyoqXG4gICAgICogVGhlIGRlc3RpbmF0aW9uIG9mIHRoZSBkYXRhIGluIHRoaXMgc3luY2hyb25pemF0aW9uIGV2ZW50LiAgV2hlbiB0aGVcbiAgICAgKiBkZXN0IGlzICdsb2NhbCcgd2UncmUgY29weWluZyBmcm9tIHRoZSBjbG91ZCB0byBsb2NhbCBhbmQgd2hlbiBpdCdzXG4gICAgICogJ2Nsb3VkJyB0aGVuIHdlJ3JlIGNvcHlpbmcgZnJvbSB0aGUgbG9jYWwgdG8gdGhlIGNsb3VkLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGRlc3Q6IERhdGFzdG9yZUlEO1xuXG59XG5cbmV4cG9ydCB0eXBlIFN5bmNocm9uaXphdGlvbkV2ZW50TGlzdGVuZXIgPSAoc3luY2hyb25pemF0aW9uRXZlbnQ6IFN5bmNocm9uaXphdGlvbkV2ZW50KSA9PiB2b2lkO1xuXG4vKipcbiAqIE11dGF0aW9ucyBvbiBiaW5hcnkgZmlsZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZVN5bmNocm9uaXphdGlvbkV2ZW50IHtcblxuICAgIHJlYWRvbmx5IGJhY2tlbmQ6IEJhY2tlbmQ7XG5cbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgICByZWFkb25seSBtdXRhdGlvblR5cGU6IE11dGF0aW9uVHlwZTtcblxufVxuXG5leHBvcnQgdHlwZSBGaWxlU3luY2hyb25pemF0aW9uRXZlbnRMaXN0ZW5lciA9IChmaWxlU3luY2hyb25pemF0aW9uRXZlbnQ6IEZpbGVTeW5jaHJvbml6YXRpb25FdmVudCkgPT4gdm9pZDtcblxuLyoqXG4gKiBDYWxsIHRoZSBsaXN0ZW5lciBmb3IgZXZlcnkgRG9jTWV0YVNuYXBzaG90RXZlbnQgYW5kIGF3YWl0IGl0cyByZXN1bHRzLiAgSXQnc1xuICogVkVSWSBpbXBvcnRhbnQgdG8gYXdhaXQgdGhlIHJlc3VsdHMgaGVyZSFcbiAqL1xuZXhwb3J0IHR5cGUgRG9jTWV0YVNuYXBzaG90RXZlbnRMaXN0ZW5lciA9IChkb2NNZXRhU25hcHNob3RFdmVudDogRG9jTWV0YVNuYXBzaG90RXZlbnQpID0+IFByb21pc2U8dm9pZD47XG5cbmV4cG9ydCB0eXBlIEVycm9yTGlzdGVuZXIgPSAoZXJyOiBFcnJvcikgPT4gdm9pZDtcblxuLyoqXG4gKiBBIERvY01ldGFTbmFwc2hvdEV2ZW50IGlzIGEgc25hcHNob3Qgb2YgdGhlIERhdGFzdG9yZSBiYXNlZCBvbiB0aGUgY3VycmVudFxuICogc3RhdGUgYXMgd2VsbCBhcyBmdXR1cmUgc25hcHNob3RzIGFzIHRoZSByZW1vdGUgc3RvcmUgY2hhbmdlcy4gIFRoaXMgaW5jbHVkZXNcbiAqIERvY01ldGEgbXV0YXRpb25zIHdoaWNoIGFsc28gaW5jbHVkZSBhIE11dGF0aW9uVHlwZSBmb3Igd2hldGhlciB0aGUgZG9jdW1lbnRcbiAqIHdhcyBjcmVhdGVkLCB1cGRhdGVkLCBvciBkZWxldGVkLlxuICpcbiAqIE5vdGUgdGhhdCBhIHNuYXBzaG90IGV2ZW50IGNhbiBoYXZlIHplcm8gb3IgbW9yZSBkb2NNZXRhTXV0YXRpb25zLiAgV2Ugd2lsbFxuICogZ2VuZXJhdGUgemVybyBEb2NNZXRhTXV0YXRpb25zIHdoZW4gd2UncmUgdXBkYXRpbmcgcHJvZ3Jlc3MuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRG9jTWV0YVNuYXBzaG90RXZlbnQge1xuXG4gICAgcmVhZG9ubHkgZGF0YXN0b3JlOiBEYXRhc3RvcmVJRDtcblxuICAgIHJlYWRvbmx5IHByb2dyZXNzOiBSZWFkb25seTxTbmFwc2hvdFByb2dyZXNzPjtcblxuICAgIHJlYWRvbmx5IGNvbnNpc3RlbmN5OiBEYXRhc3RvcmVDb25zaXN0ZW5jeTtcblxuICAgIC8qKlxuICAgICAqIEFuIGFycmF5IG9mIG11dGF0aW9ucyB0aGF0IGhhdmUgYmVlbiBhcHBsaWVkLiAgV2UgcmV0dXJuIGFzIGFuIGFycmF5IHRvXG4gICAgICogZW5hYmxlIHBlcmZvcm1hbmNlIHVwZGF0ZXMgdmlhIGJhdGNoaW5nLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGRvY01ldGFNdXRhdGlvbnM6IFJlYWRvbmx5QXJyYXk8RG9jTWV0YU11dGF0aW9uPjtcblxuICAgIHJlYWRvbmx5IGJhdGNoPzogRG9jTWV0YVNuYXBzaG90QmF0Y2g7XG5cbn1cblxuZXhwb3J0IGNsYXNzIERvY01ldGFTbmFwc2hvdEV2ZW50cyB7XG5cbiAgICBwdWJsaWMgc3RhdGljIGZvcm1hdChldjogRG9jTWV0YVNuYXBzaG90RXZlbnQpIHtcblxuICAgICAgICBsZXQgYmF0Y2ggPSBcIk5PIEJBVENIXCI7XG5cbiAgICAgICAgaWYgKGV2LmJhdGNoKSB7XG4gICAgICAgICAgICBiYXRjaCA9IGAoaWQ6ICR7ZXYuYmF0Y2ghLmlkfSwgdGVybWluYXRlZDogJHtldi5iYXRjaCEudGVybWluYXRlZH0pYDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gZXYucHJvZ3Jlc3MucHJvZ3Jlc3M7XG4gICAgICAgIGNvbnN0IG5yTXV0YXRpb25zID0gZXYuZG9jTWV0YU11dGF0aW9ucy5sZW5ndGg7XG5cbiAgICAgICAgcmV0dXJuIGAke2V2LmRhdGFzdG9yZX0gJHtwcm9ncmVzc30lIChjb25zaXN0ZW5jeTogJHtldi5jb25zaXN0ZW5jeX0sIG5yIG11dGF0aW9uczogJHtuck11dGF0aW9uc30sIGJhdGNoOiAke2JhdGNofSlgO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyB0b0RvY0luZm9zKGRvY01ldGFTbmFwc2hvdEV2ZW50OiBEb2NNZXRhU25hcHNob3RFdmVudCk6XG4gICAgICAgIFByb21pc2U8UmVhZG9ubHlBcnJheTxJRG9jSW5mbz4+IHtcblxuICAgICAgICByZXR1cm4gQXN5bmNXb3JrUXVldWVzXG4gICAgICAgICAgICAuYXdhaXRQcm9taXNlcyhkb2NNZXRhU25hcHNob3RFdmVudC5kb2NNZXRhTXV0YXRpb25zLm1hcChjdXJyZW50ID0+IGN1cnJlbnQuZG9jSW5mb1Byb3ZpZGVyKCkpKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgdG9TeW5jRG9jcyhkb2NNZXRhU25hcHNob3RFdmVudDogRG9jTWV0YVNuYXBzaG90RXZlbnQpOlxuICAgICAgICBQcm9taXNlPFJlYWRvbmx5QXJyYXk8U3luY0RvYz4+IHtcblxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IGRvY01ldGFTbmFwc2hvdEV2ZW50LmRvY01ldGFNdXRhdGlvbnMubWFwKGRvY01ldGFNdXRhdGlvbiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRvY0luZm8gPSBhd2FpdCBkb2NNZXRhTXV0YXRpb24uZG9jSW5mb1Byb3ZpZGVyKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN5bmNEb2NzLmZyb21Eb2NJbmZvKGRvY0luZm8sIGRvY01ldGFNdXRhdGlvbi5tdXRhdGlvblR5cGUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSkubWFwKGN1cnJlbnQgPT4gY3VycmVudCgpKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgQXN5bmNXb3JrUXVldWVzLmF3YWl0UHJvbWlzZXMocHJvbWlzZXMpO1xuXG4gICAgfVxuXG59XG5cbi8qKlxuICogUmVwcmVzZW50cyBkYXRhIGFyb3VuZCBhIHNwZWNpZmljIGJhdGNoIG9mIERvY01ldGFNdXRhdGlvbnMgc28gdGhhdCB3ZSBrbm93XG4gKiB3aGVuIHdlIGhhdmUgYSBmaXJzdCBjb25zaXN0ZW50IHNuYXBzaG90LiAgVGhpcyB3YXkgd2UgY2FuIGdldCBzdHJlYW1pbmdcbiAqIGV2ZW50cyBidXQga25vdyB3aGVuIHBhcnQgb2YgdGhlIHN0cmVhbSBoYXMgdGVybWluYXRlZC5cbiAqXG4gKiBUaGUgYmF0Y2ggaXMgb25seSBwcmVzZW50ICh1c3VhbGx5KSBvbiBmaXJzdCBsZXZlbCBkYXRhc3RvcmVzIG5vdCBhZ2dyZWdhdGVcbiAqIGRhdGFzdG9yZXMgd2hpY2ggbWlnaHQgYmUgbWVyZ2luZyBzdHJlYW1zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIERvY01ldGFTbmFwc2hvdEJhdGNoIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBJRCBvZiB0aGlzIGJhdGNoLiBUaGUgZmlyc3QgYmF0Y2ggYXQgYSBnaXZlbiBjb25zaXN0ZW5jeSBsZXZlbCBpcyBhXG4gICAgICogY29tcGxldGUgc25hcHNob3Qgb2YgdGhlIHVuZGVybHlpbmcgZGF0YXN0b3JlIGFuZCBhbGwgZG9jcy4gIFlvdSBNQVkgbm90XG4gICAgICogcmVjZWl2ZSBhIGJhdGNoIHdpdGggY29uc2lzdGVuY3kgJ3dyaXR0ZW4nIGFuZCBvbmx5IHJlY2VpdmUgb25lIGZvclxuICAgICAqICdjb21taXR0ZWQnIHNvIHlvdSBzaG91bGQgZm9jdXMgb24gY29tbWl0dGVkLiBCYXRjaGVzIGFmdGVyIHRoZSBmaXJzdCBhcmVcbiAgICAgKiBkaWZmZXJlbnRpYWwgYW5kIG9ubHkgcmVwcmVzZW50IHVwZGF0ZXMuXG4gICAgICovXG4gICAgcmVhZG9ubHkgaWQ6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIFRydWUgaWYgd2UndmUgcmVjZWl2ZWQgYWxsIHRoZSBldmVudHMgaW4gdGhpcyBiYXRjaCBhbmQgdGhpcyBpcyB0aGUgbGFzdFxuICAgICAqIGV2ZW50IHlvdSB3aWxsIHNlZSB3aXRoIHRoZSBzYW1lIGJhdGNoIElELlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHRlcm1pbmF0ZWQ6IGJvb2xlYW47XG5cbn1cblxuLyoqXG4gKiBUaGUgY29uc2lzdGVuY3kgb2YgdGhlIHVuZGVybHlpbmcgZGF0YSwgd2hldGhlciBpdCdzIHdyaXR0ZW4gb3IgY29tbWl0dGVkLlxuICpcbiAqICd3cml0dGVuJyBtZWFucyB0aGF0IGl0IHdhcyB3cml0dGVuIHRvIGEgV0FMIG9yIGEgbG9jYWwgY2FjaGUgYnV0IG1heSBub3RcbiAqIGJlIGZ1bGx5IGNvbW1pdHRlZCB0byBhIGNsb3VkIHN0b3JlLCB0byBhbGwgcmVwbGljYXMgb2YgYSBkYXRhYmFzZSwgZXRjLlxuICpcbiAqICdjb21taXR0ZWQnIG1lYW5zIHRoYXQgaXQncyBmdWxseSBjb21taXRlZCBhbmQgY29uc2lzdGVudCB3aXRoIHRoZSBjdXJyZW50XG4gKiBzdGF0ZSBvZiBhIGRhdGFiYXNlIHN5c3RlbS4gIEEgcmVhZCB0aGF0IGlzICdjb21taXR0ZWQnIG1lYW5zIGl0IGlzIGZ1bGx5XG4gKiB1cCB0byBkYXRlLlxuICpcbiAqL1xuZXhwb3J0IHR5cGUgRGF0YXN0b3JlQ29uc2lzdGVuY3kgPSAnd3JpdHRlbicgfCAnY29tbWl0dGVkJztcblxuZXhwb3J0IGludGVyZmFjZSBTbmFwc2hvdFByb2dyZXNzIGV4dGVuZHMgUmVhZG9ubHk8UHJvZ3Jlc3M+IHtcblxufVxuXG4vKipcbiAqIE9ubHkgdXNlIG9uZSBwcm92aWRlciwgZWl0aGVyIGRhdGFQcm92aWRlciwgZG9jTWV0YVByb3ZpZGVyLCBvclxuICogZG9jSW5mb1Byb3ZpZGVyLCB3aGljaGV2ZXIgaXMgdGhlIG1vc3QgZWZmaWNpZW50IGFuZCBvbmx5IHJlYWQgb25jZSBpZGVhbGx5LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIERvY01ldGFNdXRhdGlvbiB7XG5cbiAgICByZWFkb25seSBmaW5nZXJwcmludDogc3RyaW5nO1xuXG4gICAgcmVhZG9ubHkgbXV0YXRpb25UeXBlOiBNdXRhdGlvblR5cGU7XG5cbiAgICByZWFkb25seSBkb2NNZXRhRmlsZVJlZlByb3ZpZGVyOiBBc3luY1Byb3ZpZGVyPERvY01ldGFGaWxlUmVmPjtcblxuICAgIC8qKlxuICAgICAqIEdldCBhY2Nlc3MgdG8gdGhlIHVuZGVybHlpbmcgZGF0YSBvZiB0aGUgRG9jTWV0YSB0byBlbmFibGUgdXMgdG9cbiAgICAgKiByZWFkL3dyaXRlIGRpcmVjdGx5IHRvIHRoZSBEYXRhc3RvcmUgd2l0aG91dCBtdXRhdGluZyBhbnl0aGluZy5cbiAgICAgKi9cbiAgICByZWFkb25seSBkYXRhUHJvdmlkZXI6IEFzeW5jUHJvdmlkZXI8c3RyaW5nIHwgbnVsbD47XG5cbiAgICByZWFkb25seSBkb2NNZXRhUHJvdmlkZXI6IEFzeW5jUHJvdmlkZXI8RG9jTWV0YT47XG5cbiAgICByZWFkb25seSBkb2NJbmZvUHJvdmlkZXI6IEFzeW5jUHJvdmlkZXI8SURvY0luZm8+O1xuXG59XG5cbmV4cG9ydCB0eXBlIE11dGF0aW9uVHlwZSA9ICdjcmVhdGVkJyB8ICd1cGRhdGVkJyB8J2RlbGV0ZWQnO1xuXG4vKipcbiAqIFRoZSByZXN1bHQgb2YgYW4gaW5pdCBvcGVyYXRpb24gd2hpY2ggY291bGQgYmUgZGlmZmVyZW50IGZvcm0gZWFjaCBkYXRhc3RvcmUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSW5pdFJlc3VsdCB7XG5cbn1cblxuXG4vKipcbiAqIFRoZSByZXN1bHQgb2YgYSBkZWxldGUoKSBvcGVyYXRpb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRGVsZXRlUmVzdWx0IHtcblxufVxuXG4vKipcbiAqIExpc3RlbnMgdG8gZG9jdW1lbnRzIGluIHRoZSBsb2NhbCByZXBvc2l0b3J5IG9uIGxvYWQuICBXZSByZWNlaXZlIG9uZSBldmVudFxuICogcGVyIGRvY3VtZW50IGl0IGVudGVycyB0aGUgcmVwb3NpdG9yeS4gT25jZSBvbiBzdGFydHVwIGlmIGl0J3MgYWxyZWFkeVxuICogcHJlc2VudCBhbmQgdGhlbiBhZ2FpbiBpZiBpdCdzIHJlcGxpY2F0ZWQgZnJvbSB0aGUgY2xvdWQuXG4gKi9cbmV4cG9ydCB0eXBlIEluaXREb2NNZXRhRXZlbnRMaXN0ZW5lciA9IChpbml0RG9jTWV0YUV2ZW50OiBJbml0RG9jTWV0YUV2ZW50KSA9PiB2b2lkO1xuXG5leHBvcnQgaW50ZXJmYWNlIEluaXREb2NNZXRhRXZlbnQge1xuICAgIHJlYWRvbmx5IGRvY01ldGE6IERvY01ldGE7XG59XG5cbi8qKlxuICogSWYgdGhlIGBpbml0YCBtZXRob2QgaXMgZ2l2ZW4gYW4gSW5pdExvYWRMaXN0ZW5lciB0aGUgaW5pdCBmdW5jdGlvbiBnaXZlcyB0aGVcbiAqIGNhbGxlciBhIGNvcHkgb2YgZXZlcnkgRG9jTWV0YSBpbiB0aGUgZGF0YXN0b3JlIG9uIGluaXQuICBUaGlzIGNhbiBiZSBoZWxwXG4gKiBmdWxsIGluIGdlbmVyYWwgdG8gbG9hZCBhIFVJIG9yIGRhdGEgaW50byBtZW1vcnkgYnV0IHNpbmNlIGludGVybmFsbHkgdGhlXG4gKiBkYXRhc3RvcmUgbWlnaHQgQUxTTyBiZSBsb2FkaW5nIHRoZSBkb2NNZXRhIGZvciBpbnRlcm5hbCBvcGVyYXRpb25zXG4gKiAoY29uc2lzdGVuY3ksIHNuYXBzaG90cywgZXRjKSB0aGVuIHdlIGNhbiBzdXJmYWNlIHRoaXMgZGF0YSB0byB0aGUgdXNlclxuICogd2l0aG91dCBkb2luZyBhIGRvdWJsZSBpbml0LlxuICovXG5leHBvcnQgdHlwZSBJbml0TG9hZExpc3RlbmVyID0gKGRvY01ldGE6IERvY01ldGEpID0+IHZvaWQ7XG5cbi8qKlxuICogVGhlIHJlc3VsdCBvZiBhIHNuYXBzaG90IGNhbGwgd2l0aCBhbiBvcHRpb25hbCB1bnN1YnNjcmliZSBjYWxsYmFjay5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTbmFwc2hvdFJlc3VsdCB7XG5cbiAgICAvKipcbiAgICAgKiBBbiBvcHRpb25hbCB1bnN1YnNjcmliZVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHVuc3Vic2NyaWJlPzogU25hcHNob3RVbnN1YnNjcmliZXI7XG5cbn1cblxuLyoqXG4gKiBBIGZ1bmN0aW9uIGZvciB1bnN1YnNjcmliaW5nIHRvIGZ1dHVyZSBzbmFwc2hvdCBldmVudHMuXG4gKi9cbmV4cG9ydCB0eXBlIFNuYXBzaG90VW5zdWJzY3JpYmVyID0gKCkgPT4gdm9pZDtcblxuZXhwb3J0IGludGVyZmFjZSBTeW5jRG9jTWFwIHtcbiAgICBbZmluZ2VycHJpbnQ6IHN0cmluZ106IFN5bmNEb2M7XG5cbn1cblxuZXhwb3J0IGNsYXNzIFN5bmNEb2NNYXBzIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgcHV0QWxsKHN5bmNEb2NNYXA6IFN5bmNEb2NNYXAsIHN5bmNEb2NzOiBSZWFkb25seUFycmF5PFN5bmNEb2M+KTogdm9pZCB7XG5cbiAgICAgICAgZm9yIChjb25zdCBzeW5jRG9jIG9mIHN5bmNEb2NzKSB7XG4gICAgICAgICAgICBzeW5jRG9jTWFwW3N5bmNEb2MuZmluZ2VycHJpbnRdID0gc3luY0RvYztcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmcm9tQXJyYXkoc3luY0RvY3M6IFJlYWRvbmx5QXJyYXk8U3luY0RvYz4pOiBTeW5jRG9jTWFwIHtcblxuICAgICAgICBjb25zdCByZXN1bHQ6IFN5bmNEb2NNYXAgPSB7fTtcblxuICAgICAgICBmb3IgKGNvbnN0IHN5bmNEb2Mgb2Ygc3luY0RvY3MpIHtcbiAgICAgICAgICAgIHJlc3VsdFtzeW5jRG9jLmZpbmdlcnByaW50XSA9IHN5bmNEb2M7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG5cbi8qKlxuICogQSBsaWdodHdlaWdodCBkb2MgcmVmZXJlbmNlIHRvIHN5bmMgYmV0d2VlbiB0d28gZGF0YXNvdXJjZXMuICBBIFN5bmNEb2MgaXMgYVxuICogZmxpZ2h3ZWlnaHQgYW5kIHNob3VsZCBiZSBrZXB0IG1pbmltYWxseSBjb21wYWN0IHRvIHNhdmUgc3BhY2UuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3luY0RvYyB7XG5cbiAgICByZWFkb25seSBmaW5nZXJwcmludDogc3RyaW5nO1xuXG4gICAgcmVhZG9ubHkgbXV0YXRpb25UeXBlOiBNdXRhdGlvblR5cGU7XG5cbiAgICAvKipcbiAgICAgKiBXaGlsZSB0aGUgVVVJRCBpcyBvcHRpb25hbCBpbiBwcmFjdGljZSBpdCdzIHJlcXVpcmVkIGFuZCBhbGwgZG9jcyBzaG91bGRcbiAgICAgKiBoYXZlIGEgVVVJRC5cbiAgICAgKi9cbiAgICByZWFkb25seSB1dWlkPzogVVVJRDtcblxuICAgIC8qKlxuICAgICAqIFRoZSBiaW5hcnkgZmlsZXMgcmVmZXJlbmNlIGJ5IHRoaXMgZG9jLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGZpbGVzOiBSZWFkb25seUFycmF5PFN5bmNGaWxlPjtcblxuICAgIHJlYWRvbmx5IGRvY01ldGFGaWxlUmVmOiBEb2NNZXRhRmlsZVJlZjtcbn1cblxuLyoqXG4gKiBBIGxpZ2h0d2VpZ2h0IHJlZmVyZW5jZSB0byBhIGJpbmFyeSBmaWxlIGF0dGFjaGVkIHRvIGEgU3luY0RvYy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTeW5jRmlsZSB7XG5cbiAgICByZWFkb25seSBiYWNrZW5kOiBCYWNrZW5kO1xuXG4gICAgcmVhZG9ubHkgcmVmOiBGaWxlUmVmO1xuXG59XG5cbmV4cG9ydCBjbGFzcyBTeW5jRG9jcyB7XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb21Eb2NJbmZvKGRvY0luZm86IElEb2NJbmZvLCBtdXRhdGlvblR5cGU6IE11dGF0aW9uVHlwZSk6IFN5bmNEb2Mge1xuXG4gICAgICAgIGNvbnN0IGZpbGVzOiBTeW5jRmlsZVtdID0gW107XG5cbiAgICAgICAgLy8gVE9ETzogZGVkaWNhdGVkIGZ1bmN0aW9uIHRvIHRha2UgSURvY0luZm8gYW5kIHRoZW4gZXh0cmFjdCB0aGUgZmlsZVxuICAgICAgICAvLyByZWZlcmVuY2VzIGZvciB0aGVtLiAgVGhlbiB3cml0ZSgpIGFuZCBkZWxldGUoKSBzaG91bGQgbWFrZSBzdXJlIHRoZVxuICAgICAgICAvLyBmaWxlIHJlZmVyZW5jZXMgYXJlIHZhbGlkIGFuZCBzZXR1cCBwcm9wZXJseSBiZWZvcmUgd2Ugd3JpdGVcbiAgICAgICAgLy8gKEkgdGhpbmspLlxuXG4gICAgICAgIGlmIChkb2NJbmZvLmZpbGVuYW1lKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXNoRmlsZTogU3luY0ZpbGUgPSB7XG4gICAgICAgICAgICAgICAgYmFja2VuZDogQmFja2VuZC5TVEFTSCxcbiAgICAgICAgICAgICAgICByZWY6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogZG9jSW5mby5maWxlbmFtZSEsXG4gICAgICAgICAgICAgICAgICAgIGhhc2hjb2RlOiBkb2NJbmZvLmhhc2hjb2RlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgZmlsZXMucHVzaChzdGFzaEZpbGUpO1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmluZ2VycHJpbnQ6IGRvY0luZm8uZmluZ2VycHJpbnQsXG4gICAgICAgICAgICBkb2NNZXRhRmlsZVJlZjogRG9jTWV0YUZpbGVSZWZzLmNyZWF0ZUZyb21Eb2NJbmZvKGRvY0luZm8pLFxuICAgICAgICAgICAgbXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgdXVpZDogZG9jSW5mby51dWlkLFxuICAgICAgICAgICAgZmlsZXNcbiAgICAgICAgfTtcblxuICAgIH1cblxufVxuXG5leHBvcnQgdHlwZSBEYXRhc3RvcmVJRCA9IHN0cmluZztcblxuXG5leHBvcnQgaW50ZXJmYWNlIERhdGFzdG9yZUluaXRPcHRzIHtcbiAgICByZWFkb25seSBub0luaXRpYWxTbmFwc2hvdD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJlZnNQcm92aWRlciB7XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxhdGVzdCBjb3B5IG9mIHRoZSBwcmVmcyB3ZSdyZSB1c2luZy5cbiAgICAgKi9cbiAgICBnZXQoKTogUHJlZnM7XG5cbn1cbiJdfQ==