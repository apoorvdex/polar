"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const JQuery_1 = __importDefault(require("../../ui/JQuery"));
const Viewer_1 = require("../Viewer");
const Logger_1 = require("../../logger/Logger");
const Preconditions_1 = require("../../Preconditions");
const LinkHandler_1 = require("./LinkHandler");
const Services_1 = require("../../util/services/Services");
const HTMLFormat_1 = require("../../docformat/HTMLFormat");
const FrameInitializer_1 = require("./FrameInitializer");
const BackgroundFrameResizer_1 = require("./BackgroundFrameResizer");
const Descriptors_1 = require("./Descriptors");
const IFrameWatcher_1 = require("./IFrameWatcher");
const FrameResizer_1 = require("./FrameResizer");
const RendererAnalytics_1 = require("../../ga/RendererAnalytics");
const DocMetas_1 = require("../../metadata/DocMetas");
const log = Logger_1.Logger.create();
const ENABLE_VIDEO = true;
class HTMLViewer extends Viewer_1.Viewer {
    constructor(model) {
        super();
        this.content = document.createElement('iframe');
        this.contentParent = document.createElement('div');
        this.textLayer = document.createElement('div');
        this.requestParams = null;
        this.model = model;
    }
    start() {
        log.info("Starting HTMLViewer");
        this.content = document.querySelector("#content");
        this.contentParent = document.querySelector("#content-parent");
        this.textLayer = document.querySelector(".textLayer");
        this.htmlFormat = new HTMLFormat_1.HTMLFormat();
        RendererAnalytics_1.RendererAnalytics.pageview("/htmlviewer");
        this.requestParams = this._requestParams();
        JQuery_1.default(document).ready(() => __awaiter(this, void 0, void 0, function* () {
            this._captureBrowserZoom();
            this._loadRequestData();
            this._configurePageWidth();
            this.frameResizer = new FrameResizer_1.FrameResizer(this.contentParent, this.content);
            new IFrameWatcher_1.IFrameWatcher(this.content, () => {
                log.info("Loading page now...");
                const backgroundFrameResizer = new BackgroundFrameResizer_1.BackgroundFrameResizer(this.contentParent, this.content, () => this.onResized());
                backgroundFrameResizer.start();
                const frameInitializer = new FrameInitializer_1.FrameInitializer(this.content, this.textLayer);
                frameInitializer.start();
                this.startHandlingZoom();
            }).start();
            window.addEventListener("resize", () => {
                this.doZoom();
                this.frameResizer.resize(true)
                    .catch(err => log.error("Unable to resize: ", err));
            });
            yield Services_1.Services.start(new LinkHandler_1.LinkHandler(this.content));
        }));
    }
    onResized() {
        const docMeta = this.model.docMeta;
        const pageMeta = DocMetas_1.DocMetas.getPageMeta(docMeta, 1);
        if (!pageMeta.pageInfo.dimensions) {
            const width = this.content.offsetWidth;
            const height = this.content.offsetHeight;
            pageMeta.pageInfo.dimensions = { width, height };
        }
    }
    _captureBrowserZoom() {
        JQuery_1.default(document).keydown(function (event) {
            if (event.ctrlKey && (event.which === 61 ||
                event.which === 107 ||
                event.which === 173 ||
                event.which === 109 ||
                event.which === 187 ||
                event.which === 189)) {
                log.info("Browser zoom detected. Preventing.");
                event.preventDefault();
            }
        });
        JQuery_1.default(window).bind('mousewheel DOMMouseScroll', function (event) {
            if (event.ctrlKey) {
                log.info("Browser zoom detected. Preventing.");
                event.preventDefault();
            }
        });
    }
    startHandlingZoom() {
        JQuery_1.default(".polar-zoom-select")
            .change(() => {
            this.doZoom();
        });
    }
    _configurePageWidth() {
        const descriptor = Preconditions_1.notNull(this.requestParams).descriptor;
        log.info("Loading with descriptor: ", descriptor);
        const docDimensions = Descriptors_1.Descriptors.calculateDocDimensions(descriptor);
        log.info(`Configuring page with width=${docDimensions.width} and minHeight=${docDimensions.minHeight}`);
        document.querySelectorAll("#content-parent, .page, iframe").forEach(element => {
            element.style.width = `${docDimensions.width}px`;
        });
        document.querySelectorAll(".page, iframe").forEach((element) => {
            const htmlElement = element;
            const minHeightElement = htmlElement.parentElement;
            minHeightElement.style.minHeight = `${docDimensions.minHeight}px`;
        });
    }
    doZoom() {
        const selectElement = document.querySelector(".polar-zoom-select");
        if (selectElement === null) {
            console.log("No select");
            return;
        }
        const zoom = selectElement.options[selectElement.selectedIndex].value;
        this.changeScale(parseFloat(zoom));
        selectElement.blur();
    }
    changeScale(scale) {
        log.info("Changing scale to: " + scale);
        this._changeScaleMeta(scale);
        this._changeScale(scale);
        this._removeAnnotations();
        this._signalScale();
    }
    _changeScaleMeta(scale) {
        const metaElement = Preconditions_1.notNull(document.querySelector("meta[name='polar-scale']"));
        metaElement.setAttribute("content", `${scale}`);
    }
    _changeScale(scale) {
        const contentParent = Preconditions_1.notNull(document.querySelector("#content-parent"));
        contentParent.style.transform = `scale(${scale})`;
        const height = parseInt(this.content.getAttribute('data-original-height'));
        const newHeight = height * scale;
        this.frameResizer.resize(true, newHeight)
            .catch(err => log.error("Unable to change scale: ", err));
    }
    _removeAnnotations() {
        document.querySelectorAll(".page .annotation").forEach(function (annotation) {
            annotation.parentElement.removeChild(annotation);
        });
    }
    _signalScale() {
        log.info("HTMLViewer: Signaling rescale.");
        const pageElement = Preconditions_1.notNull(document.querySelector(".page"));
        let endOfContent = Preconditions_1.notNull(pageElement.querySelector(".endOfContent"));
        Preconditions_1.notNull(Preconditions_1.notNull(endOfContent).parentElement).removeChild(endOfContent);
        endOfContent = document.createElement("div");
        endOfContent.setAttribute("class", "endOfContent");
        pageElement.appendChild(endOfContent);
    }
    _requestParams() {
        const url = new URL(window.location.href);
        return {
            file: Preconditions_1.notNull(url.searchParams.get("file")),
            descriptor: JSON.parse(Preconditions_1.notNull(url.searchParams.get("descriptor"))),
            fingerprint: Preconditions_1.notNull(url.searchParams.get("fingerprint"))
        };
    }
    _loadRequestData() {
        const params = this._requestParams();
        let file = params.file;
        if (!file) {
            file = "example1.html";
        }
        if (ENABLE_VIDEO && file.indexOf("youtube.com/") !== -1) {
            const embedHTML = HTMLViewer.createYoutubeEmbed(file, this.content);
            this.content.contentDocument.body.innerHTML = embedHTML;
            this.content.contentWindow.history.pushState({ "html": embedHTML, "pageTitle": 'Youtube Embed' }, "", file);
        }
        else {
            this.content.src = file;
        }
        const fingerprint = params.fingerprint;
        if (!fingerprint) {
            throw new Error("Fingerprint is required");
        }
        this.htmlFormat.setCurrentDocFingerprint(fingerprint);
    }
    static createYoutubeEmbed(url, content) {
        const DEFAULT_WIDTH = 560;
        const DEFAULT_HEIGHT = 315;
        const width = content.contentDocument.body.offsetWidth;
        const height = (DEFAULT_HEIGHT / DEFAULT_WIDTH) * width;
        const u = new URL(url);
        const videoID = u.searchParams.get('v');
        return `<iframe width="${width}" height="${height}" src="https://www.youtube.com/embed/${videoID}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    }
    docDetail() {
        const requestParams = Preconditions_1.notNull(this.requestParams);
        return {
            fingerprint: requestParams.fingerprint,
            title: requestParams.descriptor.title,
            url: requestParams.descriptor.url,
            nrPages: 1,
            filename: this.getFilename()
        };
    }
}
exports.HTMLViewer = HTMLViewer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSFRNTFZpZXdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkhUTUxWaWV3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDZEQUFnQztBQUNoQyxzQ0FBaUM7QUFDakMsZ0RBQTJDO0FBQzNDLHVEQUE0QztBQUk1QywrQ0FBMEM7QUFDMUMsMkRBQXNEO0FBQ3RELDJEQUFzRDtBQUN0RCx5REFBb0Q7QUFDcEQscUVBQWdFO0FBQ2hFLCtDQUEwQztBQUMxQyxtREFBOEM7QUFDOUMsaURBQTRDO0FBQzVDLGtFQUE2RDtBQUM3RCxzREFBaUQ7QUFNakQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQztBQUUxQixNQUFhLFVBQVcsU0FBUSxlQUFNO0lBZ0JsQyxZQUFZLEtBQVk7UUFDcEIsS0FBSyxFQUFFLENBQUM7UUFmSixZQUFPLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFOUQsa0JBQWEsR0FBZ0IsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUzRCxjQUFTLEdBQWdCLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdkQsa0JBQWEsR0FBeUIsSUFBSSxDQUFDO1FBVS9DLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFFTSxLQUFLO1FBRVIsR0FBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRWhDLElBQUksQ0FBQyxPQUFPLEdBQXVCLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLGFBQWEsR0FBaUIsUUFBUSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxTQUFTLEdBQWlCLFFBQVEsQ0FBQyxhQUFhLENBQUMsWUFBWSxD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RUFBRSxhQUFhLENBQUMsV0FBVztZQUN0QyxLQUFLLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxLQUFLO1lBQ3JDLEdBQUcsRUFBRSxhQUFhLENBQUMsVUFBVSxDQUFDLEdBQUc7WUFDakMsT0FBTyxFQUFFLENBQUM7WUFDVixRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRTtTQUMvQixDQUFDO0lBRU4sQ0FBQztDQUVKO0FBaFdELGdDQWdXQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAkIGZyb20gJy4uLy4uL3VpL0pRdWVyeSc7XG5pbXBvcnQge1ZpZXdlcn0gZnJvbSAnLi4vVmlld2VyJztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICcuLi8uLi9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7bm90TnVsbH0gZnJvbSAnLi4vLi4vUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge01vZGVsfSBmcm9tICcuLi8uLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge1BIWk1ldGFkYXRhfSBmcm9tICcuLi8uLi9waHovUEhaTWV0YWRhdGEnO1xuaW1wb3J0IHtEb2NEZXRhaWx9IGZyb20gJy4uLy4uL21ldGFkYXRhL0RvY0RldGFpbCc7XG5pbXBvcnQge0xpbmtIYW5kbGVyfSBmcm9tICcuL0xpbmtIYW5kbGVyJztcbmltcG9ydCB7U2VydmljZXN9IGZyb20gJy4uLy4uL3V0aWwvc2VydmljZXMvU2VydmljZXMnO1xuaW1wb3J0IHtIVE1MRm9ybWF0fSBmcm9tICcuLi8uLi9kb2Nmb3JtYXQvSFRNTEZvcm1hdCc7XG5pbXBvcnQge0ZyYW1lSW5pdGlhbGl6ZXJ9IGZyb20gJy4vRnJhbWVJbml0aWFsaXplcic7XG5pbXBvcnQge0JhY2tncm91bmRGcmFtZVJlc2l6ZXJ9IGZyb20gJy4vQmFja2dyb3VuZEZyYW1lUmVzaXplcic7XG5pbXBvcnQge0Rlc2NyaXB0b3JzfSBmcm9tICcuL0Rlc2NyaXB0b3JzJztcbmltcG9ydCB7SUZyYW1lV2F0Y2hlcn0gZnJvbSAnLi9JRnJhbWVXYXRjaGVyJztcbmltcG9ydCB7RnJhbWVSZXNpemVyfSBmcm9tICcuL0ZyYW1lUmVzaXplcic7XG5pbXBvcnQge1JlbmRlcmVyQW5hbHl0aWNzfSBmcm9tICcuLi8uLi9nYS9SZW5kZXJlckFuYWx5dGljcyc7XG5pbXBvcnQge0RvY01ldGFzfSBmcm9tICcuLi8uLi9tZXRhZGF0YS9Eb2NNZXRhcyc7XG5pbXBvcnQge0NhcHR1cmVkU2NyZWVuc2hvdHN9IGZyb20gJy4uLy4uL3NjcmVlbnNob3RzL0NhcHR1cmVkU2NyZWVuc2hvdHMnO1xuaW1wb3J0IHtWaWV3ZXJTY3JlZW5zaG90c30gZnJvbSAnLi4vVmlld2VyU2NyZWVuc2hvdHMnO1xuaW1wb3J0IHtBcnJheXN9IGZyb20gJy4uLy4uL3V0aWwvQXJyYXlzJztcbmltcG9ydCB7RWxlbWVudHN9IGZyb20gJy4uLy4uL3V0aWwvRWxlbWVudHMnO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmNvbnN0IEVOQUJMRV9WSURFTyA9IHRydWU7XG5cbmV4cG9ydCBjbGFzcyBIVE1MVmlld2VyIGV4dGVuZHMgVmlld2VyIHtcblxuICAgIHByaXZhdGUgY29udGVudDogSFRNTElGcmFtZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTtcblxuICAgIHByaXZhdGUgY29udGVudFBhcmVudDogSFRNTEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgIHByaXZhdGUgdGV4dExheWVyOiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgcHJpdmF0ZSByZXF1ZXN0UGFyYW1zOiBSZXF1ZXN0UGFyYW1zIHwgbnVsbCA9IG51bGw7XG5cbiAgICBwcml2YXRlIGh0bWxGb3JtYXQ6IGFueTtcblxuICAgIHByaXZhdGUgZnJhbWVSZXNpemVyPzogRnJhbWVSZXNpemVyO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBtb2RlbDogTW9kZWw7XG5cbiAgICBjb25zdHJ1Y3Rvcihtb2RlbDogTW9kZWwpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICBsb2cuaW5mbyhcIlN0YXJ0aW5nIEhUTUxWaWV3ZXJcIik7XG5cbiAgICAgICAgdGhpcy5jb250ZW50ID0gPEhUTUxJRnJhbWVFbGVtZW50PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI2NvbnRlbnRcIik7XG4gICAgICAgIHRoaXMuY29udGVudFBhcmVudCA9IDxIVE1MRWxlbWVudD4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiNjb250ZW50LXBhcmVudFwiKTtcbiAgICAgICAgdGhpcy50ZXh0TGF5ZXIgPSA8SFRNTEVsZW1lbnQ+IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIudGV4dExheWVyXCIpO1xuXG4gICAgICAgIHRoaXMuaHRtbEZvcm1hdCA9IG5ldyBIVE1MRm9ybWF0KCk7XG5cbiAgICAgICAgUmVuZGVyZXJBbmFseXRpY3MucGFnZXZpZXcoXCIvaHRtbHZpZXdlclwiKTtcblxuICAgICAgICAvLyAqKiogc3RhcnQgdGhlIHJlc2l6ZXIgYW5kIGluaXRpYWxpemVyIGJlZm9yZSBzZXR0aW5nIHRoZSBpZnJhbWVcblxuICAgICAgICB0aGlzLnJlcXVlc3RQYXJhbXMgPSB0aGlzLl9yZXF1ZXN0UGFyYW1zKCk7XG5cbiAgICAgICAgJChkb2N1bWVudCkucmVhZHkoYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgICAgICB0aGlzLl9jYXB0dXJlQnJvd3Nlclpvb20oKTtcblxuICAgICAgICAgICAgdGhpcy5fbG9hZFJlcXVlc3REYXRhKCk7XG5cbiAgICAgICAgICAgIHRoaXMuX2NvbmZpZ3VyZVBhZ2VXaWR0aCgpO1xuXG4gICAgICAgICAgICB0aGlzLmZyYW1lUmVzaXplciA9IG5ldyBGcmFtZVJlc2l6ZXIodGhpcy5jb250ZW50UGFyZW50LCB0aGlzLmNvbnRlbnQpO1xuXG4gICAgICAgICAgICBuZXcgSUZyYW1lV2F0Y2hlcih0aGlzLmNvbnRlbnQsICgpID0+IHtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiTG9hZGluZyBwYWdlIG5vdy4uLlwiKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGJhY2tncm91bmRGcmFtZVJlc2l6ZXJcbiAgICAgICAgICAgICAgICAgICAgPSBuZXcgQmFja2dyb3VuZEZyYW1lUmVzaXplcih0aGlzLmNvbnRlbnRQYXJlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IHRoaXMub25SZXNpemVkKCkpO1xuXG4gICAgICAgICAgICAgICAgYmFja2dyb3VuZEZyYW1lUmVzaXplci5zdGFydCgpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgZnJhbWVJbml0aWFsaXplciA9IG5ldyBGcmFtZUluaXRpYWxpemVyKHRoaXMuY29udGVudCwgdGhpcy50ZXh0TGF5ZXIpO1xuICAgICAgICAgICAgICAgIGZyYW1lSW5pdGlhbGl6ZXIuc3RhcnQoKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRIYW5kbGluZ1pvb20oKTtcblxuICAgICAgICAgICAgfSkuc3RhcnQoKTtcblxuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZG9ab29tKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5mcmFtZVJlc2l6ZXIhLnJlc2l6ZSh0cnVlKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IGxvZy5lcnJvcihcIlVuYWJsZSB0byByZXNpemU6IFwiLCBlcnIpKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IFNlcnZpY2VzLnN0YXJ0KG5ldyBMaW5rSGFuZGxlcih0aGlzLmNvbnRlbnQpKTtcblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgb25SZXNpemVkKCkge1xuXG4gICAgICAgIGNvbnN0IGRvY01ldGEgPSB0aGlzLm1vZGVsLmRvY01ldGE7XG5cbiAgICAgICAgY29uc3QgcGFnZU1ldGEgPSBEb2NNZXRhcy5nZXRQYWdlTWV0YShkb2NNZXRhLCAxKTtcblxuICAgICAgICBpZiAoISBwYWdlTWV0YS5wYWdlSW5mby5kaW1lbnNpb25zKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gdGhpcy5jb250ZW50Lm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jb250ZW50Lm9mZnNldEhlaWdodDtcblxuICAgICAgICAgICAgcGFnZU1ldGEucGFnZUluZm8uZGltZW5zaW9ucyA9IHt3aWR0aCwgaGVpZ2h0fTtcblxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmlld2VyU2NyZWVuc2hvdHMuZG9TY3JlZW5zaG90KCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIF9jYXB0dXJlQnJvd3Nlclpvb20oKSB7XG5cbiAgICAgICAgLy8gVE9ETzogZm9yIG5vdyB0aGlzIGlzIHVzZWQgdG8ganVzdCBjYXB0dXJlIGFuZCBkaXNhYmxlIHpvb20gYnV0XG4gICAgICAgIC8vIHdlIHNob3VsZCBlbmFibGUgaXQgaW4gdGhlIGZ1dHVyZSBzbyB3ZSBjYW4gaGFuZGxlIHpvb20gb3Vyc2VsdmVzLlxuXG4gICAgICAgICQoZG9jdW1lbnQpLmtleWRvd24oZnVuY3Rpb24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcblxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgJiYgKGV2ZW50LndoaWNoID09PSA2MSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LndoaWNoID09PSAxMDcgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC53aGljaCA9PT0gMTczIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQud2hpY2ggPT09IDEwOSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LndoaWNoID09PSAxODcgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC53aGljaCA9PT0gMTg5ICkgKSB7XG5cbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIkJyb3dzZXIgem9vbSBkZXRlY3RlZC4gUHJldmVudGluZy5cIik7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gMTA3IE51bSBLZXkgICtcbiAgICAgICAgICAgIC8vIDEwOSBOdW0gS2V5ICAtXG4gICAgICAgICAgICAvLyAxNzMgTWluIEtleSAgaHlwaGVuL3VuZGVyc2NvciBIZXlcbiAgICAgICAgICAgIC8vIDYxIFBsdXMga2V5ICArLz0ga2V5XG4gICAgICAgIH0pO1xuXG4gICAgICAgICQod2luZG93KS5iaW5kKCdtb3VzZXdoZWVsIERPTU1vdXNlU2Nyb2xsJywgZnVuY3Rpb24oZXZlbnQ6IE1vdXNlRXZlbnQpIHtcblxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkpIHtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiQnJvd3NlciB6b29tIGRldGVjdGVkLiBQcmV2ZW50aW5nLlwiKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydEhhbmRsaW5nWm9vbSgpIHtcblxuICAgICAgICAkKFwiLnBvbGFyLXpvb20tc2VsZWN0XCIpXG4gICAgICAgICAgICAuY2hhbmdlKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmRvWm9vbSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBwYWdlIHdpZHRoIGZyb20gdGhlIGRlc2NyaXB0b3IgaWYgaXQncyBwcmVzZW50IGFuZCB1c2UgdGhhdC5cbiAgICAgKlxuICAgICAqIE90aGVyd2lzZSwgdXNlIHRoZSBkZWZhdWx0cy5cbiAgICAgKi9cbiAgICBwcml2YXRlIF9jb25maWd1cmVQYWdlV2lkdGgoKSB7XG5cbiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IG5vdE51bGwodGhpcy5yZXF1ZXN0UGFyYW1zKS5kZXNjcmlwdG9yO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiTG9hZGluZyB3aXRoIGRlc2NyaXB0b3I6IFwiLCBkZXNjcmlwdG9yKTtcblxuICAgICAgICBjb25zdCBkb2NEaW1lbnNpb25zID0gRGVzY3JpcHRvcnMuY2FsY3VsYXRlRG9jRGltZW5zaW9ucyhkZXNjcmlwdG9yKTtcblxuICAgICAgICBsb2cuaW5mbyhgQ29uZmlndXJpbmcgcGFnZSB3aXRoIHdpZHRoPSR7ZG9jRGltZW5zaW9ucy53aWR0aH0gYW5kIG1pbkhlaWdodD0ke2RvY0RpbWVuc2lvbnMubWluSGVpZ2h0fWApO1xuXG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIjY29udGVudC1wYXJlbnQsIC5wYWdlLCBpZnJhbWVcIikuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgIChlbGVtZW50IGFzIEhUTUxFbGVtZW50KS5zdHlsZS53aWR0aCA9IGAke2RvY0RpbWVuc2lvbnMud2lkdGh9cHhgO1xuICAgICAgICB9KTtcblxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnBhZ2UsIGlmcmFtZVwiKS5mb3JFYWNoKChlbGVtZW50KSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGh0bWxFbGVtZW50ID0gZWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IG1pbkhlaWdodEVsZW1lbnQgPSBodG1sRWxlbWVudC5wYXJlbnRFbGVtZW50ITtcblxuICAgICAgICAgICAgbWluSGVpZ2h0RWxlbWVudC5zdHlsZS5taW5IZWlnaHQgPSBgJHtkb2NEaW1lbnNpb25zLm1pbkhlaWdodH1weGA7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgZG9ab29tKCkge1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdEVsZW1lbnQ6IEhUTUxTZWxlY3RFbGVtZW50IHwgbnVsbFxuICAgICAgICAgICAgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBvbGFyLXpvb20tc2VsZWN0XCIpO1xuXG4gICAgICAgIGlmIChzZWxlY3RFbGVtZW50ID09PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vIHNlbGVjdFwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHpvb20gPSBzZWxlY3RFbGVtZW50Lm9wdGlvbnNbc2VsZWN0RWxlbWVudC5zZWxlY3RlZEluZGV4XS52YWx1ZTtcblxuICAgICAgICB0aGlzLmNoYW5nZVNjYWxlKHBhcnNlRmxvYXQoem9vbSkpO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgc2VsZWN0IGRvZXNuJ3QgaGF2ZSBmb2N1cyBzbyB0aGF0IHdlIGNhbiBzY3JvbGwuXG4gICAgICAgIHNlbGVjdEVsZW1lbnQuYmx1cigpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGNoYW5nZVNjYWxlKHNjYWxlOiBudW1iZXIpIHtcblxuICAgICAgICBsb2cuaW5mbyhcIkNoYW5naW5nIHNjYWxlIHRvOiBcIiArIHNjYWxlKTtcblxuICAgICAgICB0aGlzLl9jaGFuZ2VTY2FsZU1ldGEoc2NhbGUpO1xuICAgICAgICB0aGlzLl9jaGFuZ2VTY2FsZShzY2FsZSk7XG4gICAgICAgIHRoaXMuX3JlbW92ZUFubm90YXRpb25zKCk7XG4gICAgICAgIHRoaXMuX3NpZ25hbFNjYWxlKCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIF9jaGFuZ2VTY2FsZU1ldGEoc2NhbGU6IG51bWJlcikge1xuXG4gICAgICAgIGNvbnN0IG1ldGFFbGVtZW50ID0gbm90TnVsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwibWV0YVtuYW1lPSdwb2xhci1zY2FsZSddXCIpKTtcblxuICAgICAgICBtZXRhRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJjb250ZW50XCIsIGAke3NjYWxlfWApO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2hhbmdlU2NhbGUoc2NhbGU6IG51bWJlcikge1xuXG4gICAgICAgIC8vIE5PVEU6IHJlbW92aW5nIHRoZSBpZnJhbWUgYW5kIGFkZGluZyBpdCBiYWNrIGluIGZpeGVkIGEgbWFqb3IgcHJvYmxlbVxuICAgICAgICAvLyB3aXRoIGZvbnQgZnV6emluZXNzIG9uIENocm9tZS9FbGVjdHJvbi4gIFRlY2huaWNhbGx5IGl0IHNob3VsZCBiZVxuICAgICAgICAvLyBwb3NzaWJsZSB0byByZXNpemUgdGhlIGlmcmFtZSB2aWEgc2NhbGUgYWxvbmUgYnV0IEkgZG9uJ3QgdGhpbmtcbiAgICAgICAgLy8gY2hyb21lIHJlLXJlbmRlcnMgdGhlIGZvbnRzIHVubGVzcyBzaWduaWZpY2FudCBzY2FsZSBjaGFuZ2VzIGFyZVxuICAgICAgICAvLyBtYWRlLlxuXG4gICAgICAgIC8vIGNvbnN0IGlmcmFtZSA9IG5vdE51bGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImlmcmFtZVwiKSk7XG4gICAgICAgIC8vIGNvbnN0IGlmcmFtZVBhcmVudEVsZW1lbnQgPSBpZnJhbWUucGFyZW50RWxlbWVudDtcblxuICAgICAgICAvLyBUT0RPOiB3ZSB3ZXJlIGV4cGVyaW1lbnRpbmcgd2l0aCBhZGRpbmcrcmVtb3ZpbmcgdGhlIGNoaWxkIGlmcmFtZXNcbiAgICAgICAgLy8gYnV0IGRlY2lkZWQgdG8gYmFjayBvdXQgdGhlIGNvZGUgYXMgaXQgd2FzIGRlLWFjdGl2YXRpbmcgdGhlIGlmcmFtZXNcbiAgICAgICAgLy8gYW5kIEkgY291bGRuJ3QgY2xpY2sgb24gdGhlbS5cblxuICAgICAgICAvLyBpZnJhbWVQYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGlmcmFtZSk7XG5cbiAgICAgICAgLy8gRklYTUU6IHJ1biBhbiBhbGdvcml0aG0gdG8gbWFrZSBzdXJlIHRoZXJlIGFyZSBubyBlbGVtZW50cyBiZXR3ZWVuXG4gICAgICAgIC8vIHR3byBwYXRocyBpbiB0aGUgRE9NIHRoYXQgaGF2ZSBhbnkgc2Nyb2xsSGVpZ2h0ID4gdGhlaXIgaGVpZ2h0LlxuXG4gICAgICAgIGNvbnN0IGNvbnRlbnRQYXJlbnQgPSBub3ROdWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjY29udGVudC1wYXJlbnRcIikpO1xuICAgICAgICAoY29udGVudFBhcmVudCBhcyBIVE1MRWxlbWVudCkuc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlKCR7c2NhbGV9KWA7XG5cbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gcGFyc2VJbnQodGhpcy5jb250ZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1vcmlnaW5hbC1oZWlnaHQnKSEpO1xuICAgICAgICBjb25zdCBuZXdIZWlnaHQgPSBoZWlnaHQgKiBzY2FsZTtcblxuICAgICAgICB0aGlzLmZyYW1lUmVzaXplciEucmVzaXplKHRydWUsIG5ld0hlaWdodClcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gbG9nLmVycm9yKFwiVW5hYmxlIHRvIGNoYW5nZSBzY2FsZTogXCIsIGVycikpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVtb3ZlQW5ub3RhdGlvbnMoKSB7XG4gICAgICAgIC8vIHJlbW92ZSBhbGwgYW5ub3RhdGlvbnMgZnJvbSB0aGUgLnBhZ2UuIHRoZXkgd2lsbCBiZSByZS1jcmVhdGVkIGJ5XG4gICAgICAgIC8vIGFsbCB0aGUgdmlld3MuIFRoZSBQREYgdmlld2VyIGRvZXMgdGhpcyBmb3IgdXMgYXV0b21hdGljYWxseS5cblxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnBhZ2UgLmFubm90YXRpb25cIikuZm9yRWFjaChmdW5jdGlvbihhbm5vdGF0aW9uKSB7XG4gICAgICAgICAgICAoYW5ub3RhdGlvbi5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50KS5yZW1vdmVDaGlsZChhbm5vdGF0aW9uKTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvLyByZW1vdmUgYW5kIHJlLWluamVjdCBhbiBlbmRPZkNvbnRlbnQgZWxlbWVudCB0byB0cmlnZ2VyIHRoZSB2aWV3IHRvXG4gICAgLy8gcmUtZHJhdyBwYWdlbWFya3MuXG4gICAgcHJpdmF0ZSBfc2lnbmFsU2NhbGUoKSB7XG5cbiAgICAgICAgbG9nLmluZm8oXCJIVE1MVmlld2VyOiBTaWduYWxpbmcgcmVzY2FsZS5cIik7XG5cbiAgICAgICAgY29uc3QgcGFnZUVsZW1lbnQgPSBub3ROdWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucGFnZVwiKSk7XG4gICAgICAgIGxldCBlbmRPZkNvbnRlbnQgPSBub3ROdWxsKHBhZ2VFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZW5kT2ZDb250ZW50XCIpKTtcblxuICAgICAgICBub3ROdWxsKG5vdE51bGwoZW5kT2ZDb250ZW50KS5wYXJlbnRFbGVtZW50KS5yZW1vdmVDaGlsZChlbmRPZkNvbnRlbnQpO1xuXG4gICAgICAgIGVuZE9mQ29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIGVuZE9mQ29udGVudC5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcImVuZE9mQ29udGVudFwiICk7XG5cbiAgICAgICAgcGFnZUVsZW1lbnQuYXBwZW5kQ2hpbGQoZW5kT2ZDb250ZW50KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgcmVxdWVzdCBwYXJhbXMgYXMgYSBkaWN0aW9uYXJ5LlxuICAgICAqL1xuICAgIHByaXZhdGUgX3JlcXVlc3RQYXJhbXMoKTogUmVxdWVzdFBhcmFtcyB7XG5cbiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCh3aW5kb3cubG9jYXRpb24uaHJlZik7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZpbGU6IG5vdE51bGwodXJsLnNlYXJjaFBhcmFtcy5nZXQoXCJmaWxlXCIpKSxcbiAgICAgICAgICAgIGRlc2NyaXB0b3I6IEpTT04ucGFyc2Uobm90TnVsbCh1cmwuc2VhcmNoUGFyYW1zLmdldChcImRlc2NyaXB0b3JcIikpKSxcbiAgICAgICAgICAgIGZpbmdlcnByaW50OiBub3ROdWxsKHVybC5zZWFyY2hQYXJhbXMuZ2V0KFwiZmluZ2VycHJpbnRcIikpXG4gICAgICAgIH07XG5cbiAgICB9XG5cblxuICAgIHByaXZhdGUgX2xvYWRSZXF1ZXN0RGF0YSgpIHtcblxuICAgICAgICAvLyAqKiogbm93IHNldHVwIHRoZSBpZnJhbWVcblxuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLl9yZXF1ZXN0UGFyYW1zKCk7XG5cbiAgICAgICAgbGV0IGZpbGUgPSBwYXJhbXMuZmlsZTtcblxuICAgICAgICBpZiAoIWZpbGUpIHtcbiAgICAgICAgICAgIGZpbGUgPSBcImV4YW1wbGUxLmh0bWxcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IGltcHJvdmUgdGhpcyBzbyB0aGF0IHdlIGNhbiBkZXRlY3QgaWYgdGhpcyBpcyBhIFlvdXR1YmUgdmlkZW9cbiAgICAgICAgLy8gZW1iZWQgc2FmZWx5LlxuICAgICAgICBpZiAoRU5BQkxFX1ZJREVPICYmIGZpbGUuaW5kZXhPZihcInlvdXR1YmUuY29tL1wiKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIC8vIFRPRE86IGJldHRlciByZWdleCBmb3IgdGhpcyBpbiB0aGUgZnV0dXJlLlxuXG4gICAgICAgICAgICBjb25zdCBlbWJlZEhUTUwgPSBIVE1MVmlld2VyLmNyZWF0ZVlvdXR1YmVFbWJlZChmaWxlLCB0aGlzLmNvbnRlbnQpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQuY29udGVudERvY3VtZW50IS5ib2R5LmlubmVySFRNTCA9IGVtYmVkSFRNTDtcblxuICAgICAgICAgICAgdGhpcy5jb250ZW50LmNvbnRlbnRXaW5kb3chLmhpc3RvcnkucHVzaFN0YXRlKHtcImh0bWxcIjogZW1iZWRIVE1MLCBcInBhZ2VUaXRsZVwiOiAnWW91dHViZSBFbWJlZCd9LCBcIlwiLCBmaWxlKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnNyYyA9IGZpbGU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmaW5nZXJwcmludCA9IHBhcmFtcy5maW5nZXJwcmludDtcbiAgICAgICAgaWYgKCFmaW5nZXJwcmludCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmluZ2VycHJpbnQgaXMgcmVxdWlyZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmh0bWxGb3JtYXQuc2V0Q3VycmVudERvY0ZpbmdlcnByaW50KGZpbmdlcnByaW50KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZVlvdXR1YmVFbWJlZCh1cmw6IHN0cmluZywgY29udGVudDogSFRNTElGcmFtZUVsZW1lbnQpIHtcblxuICAgICAgICBjb25zdCBERUZBVUxUX1dJRFRIID0gNTYwO1xuICAgICAgICBjb25zdCBERUZBVUxUX0hFSUdIVCA9IDMxNTtcblxuICAgICAgICBjb25zdCB3aWR0aCA9IGNvbnRlbnQuY29udGVudERvY3VtZW50IS5ib2R5Lm9mZnNldFdpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSAoREVGQVVMVF9IRUlHSFQgLyBERUZBVUxUX1dJRFRIKSAqIHdpZHRoO1xuXG4gICAgICAgIC8vIGdldCB0aGUgdmlkZW8gSUQgZnJvbSBhIFVSTCBsaWtlOlxuICAgICAgICAvL1xuICAgICAgICAvLyBodHRwczovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PUNQMUJWcEYtTmpZXG5cbiAgICAgICAgY29uc3QgdSA9IG5ldyBVUkwodXJsKTtcbiAgICAgICAgY29uc3QgdmlkZW9JRCA9IHUuc2VhcmNoUGFyYW1zLmdldCgndicpO1xuXG4gICAgICAgIHJldHVybiBgPGlmcmFtZSB3aWR0aD1cIiR7d2lkdGh9XCIgaGVpZ2h0PVwiJHtoZWlnaHR9XCIgc3JjPVwiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvJHt2aWRlb0lEfVwiIGZyYW1lYm9yZGVyPVwiMFwiIGFsbG93PVwiYXV0b3BsYXk7IGVuY3J5cHRlZC1tZWRpYVwiIGFsbG93ZnVsbHNjcmVlbj48L2lmcmFtZT5gO1xuICAgIH1cblxuICAgIHB1YmxpYyBkb2NEZXRhaWwoKTogRG9jRGV0YWlsIHtcblxuICAgICAgICBjb25zdCByZXF1ZXN0UGFyYW1zID0gbm90TnVsbCh0aGlzLnJlcXVlc3RQYXJhbXMpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmaW5nZXJwcmludDogcmVxdWVzdFBhcmFtcy5maW5nZXJwcmludCxcbiAgICAgICAgICAgIHRpdGxlOiByZXF1ZXN0UGFyYW1zLmRlc2NyaXB0b3IudGl0bGUsXG4gICAgICAgICAgICB1cmw6IHJlcXVlc3RQYXJhbXMuZGVzY3JpcHRvci51cmwsXG4gICAgICAgICAgICBuclBhZ2VzOiAxLFxuICAgICAgICAgICAgZmlsZW5hbWU6IHRoaXMuZ2V0RmlsZW5hbWUoKVxuICAgICAgICB9O1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBSZXF1ZXN0UGFyYW1zIHtcbiAgICBmaWxlOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRvcjogUEhaTWV0YWRhdGE7XG4gICAgZmluZ2VycHJpbnQ6IHN0cmluZztcbn1cbiJdfQ==