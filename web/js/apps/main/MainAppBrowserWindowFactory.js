"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const Logger_1 = require("../../logger/Logger");
const ResourcePaths_1 = require("../../electron/webresource/ResourcePaths");
const log = Logger_1.Logger.create();
const WIDTH = 900 * 1.2;
const HEIGHT = 1100 * 1.2;
const SIDEBAR_BUFFER = 100;
const DEFAULT_URL = ResourcePaths_1.ResourcePaths.resourceURLFromRelativeURL('./apps/home/default.html');
exports.APP_ICON = ResourcePaths_1.ResourcePaths.resourceURLFromRelativeURL('./icon.png');
exports.BROWSER_WINDOW_OPTIONS = Object.freeze({
    backgroundColor: '#FFF',
    width: WIDTH + SIDEBAR_BUFFER,
    height: HEIGHT,
    show: false,
    icon: exports.APP_ICON,
    webPreferences: {
        nodeIntegration: true,
        defaultEncoding: 'UTF-8',
        webSecurity: false,
        webaudio: true,
        partition: "persist:polar"
    }
});
class MainAppBrowserWindowFactory {
    static createWindow(browserWindowOptions = exports.BROWSER_WINDOW_OPTIONS, url = DEFAULT_URL) {
        browserWindowOptions = Object.assign({}, browserWindowOptions);
        const position = this.computeXY();
        if (position) {
            browserWindowOptions.x = position.x;
            browserWindowOptions.y = position.y;
        }
        const display = electron_1.screen.getPrimaryDisplay();
        const MIN_FACTOR = 0.4;
        const dimensionMappings = [
            { original: 'minHeight', dimension: 'height', defaultValue: display.size.width * MIN_FACTOR },
            { original: 'minWidth', dimension: 'width', defaultValue: display.size.height * MIN_FACTOR },
            { original: 'height', dimension: 'height' },
            { original: 'width', dimension: 'width' }
        ];
        for (const dimensionMapping of dimensionMappings) {
            const current = browserWindowOptions[dimensionMapping.original] || dimensionMapping.defaultValue;
            const max = display.size[dimensionMapping.dimension];
            browserWindowOptions[dimensionMapping.original]
                = Math.min(current, max);
        }
        log.info(`Creating window for URL: ${url} in partition ${browserWindowOptions.webPreferences.partition}`);
        const browserWindow = new electron_1.BrowserWindow(browserWindowOptions);
        browserWindow.on('close', function (e) {
            e.preventDefault();
            if (browserWindow.webContents) {
                browserWindow.webContents.clearHistory();
                browserWindow.webContents.session.clearCache(() => {
                    browserWindow.destroy();
                });
            }
        });
        browserWindow.webContents.on('new-window', (e, url) => {
            e.preventDefault();
            electron_1.shell.openExternal(url);
        });
        browserWindow.webContents.on('will-navigate', (e, navURL) => {
            const parsedURL = new URL(navURL);
            const host = parsedURL.hostname;
            const allowedHosts = ["accounts.google.com",
                "polar-32b0f.firebaseapp.com",
                "accountchooser.com",
                "www.accountchooser.com",
                "localhost"];
            if (host === "localhost") {
                log.info("Always allowing localhost URL");
                return;
            }
            if (navURL.startsWith("https://") && allowedHosts.includes(host)) {
                log.info("Allowing URL for authentication: " + navURL);
                return;
            }
            log.info("Attempt to navigate to new URL: ", navURL);
            e.preventDefault();
            electron_1.shell.openExternal(navURL);
        });
        log.info("Loading URL: " + url);
        browserWindow.loadURL(url);
        return new Promise(resolve => {
            browserWindow.once('ready-to-show', () => {
                browserWindow.webContents.setZoomFactor(1.0);
                browserWindow.show();
                resolve(browserWindow);
            });
        });
    }
    static computeXY() {
        const offset = 35;
        const focusedWindow = electron_1.BrowserWindow.getFocusedWindow();
        if (focusedWindow) {
            const position = focusedWindow.getPosition();
            let x = position[0];
            let y = position[1];
            x += offset;
            y += offset;
            return { x, y };
        }
        return undefined;
    }
}
exports.MainAppBrowserWindowFactory = MainAppBrowserWindowFactory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQThGO0FBQzlGLGdEQUEyQztBQUMzQyw0RUFBdUU7QUFFdkUsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQU0sS0FBSyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUM7QUFDeEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQztBQUMxQixNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUM7QUFFM0IsTUFBTSxXQUFXLEdBQUcsNkJBQWEsQ0FBQywwQkFBMEIsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBSTVFLFFBQUEsUUFBUSxHQUFHLDZCQUFhLENBQUMsMEJBQTBCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFbEUsUUFBQSxzQkFBc0IsR0FBNkMsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUMxRixlQUFlLEVBQUUsTUFBTTtJQUN2QixLQUFLLEVBQUUsS0FBSyxHQUFHLGNBQWM7SUFDN0IsTUFBTSxFQUFFLE1BQU07SUFDZCxJQUFJLEVBQUUsS0FBSztJQUlYLElBQUksRUFBRSxnQkFBUTtJQUNkLGNBQWMsRUFBRTtRQUlaLGVBQWUsRUFBRSxJQUFJO1FBU3JCLGVBQWUsRUFBRSxPQUFPO1FBS3hCLFdBQVcsRUFBRSxLQUFLO1FBRWxCLFFBQVEsRUFBRSxJQUFJO1FBT2QsU0FBUyxFQUFFLGVBQWU7S0FFN0I7Q0FFSixDQUFDLENBQUM7QUFFSCxNQUFhLDJCQUEyQjtJQUU3QixNQUFNLENBQUMsWUFBWSxDQUFDLHVCQUFpRSw4QkFBc0IsRUFDdkYsR0FBRyxHQUFHLFdBQVc7UUFFeEMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUUvRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFbEMsSUFBSSxRQUFRLEVBQUU7WUFJVixvQkFBb0IsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNwQyxvQkFBb0IsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUN2QztRQUVELE1BQU0sT0FBTyxHQUFHLGlCQUFNLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQVczQyxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFFdkIsTUFBTSxpQkFBaUIsR0FBdUI7WUFFMUMsRUFBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLFVBQVUsRUFBQztZQUMzRixFQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsVUFBVSxFQUFDO1lBRTFGLEVBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFDO1lBQ3pDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFDO1NBRTFDLENBQUM7UUFFRixLQUFLLE1BQU0sZ0JBQWdCLElBQUksaUJBQWlCLEVBQUU7WUFFOUMsTUFBTSxPQUFPLEdBQUcsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFFLElBQUksZ0JBQWdCLENBQUMsWUFBYSxDQUFDO1lBQ25HLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFckQsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDO2tCQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztTQUVoQztRQUVELEdBQUcsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEdBQUcsaUJBQWlCLG9CQUFvQixDQUFDLGNBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRzNHLE1BQU0sYUFBYSxHQUFHLElBQUksd0JBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRTlELGFBQWEsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQztZQUNoQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7WUFFbkIsSUFBSSxhQUFhLENBQUMsV0FBVyxFQUFFO2dCQUUzQixhQUFhLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUN6QyxhQUFhLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO29CQUM5QyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzVCLENBQUMsQ0FBQyxDQUFDO2FBRU47UUFFTCxDQUFDLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNsRCxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDbkIsZ0JBQUssQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxhQUFhLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFLeEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFbEMsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUVoQyxNQUFNLFlBQVksR0FBRyxDQUFDLHFCQUFxQjtnQkFDckIsNkJBQTZCO2dCQUM3QixvQkFBb0I7Z0JBQ3BCLHdCQUF3QjtnQkFDeEIsV0FBVyxDQUFDLENBQUM7WUFFbkMsSUFBSSxJQUFJLEtBQUssV0FBVyxFQUFFO2dCQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUM7Z0JBQzFDLE9BQU87YUFDVjtZQUVELElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM5RCxHQUFHLENBQUMsSUFBSSxDQUFDLG1DQUFtQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO2dCQUN2RCxPQUFPO2FBQ1Y7WUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBR3JELENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNuQixnQkFBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvQixDQUFDLENBQUMsQ0FBQztRQUVILEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFM0IsT0FBTyxJQUFJLE9BQU8sQ0FBZ0IsT0FBTyxDQUFDLEVBQUU7WUFFeEMsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO2dCQU1yQyxhQUFhLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFN0MsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUVyQixPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFM0IsQ0FBQyxDQUFDLENBQUM7UUFFUCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFTyxNQUFNLENBQUMsU0FBUztRQUVwQixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFFbEIsTUFBTSxhQUFhLEdBQUcsd0JBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRXZELElBQUksYUFBYSxFQUFFO1lBQ2YsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEIsQ0FBQyxJQUFJLE1BQU0sQ0FBQztZQUNaLENBQUMsSUFBSSxNQUFNLENBQUM7WUFFWixPQUFPLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBQyxDQUFDO1NBRWpCO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFFckIsQ0FBQztDQUVKO0FBeEpELGtFQXdKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QnJvd3NlcldpbmRvdywgbmF0aXZlSW1hZ2UsIHNoZWxsLCBEb3dubG9hZEl0ZW0sIFdlYkNvbnRlbnRzLCBzY3JlZW59IGZyb20gXCJlbGVjdHJvblwiO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJy4uLy4uL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtSZXNvdXJjZVBhdGhzfSBmcm9tICcuLi8uLi9lbGVjdHJvbi93ZWJyZXNvdXJjZS9SZXNvdXJjZVBhdGhzJztcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5jb25zdCBXSURUSCA9IDkwMCAqIDEuMjsgLy8gMTMwMCBpcyBsaWtlIDgwJSBvZiB1c2Vyc1xuY29uc3QgSEVJR0hUID0gMTEwMCAqIDEuMjtcbmNvbnN0IFNJREVCQVJfQlVGRkVSID0gMTAwO1xuXG5jb25zdCBERUZBVUxUX1VSTCA9IFJlc291cmNlUGF0aHMucmVzb3VyY2VVUkxGcm9tUmVsYXRpdmVVUkwoJy4vYXBwcy9ob21lL2RlZmF1bHQuaHRtbCcpO1xuXG4vLyBUT0RPOiBmaWxlcyBpbiB0aGUgcm9vdCBhcmUgYWx3YXlzIGtlcHQgaW4gdGhlIHBhY2thZ2Ugd2UgY2FuIGp1c3QgbG9hZFxuLy8gdGhpcyBhcyBhIG5hdGl2ZV9pbWFnZSBkaXJlY3RseS5cbmV4cG9ydCBjb25zdCBBUFBfSUNPTiA9IFJlc291cmNlUGF0aHMucmVzb3VyY2VVUkxGcm9tUmVsYXRpdmVVUkwoJy4vaWNvbi5wbmcnKTtcblxuZXhwb3J0IGNvbnN0IEJST1dTRVJfV0lORE9XX09QVElPTlM6IEVsZWN0cm9uLkJyb3dzZXJXaW5kb3dDb25zdHJ1Y3Rvck9wdGlvbnMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjRkZGJyxcbiAgICB3aWR0aDogV0lEVEggKyBTSURFQkFSX0JVRkZFUixcbiAgICBoZWlnaHQ6IEhFSUdIVCxcbiAgICBzaG93OiBmYWxzZSxcbiAgICAvLyBodHRwczovL2VsZWN0cm9uanMub3JnL2RvY3MvYXBpL2Jyb3dzZXItd2luZG93I25ldy1icm93c2Vyd2luZG93b3B0aW9uc1xuXG4gICAgLy8gVE9ETzogdGhlIEFwcEljb24gQ0FOIGJlIGEgZmlsZSBVUkxcbiAgICBpY29uOiBBUFBfSUNPTixcbiAgICB3ZWJQcmVmZXJlbmNlczoge1xuICAgICAgICAvLyBUT0RPOlxuICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZWxlY3Ryb24vZWxlY3Ryb24vcHVsbC83OTRcbiAgICAgICAgLy9cbiAgICAgICAgbm9kZUludGVncmF0aW9uOiB0cnVlLFxuXG4gICAgICAgIC8vIE5PVEU6IHRoZXNlIG11c3QgYmUgZGlzYWJsZWQgYmVjYXVzZSB0aGV5IGJyZWFrIHBkZi5qcy4gIEl0IG11c3QgYmVcbiAgICAgICAgLy8gc29tZSBjaGFuZ2UgdG8gcmVxdWlyZSgpIGZyb20gdGhlaXIgd29ya2Vycy4gIFNvIG1heWJlIEkganVzdCBjYW4ndFxuICAgICAgICAvLyB1c2Ugd29ya2VycyBmb3Igbm93LlxuICAgICAgICAvLyBub2RlSW50ZWdyYXRpb25JbldvcmtlcjogdHJ1ZSxcbiAgICAgICAgLy9cbiAgICAgICAgLy8gc2FuZGJveDogZmFsc2UsXG5cbiAgICAgICAgZGVmYXVsdEVuY29kaW5nOiAnVVRGLTgnLFxuXG4gICAgICAgIC8vIFdlIGFyZSBkaXNhYmxpbmcgd2ViIHNlY3VyaXR5IG5vdyBhcyBhIHdvcmsgYXJvdW5kIGZvciBDT1JTIGlzc3Vlc1xuICAgICAgICAvLyB3aGVuIGxvYWRpbmcgZm9udHMuICBPbmNlIHdlIHJlc29sdmUgdGhpcyB3ZSBjYW4gZW5hYmxlIHdlYlNlY3VyaXR5XG4gICAgICAgIC8vIGFnYWluLlxuICAgICAgICB3ZWJTZWN1cml0eTogZmFsc2UsXG5cbiAgICAgICAgd2ViYXVkaW86IHRydWUsXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVzZSBhIHBlcnNpc3RlbnQgY29va2llIHNlc3Npb24gYmV0d2VlbiByZXN0YXJ0cy4gIFRoaXMgaXMgdXNlZCBzb1xuICAgICAgICAgKiB0aGF0IHdlIGtlZXAgdXNlciBjb29raWVzIGluY2x1ZGluZyBHb29nbGUgQW5hbHl0aWNzIGNvb2tpZXMuXG4gICAgICAgICAqL1xuICAgICAgICAvL1xuICAgICAgICBwYXJ0aXRpb246IFwicGVyc2lzdDpwb2xhclwiXG5cbiAgICB9XG5cbn0pO1xuXG5leHBvcnQgY2xhc3MgTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlV2luZG93KGJyb3dzZXJXaW5kb3dPcHRpb25zOiBFbGVjdHJvbi5Ccm93c2VyV2luZG93Q29uc3RydWN0b3JPcHRpb25zID0gQlJPV1NFUl9XSU5ET1dfT1BUSU9OUyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBERUZBVUxUX1VSTCk6IFByb21pc2U8QnJvd3NlcldpbmRvdz4ge1xuXG4gICAgICAgIGJyb3dzZXJXaW5kb3dPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgYnJvd3NlcldpbmRvd09wdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5jb21wdXRlWFkoKTtcblxuICAgICAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgICAgICAgIC8vIGFkZCBzb21lIG9mZnNldCB0byB0aGlzIHdpbmRvdyBzbyB0aGF0IHRoZSBwcmV2aW91cyB3aW5kb3cgYW5kXG4gICAgICAgICAgICAvLyB0aGUgY3VycmVudCBvbmUgZG9uJ3QgbGluZSB1cCBwZXJmZWN0bHkgb3IgZWxzZSBpdCBzZWVtcyBsaWtlXG4gICAgICAgICAgICAvLyBub3RoaW5nIGhhcHBlbmVkIG9yIHRoYXQgdGhlIG5ldyB3aW5kb3cgcmVwbGFjZWQgdGhlIG9sZCBvbmUuXG4gICAgICAgICAgICBicm93c2VyV2luZG93T3B0aW9ucy54ID0gcG9zaXRpb24ueDtcbiAgICAgICAgICAgIGJyb3dzZXJXaW5kb3dPcHRpb25zLnkgPSBwb3NpdGlvbi55O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGlzcGxheSA9IHNjcmVlbi5nZXRQcmltYXJ5RGlzcGxheSgpO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSBtaW5IZWlnaHQsIG1heEhlaWdodCwgd2lkdGgsIGFuZCBoZWlnaHQgYXJlIE5PVCBsYXJnZXJcbiAgICAgICAgLy8gdGhhbiB0aGUgY3VycmVudCBzY3JlZW4gZGltZW5zaW9ucy5cblxuICAgICAgICBpbnRlcmZhY2UgRGltZW5zaW9uTWFwcGluZyB7XG4gICAgICAgICAgICByZWFkb25seSBvcmlnaW5hbDogJ21pbldpZHRoJyB8ICdtaW5IZWlnaHQnIHwgJ3dpZHRoJyB8ICdoZWlnaHQnO1xuICAgICAgICAgICAgcmVhZG9ubHkgZGltZW5zaW9uOiAnd2lkdGgnIHwgJ2hlaWdodCc7XG4gICAgICAgICAgICByZWFkb25seSBkZWZhdWx0VmFsdWU/OiBudW1iZXI7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBNSU5fRkFDVE9SID0gMC40O1xuXG4gICAgICAgIGNvbnN0IGRpbWVuc2lvbk1hcHBpbmdzOiBEaW1lbnNpb25NYXBwaW5nW10gPSBbXG5cbiAgICAgICAgICAgIHtvcmlnaW5hbDogJ21pbkhlaWdodCcsIGRpbWVuc2lvbjogJ2hlaWdodCcsIGRlZmF1bHRWYWx1ZTogZGlzcGxheS5zaXplLndpZHRoICogTUlOX0ZBQ1RPUn0sXG4gICAgICAgICAgICB7b3JpZ2luYWw6ICdtaW5XaWR0aCcsIGRpbWVuc2lvbjogJ3dpZHRoJywgZGVmYXVsdFZhbHVlOiBkaXNwbGF5LnNpemUuaGVpZ2h0ICogTUlOX0ZBQ1RPUn0sXG5cbiAgICAgICAgICAgIHtvcmlnaW5hbDogJ2hlaWdodCcsIGRpbWVuc2lvbjogJ2hlaWdodCd9LFxuICAgICAgICAgICAge29yaWdpbmFsOiAnd2lkdGgnLCBkaW1lbnNpb246ICd3aWR0aCd9XG5cbiAgICAgICAgXTtcblxuICAgICAgICBmb3IgKGNvbnN0IGRpbWVuc2lvbk1hcHBpbmcgb2YgZGltZW5zaW9uTWFwcGluZ3MpIHtcblxuICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IGJyb3dzZXJXaW5kb3dPcHRpb25zW2RpbWVuc2lvbk1hcHBpbmcub3JpZ2luYWxdISB8fCBkaW1lbnNpb25NYXBwaW5nLmRlZmF1bHRWYWx1ZSE7XG4gICAgICAgICAgICBjb25zdCBtYXggPSBkaXNwbGF5LnNpemVbZGltZW5zaW9uTWFwcGluZy5kaW1lbnNpb25dO1xuXG4gICAgICAgICAgICBicm93c2VyV2luZG93T3B0aW9uc1tkaW1lbnNpb25NYXBwaW5nLm9yaWdpbmFsXVxuICAgICAgICAgICAgICAgID0gTWF0aC5taW4oY3VycmVudCwgbWF4KTtcblxuICAgICAgICB9XG5cbiAgICAgICAgbG9nLmluZm8oYENyZWF0aW5nIHdpbmRvdyBmb3IgVVJMOiAke3VybH0gaW4gcGFydGl0aW9uICR7YnJvd3NlcldpbmRvd09wdGlvbnMud2ViUHJlZmVyZW5jZXMhLnBhcnRpdGlvbn1gKTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIGJyb3dzZXIgd2luZG93LlxuICAgICAgICBjb25zdCBicm93c2VyV2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coYnJvd3NlcldpbmRvd09wdGlvbnMpO1xuXG4gICAgICAgIGJyb3dzZXJXaW5kb3cub24oJ2Nsb3NlJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICBpZiAoYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cykge1xuXG4gICAgICAgICAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5jbGVhckhpc3RvcnkoKTtcbiAgICAgICAgICAgICAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlc3Npb24uY2xlYXJDYWNoZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJXaW5kb3cuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5vbignbmV3LXdpbmRvdycsIChlLCB1cmwpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbCh1cmwpO1xuICAgICAgICB9KTtcblxuICAgICAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLm9uKCd3aWxsLW5hdmlnYXRlJywgKGUsIG5hdlVSTCkgPT4ge1xuXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGEgYml0IG9mIGEgaGFjayBhbmQgdGhlc2UgVVJMcyBzaG91bGRuJ3QgYmUgaGFyZFxuICAgICAgICAgICAgLy8gY29kZWQgaGVyZS4gIFdlIGNhbiByZWZhY3RvciB0aGlzIGluIHRoZSBmdXR1cmUgdGhvdWdoLlxuXG4gICAgICAgICAgICBjb25zdCBwYXJzZWRVUkwgPSBuZXcgVVJMKG5hdlVSTCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGhvc3QgPSBwYXJzZWRVUkwuaG9zdG5hbWU7XG5cbiAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRIb3N0cyA9IFtcImFjY291bnRzLmdvb2dsZS5jb21cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInBvbGFyLTMyYjBmLmZpcmViYXNlYXBwLmNvbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiYWNjb3VudGNob29zZXIuY29tXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ3d3cuYWNjb3VudGNob29zZXIuY29tXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsb2NhbGhvc3RcIl07XG5cbiAgICAgICAgICAgIGlmIChob3N0ID09PSBcImxvY2FsaG9zdFwiKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJBbHdheXMgYWxsb3dpbmcgbG9jYWxob3N0IFVSTFwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChuYXZVUkwuc3RhcnRzV2l0aChcImh0dHBzOi8vXCIpICYmIGFsbG93ZWRIb3N0cy5pbmNsdWRlcyhob3N0KSkge1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiQWxsb3dpbmcgVVJMIGZvciBhdXRoZW50aWNhdGlvbjogXCIgKyBuYXZVUkwpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbG9nLmluZm8oXCJBdHRlbXB0IHRvIG5hdmlnYXRlIHRvIG5ldyBVUkw6IFwiLCBuYXZVUkwpO1xuICAgICAgICAgICAgLy8gcmVxdWlyZWQgdG8gZm9yY2UgdGhlIFVSTHMgY2xpY2tlZCB0byBvcGVuIGluIGEgbmV3IGJyb3dzZXIuICBUaGVcbiAgICAgICAgICAgIC8vIHVzZXIgcHJvYmFibHkgLyBjZXJ0YWlubHkgd2FudHMgdG8gdXNlIHRoZWlyIG1haW4gYnJvd3Nlci5cbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbChuYXZVUkwpO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiTG9hZGluZyBVUkw6IFwiICsgdXJsKTtcbiAgICAgICAgYnJvd3NlcldpbmRvdy5sb2FkVVJMKHVybCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEJyb3dzZXJXaW5kb3c+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBicm93c2VyV2luZG93Lm9uY2UoJ3JlYWR5LXRvLXNob3cnLCAoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBBcyBvZiBFbGVjdHJvbiAzLjAgYmV0YTggdGhlcmUgYXBwZWFycyB0byBiZSBhIGJ1ZyB3aGVyZVxuICAgICAgICAgICAgICAgIC8vIGl0IHBlcnNpc3RzIHRlaCB6b29tIGZhY3RvciBiZXR3ZWVuIHJlc3RhcnRzIGFuZCByZXN0b3Jlc1xuICAgICAgICAgICAgICAgIC8vIHRoZSB6b29tIGZhY3RvciBmb3IgdGhlIHVzZXIgYnV0IHRoaXMgY2FuIGJyZWFrIC8gY29uZnVzZVxuICAgICAgICAgICAgICAgIC8vIFBIWiBsb2FkaW5nIHNvIHdlIGFsd2F5cyB3YW50IHRoZW0gdG8gc3RhcnQgYXQgMS4wXG4gICAgICAgICAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZXRab29tRmFjdG9yKDEuMCk7XG5cbiAgICAgICAgICAgICAgICBicm93c2VyV2luZG93LnNob3coKTtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUoYnJvd3NlcldpbmRvdyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY29tcHV0ZVhZKCk6IFBvc2l0aW9uIHwgdW5kZWZpbmVkIHtcblxuICAgICAgICBjb25zdCBvZmZzZXQgPSAzNTtcblxuICAgICAgICBjb25zdCBmb2N1c2VkV2luZG93ID0gQnJvd3NlcldpbmRvdy5nZXRGb2N1c2VkV2luZG93KCk7XG5cbiAgICAgICAgaWYgKGZvY3VzZWRXaW5kb3cpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZm9jdXNlZFdpbmRvdy5nZXRQb3NpdGlvbigpO1xuICAgICAgICAgICAgbGV0IHggPSBwb3NpdGlvblswXTtcbiAgICAgICAgICAgIGxldCB5ID0gcG9zaXRpb25bMV07XG5cbiAgICAgICAgICAgIHggKz0gb2Zmc2V0O1xuICAgICAgICAgICAgeSArPSBvZmZzZXQ7XG5cbiAgICAgICAgICAgIHJldHVybiB7eCwgeX07XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgICB9XG5cbn1cblxuaW50ZXJmYWNlIFBvc2l0aW9uIHtcbiAgICB4OiBudW1iZXI7XG4gICAgeTogbnVtYmVyO1xufVxuXG4iXX0=