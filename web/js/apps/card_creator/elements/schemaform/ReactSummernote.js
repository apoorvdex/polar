"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const JQuery_1 = __importDefault(require("../../../../ui/JQuery"));
require("bootstrap");
require("summernote/dist/summernote");
const react_1 = __importStar(require("react"));
const react_dom_1 = __importDefault(require("react-dom"));
const randomUid = () => Math.floor(Math.random() * 100000);
class ReactSummernote extends react_1.Component {
    constructor(props) {
        super(props);
        this.props = props;
        if (this.props.options.id) {
            this.uid = this.props.options.id;
        }
        else {
            this.uid = `react-summernote-${randomUid()}`;
        }
        this.editor = {};
        this.noteEditable = null;
        this.notePlaceholder = null;
        this.onInit = this.onInit.bind(this);
        this.onImageUpload = this.onImageUpload.bind(this);
        this.focus = this.focus.bind(this);
        this.isEmpty = this.isEmpty.bind(this);
        this.reset = this.reset.bind(this);
        this.replace = this.replace.bind(this);
        this.disable = this.disable.bind(this);
        this.enable = this.enable.bind(this);
        this.toggleState = this.toggleState.bind(this);
        this.insertImage = this.insertImage.bind(this);
        this.insertNode = this.insertNode.bind(this);
        this.insertText = this.insertText.bind(this);
    }
    componentDidMount() {
        const options = this.props.options || {};
        const codeview = this.props.codeview;
        options.callbacks = this.callbacks;
        let domNode = react_dom_1.default.findDOMNode(this);
        this.editor = JQuery_1.default(domNode).find(`#${this.uid}`);
        this.editor.summernote(options);
        if (codeview) {
            this.editor.summernote('codeview.activate');
        }
    }
    componentWillReceiveProps(nextProps) {
        const { props } = this;
        const codeview = nextProps.codeview;
        const codeviewCommand = codeview ? 'codeview.activate' : 'codeview.deactivate';
        if (typeof nextProps.value === 'string' && props.value !== nextProps.value) {
            this.replace(nextProps.value);
        }
        if (typeof nextProps.disabled === 'boolean' && props.disabled !== nextProps.disabled) {
            this.toggleState(nextProps.disabled);
        }
        if (codeview !== props.codeview) {
            this.editor.summernote(codeviewCommand);
        }
    }
    shouldComponentUpdate() {
        return false;
    }
    componentWillUnmount() {
        if (this.editor.summernote) {
            this.editor.summernote('destroy');
        }
    }
    onInit() {
        const { disabled, onInit } = this.props;
        const $container = this.editor.parent();
        this.noteEditable = $container.find('.note-editable');
        this.notePlaceholder = $container.find('.note-placeholder');
        if (typeof disabled === 'boolean') {
            this.toggleState(disabled);
        }
        if (typeof onInit === 'function') {
            onInit({
                summernote: this.editor.summernote.bind(this.editor),
                focus: this.focus,
                isEmpty: this.isEmpty,
                reset: this.reset,
                replace: this.replace,
                disable: this.disable,
                enable: this.enable,
                insertImage: this.insertImage,
                insertNode: this.insertNode,
                insertText: this.insertText
            });
        }
    }
    onImageUpload(images) {
        const { onImageUpload } = this.props;
        if (typeof onImageUpload === 'function') {
            onImageUpload(images, this.insertImage);
        }
    }
    focus() {
        this.editor.summernote('focus');
    }
    isEmpty() {
        return this.editor.summernote('isEmpty');
    }
    reset() {
        this.editor.summernote('reset');
    }
    replace(content) {
        const { noteEditable, notePlaceholder } = this;
        const prevContent = noteEditable.html();
        const contentLength = content.length;
        if (prevContent !== content) {
            if (this.isEmpty() && contentLength > 0) {
                notePlaceholder.hide();
            }
            else if (contentLength === 0) {
                notePlaceholder.show();
            }
            noteEditable.html(content);
        }
    }
    disable() {
        this.editor.summernote('disable');
    }
    enable() {
        this.editor.summernote('enable');
    }
    toggleState(disabled) {
        if (disabled) {
            this.disable();
        }
        else {
            this.enable();
        }
    }
    insertImage(url, filenameOrCallback) {
        this.editor.summernote('insertImage', url, filenameOrCallback);
    }
    insertNode(node) {
        this.editor.summernote('insertNode', node);
    }
    insertText(text) {
        this.editor.summernote('insertText', text);
    }
    get callbacks() {
        const props = this.props;
        return {
            onInit: this.onInit,
            onEnter: props.onEnter,
            onFocus: props.onFocus,
            onBlur: props.onBlur,
            onKeyup: props.onKeyUp,
            onKeydown: props.onKeyDown,
            onPaste: props.onPaste,
            onChange: props.onChange,
            onImageUpload: this.onImageUpload
        };
    }
    render() {
        const { value, defaultValue, className } = this.props;
        const html = value || defaultValue;
        return (react_1.default.createElement("div", { className: className },
            react_1.default.createElement("div", { id: this.uid, dangerouslySetInnerHTML: { __html: html } })));
    }
}
exports.default = ReactSummernote;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhY3RTdW1tZXJub3RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUmVhY3RTdW1tZXJub3RlLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFFQSxtRUFBc0M7QUFDdEMscUJBQW1CO0FBQ25CLHNDQUFvQztBQUVwQywrQ0FBeUM7QUFDekMsMERBQWlDO0FBRWpDLE1BQU0sU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDO0FBRTNELE1BQU0sZUFBZ0IsU0FBUSxpQkFBUztJQStCbkMsWUFBWSxLQUFVO1FBQ2xCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUViLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1NBQ3BDO2FBQU07WUFDSCxJQUFJLENBQUMsR0FBRyxHQUFHLG9CQUFvQixTQUFTLEVBQUUsRUFBRSxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFFNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENB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LENBQ0gsdUNBQUssU0FBUyxFQUFFLFNBQVM7WUFDckIsdUNBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsdUJBQXVCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUksQ0FDOUQsQ0FDVCxDQUFDO0lBQ04sQ0FBQztDQUVKO0FBRUQsa0JBQWUsZUFBZSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsICQgKi9cblxuaW1wb3J0ICQgZnJvbSAnLi4vLi4vLi4vLi4vdWkvSlF1ZXJ5JztcbmltcG9ydCAnYm9vdHN0cmFwJztcbmltcG9ydCAnc3VtbWVybm90ZS9kaXN0L3N1bW1lcm5vdGUnO1xuXG5pbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XG5cbmNvbnN0IHJhbmRvbVVpZCA9ICgpID0+IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwMCk7XG5cbmNsYXNzIFJlYWN0U3VtbWVybm90ZSBleHRlbmRzIENvbXBvbmVudCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHVpZDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBlZGl0b3I6IGFueTtcblxuICAgIHByaXZhdGUgbm90ZUVkaXRhYmxlOiBhbnk7XG5cbiAgICBwcml2YXRlIG5vdGVQbGFjZWhvbGRlcjogYW55O1xuXG4gICAgcmVhZG9ubHkgcHJvcHMgOiBhbnk7XG5cbiAgICAvLyBSZWFjdFN1bW1lcm5vdGUucHJvcFR5cGVzID0ge1xuICAgIC8vICAgICB2YWx1ZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAvLyAgICAgZGVmYXVsdFZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIC8vICAgICBjb2RldmlldzogUHJvcFR5cGVzLmJvb2wsXG4gICAgLy8gICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAvLyAgICAgb3B0aW9uczogUHJvcFR5cGVzLm9iamVjdCxcbiAgICAvLyAgICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuXG4gICAgLy8gICAgIG9uSW5pdDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gICAgIG9uRW50ZXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8vICAgICBvbkZvY3VzOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAvLyAgICAgb25CbHVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAvLyAgICAgb25LZXlVcDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gICAgIG9uS2V5RG93bjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gICAgIG9uUGFzdGU6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8vICAgICBvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gICAgIG9uSW1hZ2VVcGxvYWQ6IFByb3BUeXBlcy5mdW5jXG4gICAgLy8gfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBhbnkpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMucHJvcHMgPSBwcm9wcztcblxuICAgICAgICBpZiAodGhpcy5wcm9wcy5vcHRpb25zLmlkKSB7XG4gICAgICAgICAgICB0aGlzLnVpZCA9IHRoaXMucHJvcHMub3B0aW9ucy5pZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudWlkID0gYHJlYWN0LXN1bW1lcm5vdGUtJHtyYW5kb21VaWQoKX1gO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lZGl0b3IgPSB7fTtcbiAgICAgICAgdGhpcy5ub3RlRWRpdGFibGUgPSBudWxsO1xuICAgICAgICB0aGlzLm5vdGVQbGFjZWhvbGRlciA9IG51bGw7XG5cbiAgICAgICAgdGhpcy5vbkluaXQgPSB0aGlzLm9uSW5pdC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uSW1hZ2VVcGxvYWQgPSB0aGlzLm9uSW1hZ2VVcGxvYWQuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5mb2N1cyA9IHRoaXMuZm9jdXMuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5pc0VtcHR5ID0gdGhpcy5pc0VtcHR5LmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMucmVzZXQgPSB0aGlzLnJlc2V0LmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMucmVwbGFjZSA9IHRoaXMucmVwbGFjZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmRpc2FibGUgPSB0aGlzLmRpc2FibGUuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5lbmFibGUgPSB0aGlzLmVuYWJsZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnRvZ2dsZVN0YXRlID0gdGhpcy50b2dnbGVTdGF0ZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmluc2VydEltYWdlID0gdGhpcy5pbnNlcnRJbWFnZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmluc2VydE5vZGUgPSB0aGlzLmluc2VydE5vZGUuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5pbnNlcnRUZXh0ID0gdGhpcy5pbnNlcnRUZXh0LmJpbmQodGhpcyk7XG5cbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucHJvcHMub3B0aW9ucyB8fCB7fTtcbiAgICAgICAgY29uc3QgY29kZXZpZXcgPSB0aGlzLnByb3BzLmNvZGV2aWV3O1xuICAgICAgICAvLyBjb25zdCBjb2Rldmlld0NvbW1hbmQgPSBjb2RldmlldyA/ICdjb2Rldmlldy5hY3RpdmF0ZScgOiAnY29kZXZpZXcuZGVhY3RpdmF0ZSc7XG4gICAgICAgIG9wdGlvbnMuY2FsbGJhY2tzID0gdGhpcy5jYWxsYmFja3M7XG5cbiAgICAgICAgbGV0IGRvbU5vZGUgPSBSZWFjdERPTS5maW5kRE9NTm9kZSh0aGlzKSBhcyBIVE1MRWxlbWVudDtcblxuICAgICAgICB0aGlzLmVkaXRvciA9ICQoZG9tTm9kZSkuZmluZChgIyR7dGhpcy51aWR9YCk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3Iuc3VtbWVybm90ZShvcHRpb25zKTtcblxuICAgICAgICAvLyBkZWxldGUgdGhpcy5lZGl0b3Iuc3VtbWVybm90ZS5vcHRpb25zLmtleU1hcC5wYy5UQUI7XG4gICAgICAgIC8vIGRlbGV0ZSB0aGlzLmVkaXRvci5zdW1tZXJub3RlLm9wdGlvbnMua2V5TWFwLm1hYy5UQUI7XG5cbiAgICAgICAgaWYgKGNvZGV2aWV3KSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zdW1tZXJub3RlKCdjb2Rldmlldy5hY3RpdmF0ZScpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IGFueSkge1xuXG4gICAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG5cbiAgICAgICAgY29uc3QgY29kZXZpZXcgPSBuZXh0UHJvcHMuY29kZXZpZXc7XG4gICAgICAgIGNvbnN0IGNvZGV2aWV3Q29tbWFuZCA9IGNvZGV2aWV3ID8gJ2NvZGV2aWV3LmFjdGl2YXRlJyA6ICdjb2Rldmlldy5kZWFjdGl2YXRlJztcblxuXG4gICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3BzLnZhbHVlID09PSAnc3RyaW5nJyAmJiBwcm9wcy52YWx1ZSAhPT0gbmV4dFByb3BzLnZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnJlcGxhY2UobmV4dFByb3BzLnZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3BzLmRpc2FibGVkID09PSAnYm9vbGVhbicgJiYgcHJvcHMuZGlzYWJsZWQgIT09IG5leHRQcm9wcy5kaXNhYmxlZCkge1xuICAgICAgICAgICAgdGhpcy50b2dnbGVTdGF0ZShuZXh0UHJvcHMuZGlzYWJsZWQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb2RldmlldyAhPT0gcHJvcHMuY29kZXZpZXcpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoY29kZXZpZXdDb21tYW5kKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBpZiAodGhpcy5lZGl0b3Iuc3VtbWVybm90ZSkge1xuICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc3VtbWVybm90ZSgnZGVzdHJveScpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25Jbml0KCkge1xuXG4gICAgICAgIGNvbnN0IHsgZGlzYWJsZWQsIG9uSW5pdCB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBjb25zdCAkY29udGFpbmVyID0gdGhpcy5lZGl0b3IucGFyZW50KCk7XG5cbiAgICAgICAgdGhpcy5ub3RlRWRpdGFibGUgPSAkY29udGFpbmVyLmZpbmQoJy5ub3RlLWVkaXRhYmxlJyk7XG4gICAgICAgIHRoaXMubm90ZVBsYWNlaG9sZGVyID0gJGNvbnRhaW5lci5maW5kKCcubm90ZS1wbGFjZWhvbGRlcicpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgZGlzYWJsZWQgPT09ICdib29sZWFuJykge1xuICAgICAgICAgICAgdGhpcy50b2dnbGVTdGF0ZShkaXNhYmxlZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIG9uSW5pdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25Jbml0KHtcbiAgICAgICAgICAgICAgICBzdW1tZXJub3RlOiB0aGlzLmVkaXRvci5zdW1tZXJub3RlLmJpbmQodGhpcy5lZGl0b3IpLFxuICAgICAgICAgICAgICAgIGZvY3VzOiB0aGlzLmZvY3VzLFxuICAgICAgICAgICAgICAgIGlzRW1wdHk6IHRoaXMuaXNFbXB0eSxcbiAgICAgICAgICAgICAgICByZXNldDogdGhpcy5yZXNldCxcbiAgICAgICAgICAgICAgICByZXBsYWNlOiB0aGlzLnJlcGxhY2UsXG4gICAgICAgICAgICAgICAgZGlzYWJsZTogdGhpcy5kaXNhYmxlLFxuICAgICAgICAgICAgICAgIGVuYWJsZTogdGhpcy5lbmFibGUsXG4gICAgICAgICAgICAgICAgaW5zZXJ0SW1hZ2U6IHRoaXMuaW5zZXJ0SW1hZ2UsXG4gICAgICAgICAgICAgICAgaW5zZXJ0Tm9kZTogdGhpcy5pbnNlcnROb2RlLFxuICAgICAgICAgICAgICAgIGluc2VydFRleHQ6IHRoaXMuaW5zZXJ0VGV4dFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkltYWdlVXBsb2FkKGltYWdlczogYW55KSB7XG5cbiAgICAgICAgY29uc3QgeyBvbkltYWdlVXBsb2FkIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygb25JbWFnZVVwbG9hZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgb25JbWFnZVVwbG9hZChpbWFnZXMsIHRoaXMuaW5zZXJ0SW1hZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZm9jdXMoKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2ZvY3VzJyk7XG4gICAgfVxuXG4gICAgaXNFbXB0eSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2lzRW1wdHknKTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc3VtbWVybm90ZSgncmVzZXQnKTtcbiAgICB9XG5cbiAgICByZXBsYWNlKGNvbnRlbnQ6IGFueSkge1xuICAgICAgICBjb25zdCB7IG5vdGVFZGl0YWJsZSwgbm90ZVBsYWNlaG9sZGVyIH0gPSB0aGlzO1xuICAgICAgICBjb25zdCBwcmV2Q29udGVudCA9IG5vdGVFZGl0YWJsZS5odG1sKCk7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRMZW5ndGggPSBjb250ZW50Lmxlbmd0aDtcblxuICAgICAgICBpZiAocHJldkNvbnRlbnQgIT09IGNvbnRlbnQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzRW1wdHkoKSAmJiBjb250ZW50TGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIG5vdGVQbGFjZWhvbGRlci5oaWRlKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRlbnRMZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBub3RlUGxhY2Vob2xkZXIuc2hvdygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBub3RlRWRpdGFibGUuaHRtbChjb250ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRpc2FibGUoKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2Rpc2FibGUnKTtcbiAgICB9XG5cbiAgICBlbmFibGUoKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2VuYWJsZScpO1xuICAgIH1cblxuICAgIHRvZ2dsZVN0YXRlKGRpc2FibGVkOiBib29sZWFuKSB7XG4gICAgICAgIGlmIChkaXNhYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmVuYWJsZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaW5zZXJ0SW1hZ2UodXJsOiBhbnksIGZpbGVuYW1lT3JDYWxsYmFjazogYW55KSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2luc2VydEltYWdlJywgdXJsLCBmaWxlbmFtZU9yQ2FsbGJhY2spO1xuICAgIH1cblxuICAgIGluc2VydE5vZGUobm9kZTogTm9kZSkge1xuICAgICAgICB0aGlzLmVkaXRvci5zdW1tZXJub3RlKCdpbnNlcnROb2RlJywgbm9kZSk7XG4gICAgfVxuXG4gICAgaW5zZXJ0VGV4dCh0ZXh0OiBOb2RlKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnN1bW1lcm5vdGUoJ2luc2VydFRleHQnLCB0ZXh0KTtcbiAgICB9XG5cbiAgICBnZXQgY2FsbGJhY2tzKCkge1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG9uSW5pdDogdGhpcy5vbkluaXQsXG4gICAgICAgICAgICBvbkVudGVyOiBwcm9wcy5vbkVudGVyLFxuICAgICAgICAgICAgb25Gb2N1czogcHJvcHMub25Gb2N1cyxcbiAgICAgICAgICAgIG9uQmx1cjogcHJvcHMub25CbHVyLFxuICAgICAgICAgICAgb25LZXl1cDogcHJvcHMub25LZXlVcCxcbiAgICAgICAgICAgIG9uS2V5ZG93bjogcHJvcHMub25LZXlEb3duLFxuICAgICAgICAgICAgb25QYXN0ZTogcHJvcHMub25QYXN0ZSxcbiAgICAgICAgICAgIG9uQ2hhbmdlOiBwcm9wcy5vbkNoYW5nZSxcbiAgICAgICAgICAgIG9uSW1hZ2VVcGxvYWQ6IHRoaXMub25JbWFnZVVwbG9hZFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSwgZGVmYXVsdFZhbHVlLCBjbGFzc05hbWUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IGh0bWwgPSB2YWx1ZSB8fCBkZWZhdWx0VmFsdWU7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWV9PlxuICAgICAgICAgICAgICAgIDxkaXYgaWQ9e3RoaXMudWlkfSBkYW5nZXJvdXNseVNldElubmVySFRNTD17eyBfX2h0bWw6IGh0bWwgfX0gLz5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBSZWFjdFN1bW1lcm5vdGU7XG4iXX0=