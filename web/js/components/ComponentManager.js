"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const Logger_1 = require("../logger/Logger");
const Preconditions_1 = require("../Preconditions");
const MutationState_1 = require("../proxies/MutationState");
const log = Logger_1.Logger.create();
class ComponentManager {
    constructor(model, containerProvider, createComponent, createDocMetaModel) {
        this.containers = {};
        this.components = {};
        this.model = model;
        this.containerProvider = containerProvider;
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        this.createComponent = createComponent;
        this.createDocMetaModel = createDocMetaModel;
    }
    start() {
        this.model.registerListenerForDocumentLoaded(this.onDocumentLoaded.bind(this));
    }
    onDocumentLoaded(documentLoadedEvent) {
        log.debug("onDocumentLoaded: ", documentLoadedEvent.fingerprint);
        let docMetaModel = this.createDocMetaModel();
        this.containers = this.containerProvider.getContainers();
        log.debug("Working with containers: ", this.containers);
        docMetaModel.registerListener(documentLoadedEvent.docMeta, this.onComponentEvent.bind(this));
    }
    onComponentEvent(componentEvent) {
        log.debug("onComponentEvent: ", componentEvent);
        let containerID = componentEvent.pageMeta.pageInfo.num;
        Preconditions_1.Preconditions.assertNumber(containerID, "containerID");
        Preconditions_1.Preconditions.assertNumber(containerID, "containerID");
        if (componentEvent.mutationState === MutationState_1.MutationState.PRESENT) {
            log.debug("PRESENT");
            let container = this.containers[containerID];
            if (!container) {
                throw new Error("No container for containerID: " + containerID);
            }
            componentEvent.container = container;
            let component = this.createComponent();
            component.init(componentEvent);
            let callback = (containerLifecycleState) => {
                if (containerLifecycleState.visible) {
                    component.render();
                }
                else {
                    component.destroy();
                }
            };
            let containerLifecycleListener = this.containerProvider.createContainerLifecycleListener(container);
            containerLifecycleListener.register(callback);
            let containerState = containerLifecycleListener.getState();
            if (containerState && containerState.visible) {
                callback(containerState);
            }
            this.components[componentEvent.id] = new ComponentEntry(containerLifecycleListener, component);
        }
        else if (componentEvent.mutationState === MutationState_1.MutationState.ABSENT) {
            log.debug("ABSENT");
            let componentEntry = this.components[componentEvent.id];
            if (componentEntry) {
                componentEntry.containerLifecycleListener.unregister();
                componentEntry.component.destroy();
                log.debug("Destroyed component: " + componentEvent.id);
                delete this.components[componentEvent.id];
            }
            else {
                log.warn("No component entry for: " + componentEvent.id);
            }
        }
    }
}
exports.ComponentManager = ComponentManager;
class ComponentEntry {
    constructor(containerLifecycleListener, component) {
        this.containerLifecycleListener = containerLifecycleListener;
        this.component = component;
    }
}
exports.ComponentEntry = ComponentEntry;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcG9uZW50TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNvbXBvbmVudE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvRUFBK0Q7QUFDL0QsNkNBQXdDO0FBTXhDLG9EQUErQztBQUMvQyw0REFBdUQ7QUFNdkQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsZ0JBQWdCO0lBYXpCLFlBQVksS0FBWSxFQUNaLGlCQUFvQyxFQUNwQyxlQUFnQyxFQUNoQyxrQkFBc0M7UUFUMUMsZUFBVSxHQUFpQyxFQUFFLENBQUM7UUFDOUMsZUFBVSxHQUFzQyxFQUFFLENBQUM7UUFVdkQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO1FBRTNDLElBQUksQ0FBQyxTQUFTLEdBQUcsbUNBQWdCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFaEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFFdkMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDO0lBRWpELENBQUM7SUFFRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUVELGdCQUFnQixDQUFDLG1CQUF3QztRQUVyRCxHQUFHLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUFFLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWpFLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBRTdDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXpELEdBQUcsQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVB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RixJQUFJLENBQUMsMEJBQTBCLEdBQUcsMEJBQTBCLENBQUM7UUFDN0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDL0IsQ0FBQztDQUVKO0FBWkQsd0NBWUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RvY0Zvcm1hdEZhY3Rvcnl9IGZyb20gJy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5JztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICcuLi9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7RG9jdW1lbnRMb2FkZWRFdmVudCwgTW9kZWx9IGZyb20gJy4uL21vZGVsL01vZGVsJztcbmltcG9ydCB7Q29udGFpbmVyUHJvdmlkZXJ9IGZyb20gJy4vY29udGFpbmVycy9wcm92aWRlcnMvQ29udGFpbmVyUHJvdmlkZXInO1xuaW1wb3J0IHtDb21wb25lbnR9IGZyb20gJy4vQ29tcG9uZW50JztcbmltcG9ydCB7RG9jTWV0YU1vZGVsfSBmcm9tICcuLi9tZXRhZGF0YS9Eb2NNZXRhTW9kZWwnO1xuaW1wb3J0IHtEb2NGb3JtYXR9IGZyb20gJy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXQnO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICcuLi9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7TXV0YXRpb25TdGF0ZX0gZnJvbSAnLi4vcHJveGllcy9NdXRhdGlvblN0YXRlJztcbmltcG9ydCB7Q29udGFpbmVyfSBmcm9tICcuL2NvbnRhaW5lcnMvQ29udGFpbmVyJztcbmltcG9ydCB7Q29udGFpbmVyTGlmZWN5Y2xlU3RhdGV9IGZyb20gJy4vY29udGFpbmVycy9saWZlY3ljbGUvQ29udGFpbmVyTGlmZWN5Y2xlU3RhdGUnO1xuaW1wb3J0IHtDb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcn0gZnJvbSAnLi9jb250YWluZXJzL2xpZmVjeWNsZS9Db250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcic7XG5pbXBvcnQge0Fubm90YXRpb25FdmVudH0gZnJvbSAnLi4vYW5ub3RhdGlvbnMvY29tcG9uZW50cy9Bbm5vdGF0aW9uRXZlbnQnO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBDb21wb25lbnRNYW5hZ2VyIHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgbW9kZWw6IE1vZGVsO1xuICAgIHByaXZhdGUgY29udGFpbmVyUHJvdmlkZXI6IENvbnRhaW5lclByb3ZpZGVyO1xuICAgIHByaXZhdGUgZG9jRm9ybWF0OiBEb2NGb3JtYXQ7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjcmVhdGVDb21wb25lbnQ6ICgpID0+IENvbXBvbmVudDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNyZWF0ZURvY01ldGFNb2RlbDogKCkgPT4gRG9jTWV0YU1vZGVsO1xuICAgIHByaXZhdGUgY29udGFpbmVyczogeyBba2V5OiBudW1iZXJdOiBDb250YWluZXIgfSA9IHt9O1xuICAgIHByaXZhdGUgY29tcG9uZW50czogeyBba2V5OiBzdHJpbmddOiBDb21wb25lbnRFbnRyeSB9ID0ge307XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG1vZGVsOiBNb2RlbCxcbiAgICAgICAgICAgICAgICBjb250YWluZXJQcm92aWRlcjogQ29udGFpbmVyUHJvdmlkZXIsXG4gICAgICAgICAgICAgICAgY3JlYXRlQ29tcG9uZW50OiAoKSA9PiBDb21wb25lbnQsXG4gICAgICAgICAgICAgICAgY3JlYXRlRG9jTWV0YU1vZGVsOiAoKSA9PiBEb2NNZXRhTW9kZWwpIHtcblxuICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXJQcm92aWRlciA9IGNvbnRhaW5lclByb3ZpZGVyO1xuXG4gICAgICAgIHRoaXMuZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlQ29tcG9uZW50ID0gY3JlYXRlQ29tcG9uZW50O1xuXG4gICAgICAgIHRoaXMuY3JlYXRlRG9jTWV0YU1vZGVsID0gY3JlYXRlRG9jTWV0YU1vZGVsO1xuXG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMubW9kZWwucmVnaXN0ZXJMaXN0ZW5lckZvckRvY3VtZW50TG9hZGVkKHRoaXMub25Eb2N1bWVudExvYWRlZC5iaW5kKHRoaXMpKTtcbiAgICB9XG5cbiAgICBvbkRvY3VtZW50TG9hZGVkKGRvY3VtZW50TG9hZGVkRXZlbnQ6IERvY3VtZW50TG9hZGVkRXZlbnQpIHtcblxuICAgICAgICBsb2cuZGVidWcoXCJvbkRvY3VtZW50TG9hZGVkOiBcIiwgZG9jdW1lbnRMb2FkZWRFdmVudC5maW5nZXJwcmludCk7XG5cbiAgICAgICAgbGV0IGRvY01ldGFNb2RlbCA9IHRoaXMuY3JlYXRlRG9jTWV0YU1vZGVsKCk7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXJzID0gdGhpcy5jb250YWluZXJQcm92aWRlci5nZXRDb250YWluZXJzKCk7XG5cbiAgICAgICAgbG9nLmRlYnVnKFwiV29ya2luZyB3aXRoIGNvbnRhaW5lcnM6IFwiLCB0aGlzLmNvbnRhaW5lcnMpO1xuXG4gICAgICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlcyBmcm9tIHRoZSBtb2RlbCBhcyBvYmplY3RzIGFyZSBQUkVTRU5UIG9yIEFCU0VOVFxuICAgICAgICAvLyBmb3IgdGhlIHNwZWNpZmljIG9iamVjdHMgd2UncmUgaW50ZXJlc3RlZCBpbiBhbmQgdGhlbiBjYWxsXG4gICAgICAgIC8vIG9uQ29tcG9uZW50RXZlbnQgc28gdGhhdCB3ZSBjYW4gcmVuZGVyL2Rlc3Ryb3kgdGhlIGNvbXBvbmVudCBhbmRcbiAgICAgICAgLy8gYW5kIGNoYW5nZSBpdCBvbiBwYWdlIGV2ZW50cy5cblxuICAgICAgICBkb2NNZXRhTW9kZWwucmVnaXN0ZXJMaXN0ZW5lcihkb2N1bWVudExvYWRlZEV2ZW50LmRvY01ldGEsIHRoaXMub25Db21wb25lbnRFdmVudC5iaW5kKHRoaXMpKTtcblxuICAgIH1cblxuICAgIG9uQ29tcG9uZW50RXZlbnQoY29tcG9uZW50RXZlbnQ6IEFubm90YXRpb25FdmVudCkge1xuXG4gICAgICAgIC8vIFRPRE86IEkgdGhpbmsgaXQgd291bGQgYmUgYmV0dGVyIHRvIGJ1aWxkIHVwIHBhZ2VOdW0gYW5kIHBhZ2VFbGVtZW50XG4gICAgICAgIC8vIHdpdGhpbiBBbm5vdGF0aW9uRXZlbnQgLSBub3QgaGVyZS4gIFRoaXMgc2hvdWxkIGp1c3QgYmUgYSBDb21wb25lbnRFdmVudFxuICAgICAgICAvLyBhbmQgbm90IGtub3cgYW55dGhpbmcgYWJvdXQgYW5ub3RhdGlvbnMuXG5cbiAgICAgICAgbG9nLmRlYnVnKFwib25Db21wb25lbnRFdmVudDogXCIsIGNvbXBvbmVudEV2ZW50KTtcblxuICAgICAgICBsZXQgY29udGFpbmVySUQgPSBjb21wb25lbnRFdmVudC5wYWdlTWV0YS5wYWdlSW5mby5udW07XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROdW1iZXIoY29udGFpbmVySUQsIFwiY29udGFpbmVySURcIik7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROdW1iZXIoY29udGFpbmVySUQsIFwiY29udGFpbmVySURcIik7XG5cbiAgICAgICAgaWYoY29tcG9uZW50RXZlbnQubXV0YXRpb25TdGF0ZSA9PT0gTXV0YXRpb25TdGF0ZS5QUkVTRU5UKSB7XG5cbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIlBSRVNFTlRcIik7XG5cbiAgICAgICAgICAgIGxldCBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcnNbY29udGFpbmVySURdO1xuXG4gICAgICAgICAgICBpZighIGNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGNvbnRhaW5lciBmb3IgY29udGFpbmVySUQ6IFwiICsgY29udGFpbmVySUQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb21wb25lbnRFdmVudC5jb250YWluZXIgPSBjb250YWluZXI7XG5cbiAgICAgICAgICAgIC8vbGV0IGNvbnRhaW5lciA9IHRoaXMuY29udFxuXG4gICAgICAgICAgICAvLyBjcmVhdGUgdGhlIGNvbXBvbmVudCBhbmQgY2FsbCByZW5kZXIgb24gaXQuLi5cblxuICAgICAgICAgICAgbGV0IGNvbXBvbmVudCA9IHRoaXMuY3JlYXRlQ29tcG9uZW50KCk7XG5cbiAgICAgICAgICAgIGNvbXBvbmVudC5pbml0KGNvbXBvbmVudEV2ZW50KTtcblxuICAgICAgICAgICAgLy8gRklYTUU6IHJlZ2lzdGVyIHRoZSBjb21wb25lbnQgd2l0aCB0aGUgY29udGFpbmVyIGFuZCBPTkxZIGNhbGxcbiAgICAgICAgICAgIC8vIGhlIGNhbGxiYWNrIGlmIGFuZCB3aGVuIHRoZSBjb250YWluZXIgaXMgdmlzaWJsZS5cblxuICAgICAgICAgICAgbGV0IGNhbGxiYWNrID0gKGNvbnRhaW5lckxpZmVjeWNsZVN0YXRlOiBDb250YWluZXJMaWZlY3ljbGVTdGF0ZSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYoY29udGFpbmVyTGlmZWN5Y2xlU3RhdGUudmlzaWJsZSkge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vdyByZW5kZXIgdGhlIGNvbXBvbmVudCBvbiBzY3JlZW4uXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yZW5kZXIoKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXJcbiAgICAgICAgICAgICAgICA9IHRoaXMuY29udGFpbmVyUHJvdmlkZXIuY3JlYXRlQ29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIoY29udGFpbmVyKTtcblxuICAgICAgICAgICAgY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIucmVnaXN0ZXIoY2FsbGJhY2spO1xuXG4gICAgICAgICAgICBsZXQgY29udGFpbmVyU3RhdGUgPSBjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lci5nZXRTdGF0ZSgpO1xuXG4gICAgICAgICAgICBpZihjb250YWluZXJTdGF0ZSAmJiBjb250YWluZXJTdGF0ZS52aXNpYmxlKSB7XG4gICAgICAgICAgICAgICAgLy8gZHJhdyBpdCBtYW51YWxseSB0aGUgZmlyc3QgdGltZS5cbiAgICAgICAgICAgICAgICBjYWxsYmFjayhjb250YWluZXJTdGF0ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50c1tjb21wb25lbnRFdmVudC5pZF0gPSBuZXcgQ29tcG9uZW50RW50cnkoY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIsIGNvbXBvbmVudCk7XG5cbiAgICAgICAgfSBlbHNlIGlmKGNvbXBvbmVudEV2ZW50Lm11dGF0aW9uU3RhdGUgPT09IE11dGF0aW9uU3RhdGUuQUJTRU5UKSB7XG5cbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIkFCU0VOVFwiKTtcblxuICAgICAgICAgICAgbGV0IGNvbXBvbmVudEVudHJ5ID0gdGhpcy5jb21wb25lbnRzW2NvbXBvbmVudEV2ZW50LmlkXTtcblxuICAgICAgICAgICAgaWYoY29tcG9uZW50RW50cnkpIHtcblxuICAgICAgICAgICAgICAgIGNvbXBvbmVudEVudHJ5LmNvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyLnVucmVnaXN0ZXIoKTtcbiAgICAgICAgICAgICAgICBjb21wb25lbnRFbnRyeS5jb21wb25lbnQuZGVzdHJveSgpO1xuXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKFwiRGVzdHJveWVkIGNvbXBvbmVudDogXCIgKyBjb21wb25lbnRFdmVudC5pZCk7XG5cbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jb21wb25lbnRzW2NvbXBvbmVudEV2ZW50LmlkXTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2cud2FybihcIk5vIGNvbXBvbmVudCBlbnRyeSBmb3I6IFwiICsgY29tcG9uZW50RXZlbnQuaWQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50RW50cnkge1xuXG4gICAgcHVibGljIHJlYWRvbmx5IGNvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyOiBDb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgY29tcG9uZW50OiBDb21wb25lbnQ7XG5cbiAgICAvKipcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjogQ29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIsIGNvbXBvbmVudDogQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIgPSBjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjtcbiAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7XG4gICAgfVxuXG59XG4iXX0=