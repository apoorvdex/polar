"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("../Preconditions");
const HitMap_1 = require("../util/HitMap");
const Multimap_1 = require("../util/Multimap");
const ISODateTimeStrings_1 = require("./ISODateTimeStrings");
const PagemarkMode_1 = require("./PagemarkMode");
const Reducers_1 = require("../util/Reducers");
const Numbers_1 = require("../util/Numbers");
const Tuples_1 = require("../util/Tuples");
const PRE_EXISTING_DAY = '!preexisting';
class ReadingOverviews {
    static toDatePercs(records) {
        const mapping = new Multimap_1.ArrayListMultimap();
        for (const record of records) {
            const date = record.preExisting ? PRE_EXISTING_DAY : ISODateTimeStrings_1.ISODateTimeStrings.toISODate(record.created);
            const created = record.created;
            mapping.put(date, {
                created,
                perc: record.progressByMode[PagemarkMode_1.PagemarkMode.READ] || 0
            });
        }
        const dates = [...mapping.keys()].sort();
        const result = [];
        for (const date of dates) {
            const perc = mapping.get(date)
                .sort(((a, b) => a.created.localeCompare(b.created)))
                .reduce(Reducers_1.Reducers.LAST)
                .perc;
            result.push({ date, perc });
        }
        return result;
    }
    static toDatePercDeltas(readingEntries) {
        const tuples = Tuples_1.Tuples.createSiblings(readingEntries);
        const result = [];
        for (const tuple of tuples) {
            if (!tuple.prev) {
                result.push(tuple.curr);
            }
            else {
                const perc = Math.abs(tuple.curr.perc - tuple.prev.perc);
                result.push({ date: tuple.curr.date, perc });
            }
        }
        return result;
    }
    static toLogicalPages(pageMeta) {
        const dimensions = pageMeta.pageInfo.dimensions;
        if (dimensions && Preconditions_1.isPresent(dimensions.height)) {
            return dimensions.height / 1100;
        }
        return 1;
    }
    static toFixedFloat(value) {
        return Numbers_1.Numbers.toFixedFloat(value, 2);
    }
    static compute(pageMetas) {
        const hitMap = new HitMap_1.HitMap();
        for (const pageMeta of pageMetas) {
            const logicalPages = this.toLogicalPages(pageMeta);
            const datePercs = this.toDatePercs(Object.values(pageMeta.readingProgress));
            const datePercDeltas = this.toDatePercDeltas(datePercs);
            for (const datePercDelta of datePercDeltas) {
                const date = datePercDelta.date;
                const perc = datePercDelta.perc;
                const nrPages = this.toFixedFloat((perc / 100) * logicalPages);
                hitMap.registerHit(date, nrPages);
            }
        }
        const result = hitMap.toLiteralMap();
        delete result[PRE_EXISTING_DAY];
        return result;
    }
}
exports.ReadingOverviews = ReadingOverviews;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhZGluZ092ZXJ2aWV3cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlYWRpbmdPdmVydmlld3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxvREFBMkM7QUFDM0MsMkNBQXNDO0FBRXRDLCtDQUFtRDtBQUNuRCw2REFBMEY7QUFDMUYsaURBQTRDO0FBQzVDLCtDQUEwQztBQUMxQyw2Q0FBd0M7QUFDeEMsMkNBQXNDO0FBRXRDLE1BQU0sZ0JBQWdCLEdBQUcsY0FBYyxDQUFDO0FBRXhDLE1BQWEsZ0JBQWdCO0lBRWpCLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBdUM7UUFPOUQsTUFBTSxPQUFPLEdBQUcsSUFBSSw0QkFBaUIsRUFBOEMsQ0FBQztRQUVwRixLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRTtZQUUxQixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsdUNBQWtCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsRyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBRS9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFO2dCQUNkLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLE1BQU0sQ0FBQyxjQUFjLENBQUMsMkJBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2FBQ3RELENBQUMsQ0FBQztTQUVOO1FBRUQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXpDLE1BQU0sTUFBTSxHQUFlLEVBQUUsQ0FBQztRQUU5QixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUV0QixNQUFNLElBQUksR0FDTixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztpQkFDWixJQUFJLENBQUMsQ0FBQyxDQUFDLENB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Z1Byb2dyZXNzfSBmcm9tICcuL1JlYWRpbmdQcm9ncmVzcyc7XG5pbXBvcnQge1BhZ2VNZXRhfSBmcm9tICcuL1BhZ2VNZXRhJztcbmltcG9ydCB7aXNQcmVzZW50fSBmcm9tICcuLi9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7SGl0TWFwfSBmcm9tICcuLi91dGlsL0hpdE1hcCc7XG5pbXBvcnQge1JlYWRpbmdPdmVydmlld30gZnJvbSAnLi9SZWFkaW5nT3ZlcnZpZXcnO1xuaW1wb3J0IHtBcnJheUxpc3RNdWx0aW1hcH0gZnJvbSAnLi4vdXRpbC9NdWx0aW1hcCc7XG5pbXBvcnQge0lTT0RhdGVTdHJpbmcsIElTT0RhdGVUaW1lU3RyaW5nLCBJU09EYXRlVGltZVN0cmluZ3N9IGZyb20gJy4vSVNPRGF0ZVRpbWVTdHJpbmdzJztcbmltcG9ydCB7UGFnZW1hcmtNb2RlfSBmcm9tICcuL1BhZ2VtYXJrTW9kZSc7XG5pbXBvcnQge1JlZHVjZXJzfSBmcm9tICcuLi91dGlsL1JlZHVjZXJzJztcbmltcG9ydCB7TnVtYmVyc30gZnJvbSAnLi4vdXRpbC9OdW1iZXJzJztcbmltcG9ydCB7VHVwbGVzfSBmcm9tICcuLi91dGlsL1R1cGxlcyc7XG5cbmNvbnN0IFBSRV9FWElTVElOR19EQVkgPSAnIXByZWV4aXN0aW5nJztcblxuZXhwb3J0IGNsYXNzIFJlYWRpbmdPdmVydmlld3Mge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgdG9EYXRlUGVyY3MocmVjb3JkczogUmVhZG9ubHlBcnJheTxSZWFkaW5nUHJvZ3Jlc3M+KTogUmVhZG9ubHlBcnJheTxEYXRlUGVyYz4ge1xuXG4gICAgICAgIGludGVyZmFjZSBEYXRlVG9SZWFkUGVyYyB7XG4gICAgICAgICAgICByZWFkb25seSBjcmVhdGVkOiBJU09EYXRlVGltZVN0cmluZztcbiAgICAgICAgICAgIHJlYWRvbmx5IHBlcmM6IFBlcmM7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtYXBwaW5nID0gbmV3IEFycmF5TGlzdE11bHRpbWFwPHN0cmluZyAvKiBJU09EYXRlU3RyaW5nICovLCBEYXRlVG9SZWFkUGVyYz4oKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiByZWNvcmRzKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSByZWNvcmQucHJlRXhpc3RpbmcgPyBQUkVfRVhJU1RJTkdfREFZIDogSVNPRGF0ZVRpbWVTdHJpbmdzLnRvSVNPRGF0ZShyZWNvcmQuY3JlYXRlZCk7XG4gICAgICAgICAgICBjb25zdCBjcmVhdGVkID0gcmVjb3JkLmNyZWF0ZWQ7XG5cbiAgICAgICAgICAgIG1hcHBpbmcucHV0KGRhdGUsIHtcbiAgICAgICAgICAgICAgICBjcmVhdGVkLFxuICAgICAgICAgICAgICAgIHBlcmM6IHJlY29yZC5wcm9ncmVzc0J5TW9kZVtQYWdlbWFya01vZGUuUkVBRF0gfHwgMFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRhdGVzID0gWy4uLm1hcHBpbmcua2V5cygpXS5zb3J0KCk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0OiBEYXRlUGVyY1tdID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCBkYXRlIG9mIGRhdGVzKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBlcmMgPVxuICAgICAgICAgICAgICAgIG1hcHBpbmcuZ2V0KGRhdGUpXG4gICAgICAgICAgICAgICAgICAgIC5zb3J0KCgoYSwgYikgPT4gYS5jcmVhdGVkLmxvY2FsZUNvbXBhcmUoYi5jcmVhdGVkKSkpXG4gICAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoUmVkdWNlcnMuTEFTVClcbiAgICAgICAgICAgICAgICAgICAgLnBlcmM7XG5cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtkYXRlLCBwZXJjfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgdG9EYXRlUGVyY0RlbHRhcyhyZWFkaW5nRW50cmllczogUmVhZG9ubHlBcnJheTxEYXRlUGVyY0RlbHRhPikge1xuXG4gICAgICAgIGNvbnN0IHR1cGxlcyA9IFR1cGxlcy5jcmVhdGVTaWJsaW5ncyhyZWFkaW5nRW50cmllcyk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0OiBEYXRlUGVyY0RlbHRhW10gPSBbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IHR1cGxlIG9mIHR1cGxlcykge1xuXG4gICAgICAgICAgICBpZiAoISB0dXBsZS5wcmV2KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godHVwbGUuY3Vycik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcmMgPSBNYXRoLmFicyh0dXBsZS5jdXJyLnBlcmMgLSB0dXBsZS5wcmV2LnBlcmMpO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtkYXRlOiB0dXBsZS5jdXJyLmRhdGUsIHBlcmN9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIHRvTG9naWNhbFBhZ2VzKHBhZ2VNZXRhOiBQYWdlTWV0YSkge1xuXG4gICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBwYWdlTWV0YS5wYWdlSW5mby5kaW1lbnNpb25zO1xuXG4gICAgICAgIGlmIChkaW1lbnNpb25zICYmIGlzUHJlc2VudChkaW1lbnNpb25zLmhlaWdodCkpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgaW4gSFRNTCBkb2N1bWVudCBhbmQgd2Ugc2hvdWxkIGFzc3VtZSA4NTBweCB4IDExMDBweFxuICAgICAgICAgICAgLy8gaXMgYSBwYWdlLlxuICAgICAgICAgICAgcmV0dXJuIGRpbWVuc2lvbnMuaGVpZ2h0IC8gMTEwMDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAxO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgdG9GaXhlZEZsb2F0KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIE51bWJlcnMudG9GaXhlZEZsb2F0KHZhbHVlLCAyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNvbXB1dGUocGFnZU1ldGFzOiBSZWFkb25seUFycmF5PFBhZ2VNZXRhPik6IFJlYWRpbmdPdmVydmlldyB7XG5cbiAgICAgICAgY29uc3QgaGl0TWFwID0gbmV3IEhpdE1hcCgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgcGFnZU1ldGEgb2YgcGFnZU1ldGFzKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGxvZ2ljYWxQYWdlcyA9IHRoaXMudG9Mb2dpY2FsUGFnZXMocGFnZU1ldGEpO1xuXG4gICAgICAgICAgICBjb25zdCBkYXRlUGVyY3NcbiAgICAgICAgICAgICAgICA9IHRoaXMudG9EYXRlUGVyY3MoT2JqZWN0LnZhbHVlcyhwYWdlTWV0YS5yZWFkaW5nUHJvZ3Jlc3MpKTtcblxuICAgICAgICAgICAgY29uc3QgZGF0ZVBlcmNEZWx0YXMgPSB0aGlzLnRvRGF0ZVBlcmNEZWx0YXMoZGF0ZVBlcmNzKTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBkYXRlUGVyY0RlbHRhIG9mIGRhdGVQZXJjRGVsdGFzKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkYXRlID0gZGF0ZVBlcmNEZWx0YS5kYXRlO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcmMgPSBkYXRlUGVyY0RlbHRhLnBlcmM7XG4gICAgICAgICAgICAgICAgY29uc3QgbnJQYWdlcyA9IHRoaXMudG9GaXhlZEZsb2F0KChwZXJjIC8gMTAwKSAqIGxvZ2ljYWxQYWdlcyk7XG4gICAgICAgICAgICAgICAgaGl0TWFwLnJlZ2lzdGVySGl0KGRhdGUsIG5yUGFnZXMpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGhpdE1hcC50b0xpdGVyYWxNYXAoKTtcbiAgICAgICAgZGVsZXRlIHJlc3VsdFtQUkVfRVhJU1RJTkdfREFZXTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBEYXRlUGVyYyB7XG4gICAgcmVhZG9ubHkgZGF0ZTogSVNPRGF0ZVN0cmluZztcbiAgICByZWFkb25seSBwZXJjOiBQZXJjO1xufVxuXG4vKipcbiAqIEp1c3QgbGlrZSByZWFkaW5nIGVudHJ5IGJ1dCB0aGUgcmVhZGluZyBlbnRyaWVzIGFyZSBkZWx0YSBlbmNvZGVkIHdpdGhcbiAqIHRoZSBmaXJzdCBiZWluZyB0aGUgaW5pdGlhbCB2YWx1ZS5cbiAqL1xuaW50ZXJmYWNlIERhdGVQZXJjRGVsdGEgZXh0ZW5kcyBEYXRlUGVyYyB7XG5cbn1cblxuLyoqXG4gKlxuICogUGVyY2VudGFnZSBmcm9tIDAgdG8gMTAwXG4gKi9cbnR5cGUgUGVyYyA9IG51bWJlcjtcblxuIl19