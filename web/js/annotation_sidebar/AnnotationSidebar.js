"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const React = __importStar(require("react"));
const Logger_1 = require("../logger/Logger");
const DocAnnotations_1 = require("./DocAnnotations");
const DocAnnotationIndex_1 = require("./DocAnnotationIndex");
const DocAnnotationIndexes_1 = require("./DocAnnotationIndexes");
const AreaHighlightModel_1 = require("../highlights/area/model/AreaHighlightModel");
const MutationType_1 = require("../proxies/MutationType");
const TextHighlightModel_1 = require("../highlights/text/model/TextHighlightModel");
const Preconditions_1 = require("../Preconditions");
const DocAnnotationComponent_1 = require("./annotations/DocAnnotationComponent");
const CommentModel_1 = require("./CommentModel");
const Refs_1 = require("../metadata/Refs");
const FlashcardModel_1 = require("./FlashcardModel");
const ExportButton_1 = require("../ui/export/ExportButton");
const Exporters_1 = require("../metadata/exporter/Exporters");
const SplitBar_1 = require("../../../apps/repository/js/SplitBar");
const log = Logger_1.Logger.create();
class AnnotationSidebar extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.docAnnotationIndex = new DocAnnotationIndex_1.DocAnnotationIndex();
        this.scrollToAnnotation = this.scrollToAnnotation.bind(this);
        this.onExport = this.onExport.bind(this);
        const annotations = DocAnnotations_1.DocAnnotations.getAnnotationsForPage(props.docMeta);
        this.docAnnotationIndex
            = DocAnnotationIndexes_1.DocAnnotationIndexes.rebuild(this.docAnnotationIndex, ...annotations);
        this.state = {
            annotations: this.docAnnotationIndex.sortedDocAnnotation
        };
    }
    componentDidMount() {
        new AreaHighlightModel_1.AreaHighlightModel().registerListener(this.props.docMeta, annotationEvent => {
            const docAnnotation = this.convertAnnotation(annotationEvent.value, annotationValue => DocAnnotations_1.DocAnnotations.createFromAreaHighlight(annotationValue, annotationEvent.pageMeta));
            this.handleAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, docAnnotation);
        });
        new TextHighlightModel_1.TextHighlightModel().registerListener(this.props.docMeta, annotationEvent => {
            const docAnnotation = this.convertAnnotation(annotationEvent.value, annotationValue => DocAnnotations_1.DocAnnotations.createFromTextHighlight(annotationValue, annotationEvent.pageMeta));
            this.handleAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, docAnnotation);
        });
        new CommentModel_1.CommentModel().registerListener(this.props.docMeta, annotationEvent => {
            const comment = annotationEvent.value || annotationEvent.previousValue;
            const childDocAnnotation = DocAnnotations_1.DocAnnotations.createFromComment(comment, annotationEvent.pageMeta);
            this.handleChildAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, childDocAnnotation);
        });
        new FlashcardModel_1.FlashcardModel().registerListener(this.props.docMeta, annotationEvent => {
            const flashcard = annotationEvent.value || annotationEvent.previousValue;
            const childDocAnnotation = DocAnnotations_1.DocAnnotations.createFromFlashcard(flashcard, annotationEvent.pageMeta);
            this.handleChildAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, childDocAnnotation);
        });
    }
    convertAnnotation(value, converter) {
        if (!Preconditions_1.isPresent(value)) {
            return undefined;
        }
        return converter(value);
    }
    handleChildAnnotationEvent(id, mutationType, childDocAnnotation) {
        if (!childDocAnnotation.ref) {
            log.warn("Annotation hidden from sidebar: ", childDocAnnotation);
            return;
        }
        const ref = Refs_1.Refs.parse(childDocAnnotation.ref);
        const annotation = this.docAnnotationIndex.docAnnotationMap[ref.value];
        if (!annotation) {
            log.warn("No annotation for ref:", annotation);
            return;
        }
        if (!annotation.children) {
            annotation.children = [];
        }
        if (mutationType !== MutationType_1.MutationType.DELETE) {
            annotation.children.push(childDocAnnotation);
            annotation.children.sort((c0, c1) => -c0.created.localeCompare(c1.created));
        }
        else {
            annotation.children =
                annotation.children.filter(current => current.id !== id);
        }
        this.reload();
    }
    handleAnnotationEvent(id, mutationType, docAnnotation) {
        if (mutationType === MutationType_1.MutationType.INITIAL) {
            return;
        }
        else if (mutationType === MutationType_1.MutationType.DELETE) {
            this.docAnnotationIndex
                = DocAnnotationIndexes_1.DocAnnotationIndexes.delete(this.docAnnotationIndex, id);
            this.reload();
        }
        else {
            this.refresh(docAnnotation);
        }
    }
    refresh(docAnnotation) {
        this.docAnnotationIndex
            = DocAnnotationIndexes_1.DocAnnotationIndexes.rebuild(this.docAnnotationIndex, docAnnotation);
        this.reload();
    }
    reload() {
        this.setState({
            annotations: this.docAnnotationIndex.sortedDocAnnotation
        });
    }
    scrollToAnnotation(id, pageNum) {
        const selector = `.page div[data-annotation-id='${id}']`;
        const pageElements = Array.from(document.querySelectorAll(".page"));
        const pageElement = pageElements[pageNum - 1];
        if (!pageElement) {
            log.error(`Could not find page ${pageNum} of N pages: ${pageElements.length}`);
            return;
        }
        this.scrollToElement(pageElement);
        const annotationElement = document.querySelector(selector);
        this.scrollToElement(annotationElement);
    }
    scrollToElement(element) {
        element.scrollIntoView({
            behavior: 'auto',
            block: 'center',
            inline: 'center'
        });
    }
    createItems(annotations) {
        const result = [];
        annotations.map(annotation => {
            result.push(React.createElement(DocAnnotationComponent_1.DocAnnotationComponent, { key: annotation.id, annotation: annotation, docMeta: this.props.docMeta }));
        });
        return result;
    }
    onExport(path, format) {
        Exporters_1.Exporters.doExport(path, format, this.props.docMeta)
            .catch(err => log.error(err));
    }
    render() {
        const { annotations } = this.state;
        const AnnotationHeader = () => {
            if (annotations.length === 0) {
                return (React.createElement("div", null));
            }
            return (React.createElement("div", { className: "p-1 pb-2 mb-3 border-bottom pl-1 pr-1" },
                React.createElement(SplitBar_1.SplitBar, null,
                    React.createElement(SplitBar_1.SplitBarLeft, null,
                        React.createElement("div", { style: { fontWeight: 'bold', fontSize: '14px' } }, "Annotations")),
                    React.createElement(SplitBar_1.SplitBarRight, null,
                        React.createElement(ExportButton_1.ExportButton, { onExport: (path, format) => this.onExport(path, format) })))));
        };
        return (React.createElement("div", { id: "annotation-manager", className: "annotation-sidebar" },
            React.createElement(AnnotationHeader, null),
            React.createElement("div", { className: "annotations" }, this.createItems(annotations))));
    }
}
exports.AnnotationSidebar = AnnotationSidebar;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQW5ub3RhdGlvblNpZGViYXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBbm5vdGF0aW9uU2lkZWJhci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsNkNBQStCO0FBQy9CLDZDQUF3QztBQUd4QyxxREFBZ0Q7QUFFaEQsNkRBQXdEO0FBQ3hELGlFQUE0RDtBQUM1RCxvRkFBK0U7QUFDL0UsMERBQXFEO0FBQ3JELG9GQUErRTtBQUMvRSxvREFBMkM7QUFDM0MsaUZBQTRFO0FBQzVFLGlEQUE0QztBQUM1QywyQ0FBMkM7QUFDM0MscURBQWdEO0FBRWhELDREQUF1RDtBQUN2RCw4REFBdUU7QUFDdkUsbUVBQTJGO0FBRTNGLE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFhLGlCQUFrQixTQUFRLEtBQUssQ0FBQyxTQUF5QjtJQUlsRSxZQUFZLEtBQWEsRUFBRSxPQUFZO1FBQ25DLEtBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFIbEIsdUJBQWtCLEdBQXVCLElBQUksdUNBQWtCLEVBQUUsQ0FBQztRQUt0RSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXpDLE1BQU0sV0FBVyxHQUFHLCtCQUFjLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhFLElBQUksQ0FBQyxrQkFBa0I7Y0FDakIsMkNBQW9CLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDO1FBRTVFLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxXQUFXLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQjtTQUMzRCxDQUFDO0lBRU4sQ0FBQztJQUVNLGlCQUFpQjtRQUlwQixJQUFJLHVDQUFrQixFQUFFLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUU7WUFFNUUsTUFBTSxhQUFhLEdBQ2YsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxFQUFFLENBQUMsK0JBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLEVBQ2YsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFFaEgsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQ2xCLGVBQWUsQ0FBQyxVQUFVLENBQUMsWUFBWSxFQUN2QyxhQUFhLENBQUMsQ0FBQztRQUU5QyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksdUNBQWtCLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxlQUFlLENBQUMsRUFBRTtZQUU1RSxNQUFNLGFBQWEsR0FDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLEtBQUssRUFDckIsZUFBZSxDQUFDLEVBQUUsQ0FBQywrQkFBYyxDQUFDLHVCQUF1QixDQUFDLGVBQWUsRUFDZixlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUVoSCxJQUFJLENBQUMscUJBQXFCLENBQUMsZUFBZSxDQUFDLEVBQUUsRUFDbEIsZUFBZSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQ3ZDLGFBQWEsQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSwyQkFBWSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUU7WUFFdEUsTUFBTSxPQUFPLEdBQVksZUFBZSxDQUFDLEtBQUssSUFBSSxlQUFlLENBQUMsYUFBYSxDQUFDO1lBQ2hGLE1BQU0sa0JBQWtCLEdBQUcsK0JBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRS9GLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxlQUFlLENBQUMsRUFBRSxFQUNsQixlQUFlLENBQUMsVUFBVSxDQUFDLFlBQVksRUFDdkMsa0JBQWtCLENBQUMsQ0FBQztRQUV4RCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksK0JBQWMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxFQUFFO1lBRXhFLE1BQU0sU0FBUyxHQUFjLGVBQWUsQ0FBQyxLQUFLLElBQUksZUFBZSxDQUFDLGFBQWEsQ0FBQztZQUNwRixNQUFNLGtCQUFrQixHQUFHLCtCQUFjLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVuRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsZUFBZSxDQUFDLEVBQUUsRUFDbEIsZUFBZSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQ3ZDLGtCQUFrQixDQUFDLENBQUM7UUFFeEQsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRU8saUJBQWlCLENBQUksS0FBNkIsRUFBRSxTQUE0QjtRQUVwRixJQUFJLENBQUUseUJBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNwQixPQUFPLFNBQVMsQ0FBQztTQUNwQjtRQUVELE9BQU8sU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRTVCLENBQUM7SUFFTywwQkFBMEIsQ0FBQyxFQUFVLEVBQ1YsWUFBMEIsRUFDMUIsa0JBQWlDO1FBRWhFLElBQUksQ0FBRSxrQkFBa0IsQ0FBQyxHQUFHLEVBQUU7WUFFMUIsR0FBRyxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2pFLE9BQU87U0FDVjtRQUVELE1BQU0sR0FBRyxHQUFHLFdBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsR0FBSSxDQUFDLENBQUM7UUFFaEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV2RSxJQUFJLENBQUUsVUFBVSxFQUFFO1lBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUMvQyxPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUUsVUFBVSxDQUFDLFFBQVEsRUFBRTtZQUN2QixVQUFVLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUM1QjtRQUVELElBQUksWUFBWSxLQUFLLDJCQUFZLENBQUMsTUFBTSxFQUFFO1lBRXRDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDN0MsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBRS9FO2FBQU07WUFFSCxVQUFVLENBQUMsUUFBUTtnQkFDZixVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7U0FFaEU7UUFFRCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFHbEIsQ0FBQztJQUVPLHFCQUFxQixDQUFDLEVBQVUsRUFDVixZQUEwQixFQUMxQixhQUF3QztRQUVsRSxJQUFJLFlBQVksS0FBSywyQkFBWSxDQUFDLE9BQU8sRUFBRTtZQUV2QyxPQUFPO1NBQ1Y7YUFBTSxJQUFJLFlBQVksS0FBSywyQkFBWSxDQUFDLE1BQU0sRUFBRTtZQUU3QyxJQUFJLENBQUMsa0JBQWtCO2tCQUNqQiwyQ0FBb0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRS9ELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUVqQjthQUFNO1lBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFjLENBQUMsQ0FBQztTQUNoQztJQUVMLENBQUM7SUFFTyxPQUFPLENBQUMsYUFBNEI7UUFFeEMsSUFBSSxDQUFDLGtCQUFrQjtjQUNqQiwyQ0FBb0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRTNFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUVsQixDQUFDO0lBRU8sTUFBTTtRQUVWLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDVixXQUFXLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQjtTQUMzRCxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRU8sa0JBQWtCLENBQUMsRUFBVSxFQUFFLE9BQWU7UUFFbEQsTUFBTSxRQUFRLEdBQUcsaUNBQWlDLEVBQUUsSUFBSSxDQUFDO1FBRXpELE1BQU0sWUFBWSxHQUFrQixLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ25GLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFOUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNkLEdBQUcsQ0FBQyxLQUFLLENBQUMsdUJBQXVCLE9BQU8sZ0JBQWdCLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQy9FLE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFbEMsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBaUIsQ0FBQztRQUUzRSxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFFNUMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFvQjtRQUV4QyxPQUFPLENBQUMsY0FBYyxDQUFDO1lBQ25CLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLEtBQUssRUFBRSxRQUFRO1lBQ2YsTUFBTSxFQUFFLFFBQVE7U0FDbkIsQ0FBQyxDQUFDO0lBRVAsQ0FBQztJQUVPLFdBQVcsQ0FBQyxXQUE0QjtRQU81QyxNQUFNLE1BQU0sR0FBUSxFQUFFLENBQUM7UUFFdkIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUN6QixNQUFNLENBQUMsSUFBSSxDQUFFLG9CQUFDLCtDQUFzQixJQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsRUFBRSxFQUNsQixVQUFVLEVBQUUsVUFBVSxFQUN0QixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ3pFLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFFbEIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxJQUFZLEVBQUUsTUFBb0I7UUFFL0MscUJBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQzthQUMvQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFFdEMsQ0FBQztJQUVNLE1BQU07UUFFVCxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUVuQyxNQUFNLGdCQUFnQixHQUFHLEdBQUcsRUFBRTtZQUUxQixJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUMxQixPQUFPLENBQUMsZ0NBQVcsQ0FBQyxDQUFDO2FBQ3hCO1lBRUQsT0FBTyxDQUdILDZCQUFLLFNBQVMsRUFBQyx1Q0FBdUM7Z0JBRWxELG9CQUFDLG1CQUFRO29CQUVMLG9CQUFDLHVCQUFZO3dCQUNULDZCQUFLLEtBQUssRUFBRSxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBQyxrQkFBbUIsQ0FDMUQ7b0JBRWYsb0JBQUMsd0JBQWE7d0JBRVYsb0JBQUMsMkJBQVksSUFBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsR0FBRyxDQUU1RCxDQUdULENBRVQsQ0FFVCxDQUFDO1FBRU4sQ0FBQyxDQUFDO1FBRUYsT0FBTyxDQUVILDZCQUFLLEVBQUUsRUFBQyxvQkFBb0IsRUFBQyxTQUFTLEVBQUMsb0JBQW9CO1lBRXZELG9CQUFDLGdCQUFnQixPQUFFO1lBRW5CLDZCQUFLLFNBQVMsRUFBQyxhQUFhLElBQ3ZCLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQzVCLENBRUosQ0FFVCxDQUFDO0lBQ04sQ0FBQztDQUVKO0FBNVFELDhDQTRRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICcuLi9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7Q29tbWVudH0gZnJvbSAnLi4vbWV0YWRhdGEvQ29tbWVudCc7XG5pbXBvcnQge0RvY01ldGF9IGZyb20gJy4uL21ldGFkYXRhL0RvY01ldGEnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uc30gZnJvbSAnLi9Eb2NBbm5vdGF0aW9ucyc7XG5pbXBvcnQge0RvY0Fubm90YXRpb259IGZyb20gJy4vRG9jQW5ub3RhdGlvbic7XG5pbXBvcnQge0RvY0Fubm90YXRpb25JbmRleH0gZnJvbSAnLi9Eb2NBbm5vdGF0aW9uSW5kZXgnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uSW5kZXhlc30gZnJvbSAnLi9Eb2NBbm5vdGF0aW9uSW5kZXhlcyc7XG5pbXBvcnQge0FyZWFIaWdobGlnaHRNb2RlbH0gZnJvbSAnLi4vaGlnaGxpZ2h0cy9hcmVhL21vZGVsL0FyZWFIaWdobGlnaHRNb2RlbCc7XG5pbXBvcnQge011dGF0aW9uVHlwZX0gZnJvbSAnLi4vcHJveGllcy9NdXRhdGlvblR5cGUnO1xuaW1wb3J0IHtUZXh0SGlnaGxpZ2h0TW9kZWx9IGZyb20gJy4uL2hpZ2hsaWdodHMvdGV4dC9tb2RlbC9UZXh0SGlnaGxpZ2h0TW9kZWwnO1xuaW1wb3J0IHtpc1ByZXNlbnR9IGZyb20gJy4uL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uQ29tcG9uZW50fSBmcm9tICcuL2Fubm90YXRpb25zL0RvY0Fubm90YXRpb25Db21wb25lbnQnO1xuaW1wb3J0IHtDb21tZW50TW9kZWx9IGZyb20gJy4vQ29tbWVudE1vZGVsJztcbmltcG9ydCB7UmVmLCBSZWZzfSBmcm9tICcuLi9tZXRhZGF0YS9SZWZzJztcbmltcG9ydCB7Rmxhc2hjYXJkTW9kZWx9IGZyb20gJy4vRmxhc2hjYXJkTW9kZWwnO1xuaW1wb3J0IHtGbGFzaGNhcmR9IGZyb20gJy4uL21ldGFkYXRhL0ZsYXNoY2FyZCc7XG5pbXBvcnQge0V4cG9ydEJ1dHRvbn0gZnJvbSAnLi4vdWkvZXhwb3J0L0V4cG9ydEJ1dHRvbic7XG5pbXBvcnQge0V4cG9ydEZvcm1hdCwgRXhwb3J0ZXJzfSBmcm9tICcuLi9tZXRhZGF0YS9leHBvcnRlci9FeHBvcnRlcnMnO1xuaW1wb3J0IHtTcGxpdEJhciwgU3BsaXRCYXJMZWZ0LCBTcGxpdEJhclJpZ2h0fSBmcm9tICcuLi8uLi8uLi9hcHBzL3JlcG9zaXRvcnkvanMvU3BsaXRCYXInO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBBbm5vdGF0aW9uU2lkZWJhciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuXG4gICAgcHJpdmF0ZSBkb2NBbm5vdGF0aW9uSW5kZXg6IERvY0Fubm90YXRpb25JbmRleCA9IG5ldyBEb2NBbm5vdGF0aW9uSW5kZXgoKTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMsIGNvbnRleHQ6IGFueSkge1xuICAgICAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XG5cbiAgICAgICAgdGhpcy5zY3JvbGxUb0Fubm90YXRpb24gPSB0aGlzLnNjcm9sbFRvQW5ub3RhdGlvbi5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uRXhwb3J0ID0gdGhpcy5vbkV4cG9ydC5iaW5kKHRoaXMpO1xuXG4gICAgICAgIGNvbnN0IGFubm90YXRpb25zID0gRG9jQW5ub3RhdGlvbnMuZ2V0QW5ub3RhdGlvbnNGb3JQYWdlKHByb3BzLmRvY01ldGEpO1xuXG4gICAgICAgIHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4XG4gICAgICAgICAgICA9IERvY0Fubm90YXRpb25JbmRleGVzLnJlYnVpbGQodGhpcy5kb2NBbm5vdGF0aW9uSW5kZXgsIC4uLmFubm90YXRpb25zKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgYW5ub3RhdGlvbnM6IHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LnNvcnRlZERvY0Fubm90YXRpb25cbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBjb21wb25lbnREaWRNb3VudCgpOiB2b2lkIHtcblxuICAgICAgICAvLyBUT0RPOiByZW1vdmUgYWxsIHRoZXNlIGxpc3RlbmVycyB3aGVuIHRoZSBjb21wb25lbnQgdW5tb3VudHMuLi5cblxuICAgICAgICBuZXcgQXJlYUhpZ2hsaWdodE1vZGVsKCkucmVnaXN0ZXJMaXN0ZW5lcih0aGlzLnByb3BzLmRvY01ldGEsIGFubm90YXRpb25FdmVudCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRvY0Fubm90YXRpb24gPVxuICAgICAgICAgICAgICAgIHRoaXMuY29udmVydEFubm90YXRpb24oYW5ub3RhdGlvbkV2ZW50LnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvblZhbHVlID0+IERvY0Fubm90YXRpb25zLmNyZWF0ZUZyb21BcmVhSGlnaGxpZ2h0KGFubm90YXRpb25WYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEpKTtcblxuICAgICAgICAgICAgdGhpcy5oYW5kbGVBbm5vdGF0aW9uRXZlbnQoYW5ub3RhdGlvbkV2ZW50LmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnRyYWNlRXZlbnQubXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jQW5ub3RhdGlvbik7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV3IFRleHRIaWdobGlnaHRNb2RlbCgpLnJlZ2lzdGVyTGlzdGVuZXIodGhpcy5wcm9wcy5kb2NNZXRhLCBhbm5vdGF0aW9uRXZlbnQgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBkb2NBbm5vdGF0aW9uID1cbiAgICAgICAgICAgICAgICB0aGlzLmNvbnZlcnRBbm5vdGF0aW9uKGFubm90YXRpb25FdmVudC52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25WYWx1ZSA9PiBEb2NBbm5vdGF0aW9ucy5jcmVhdGVGcm9tVGV4dEhpZ2hsaWdodChhbm5vdGF0aW9uVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnBhZ2VNZXRhKSk7XG5cbiAgICAgICAgICAgIHRoaXMuaGFuZGxlQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25FdmVudC50cmFjZUV2ZW50Lm11dGF0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY0Fubm90YXRpb24pO1xuICAgICAgICB9KTtcblxuICAgICAgICBuZXcgQ29tbWVudE1vZGVsKCkucmVnaXN0ZXJMaXN0ZW5lcih0aGlzLnByb3BzLmRvY01ldGEsIGFubm90YXRpb25FdmVudCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnQ6IENvbW1lbnQgPSBhbm5vdGF0aW9uRXZlbnQudmFsdWUgfHwgYW5ub3RhdGlvbkV2ZW50LnByZXZpb3VzVmFsdWU7XG4gICAgICAgICAgICBjb25zdCBjaGlsZERvY0Fubm90YXRpb24gPSBEb2NBbm5vdGF0aW9ucy5jcmVhdGVGcm9tQ29tbWVudChjb21tZW50LCBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEpO1xuXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUNoaWxkQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnRyYWNlRXZlbnQubXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZERvY0Fubm90YXRpb24pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBGbGFzaGNhcmRNb2RlbCgpLnJlZ2lzdGVyTGlzdGVuZXIodGhpcy5wcm9wcy5kb2NNZXRhLCBhbm5vdGF0aW9uRXZlbnQgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBmbGFzaGNhcmQ6IEZsYXNoY2FyZCA9IGFubm90YXRpb25FdmVudC52YWx1ZSB8fCBhbm5vdGF0aW9uRXZlbnQucHJldmlvdXNWYWx1ZTtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkRG9jQW5ub3RhdGlvbiA9IERvY0Fubm90YXRpb25zLmNyZWF0ZUZyb21GbGFzaGNhcmQoZmxhc2hjYXJkLCBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEpO1xuXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUNoaWxkQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnRyYWNlRXZlbnQubXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZERvY0Fubm90YXRpb24pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb252ZXJ0QW5ub3RhdGlvbjxUPih2YWx1ZTogYW55IHwgdW5kZWZpbmVkIHwgbnVsbCwgY29udmVydGVyOiAoaW5wdXQ6IGFueSkgPT4gVCkge1xuXG4gICAgICAgIGlmICghIGlzUHJlc2VudCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29udmVydGVyKHZhbHVlKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ2hpbGRBbm5vdGF0aW9uRXZlbnQoaWQ6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGF0aW9uVHlwZTogTXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGREb2NBbm5vdGF0aW9uOiBEb2NBbm5vdGF0aW9uKSB7XG5cbiAgICAgICAgaWYgKCEgY2hpbGREb2NBbm5vdGF0aW9uLnJlZikge1xuICAgICAgICAgICAgLy8gdGhpcyBpcyBhbiBvbGQgYW5ub3RhdGlvbi4gIFdlIGNhbid0IHNob3cgaXQgaW4gdGhlIHNpZGViYXIgeWV0LlxuICAgICAgICAgICAgbG9nLndhcm4oXCJBbm5vdGF0aW9uIGhpZGRlbiBmcm9tIHNpZGViYXI6IFwiLCBjaGlsZERvY0Fubm90YXRpb24pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVmID0gUmVmcy5wYXJzZShjaGlsZERvY0Fubm90YXRpb24ucmVmISk7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvbiA9IHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LmRvY0Fubm90YXRpb25NYXBbcmVmLnZhbHVlXTtcblxuICAgICAgICBpZiAoISBhbm5vdGF0aW9uKSB7XG4gICAgICAgICAgICBsb2cud2FybihcIk5vIGFubm90YXRpb24gZm9yIHJlZjpcIiwgYW5ub3RhdGlvbik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoISBhbm5vdGF0aW9uLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBhbm5vdGF0aW9uLmNoaWxkcmVuID0gW107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobXV0YXRpb25UeXBlICE9PSBNdXRhdGlvblR5cGUuREVMRVRFKSB7XG5cbiAgICAgICAgICAgIGFubm90YXRpb24uY2hpbGRyZW4ucHVzaChjaGlsZERvY0Fubm90YXRpb24pO1xuICAgICAgICAgICAgYW5ub3RhdGlvbi5jaGlsZHJlbi5zb3J0KChjMCwgYzEpID0+IC1jMC5jcmVhdGVkLmxvY2FsZUNvbXBhcmUoYzEuY3JlYXRlZCkpO1xuXG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIGFubm90YXRpb24uY2hpbGRyZW4gPVxuICAgICAgICAgICAgICAgIGFubm90YXRpb24uY2hpbGRyZW4uZmlsdGVyKGN1cnJlbnQgPT4gY3VycmVudC5pZCAhPT0gaWQpO1xuXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnJlbG9hZCgpO1xuXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUFubm90YXRpb25FdmVudChpZDogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGF0aW9uVHlwZTogTXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY0Fubm90YXRpb246IERvY0Fubm90YXRpb24gfCB1bmRlZmluZWQpIHtcblxuICAgICAgICBpZiAobXV0YXRpb25UeXBlID09PSBNdXRhdGlvblR5cGUuSU5JVElBTCkge1xuICAgICAgICAgICAgLy8gd2UgYWxyZWFkeSBoYXZlIHRoZSBkYXRhIHByb3Blcmx5LlxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKG11dGF0aW9uVHlwZSA9PT0gTXV0YXRpb25UeXBlLkRFTEVURSkge1xuXG4gICAgICAgICAgICB0aGlzLmRvY0Fubm90YXRpb25JbmRleFxuICAgICAgICAgICAgICAgID0gRG9jQW5ub3RhdGlvbkluZGV4ZXMuZGVsZXRlKHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LCBpZCk7XG5cbiAgICAgICAgICAgIHRoaXMucmVsb2FkKCk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaChkb2NBbm5vdGF0aW9uISk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgcmVmcmVzaChkb2NBbm5vdGF0aW9uOiBEb2NBbm5vdGF0aW9uKSB7XG5cbiAgICAgICAgdGhpcy5kb2NBbm5vdGF0aW9uSW5kZXhcbiAgICAgICAgICAgID0gRG9jQW5ub3RhdGlvbkluZGV4ZXMucmVidWlsZCh0aGlzLmRvY0Fubm90YXRpb25JbmRleCwgZG9jQW5ub3RhdGlvbik7XG5cbiAgICAgICAgdGhpcy5yZWxvYWQoKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgcmVsb2FkKCkge1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgYW5ub3RhdGlvbnM6IHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LnNvcnRlZERvY0Fubm90YXRpb25cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHNjcm9sbFRvQW5ub3RhdGlvbihpZDogc3RyaW5nLCBwYWdlTnVtOiBudW1iZXIpIHtcblxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IGAucGFnZSBkaXZbZGF0YS1hbm5vdGF0aW9uLWlkPScke2lkfSddYDtcblxuICAgICAgICBjb25zdCBwYWdlRWxlbWVudHM6IEhUTUxFbGVtZW50W10gPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIucGFnZVwiKSk7XG4gICAgICAgIGNvbnN0IHBhZ2VFbGVtZW50ID0gcGFnZUVsZW1lbnRzW3BhZ2VOdW0gLSAxXTtcblxuICAgICAgICBpZiAoIXBhZ2VFbGVtZW50KSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoYENvdWxkIG5vdCBmaW5kIHBhZ2UgJHtwYWdlTnVtfSBvZiBOIHBhZ2VzOiAke3BhZ2VFbGVtZW50cy5sZW5ndGh9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNjcm9sbFRvRWxlbWVudChwYWdlRWxlbWVudCk7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvbkVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSEgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgdGhpcy5zY3JvbGxUb0VsZW1lbnQoYW5ub3RhdGlvbkVsZW1lbnQpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzY3JvbGxUb0VsZW1lbnQoZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICBlbGVtZW50LnNjcm9sbEludG9WaWV3KHtcbiAgICAgICAgICAgIGJlaGF2aW9yOiAnYXV0bycsXG4gICAgICAgICAgICBibG9jazogJ2NlbnRlcicsXG4gICAgICAgICAgICBpbmxpbmU6ICdjZW50ZXInXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVJdGVtcyhhbm5vdGF0aW9uczogRG9jQW5ub3RhdGlvbltdKSB7XG5cbiAgICAgICAgLy8gaHR0cHM6Ly9ibG9nLmNsb3VkYm9vc3QuaW8vZm9yLWxvb3BzLWluLXJlYWN0LXJlbmRlci1uby15b3UtZGlkbnQtNmM5ZjRhYTczNzc4XG5cbiAgICAgICAgLy8gVE9ETzogSSdtIG5vdCBzdXJlIHdoYXQgdHlwZSBvZiBjbGFzcyBhIDxkaXY+IG9yIFJlYWN0IGVsZW1lbnQgdXNlc1xuICAgICAgICAvLyBzbyB1c2luZyAnYW55JyBmb3Igbm93LlxuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gW107XG5cbiAgICAgICAgYW5ub3RhdGlvbnMubWFwKGFubm90YXRpb24gPT4ge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2ggKDxEb2NBbm5vdGF0aW9uQ29tcG9uZW50IGtleT17YW5ub3RhdGlvbi5pZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uPXthbm5vdGF0aW9ufVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY01ldGE9e3RoaXMucHJvcHMuZG9jTWV0YX0vPik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRXhwb3J0KHBhdGg6IHN0cmluZywgZm9ybWF0OiBFeHBvcnRGb3JtYXQpIHtcblxuICAgICAgICBFeHBvcnRlcnMuZG9FeHBvcnQocGF0aCwgZm9ybWF0LCB0aGlzLnByb3BzLmRvY01ldGEpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IGxvZy5lcnJvcihlcnIpKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG5cbiAgICAgICAgY29uc3QgeyBhbm5vdGF0aW9ucyB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBjb25zdCBBbm5vdGF0aW9uSGVhZGVyID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAoYW5ub3RhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICg8ZGl2PjwvZGl2Pik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAoXG5cblxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwicC0xIHBiLTIgbWItMyBib3JkZXItYm90dG9tIHBsLTEgcHItMVwiPlxuXG4gICAgICAgICAgICAgICAgICAgIDxTcGxpdEJhcj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPFNwbGl0QmFyTGVmdD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPXt7Zm9udFdlaWdodDogJ2JvbGQnLCBmb250U2l6ZTogJzE0cHgnfX0+QW5ub3RhdGlvbnM8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvU3BsaXRCYXJMZWZ0PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8U3BsaXRCYXJSaWdodD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxFeHBvcnRCdXR0b24gb25FeHBvcnQ9eyhwYXRoLCBmb3JtYXQpID0+IHRoaXMub25FeHBvcnQocGF0aCwgZm9ybWF0KX0vPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8L1NwbGl0QmFyUmlnaHQ+XG5cblxuICAgICAgICAgICAgICAgICAgICA8L1NwbGl0QmFyPlxuXG4gICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gKFxuXG4gICAgICAgICAgICA8ZGl2IGlkPVwiYW5ub3RhdGlvbi1tYW5hZ2VyXCIgY2xhc3NOYW1lPVwiYW5ub3RhdGlvbi1zaWRlYmFyXCI+XG5cbiAgICAgICAgICAgICAgICA8QW5ub3RhdGlvbkhlYWRlci8+XG5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImFubm90YXRpb25zXCI+XG4gICAgICAgICAgICAgICAgICAgIHt0aGlzLmNyZWF0ZUl0ZW1zKGFubm90YXRpb25zKX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgKTtcbiAgICB9XG5cbn1cblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgcmVhZG9ubHkgZG9jTWV0YTogRG9jTWV0YTtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcmVhZG9ubHkgYW5ub3RhdGlvbnM6IERvY0Fubm90YXRpb25bXTtcbn1cblxuXG4iXX0=