"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Rect_1 = require("./Rect");
const Preconditions_1 = require("./Preconditions");
const Styles_1 = require("./util/Styles");
const Objects_1 = require("./util/Objects");
class Rects {
    static isVisible(rect) {
        return rect.height > 0 && rect.width > 0;
    }
    static scale(rect, scale) {
        Preconditions_1.Preconditions.assertNotNull(rect, "rect");
        rect = Rects.validate(rect);
        rect = new Rect_1.Rect(rect);
        let result = {};
        Objects_1.Objects.typedKeys(rect).forEach(key => {
            result[key] = rect[key] * scale;
        });
        return Rects.validate(result);
    }
    static validate(rect) {
        Preconditions_1.Preconditions.assertNotNull(rect.left, "left");
        Preconditions_1.Preconditions.assertNotNull(rect.top, "top");
        Preconditions_1.Preconditions.assertNotNull(rect.width, "width");
        Preconditions_1.Preconditions.assertNotNull(rect.height, "height");
        Preconditions_1.Preconditions.assertNotNull(rect.bottom, "bottom");
        Preconditions_1.Preconditions.assertNotNull(rect.right, "right");
        Preconditions_1.Preconditions.assertNumber(rect.left, "left");
        Preconditions_1.Preconditions.assertNumber(rect.top, "top");
        Preconditions_1.Preconditions.assertNumber(rect.width, "width");
        Preconditions_1.Preconditions.assertNumber(rect.height, "height");
        Preconditions_1.Preconditions.assertNumber(rect.bottom, "bottom");
        Preconditions_1.Preconditions.assertNumber(rect.right, "right");
        if (!(rect instanceof Rect_1.Rect)) {
            return new Rect_1.Rect(rect);
        }
        else {
            return rect;
        }
    }
    static relativeTo(point, rect) {
        rect = Rects.validate(rect);
        rect = new Rect_1.Rect(rect);
        rect.left = rect.left + point.x;
        rect.top = rect.top + point.y;
        rect.right = rect.right + point.x;
        rect.bottom = rect.bottom + point.y;
        return Rects.validate(rect);
    }
    static move(rect, dir, absolute) {
        rect = new Rect_1.Rect(rect);
        if (absolute) {
            if (dir.x !== undefined) {
                rect.left = dir.x;
                rect.right = rect.left + rect.width;
            }
            if (dir.y !== undefined) {
                rect.top = dir.y;
                rect.bottom = rect.top + rect.height;
            }
        }
        else {
            if (dir.x !== undefined) {
                rect.left = rect.left + dir.x;
                rect.right = rect.right + dir.x;
            }
            if (dir.y !== undefined) {
                rect.bottom = rect.bottom + dir.y;
                rect.top = rect.top + dir.y;
            }
        }
        return Rects.validate(rect);
    }
    static intersect(a, b) {
        return (a.left <= b.right &&
            b.left <= a.right &&
            a.top <= b.bottom &&
            b.top <= a.bottom);
    }
    static overlap(a, b) {
        return a.toLine("x").overlaps(b.toLine("x")) || a.toLine("y").overlaps(b.toLine("y"));
    }
    static intersection(a, b) {
        return Rects.createFromBasicRect({
            top: Math.max(a.top, b.top),
            bottom: Math.min(a.bottom, b.bottom),
            left: Math.max(a.left, b.left),
            right: Math.min(a.right, b.right),
        });
    }
    static intersectedPositions(a, b) {
        let result = [];
        if (_interval(a.left, b.right, a.right)) {
            result.push("left");
        }
        if (_interval(a.left, b.left, a.right)) {
            result.push("right");
        }
        if (_interval(a.top, b.bottom, a.bottom)) {
            result.push("top");
        }
        if (_interval(a.top, b.top, a.bottom)) {
            result.push("bottom");
        }
        return result;
    }
    static relativePositions(a, b) {
        Rects.validate(a);
        Rects.validate(b);
        let result = {};
        result.top = Math.abs(a.top - b.bottom);
        result.bottom = Math.abs(a.bottom - b.top);
        result.left = Math.abs(a.left - a.right);
        result.right = Math.abs(a.right - b.left);
        return result;
    }
    static subtract(a, b) {
        a = Rects.validate(a);
        b = Rects.validate(b);
        let keys = ["left", "top", "right", "bottom", "width", "height"];
        let result = {};
        keys.forEach(key => {
            result[key] = a[key] - b[key];
        });
        return new Rect_1.Rect(result);
    }
    static add(a, b) {
        a = Rects.validate(a);
        b = Rects.validate(b);
        let keys = ["left", "top", "right", "bottom", "width", "height"];
        let result = {};
        keys.forEach(key => {
            result[key] = a[key] + b[key];
        });
        return new Rect_1.Rect(result);
    }
    static perc(a, b) {
        if (a.width > b.width || a.height > b.height) {
            throw new Error(`Dimensions invalid ${a.dimensions} vs ${b.dimensions}`);
        }
        let result = {
            left: 100 * (a.left / b.width),
            right: 100 * (a.right / b.width),
            top: 100 * (a.top / b.height),
            bottom: 100 * (a.bottom / b.height)
        };
        return Rects.createFromBasicRect(result);
    }
    static createFromBasicRect(rect) {
        rect = new Rect_1.Rect(rect);
        if (!rect.bottom && "top" in rect && "height" in rect) {
            rect.bottom = rect.top + rect.height;
        }
        if (!rect.right && "left" in rect && "width" in rect) {
            rect.right = rect.left + rect.width;
        }
        if (!rect.height && "bottom" in rect && "top" in rect) {
            rect.height = rect.bottom - rect.top;
        }
        if (!rect.width && "right" in rect && "left" in rect) {
            rect.width = rect.right - rect.left;
        }
        return Rects.validate(new Rect_1.Rect(rect));
    }
    static createFromLines(xAxis, yAxis) {
        Preconditions_1.Preconditions.assertNotNull(xAxis, "xAxis");
        Preconditions_1.Preconditions.assertNotNull(yAxis, "yAxis");
        Preconditions_1.Preconditions.assertEqual(xAxis.axis, "x", "xAxis.axis");
        Preconditions_1.Preconditions.assertEqual(yAxis.axis, "y", "yAxis.axis");
        return Rects.createFromBasicRect({
            left: xAxis.start,
            width: xAxis.length,
            top: yAxis.start,
            height: yAxis.length
        });
    }
    static createFromOffset(element) {
        return Rects.createFromBasicRect({
            left: element.offsetLeft,
            top: element.offsetTop,
            width: element.offsetWidth,
            height: element.offsetHeight,
        });
    }
    static fromElementStyle(element) {
        let rect = {
            left: Styles_1.Styles.parsePX(element.style.left),
            top: Styles_1.Styles.parsePX(element.style.top),
            width: Styles_1.Styles.parsePX(element.style.width),
            height: Styles_1.Styles.parsePX(element.style.height)
        };
        return Rects.createFromBasicRect(rect);
    }
}
exports.Rects = Rects;
function _interval(min, point, max) {
    return min <= point && point <= max;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVjdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJSZWN0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUE0QjtBQUM1QixtREFBOEM7QUFHOUMsMENBQXFDO0FBQ3JDLDRDQUF1QztBQUV2QyxNQUFhLEtBQUs7SUFRZCxNQUFNLENBQUMsU0FBUyxDQUFDLElBQW9CO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQU9ELE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBVSxFQUFFLEtBQWE7UUFFbEMsNkJBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRzFDLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTVCLElBQUksR0FBRyxJQUFJLFdBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV0QixJQUFJLE1BQU0sR0FBUSxFQUFFLENBQUM7UUFFckIsaUJBQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBVyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRWxDLENBQUM7SUFZTSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQVM7UUFFNUIsNkJBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMvQyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdDLDZCQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFL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LENBQUMsR0FBRyxDQUFDO1lBQ3RDLEtBQUssRUFBRSxlQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO1lBQzFDLE1BQU0sRUFBRSxlQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1NBRS9DLENBQUM7UUFFRixPQUFPLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUzQyxDQUFDO0NBRUo7QUE3YUQsc0JBNmFDO0FBV0QsU0FBUyxTQUFTLENBQUMsR0FBVyxFQUFFLEtBQWEsRUFBRSxHQUFXO0lBRXRELE9BQU8sR0FBRyxJQUFJLEtBQUssSUFBSSxLQUFLLElBQUksR0FBRyxDQUFDO0FBQ3hDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JlY3R9IGZyb20gJy4vUmVjdCc7XG5pbXBvcnQge1ByZWNvbmRpdGlvbnN9IGZyb20gJy4vUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1BvaW50fSBmcm9tICcuL1BvaW50JztcbmltcG9ydCB7TGluZX0gZnJvbSAnLi91dGlsL0xpbmUnO1xuaW1wb3J0IHtTdHlsZXN9IGZyb20gJy4vdXRpbC9TdHlsZXMnO1xuaW1wb3J0IHtPYmplY3RzfSBmcm9tICcuL3V0aWwvT2JqZWN0cyc7XG5cbmV4cG9ydCBjbGFzcyBSZWN0cyB7XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIHN1cmUgdGhlIHJlY3QgaXMgdmlzaWJsZS4gSWYgaXQgaGFzIGEgemVybyB3aWR0aCBvciBoZWlnaHQgaXQnc1xuICAgICAqIG5vdCB2aXNpYmxlLlxuICAgICAqIEBwYXJhbSByZWN0IHtSZWN0IHwgRE9NUmVjdH1cbiAgICAgKiBAcmV0dXJuIGJvb2xlYW4gVHJ1ZSB3aGVuIHRoZSByZWN0IGlzIHZpc2libGUuXG4gICAgICovXG4gICAgc3RhdGljIGlzVmlzaWJsZShyZWN0OiBSZWN0IHwgRE9NUmVjdCkge1xuICAgICAgICByZXR1cm4gcmVjdC5oZWlnaHQgPiAwICYmIHJlY3Qud2lkdGggPiAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNjYWxlIHRoZSByZWN0IGJhc2VkIG9uIHRoZSBjdXJyZW50IHZhbHVlcyBhbmQgdGhlIGdpdmVuIHNjYWxlLlxuICAgICAqIEBwYXJhbSByZWN0IHtSZWN0fVxuICAgICAqIEBwYXJhbSBzY2FsZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHN0YXRpYyBzY2FsZShyZWN0OiBSZWN0LCBzY2FsZTogbnVtYmVyKSB7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKHJlY3QsIFwicmVjdFwiKTtcblxuICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIGlucHV0IGlzIHZhbGlkIGJlZm9yZSB3ZSB3b3JrIG9uIGl0LlxuICAgICAgICByZWN0ID0gUmVjdHMudmFsaWRhdGUocmVjdCk7XG5cbiAgICAgICAgcmVjdCA9IG5ldyBSZWN0KHJlY3QpO1xuXG4gICAgICAgIGxldCByZXN1bHQ6IGFueSA9IHt9O1xuXG4gICAgICAgIE9iamVjdHMudHlwZWRLZXlzKHJlY3QpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gPG51bWJlcj5yZWN0W2tleV0gKiBzY2FsZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLnZhbGlkYXRlKHJlc3VsdCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIHN1cmUgdGhlIGdpdmVuIHJlY3QgaGFzIGFsbCB0aGUgY29ycmVjdCBwcm9wZXJ0aWVzIGFuZCB0aGVuIHJldHVyblxuICAgICAqIHRoZSByZWN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIHJlY3Qge09iamVjdH0gQSByZWN0LWxpa2Ugb2JqZWN0IHdpdGggdGhlIGZpZWxkcyB3ZSBuZWVkIHRvIHdvcmtcbiAgICAgKiAgICAgICAgd2l0aC4gIElmIGl0J3Mgbm90IGFjdHVhbGx5IGFuIGluc3RhbmNlIG9mIFJlY3Qgd2UgY3JlYXRlIGEgcmVjdFxuICAgICAqICAgICAgICBhbmQgcmV0dXJuIHRoYXQgaW5zdGVhZC5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge1JlY3R9XG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyB2YWxpZGF0ZShyZWN0OiBhbnkpOiBSZWN0IHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwocmVjdC5sZWZ0LCBcImxlZnRcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0Tm90TnVsbChyZWN0LnRvcCwgXCJ0b3BcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0Tm90TnVsbChyZWN0LndpZHRoLCBcIndpZHRoXCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwocmVjdC5oZWlnaHQsIFwiaGVpZ2h0XCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwocmVjdC5ib3R0b20sIFwiYm90dG9tXCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwocmVjdC5yaWdodCwgXCJyaWdodFwiKTtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE51bWJlcihyZWN0LmxlZnQsIFwibGVmdFwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROdW1iZXIocmVjdC50b3AsIFwidG9wXCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE51bWJlcihyZWN0LndpZHRoLCBcIndpZHRoXCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE51bWJlcihyZWN0LmhlaWdodCwgXCJoZWlnaHRcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0TnVtYmVyKHJlY3QuYm90dG9tLCBcImJvdHRvbVwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROdW1iZXIocmVjdC5yaWdodCwgXCJyaWdodFwiKTtcblxuICAgICAgICBpZiAoISAocmVjdCBpbnN0YW5jZW9mIFJlY3QpKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlY3QocmVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gcmVjdDtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzdW1lIHRoYXQgdGhlIGdpdmVuIHJlY3QgaXMgcmVsYXRpdmUgdG8gdGhlIHBvaW50IGFuZCByZXR1cm4gdGhlIG5ld1xuICAgICAqIHJlY3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcG9pbnQge1BvaW50fVxuICAgICAqIEBwYXJhbSByZWN0IHtSZWN0fVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVsYXRpdmVUbyhwb2ludDogUG9pbnQsIHJlY3Q6IFJlY3QpIHtcblxuICAgICAgICByZWN0ID0gUmVjdHMudmFsaWRhdGUocmVjdCk7XG4gICAgICAgIHJlY3QgPSBuZXcgUmVjdChyZWN0KTtcblxuICAgICAgICByZWN0LmxlZnQgPSByZWN0LmxlZnQgKyBwb2ludC54O1xuICAgICAgICByZWN0LnRvcCA9IHJlY3QudG9wICsgcG9pbnQueTtcblxuICAgICAgICByZWN0LnJpZ2h0ID0gcmVjdC5yaWdodCArIHBvaW50Lng7XG4gICAgICAgIHJlY3QuYm90dG9tID0gcmVjdC5ib3R0b20gKyBwb2ludC55O1xuXG4gICAgICAgIHJldHVybiBSZWN0cy52YWxpZGF0ZShyZWN0KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc3VtZSB0aGF0IHRoZSBnaXZlbiByZWN0IGlzIHJlbGF0aXZlIHRvIHRoZSBwb2ludCBhbmQgcmV0dXJuIHRoZSBuZXdcbiAgICAgKiByZWN0LlxuICAgICAqXG4gICAgICogVGhpcyBhZGp1c3QgQUxMIHByb3BlcnRpZXMgaW5jbHVkaW5nIHRvcCwgbGVmdCwgYm90dG9tLCByaWdodFxuICAgICAqXG4gICAgICogQHBhcmFtIHJlY3Qge1JlY3R9IFRoZSByZWN0IHRvIG1vdmUuXG4gICAgICogQHBhcmFtIGRpciB7T2JqZWN0fSBNb3ZlIHRoZSByZWN0IGluIHRoZSBnaXZlbiBkaXIgKGRpcmVjdGlvbikgaW4gdGhlXG4gICAgICogeCBhbmQgeSBwbGFuZS4gIFRoZSBkaXIueCBhbmQgZGlyLnkgc3BlY2lmeSBob3cgbXVjaCB0byBtb3ZlIHRoZSByZWN0LlxuICAgICAqIEBwYXJhbSBhYnNvbHV0ZSB7Ym9vbGVhbn0gV2hlbiB0cnVlLCBtb3ZlIHRvIHRoZSBhYnNvbHV0ZSBwb3NpdGlvbiwgbm90XG4gICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5cbiAgICAgKiBAcmV0dXJuIHtSZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBtb3ZlKHJlY3Q6IFJlY3QsIGRpcjogRGlyZWN0aW9uLCBhYnNvbHV0ZTogYm9vbGVhbikge1xuXG4gICAgICAgIHJlY3QgPSBuZXcgUmVjdChyZWN0KTtcblxuICAgICAgICBpZihhYnNvbHV0ZSkge1xuXG4gICAgICAgICAgICBpZihkaXIueCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcmVjdC5sZWZ0ID0gZGlyLng7XG4gICAgICAgICAgICAgICAgcmVjdC5yaWdodCA9IHJlY3QubGVmdCArIHJlY3Qud2lkdGg7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmKGRpci55ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZWN0LnRvcCA9IGRpci55O1xuICAgICAgICAgICAgICAgIHJlY3QuYm90dG9tID0gcmVjdC50b3AgKyByZWN0LmhlaWdodDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvLyBUT0RPOiBJIGNvdWxkIGp1c3QgY29udmVydCB0aGUgcmVsYXRpdmUgcG9zaXRpb25zIHRvIGFic29sdXRlIHRvXG4gICAgICAgICAgICAvLyBjbGVhbiB1cCB0aGlzIGNvZGUgYSBiaXQuXG4gICAgICAgICAgICBpZihkaXIueCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcmVjdC5sZWZ0ID0gcmVjdC5sZWZ0ICsgZGlyLng7XG4gICAgICAgICAgICAgICAgcmVjdC5yaWdodCA9IHJlY3QucmlnaHQgKyBkaXIueDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYoZGlyLnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHJlY3QuYm90dG9tID0gcmVjdC5ib3R0b20gKyBkaXIueTtcbiAgICAgICAgICAgICAgICByZWN0LnRvcCA9IHJlY3QudG9wICsgZGlyLnk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBSZWN0cy52YWxpZGF0ZShyZWN0KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0cnVlIGlmIHRoZSB0d28gcmVjdHMgaW50ZXJzZWN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIGEge1JlY3R8T2JqZWN0fVxuICAgICAqIEBwYXJhbSBiIHtSZWN0fE9iamVjdH1cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAgICovXG4gICAgc3RhdGljIGludGVyc2VjdChhOiBSZWN0LCBiOiBSZWN0KSB7XG5cbiAgICAgICAgLy8gVE9ETzogaW50ZXJuYWxseSB3ZSBzaG91bGQgY29udmVydCB0aGUgb2JqZWN0IHRvIGEgcmVjdCBzbyB3ZSBjYW5cbiAgICAgICAgLy8gdmFsaWRhdGUgaXQuXG5cbiAgICAgICAgcmV0dXJuIChhLmxlZnQgPD0gYi5yaWdodCAmJlxuICAgICAgICAgICAgICAgIGIubGVmdCA8PSBhLnJpZ2h0ICYmXG4gICAgICAgICAgICAgICAgYS50b3AgPD0gYi5ib3R0b20gJiZcbiAgICAgICAgICAgICAgICBiLnRvcCA8PSBhLmJvdHRvbSlcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0cnVlIGlmIHRoZSB0d28gcmVjdHMgb3ZlcmxhcC4gVGhpcyBpbmNsdWRlcyBpbnRlcnNlY3Rpb24gYnV0IGFsc29cbiAgICAgKiBpbmNsdWRlcyBvbmUgY29tcGxldGVseSBzd2FsbG93aW5nIHRoZSBvdGhlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBhIHtSZWN0fVxuICAgICAqIEBwYXJhbSBiIHtSZWN0fVxuICAgICAqXG4gICAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBzdGF0aWMgb3ZlcmxhcChhOiBSZWN0LCBiOiBSZWN0KSB7XG4gICAgICAgIHJldHVybiBhLnRvTGluZShcInhcIikub3ZlcmxhcHMoYi50b0xpbmUoXCJ4XCIpKSB8fCBhLnRvTGluZShcInlcIikub3ZlcmxhcHMoYi50b0xpbmUoXCJ5XCIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb21wdXRlIHRoZSBpbnRlcnNlY3Rpb24gb2YgYSBhbmQgYiBhcyBhIG5ldyByZWN0LlxuICAgICAqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gYSB7UmVjdH1cbiAgICAgKiBAcGFyYW0gYiB7UmVjdH1cbiAgICAgKiBAcmV0dXJuIHtSZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBpbnRlcnNlY3Rpb24oYTogUmVjdCwgYjogUmVjdCkge1xuXG4gICAgICAgIC8vIFRPRE8vcmVmYWN0b3IuICBNYWtlIGVhY2ggZGltZW5zaW9uIGEgbGluZSwgdGhlbiBhZGp1c3QgdGhlIGxpbmUuXG4gICAgICAgIC8vIFRoaXMgd2F5IHRoZSBzYW1lIGZ1bmN0aW9uIGlzIHVzZWQgdHdpY2Ugd2l0aCBsZXNzIGNvcHkvcGFzdGUuXG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgdG9wOiBNYXRoLm1heChhLnRvcCwgYi50b3ApLFxuICAgICAgICAgICAgYm90dG9tOiBNYXRoLm1pbihhLmJvdHRvbSwgYi5ib3R0b20pLFxuICAgICAgICAgICAgbGVmdDogTWF0aC5tYXgoYS5sZWZ0LCBiLmxlZnQpLFxuICAgICAgICAgICAgcmlnaHQ6IE1hdGgubWluKGEucmlnaHQsIGIucmlnaHQpLFxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgcG9zaXRpb25zIHdoZXJlIGBhYCAocmVmZXJlbmNlKSBpcyBpbnRlcnNlY3RlZCBieSBgYmAuICBJZlxuICAgICAqIGFsbCBmb3VyIHNpemVzIGFyZSBwcmVzZW50IGEgZW52ZWxvcHMgYi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBhIHtSZWN0fVxuICAgICAqIEBwYXJhbSBiIHtSZWN0fVxuICAgICAqIEByZXR1cm4ge0FycmF5PHN0cmluZz59XG4gICAgICovXG4gICAgc3RhdGljIGludGVyc2VjdGVkUG9zaXRpb25zKGE6IFJlY3QsIGI6IFJlY3QpIHtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gW107XG5cbiAgICAgICAgaWYoX2ludGVydmFsKGEubGVmdCwgYi5yaWdodCwgYS5yaWdodCkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwibGVmdFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmKF9pbnRlcnZhbChhLmxlZnQsIGIubGVmdCwgYS5yaWdodCkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwicmlnaHRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZihfaW50ZXJ2YWwoYS50b3AsIGIuYm90dG9tLCBhLmJvdHRvbSkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwidG9wXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoX2ludGVydmFsKGEudG9wLCBiLnRvcCwgYS5ib3R0b20pKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChcImJvdHRvbVwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUYWtlIHR3byByZWN0cyBhbmQgcmV0dXJuIHRoZSBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gb25lIGFub3RoZXIuICBXZVxuICAgICAqIGFzc3VtZSB0aGF0IHRoZSByZWN0cyB0byBub3QgaW50ZXJzZWN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIGEge1JlY3R9XG4gICAgICogQHBhcmFtIGIge1JlY3R9XG4gICAgICogQHJldHVybiB7T2JqZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyByZWxhdGl2ZVBvc2l0aW9ucyhhOiBSZWN0LCBiOiBSZWN0KSB7XG5cbiAgICAgICAgUmVjdHMudmFsaWRhdGUoYSk7XG4gICAgICAgIFJlY3RzLnZhbGlkYXRlKGIpO1xuXG4gICAgICAgIGxldCByZXN1bHQ6IGFueSA9IHt9O1xuXG4gICAgICAgIC8vIGJhc2ljYWxseSB0aGlzIGlzIHRoZSBkZWdyZWUgQVdBWSBmcm9tIGdpdmVuIHBvc2l0aW9uLiAgTmVnYXRpdmVcbiAgICAgICAgLy8gdmFsdWVzIHdvdWxkIGJlIEJFRk9SRSB0aGUgcG9zaXRpb24uXG5cbiAgICAgICAgcmVzdWx0LnRvcCA9IE1hdGguYWJzKGEudG9wIC0gYi5ib3R0b20pO1xuICAgICAgICByZXN1bHQuYm90dG9tID0gTWF0aC5hYnMoYS5ib3R0b20gLSBiLnRvcCk7XG4gICAgICAgIHJlc3VsdC5sZWZ0ID0gTWF0aC5hYnMoYS5sZWZ0IC0gYS5yaWdodCk7XG4gICAgICAgIHJlc3VsdC5yaWdodCA9IE1hdGguYWJzKGEucmlnaHQgLSBiLmxlZnQpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdWJ0cmFjdCBzZWNvbmQgcmVjdCBmcm9tIHRoZSBmaXJzdCBhbmQgcmV0dXJuIGEgdmlydHVhbCByZWN0IHdpdGggdGhlXG4gICAgICogY2hhbmdlIGluIGVsZW1lbnRzLiBUaGUgY2hhbmdlIGlzIHZpcnR1YWwgYXMgd2UgY291bGQgcmVjb3JkIGEgcmVjdCB3aXRoXG4gICAgICogbmVnYXRpdmUgd2lkdGggZm9yIGEgZ2l2ZW4gbGluZSB3aGljaCB3b3VsZCBiZSBhbiBpbWFnaW5hcnkgZ2VvbWV0cmljXG4gICAgICogb2JqZWN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIGEge1JlY3R9XG4gICAgICogQHBhcmFtIGIge1JlY3R9XG4gICAgICovXG4gICAgc3RhdGljIHN1YnRyYWN0KGE6IFJlY3QsIGI6IFJlY3QpOiBSZWN0IHtcblxuICAgICAgICBhID0gUmVjdHMudmFsaWRhdGUoYSk7XG4gICAgICAgIGIgPSBSZWN0cy52YWxpZGF0ZShiKTtcblxuICAgICAgICBsZXQga2V5czogKGtleW9mIFJlY3QpW10gPSBbXCJsZWZ0XCIsIFwidG9wXCIsIFwicmlnaHRcIiwgXCJib3R0b21cIiwgXCJ3aWR0aFwiLCBcImhlaWdodFwiXTtcblxuICAgICAgICBsZXQgcmVzdWx0OiBhbnkgPSB7fTtcblxuICAgICAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gPG51bWJlcj5hW2tleV0gLSA8bnVtYmVyPmJba2V5XTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBSZWN0KHJlc3VsdCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgdHdvIHJlY3RzIHRvZ2V0aGVyIHRvIGJ1aWxkIGEgbmV3IHJlY3QuICBUaGUgc2Vjb25kIHJlY3QgY291bGQgYmVcbiAgICAgKiB2aXJ0dWFsIGFuZCBoYXZlIGEgbmVnYXRpdmUgd2lkdGggZm9yIGEgbGluZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBhIHtSZWN0fVxuICAgICAqIEBwYXJhbSBiIHtSZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBhZGQoYTogUmVjdCwgYjogUmVjdCkge1xuXG4gICAgICAgIGEgPSBSZWN0cy52YWxpZGF0ZShhKTtcbiAgICAgICAgYiA9IFJlY3RzLnZhbGlkYXRlKGIpO1xuXG4gICAgICAgIGxldCBrZXlzOiAoa2V5b2YgUmVjdClbXSA9IFtcImxlZnRcIiwgXCJ0b3BcIiwgXCJyaWdodFwiLCBcImJvdHRvbVwiLCBcIndpZHRoXCIsIFwiaGVpZ2h0XCJdO1xuXG4gICAgICAgIGxldCByZXN1bHQ6IGFueSA9IHt9O1xuXG4gICAgICAgIGtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W2tleV0gPSA8bnVtYmVyPmFba2V5XSArIDxudW1iZXI+YltrZXldO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFJlY3QocmVzdWx0KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgcGVyY2VudGFnZSB0aGF0IGEgdGFrZXMgb2YgYiwgYSBpcyBhc3N1bWVkIHRvIGJlIDw9IGIgaW4gdGVybXNcbiAgICAgKiBvZiBkaW1lbnNpb25zIGFuZCBvbiB0aGUgc2FtZSBjb29yZGluYXRlIHBsYW5lLlxuICAgICAqXG4gICAgICogQHBhcmFtIGEge1JlY3R9XG4gICAgICogQHBhcmFtIGIge1JlY3R9XG4gICAgICogQHJldHVybiB7UmVjdH1cbiAgICAgKi9cbiAgICBzdGF0aWMgcGVyYyhhOiBSZWN0LCBiOiBSZWN0KSB7XG5cbiAgICAgICAgaWYoYS53aWR0aCA+IGIud2lkdGggfHwgYS5oZWlnaHQgPiBiLmhlaWdodCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaW1lbnNpb25zIGludmFsaWQgJHthLmRpbWVuc2lvbnN9IHZzICR7Yi5kaW1lbnNpb25zfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IHtcbiAgICAgICAgICAgIGxlZnQ6IDEwMCAqIChhLmxlZnQgLyBiLndpZHRoKSxcbiAgICAgICAgICAgIHJpZ2h0OiAxMDAgKiAoYS5yaWdodCAvIGIud2lkdGgpLFxuICAgICAgICAgICAgdG9wOiAxMDAgKiAoYS50b3AgLyBiLmhlaWdodCksXG4gICAgICAgICAgICBib3R0b206IDEwMCAqIChhLmJvdHRvbSAvIGIuaGVpZ2h0KVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHJlc3VsdCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBmdWxsIHJlY3QgZnJvbSBhIHJlY3QgdGhhdCBoYXMgdG9wLCBsZWZ0LCB3aWR0aCwgaGVpZ2h0IG9ubHkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVjdCB7UmVjdCB8IE9iamVjdH1cbiAgICAgKiBAcmV0dXJuIHtSZWN0fVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlRnJvbUJhc2ljUmVjdChyZWN0OiBhbnkpOiBSZWN0IHtcblxuICAgICAgICByZWN0ID0gbmV3IFJlY3QocmVjdCk7XG5cbiAgICAgICAgLy8gVE9ETzogYWRkIHgseSBpbiB0aGUgZnV0dXJlLlxuXG4gICAgICAgIC8vIHRoZSBvcHRpb25hbCBvbmVzIGFyZSBib3R0b20rcmlnaHQgb3Igd2lkdGgraGVpZ2h0IGJ1dCB3ZSBjb3VsZCBhZGRcbiAgICAgICAgLy8gc3VwcG9ydCBmb3Igb3RoZXIgb3B0aW9uYWwgb25lcy4uLlxuXG4gICAgICAgIC8vIGl0IG1pZ2h0IGJlIGJldHRlciB0byBzYXksIGlmIHZhcjAgYW5kIHZhcjEgYXJlIGRlZmluZWQsIEkgY2FuIGNvbXB1dGVcbiAgICAgICAgLy8gdmFyMiBvciB2YXIgMy4uLiBhbmQgdGhlbiBkZWZpbmUgdGhlbSB3aGVuIHRoZXkgYXJlIG5vdCBkZWZpbmVkLiAgRm9yXG4gICAgICAgIC8vIGV4YW1wbGUuIElmIHRvcCBhbmQgaGVpZ2h0IGFyZSBkZWZpbmVkLCBJIGNhbiBkZWZpbmUgYm90dG9tLlxuXG4gICAgICAgIGlmKCEgcmVjdC5ib3R0b20gJiYgXCJ0b3BcIiBpbiByZWN0ICYmIFwiaGVpZ2h0XCIgaW4gcmVjdCkge1xuICAgICAgICAgICAgcmVjdC5ib3R0b20gPSByZWN0LnRvcCArIHJlY3QuaGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoISByZWN0LnJpZ2h0ICYmIFwibGVmdFwiIGluIHJlY3QgJiYgXCJ3aWR0aFwiIGluIHJlY3QpIHtcbiAgICAgICAgICAgIHJlY3QucmlnaHQgPSByZWN0LmxlZnQgKyByZWN0LndpZHRoO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoISByZWN0LmhlaWdodCAmJiBcImJvdHRvbVwiIGluIHJlY3QgJiYgXCJ0b3BcIiBpbiByZWN0KSB7XG4gICAgICAgICAgICByZWN0LmhlaWdodCA9IHJlY3QuYm90dG9tIC0gcmVjdC50b3A7XG4gICAgICAgIH1cblxuICAgICAgICBpZighIHJlY3Qud2lkdGggJiYgXCJyaWdodFwiIGluIHJlY3QgJiYgXCJsZWZ0XCIgaW4gcmVjdCkge1xuICAgICAgICAgICAgcmVjdC53aWR0aCA9IHJlY3QucmlnaHQgLSByZWN0LmxlZnQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUmVjdHMudmFsaWRhdGUobmV3IFJlY3QocmVjdCkpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IHJlY3QgZnJvbSB0aGUgZ2l2ZW4gbGluZXNcbiAgICAgKiBAcGFyYW0geEF4aXMge0xpbmV9XG4gICAgICogQHBhcmFtIHlBeGlzIHtMaW5lfVxuICAgICAqIEByZXR1cm4ge1JlY3R9XG4gICAgICovXG4gICAgc3RhdGljIGNyZWF0ZUZyb21MaW5lcyh4QXhpczogTGluZSwgeUF4aXM6IExpbmUpIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoeEF4aXMsIFwieEF4aXNcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0Tm90TnVsbCh5QXhpcywgXCJ5QXhpc1wiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRFcXVhbCh4QXhpcy5heGlzLCBcInhcIiwgXCJ4QXhpcy5heGlzXCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydEVxdWFsKHlBeGlzLmF4aXMsIFwieVwiLCBcInlBeGlzLmF4aXNcIik7XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgbGVmdDogeEF4aXMuc3RhcnQsXG4gICAgICAgICAgICB3aWR0aDogeEF4aXMubGVuZ3RoLFxuICAgICAgICAgICAgdG9wOiB5QXhpcy5zdGFydCxcbiAgICAgICAgICAgIGhlaWdodDogeUF4aXMubGVuZ3RoXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBlbGVtZW50IHtIVE1MRWxlbWVudH1cbiAgICAgKiBAcmV0dXJuIHtSZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBjcmVhdGVGcm9tT2Zmc2V0KGVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgLy8gRklYTUU6IGlmIEknbSB1c2luZyB0aGlzIGl0IG1pZ2h0IG5vdCBiZSB3aGF0IEkgd2FudC5cblxuICAgICAgICByZXR1cm4gUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdCh7XG4gICAgICAgICAgICBsZWZ0OiBlbGVtZW50Lm9mZnNldExlZnQsXG4gICAgICAgICAgICB0b3A6IGVsZW1lbnQub2Zmc2V0VG9wLFxuICAgICAgICAgICAgd2lkdGg6IGVsZW1lbnQub2Zmc2V0V2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IGVsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBhcnNlIHRoZSBwb3NpdGlvbmluZyBmcm9tIHRoZSBzdHlsZSB3aXRoIGxlZnQsIHRvcCB3aWR0aCBhbmQgaGVpZ2h0IGFuZCB0aGVuXG4gICAgICogcmV0dXJuIHRoaXMgYXMgYSByZWN0LlxuICAgICAqIEBwYXJhbSBlbGVtZW50IHtIVE1MRWxlbWVudH1cbiAgICAgKi9cbiAgICBzdGF0aWMgZnJvbUVsZW1lbnRTdHlsZShlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGxldCByZWN0ID0ge1xuXG4gICAgICAgICAgICBsZWZ0OiBTdHlsZXMucGFyc2VQWChlbGVtZW50LnN0eWxlLmxlZnQpLFxuICAgICAgICAgICAgdG9wOiBTdHlsZXMucGFyc2VQWChlbGVtZW50LnN0eWxlLnRvcCksXG4gICAgICAgICAgICB3aWR0aDogU3R5bGVzLnBhcnNlUFgoZWxlbWVudC5zdHlsZS53aWR0aCksXG4gICAgICAgICAgICBoZWlnaHQ6IFN0eWxlcy5wYXJzZVBYKGVsZW1lbnQuc3R5bGUuaGVpZ2h0KVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QocmVjdCk7XG5cbiAgICB9XG5cbn1cblxuLyoqXG4gKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgcG9pbnQgaXMgd2l0aGluIHRoZSBnaXZlbiBtaW4gYW5kIG1heCBpbnRlcnZhbC5cbiAqXG4gKiBAcGFyYW0gbWluIHtudW1iZXJ9XG4gKiBAcGFyYW0gcG9pbnQge251bWJlcn1cbiAqIEBwYXJhbSBtYXgge251bWJlcn1cbiAqIEBwcml2YXRlXG4gKiBAcmV0dXJuIHtib29sZWFufVxuICovXG5mdW5jdGlvbiBfaW50ZXJ2YWwobWluOiBudW1iZXIsIHBvaW50OiBudW1iZXIsIG1heDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgLy8gVE9ETzogbWlncmF0ZSB0aGlzIHRvIHVzZSBhIExpbmUuaG9sZHNcbiAgICByZXR1cm4gbWluIDw9IHBvaW50ICYmIHBvaW50IDw9IG1heDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXJlY3Rpb24ge1xuICAgIHJlYWRvbmx5IHg/OiBudW1iZXI7XG4gICAgcmVhZG9ubHkgeT86IG51bWJlcjtcbn1cbiJdfQ==