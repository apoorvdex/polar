"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const ProxyServerConfig_1 = require("./ProxyServerConfig");
const CacheRegistry_1 = require("./CacheRegistry");
const Logger_1 = require("../../logger/Logger");
const Preconditions_1 = require("../../Preconditions");
const net = require('net');
const http = require('http');
const express = require('express');
const serveStatic = require('serve-static');
const httpProxy = require('http-proxy');
const log = Logger_1.Logger.create();
class ProxyServer {
    constructor(proxyConfig, cacheRegistry) {
        this.proxyConfig = Preconditions_1.Preconditions.assertNotNull(proxyConfig, "proxyConfig");
        this.cacheRegistry = Preconditions_1.Preconditions.assertNotNull(cacheRegistry, "cacheRegistry");
        ;
        this.app = null;
        this.server = null;
    }
    start() {
        this.proxy = httpProxy.createProxyServer({});
        this.server = http.createServer(this.requestHandler.bind(this))
            .listen(this.proxyConfig.port, "127.0.0.1");
        this.server.on('upgrade', function (req, socket, head) {
            console.warn("UPGRADE not handled");
        });
        this.server.on('connect', this.secureRequestHandler.bind(this));
        log.info(`Proxy up and running on port ${this.proxyConfig.port}`);
    }
    stop() {
        this.server.close();
    }
    requestHandler(req, res) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.cacheRegistry.hasEntry(req.url)) {
                let cacheEntry = this.cacheRegistry.get(req.url);
                if (!cacheEntry) {
                    throw new Error("No cache entry for: " + req.url);
                }
                const headers = Object.assign({}, cacheEntry.headers);
                headers["X-polar-cache"] = "hit";
                if (cacheEntry.contentLength) {
                    headers["Content-Length"] = `${cacheEntry.contentLength}`;
                }
                res.writeHead(cacheEntry.statusCode, cacheEntry.statusMessage, headers);
                while (yield cacheEntry.handleData(function (data) {
                    res.write(data);
                }))
                    ;
                res.end();
                return;
            }
            let options = {
                target: `${req.protocol}://${req.headers.host}`
            };
            this.proxy.web(req, res, options);
        });
    }
    secureRequestHandler(request, socketRequest, bodyhead) {
        let url = request['url'];
        let httpVersion = request['httpVersion'];
        let hostport = getHostPortFromString(url, 443);
        let proxySocket = new net.Socket();
        proxySocket.connect(parseInt(hostport[1]), hostport[0], function () {
            proxySocket.write(bodyhead);
            socketRequest.write("HTTP/" + httpVersion + " 200 Connection established\r\n\r\n");
        });
        proxySocket.on('data', function (chunk) {
            socketRequest.write(chunk);
        });
        proxySocket.on('end', function () {
            socketRequest.end();
        });
        socketRequest.on('data', function (chunk) {
            proxySocket.write(chunk);
        });
        socketRequest.on('end', function () {
            proxySocket.end();
        });
        proxySocket.on('error', function (err) {
            socketRequest.write("HTTP/" + httpVersion + " 500 Connection error\r\n\r\n");
            socketRequest.end();
        });
        socketRequest.on('error', function (err) {
            proxySocket.end();
        });
    }
}
exports.ProxyServer = ProxyServer;
const regex_hostport = /^([^:]+)(:([0-9]+))?$/;
function getHostPortFromString(hostString, defaultPort) {
    let host = hostString;
    let port = defaultPort;
    let result = regex_hostport.exec(hostString);
    if (result != null) {
        host = result[1];
        if (result[2] != null) {
            port = result[3];
        }
    }
    return ([host, port]);
}
function main() {
    log.info("Starting proxy...");
    let proxyServerConfig = new ProxyServerConfig_1.ProxyServerConfig(8090);
    let cacheRegistry = new CacheRegistry_1.CacheRegistry(proxyServerConfig);
    let proxyServer = new ProxyServer(proxyServerConfig, cacheRegistry);
    proxyServer.start();
}
if (require.main === module) {
    main();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJveHlTZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQcm94eVNlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBRUEsMkRBQXNEO0FBQ3RELG1EQUE4QztBQUM5QyxnREFBMkM7QUFDM0MsdURBQWtEO0FBRWxELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMzQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ25DLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFeEMsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsV0FBVztJQVNwQixZQUFZLFdBQThCLEVBQUUsYUFBNEI7UUFFcEUsSUFBSSxDQUFDLFdBQVcsR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLGFBQWEsR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFBQSxDQUFDO1FBRWxGLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBRXZCLENBQUM7SUFFRCxLQUFLO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFN0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzVDLE1BQU0sQ0FB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QUFJLEVBQUc7UUFDbEIsSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixJQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUc7WUFDckIsSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwQjtLQUNKO0lBRUQsT0FBTSxDQUFFLENBQUUsSUFBSSxFQUFFLElBQUksQ0FBRSxDQUFFLENBQUM7QUFDN0IsQ0FBQztBQUVELFNBQVMsSUFBSTtJQUNULEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUM5QixJQUFJLGlCQUFpQixHQUFHLElBQUkscUNBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEQsSUFBSSxhQUFhLEdBQUcsSUFBSSw2QkFBYSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDekQsSUFBSSxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsaUJBQWlCLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDcEUsV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBRXhCLENBQUM7QUFFRCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO0lBQ3pCLElBQUksRUFBRSxDQUFDO0NBQ1YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzdGFydCBhIHNpbXBsZSBzdGF0aWMgSFRUUCBzZXJ2ZXIgb25seSBsaXN0ZW5pbmcgb24gbG9jYWxob3N0XG5cbmltcG9ydCB7UHJveHlTZXJ2ZXJDb25maWd9IGZyb20gJy4vUHJveHlTZXJ2ZXJDb25maWcnO1xuaW1wb3J0IHtDYWNoZVJlZ2lzdHJ5fSBmcm9tICcuL0NhY2hlUmVnaXN0cnknO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJy4uLy4uL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICcuLi8uLi9QcmVjb25kaXRpb25zJztcblxuY29uc3QgbmV0ID0gcmVxdWlyZSgnbmV0Jyk7XG5jb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cCcpO1xuY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbmNvbnN0IHNlcnZlU3RhdGljID0gcmVxdWlyZSgnc2VydmUtc3RhdGljJyk7XG5jb25zdCBodHRwUHJveHkgPSByZXF1aXJlKCdodHRwLXByb3h5Jyk7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuZXhwb3J0IGNsYXNzIFByb3h5U2VydmVyIHtcblxuICAgIHByb3h5Q29uZmlnOiBQcm94eVNlcnZlckNvbmZpZztcbiAgICBjYWNoZVJlZ2lzdHJ5OiBDYWNoZVJlZ2lzdHJ5XG5cbiAgICBhcHA6IGFueTtcbiAgICBzZXJ2ZXI6IGFueTtcbiAgICBwcm94eTogYW55O1xuXG4gICAgY29uc3RydWN0b3IocHJveHlDb25maWc6IFByb3h5U2VydmVyQ29uZmlnLCBjYWNoZVJlZ2lzdHJ5OiBDYWNoZVJlZ2lzdHJ5KSB7XG5cbiAgICAgICAgdGhpcy5wcm94eUNvbmZpZyA9IFByZWNvbmRpdGlvbnMuYXNzZXJ0Tm90TnVsbChwcm94eUNvbmZpZywgXCJwcm94eUNvbmZpZ1wiKTtcbiAgICAgICAgdGhpcy5jYWNoZVJlZ2lzdHJ5ID0gUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKGNhY2hlUmVnaXN0cnksIFwiY2FjaGVSZWdpc3RyeVwiKTs7XG5cbiAgICAgICAgdGhpcy5hcHAgPSBudWxsO1xuICAgICAgICB0aGlzLnNlcnZlciA9IG51bGw7XG5cbiAgICB9XG5cbiAgICBzdGFydCgpIHtcblxuICAgICAgICB0aGlzLnByb3h5ID0gaHR0cFByb3h5LmNyZWF0ZVByb3h5U2VydmVyKHt9KTtcblxuICAgICAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMucmVxdWVzdEhhbmRsZXIuYmluZCh0aGlzKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLmxpc3Rlbih0aGlzLnByb3h5Q29uZmlnLnBvcnQsIFwiMTI3LjAuMC4xXCIpO1xuXG4gICAgICAgIHRoaXMuc2VydmVyLm9uKCd1cGdyYWRlJywgZnVuY3Rpb24gKHJlcTogYW55LCBzb2NrZXQ6IGFueSwgaGVhZDogYW55KSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJVUEdSQURFIG5vdCBoYW5kbGVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnNlcnZlci5vbignY29ubmVjdCcsIHRoaXMuc2VjdXJlUmVxdWVzdEhhbmRsZXIuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgbG9nLmluZm8oYFByb3h5IHVwIGFuZCBydW5uaW5nIG9uIHBvcnQgJHt0aGlzLnByb3h5Q29uZmlnLnBvcnR9YCk7XG5cbiAgICB9XG5cbiAgICBzdG9wKCkge1xuICAgICAgICB0aGlzLnNlcnZlci5jbG9zZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhbmRsZSByZXF1ZXN0IGZyb20gdGhlIGNhY2hlLCBvcHRpb25hbGx5IGZvcndhcmRpbmcgdG8gdGhlIG9yaWdpblxuICAgICAqIHNvdXJjZSBpZiBuZWNlc3NhcnkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVxIGh0dHBzOi8vZXhwcmVzc2pzLmNvbS9lbi80eC9hcGkuaHRtbCNyZXFcbiAgICAgKiBAcGFyYW0gcmVzIGh0dHBzOi8vZXhwcmVzc2pzLmNvbS9lbi80eC9hcGkuaHRtbCNyZXNcbiAgICAgKi9cbiAgICBhc3luYyByZXF1ZXN0SGFuZGxlcihyZXE6IGFueSwgcmVzOiBhbnkpIHtcblxuICAgICAgICAvLyBkZWJ1ZyhcIkhhbmRsaW5nIEhUVFAgcmVxdWVzdDogXCIgKyByZXEudXJsKTtcblxuICAgICAgICBpZih0aGlzLmNhY2hlUmVnaXN0cnkuaGFzRW50cnkocmVxLnVybCkpIHtcblxuICAgICAgICAgICAgLy8gc2VydmUgZnJvbSB0aGUgY2FjaGUgaWYgcmVnaXN0ZXJlZFxuXG4gICAgICAgICAgICAvLyBkZWJ1ZyhcIkhhbmRsaW5nIGNhY2hlZCByZXF1ZXN0OiBcIiArIHJlcS51cmwpO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGUgZG93bnNpZGUgb2YgdGhpcyBzdHJhdGVneSBpcyB0aGF0IHdlIGRvbid0IGJlbmVmaXRcbiAgICAgICAgICAgIC8vIGZyb20gYW55IGFkdmFuY2VkIEhUVFAgY2FjaGluZyBzZW1hbnRpY3Mgb3IgZmVhdHVyZXMgbGlrZVxuICAgICAgICAgICAgLy8gY29uZGl0aW9uYWwgR0VUIHJlcXVlc3RzIGJ1dCBzaW5jZSB3ZSdyZSBsb2NhbCBhbnl3YXkgdGhpc1xuICAgICAgICAgICAgLy8gZG9lcyBub3QgaW1wYWN0IHBlcmZvcm1hbmNlLlxuXG4gICAgICAgICAgICBsZXQgY2FjaGVFbnRyeSA9IHRoaXMuY2FjaGVSZWdpc3RyeS5nZXQocmVxLnVybCk7XG5cbiAgICAgICAgICAgIGlmKCFjYWNoZUVudHJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gY2FjaGUgZW50cnkgZm9yOiBcIiArIHJlcS51cmwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBoZWFkZXJzOiB7W2tleTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW119ID0gT2JqZWN0LmFzc2lnbih7fSwgY2FjaGVFbnRyeS5oZWFkZXJzKTtcblxuICAgICAgICAgICAgaGVhZGVyc1tcIlgtcG9sYXItY2FjaGVcIl0gPSBcImhpdFwiO1xuXG4gICAgICAgICAgICBpZihjYWNoZUVudHJ5LmNvbnRlbnRMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAvLyB3ZSBzaG91bGQgcmV0dXJuIGNvbnRlbnRMZW5ndGggdG9vIHdoZW4gaXQgaXMga25vd25cbiAgICAgICAgICAgICAgICBoZWFkZXJzW1wiQ29udGVudC1MZW5ndGhcIl0gPSBgJHtjYWNoZUVudHJ5LmNvbnRlbnRMZW5ndGh9YDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzLndyaXRlSGVhZChjYWNoZUVudHJ5LnN0YXR1c0NvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlRW50cnkuc3RhdHVzTWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycyk7XG5cbiAgICAgICAgICAgIHdoaWxlKGF3YWl0IGNhY2hlRW50cnkuaGFuZGxlRGF0YShmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIHJlcy53cml0ZShkYXRhKTtcbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgcmVzLmVuZCgpO1xuXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGRlYnVnKFwiSGFuZGxpbmcgcHJveGllZCByZXF1ZXN0OiBcIiArIHJlcS51cmwpO1xuXG4gICAgICAgIC8vIHRoZW4gZm9yd2FyZCB0byB0aGUgcmVtb3RlIHByb3h5XG5cbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICB0YXJnZXQ6IGAke3JlcS5wcm90b2NvbH06Ly8ke3JlcS5oZWFkZXJzLmhvc3R9YFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMucHJveHkud2ViKHJlcSwgcmVzLCBvcHRpb25zKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJvcnJvd2VkIGZyb206XG4gICAgICpcbiAgICAgKiBodHRwczovL25ld3NwYWludC53b3JkcHJlc3MuY29tLzIwMTIvMTEvMDUvbm9kZS1qcy1odHRwLWFuZC1odHRwcy1wcm94eS9cbiAgICAgKlxuICAgICAqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVxdWVzdFxuICAgICAqIEBwYXJhbSBzb2NrZXRSZXF1ZXN0XG4gICAgICogQHBhcmFtIGJvZHloZWFkXG4gICAgICovXG4gICAgc2VjdXJlUmVxdWVzdEhhbmRsZXIocmVxdWVzdDogYW55LCBzb2NrZXRSZXF1ZXN0OiBhbnksIGJvZHloZWFkOiBhbnkpIHtcblxuICAgICAgICAvLyBkZWJ1ZyhcIkhhbmRsaW5nIFNTTCBwcm94aWVkIHJlcXVlc3Q6IFwiICsgcmVxdWVzdC51cmwpO1xuXG4gICAgICAgIGxldCB1cmwgPSByZXF1ZXN0Wyd1cmwnXTtcbiAgICAgICAgbGV0IGh0dHBWZXJzaW9uID0gcmVxdWVzdFsnaHR0cFZlcnNpb24nXTtcblxuICAgICAgICBsZXQgaG9zdHBvcnQgPSBnZXRIb3N0UG9ydEZyb21TdHJpbmcodXJsLCA0NDMpO1xuXG4gICAgICAgIC8vIGRlYnVnKCAnICA9IHdpbGwgY29ubmVjdCB0byAlczolcycsIGhvc3Rwb3J0WzBdLCBob3N0cG9ydFsxXSApO1xuXG4gICAgICAgIC8vIHNldCB1cCBUQ1AgY29ubmVjdGlvblxuICAgICAgICBsZXQgcHJveHlTb2NrZXQgPSBuZXcgbmV0LlNvY2tldCgpO1xuICAgICAgICBwcm94eVNvY2tldC5jb25uZWN0KFxuICAgICAgICAgICAgcGFyc2VJbnQoIGhvc3Rwb3J0WzFdICksIGhvc3Rwb3J0WzBdLFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIGRlYnVnKCAnICA8IGNvbm5lY3RlZCB0byAlcy8lcycsIGhvc3Rwb3J0WzBdLCBob3N0cG9ydFsxXSApO1xuICAgICAgICAgICAgICAgIC8vIGRlYnVnKCAnICA+IHdyaXRpbmcgaGVhZCBvZiBsZW5ndGggJWQnLCBib2R5aGVhZC5sZW5ndGggKTtcblxuICAgICAgICAgICAgICAgIHByb3h5U29ja2V0LndyaXRlKCBib2R5aGVhZCApO1xuXG4gICAgICAgICAgICAgICAgLy8gdGVsbCB0aGUgY2FsbGVyIHRoZSBjb25uZWN0aW9uIHdhcyBzdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWRcbiAgICAgICAgICAgICAgICBzb2NrZXRSZXF1ZXN0LndyaXRlKCBcIkhUVFAvXCIgKyBodHRwVmVyc2lvbiArIFwiIDIwMCBDb25uZWN0aW9uIGVzdGFibGlzaGVkXFxyXFxuXFxyXFxuXCIgKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICk7XG5cbiAgICAgICAgcHJveHlTb2NrZXQub24oJ2RhdGEnLCBmdW5jdGlvbiAoIGNodW5rOiBhbnkgKSB7XG4gICAgICAgICAgICAgICAgLy8gZGVidWcoICcgIDwgZGF0YSBsZW5ndGggPSAlZCcsIGNodW5rLmxlbmd0aCApO1xuICAgICAgICAgICAgICAgIHNvY2tldFJlcXVlc3Qud3JpdGUoIGNodW5rICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgcHJveHlTb2NrZXQub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBkZWJ1ZyggJyAgPCBlbmQnICk7XG4gICAgICAgICAgICAgICAgc29ja2V0UmVxdWVzdC5lbmQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBzb2NrZXRSZXF1ZXN0Lm9uKCdkYXRhJywgZnVuY3Rpb24gKCBjaHVuazogYW55ICkge1xuICAgICAgICAgICAgICAgIC8vIGRlYnVnKCAnICA+IGRhdGEgbGVuZ3RoID0gJWQnLCBjaHVuay5sZW5ndGggKTtcblxuICAgICAgICAgICAgICAgIHByb3h5U29ja2V0LndyaXRlKCBjaHVuayApO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIHNvY2tldFJlcXVlc3Qub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBkZWJ1ZyggJyAgPiBlbmQnICk7XG5cbiAgICAgICAgICAgICAgICBwcm94eVNvY2tldC5lbmQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBwcm94eVNvY2tldC5vbignZXJyb3InLCBmdW5jdGlvbiAoIGVycjogYW55ICkge1xuICAgICAgICAgICAgICAgIHNvY2tldFJlcXVlc3Qud3JpdGUoIFwiSFRUUC9cIiArIGh0dHBWZXJzaW9uICsgXCIgNTAwIENvbm5lY3Rpb24gZXJyb3JcXHJcXG5cXHJcXG5cIiApO1xuICAgICAgICAgICAgICAgIC8vIGRlYnVnKCAnICA8IEVSUjogJXMnLCBlcnIgKTtcbiAgICAgICAgICAgICAgICBzb2NrZXRSZXF1ZXN0LmVuZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIHNvY2tldFJlcXVlc3Qub24oJ2Vycm9yJywgZnVuY3Rpb24gKCBlcnI6IGFueSApIHtcbiAgICAgICAgICAgICAgICAvLyBkZWJ1ZyggJyAgPiBFUlI6ICVzJywgZXJyICk7XG4gICAgICAgICAgICAgICAgcHJveHlTb2NrZXQuZW5kKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICB9XG5cbn1cblxuY29uc3QgcmVnZXhfaG9zdHBvcnQgPSAvXihbXjpdKykoOihbMC05XSspKT8kLztcblxuZnVuY3Rpb24gZ2V0SG9zdFBvcnRGcm9tU3RyaW5nKCBob3N0U3RyaW5nOiBhbnksIGRlZmF1bHRQb3J0OiBhbnkgKSB7XG4gICAgbGV0IGhvc3QgPSBob3N0U3RyaW5nO1xuICAgIGxldCBwb3J0ID0gZGVmYXVsdFBvcnQ7XG5cbiAgICBsZXQgcmVzdWx0ID0gcmVnZXhfaG9zdHBvcnQuZXhlYyggaG9zdFN0cmluZyApO1xuICAgIGlmICggcmVzdWx0ICE9IG51bGwgKSB7XG4gICAgICAgIGhvc3QgPSByZXN1bHRbMV07XG4gICAgICAgIGlmICggcmVzdWx0WzJdICE9IG51bGwgKSB7XG4gICAgICAgICAgICBwb3J0ID0gcmVzdWx0WzNdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuKCBbIGhvc3QsIHBvcnQgXSApO1xufVxuXG5mdW5jdGlvbiBtYWluKCkge1xuICAgIGxvZy5pbmZvKFwiU3RhcnRpbmcgcHJveHkuLi5cIik7XG4gICAgbGV0IHByb3h5U2VydmVyQ29uZmlnID0gbmV3IFByb3h5U2VydmVyQ29uZmlnKDgwOTApO1xuICAgIGxldCBjYWNoZVJlZ2lzdHJ5ID0gbmV3IENhY2hlUmVnaXN0cnkocHJveHlTZXJ2ZXJDb25maWcpO1xuICAgIGxldCBwcm94eVNlcnZlciA9IG5ldyBQcm94eVNlcnZlcihwcm94eVNlcnZlckNvbmZpZywgY2FjaGVSZWdpc3RyeSk7XG4gICAgcHJveHlTZXJ2ZXIuc3RhcnQoKTtcblxufVxuXG5pZiAocmVxdWlyZS5tYWluID09PSBtb2R1bGUpIHtcbiAgICBtYWluKCk7XG59XG4iXX0=