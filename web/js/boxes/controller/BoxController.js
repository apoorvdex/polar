"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const BoxMoveEvent_1 = require("./BoxMoveEvent");
const BoxOptions_1 = require("./BoxOptions");
const Rects_1 = require("../../Rects");
const Objects_1 = require("../../util/Objects");
const Logger_1 = require("../../logger/Logger");
const Preconditions_1 = require("../../Preconditions");
const RectEdges_1 = require("../../pagemarks/controller/interact/edges/RectEdges");
const Optional_1 = require("../../util/ts/Optional");
const DragRectAdjacencyCalculator_1 = require("../../pagemarks/controller/interact/drag/DragRectAdjacencyCalculator");
const interact = require('interactjs');
const { ResizeRectAdjacencyCalculator } = require("../../pagemarks/controller/interact/resize/ResizeRectAdjacencyCalculator");
const log = Logger_1.Logger.create();
class BoxController {
    constructor(callback) {
        this.callback = callback;
    }
    register(opts) {
        const boxOptions = new BoxOptions_1.BoxOptions(opts);
        const restrictionElement = Optional_1.Optional.of(boxOptions.restrictionElement)
            .getOrElse(boxOptions.target.parentElement);
        interact(boxOptions.target)
            .draggable({
            inertia: false,
            restrict: {
                restriction: restrictionElement,
                outer: 'parent',
                elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
            },
            restrictEdges: {
                outer: 'parent',
            },
        })
            .resizable({
            edges: {
                left: true,
                right: true,
                bottom: true,
                top: true
            },
            restrictEdges: {
                outer: restrictionElement,
            },
            restrict: {
                restriction: restrictionElement,
            },
            restrictSize: {
                min: { width: 50, height: 50 },
            },
            inertia: false,
        })
            .on('dragstart', (interactionEvent) => {
            this._captureStartTargetRect(interactionEvent);
        })
            .on('dragmove', (interactionEvent) => {
            if (!interactionEvent.currentTarget.parentElement) {
                return;
            }
            const target = interactionEvent.target;
            const restrictionRect = Rects_1.Rects.createFromBasicRect({
                left: 0,
                top: 0,
                width: restrictionElement.offsetWidth,
                height: restrictionElement.offsetHeight
            });
            const origin = this._computeOriginXY(interactionEvent);
            const targetRect = Rects_1.Rects.fromElementStyle(target);
            const intersectedBoxes = this._calculateIntersectedBoxes(interactionEvent.currentTarget, Rects_1.Rects.createFromBasicRect({
                left: origin.x,
                top: origin.y,
                width: targetRect.width,
                height: targetRect.height
            }), boxOptions.intersectedElementsSelector);
            let boxRect = Rects_1.Rects.createFromBasicRect({
                left: origin.x,
                top: origin.y,
                width: targetRect.width,
                height: targetRect.height
            });
            if (intersectedBoxes.intersectedRects.length === 0) {
                log.info("NOT INTERSECTED");
                log.info("Moving to origin: " + JSON.stringify(origin));
                this._moveTargetElement(origin.x, origin.y, target);
            }
            else {
                log.info("INTERSECTED========== ");
                let primaryRect = Rects_1.Rects.createFromBasicRect({
                    left: origin.x,
                    top: origin.y,
                    width: targetRect.width,
                    height: targetRect.height
                });
                let intersectedRect = intersectedBoxes.intersectedRects[0];
                let adjacency = DragRectAdjacencyCalculator_1.DragRectAdjacencyCalculator.calculate(primaryRect, intersectedRect, restrictionRect);
                let adjustedRect = adjacency.adjustedRect;
                if (adjustedRect) {
                    this._moveTargetElement(adjustedRect.left, adjustedRect.top, target);
                    boxRect = adjustedRect;
                }
                else {
                    console.warn("Can't move due to no valid adjustedRect we can work with.");
                }
            }
            interactionEvent.interaction.lastBoxMoveEvent =
                this._fireBoxMoveEvent("drag", restrictionRect, boxRect, target.id, target);
        })
            .on('dragend', (interactionEvent) => {
            this._fireCompletedBoxMoveEvent(interactionEvent);
        })
            .on('resizestart', (interactionEvent) => {
            this._captureStartTargetRect(interactionEvent);
            log.info("resizestart: interactionEvent.rect: " + JSON.stringify(interactionEvent.rect, null, "  "));
            interactionEvent.interaction.startRect = Objects_1.Objects.duplicate(interactionEvent.rect);
        })
            .on('resizemove', (interactionEvent) => {
            log.info("resizemove: event: ", interactionEvent);
            log.info("resizemove: event.target: ", interactionEvent.target);
            log.info("resizemove: interactionEvent.interaction.startRect: " + JSON.stringify(interactionEvent.interaction.startRect, null, "  "));
            let target = interactionEvent.target;
            let restrictionRect = Rects_1.Rects.createFromBasicRect({
                left: 0,
                top: 0,
                width: restrictionElement.offsetWidth,
                height: restrictionElement.offsetHeight
            });
            let tempRect = Rects_1.Rects.createFromBasicRect(interactionEvent.rect);
            let deltaRect = Rects_1.Rects.subtract(tempRect, interactionEvent.interaction.startRect);
            let resizeRect = Rects_1.Rects.add(interactionEvent.interaction.startTargetRect, deltaRect);
            let intersectedBoxes = this._calculateIntersectedBoxes(target, resizeRect, boxOptions.intersectedElementsSelector);
            log.info("resizemove: deltaRect: " + JSON.stringify(deltaRect, null, "  "));
            let boxRect;
            if (intersectedBoxes.intersectedRects.length === 0) {
                log.info("Resizing in non-intersected mode");
                boxRect = resizeRect;
                this._resizeTargetElement(resizeRect, target);
            }
            else {
                log.info("Resizing in intersected mode");
                let resizeRectAdjacencyCalculator = new ResizeRectAdjacencyCalculator();
                let intersectedRect = intersectedBoxes.intersectedRects[0];
                let rectEdges = new RectEdges_1.RectEdges(interactionEvent.edges);
                let adjustedRect = resizeRectAdjacencyCalculator.calculate(resizeRect, intersectedRect, rectEdges);
                log.info("resizemove: adjustedRect: " + JSON.stringify(adjustedRect, null, "  "));
                boxRect = adjustedRect;
                this._resizeTargetElement(adjustedRect, target);
            }
            interactionEvent.interaction.lastBoxMoveEvent
                = this._fireBoxMoveEvent("resize", restrictionRect, boxRect, target.id, target);
        })
            .on('resizeend', (interactionEvent) => {
            this._fireCompletedBoxMoveEvent(interactionEvent);
        });
    }
    _fireBoxMoveEvent(type, restrictionRect, boxRect, id, target) {
        let boxMoveEvent = new BoxMoveEvent_1.BoxMoveEvent({
            type,
            restrictionRect,
            boxRect,
            id,
            target,
        });
        if (this.callback) {
            this.callback(boxMoveEvent);
        }
        return boxMoveEvent;
    }
    _fireCompletedBoxMoveEvent(interactionEvent) {
        if (interactionEvent.interaction.lastBoxMoveEvent) {
            let boxMoveEvent = Object.assign({}, interactionEvent.interaction.lastBoxMoveEvent);
            boxMoveEvent.state = "completed";
            if (this.callback) {
                log.info("Firing completed BoxMoveEvent: ", boxMoveEvent);
                setTimeout(() => this.callback(boxMoveEvent), 1);
            }
        }
    }
    _calculateIntersectedBoxes(element, resizeRect, intersectedElementsSelector) {
        Preconditions_1.Preconditions.assertNotNull(element, "element");
        Preconditions_1.Preconditions.assertNotNull(resizeRect, "resizeRect");
        Preconditions_1.Preconditions.assertNotNull(intersectedElementsSelector, "intersectedElementsSelector");
        log.info("_calculateIntersectedBoxes: resizeRect is: " + JSON.stringify(resizeRect, null, "  "));
        if (!element.parentElement) {
            const msg = "Element not within DOM: ";
            log.error(msg, element);
            throw new Error(msg);
        }
        const intersectedElements = element.parentElement.querySelectorAll(intersectedElementsSelector);
        const boxes = Array.from(intersectedElements)
            .filter(current => current !== element)
            .map(current => current);
        boxes.forEach(current => current.getAttribute("id") !== element.getAttribute("id"));
        const intersectedRects = [];
        boxes.forEach(box => {
            const boxRect = Rects_1.Rects.fromElementStyle(box);
            if (Rects_1.Rects.intersect(boxRect, resizeRect)) {
                intersectedRects.push(boxRect);
            }
        });
        return {
            resizeRect,
            intersectedRects
        };
    }
    _computeOriginXY(interactionEvent) {
        let delta = {
            x: interactionEvent.pageX - interactionEvent.interaction.startCoords.page.x,
            y: interactionEvent.pageY - interactionEvent.interaction.startCoords.page.y
        };
        let x = interactionEvent.interaction.startTargetRect.left + delta.x;
        let y = interactionEvent.interaction.startTargetRect.top + delta.y;
        return { x, y };
    }
    _moveTargetElement(x, y, target) {
        target.style.left = `${x}px`;
        target.style.top = `${y}px`;
        target.setAttribute('data-x', `${x}`);
        target.setAttribute('data-y', `${y}`);
    }
    _resizeTargetElement(rect, target) {
        this._moveTargetElement(rect.left, rect.top, target);
        target.style.width = `${rect.width}px`;
        target.style.height = `${rect.height}px`;
    }
    _captureStartTargetRect(interactionEvent) {
        interactionEvent.interaction.startTargetRect = Rects_1.Rects.fromElementStyle(interactionEvent.target);
    }
}
exports.BoxController = BoxController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm94Q29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkJveENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBNEM7QUFDNUMsNkNBQXdDO0FBQ3hDLHVDQUFrQztBQUVsQyxnREFBMkM7QUFDM0MsZ0RBQTJDO0FBQzNDLHVEQUFrRDtBQUNsRCxtRkFBOEU7QUFDOUUscURBQWdEO0FBQ2hELHNIQUFpSDtBQVVqSCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFHdkMsTUFBTSxFQUFDLDZCQUE2QixFQUFDLEdBQUcsT0FBTyxDQUFDLDBFQUEwRSxDQUFDLENBQUM7QUFFNUgsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBTTVCLE1BQWEsYUFBYTtJQUl0QixZQUFZLFFBQXVDO1FBQy9DLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzdCLENBQUM7SUFJTSxRQUFRLENBQUMsSUFBZ0I7UUFFNUIsTUFBTSxVQUFVLEdBQUcsSUFBSSx1QkFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBTXhDLE1BQU0sa0JBQWtCLEdBQ3BCLG1CQUFRLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQzthQUNqQyxTQUFTLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxhQUFjLENBQUMsQ0FBQztRQUV6RCxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQzthQUN0QixTQUFTLENBQU87WUFFYixPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRTtnQkFDTixXQUFXLEVBQUUsa0JBQWtCO2dCQUMvQixLQUFLLEVBQUUsUUFBUTtnQkFFZixXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO2FBQ3hEO1lBRUQsYUFBYSxFQUFFO2dCQUNYLEtBQUssRUFBRSxRQUFRO2FBRWxCO1NBRUosQ0FBQzthQUNELFNBQVMsQ0FBUTtZQUdkLEtBQUssRUFBRTtnQkFDSCxJQUFJLEVBQUUsSUFBSTtnQkFDVixLQUFLLEVBQUUsSUFBSTtnQkFDWCxNQUFNLEVBQUUsSUFBSTtnQkFDWixHQUFHLEVBQUUsSUFBSTthQUNaO1lBSUQsYUFBYSxFQUFFO2dCQUNYLEtBQUssRUFBRSxrQkFBa0I7YUFFNUI7WUFFRCxRQUFRLEVBQUU7Z0JBQ04sV0FBVyxFQUFFLGtCQUFrQjthQUVsQztZQUdELFlBQVksRUFBRTtnQkFDVixHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUU7YUFDakM7WUFFRCxPQUFPLEVBQUUsS0FBSztTQUVqQixDQUFDO2FBQ0QsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLGdCQUFxQixFQUFFLEVBQUU7WUFDdkMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDO2FBQ0QsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDLGdCQUFxQixFQUFFLEVBQUU7WUFldEMsSUFBSSxDQUFFLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxhQUFhLEVBQUU7Z0JBR2hELE9BQU87YUFDVjtZQUVELE1BQU0sTUFBTSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztZQUV2QyxNQUFNLGVBQWUsR0FBRyxhQUFLLENBQUMsbUJBQW1CLENBQUM7Z0JBQzlDLElBQUksRUFBRSxDQUFDO2dCQUNQLEdBQUcsRUFBRSxDQUFDO2dCQUNOLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxXQUFXO2dCQUNyQyxNQUFNLEVBQUUsa0JBQWtCLENBQUMsWUFBWTthQUMxQyxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUV2RCxNQUFNLFVBQVUsR0FBRyxhQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFbEQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQztnQkFDL0csSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNkLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDYixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7Z0JBQ3ZCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTthQUM1QixDQUFDLEVBQUUsVUFBVSxDQUFDLDJCQUEyQixDQUFDLENBQUM7WUFFNUMsSUFBSSxPQUFPLEdBQUcsYUFBSyxDQUFDLG1CQUFtQixDQUFDO2dCQUNwQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQ2QsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNiLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSztnQkFDdkIsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNO2FBQzVCLENBQUMsQ0FBQztZQUVILElBQUcsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFFL0MsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUU1QixHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDeEQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUV2RDtpQkFBTTtnQkFFSCxHQUFHLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQUM7Z0JBRW5DLElBQUksV0FBVyxHQUFHLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQztvQkFDeEMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO29CQUNkLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDYixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7b0JBQ3ZCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtpQkFDNUIsQ0FBQyxDQUFDO2dCQUVILElBQUksZUFBZSxHQUFHLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUUzRCxJQUFJLFNBQVMsR0FBRyx5REFBMkIsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLGVBQWUsRUFBRSxlQUFlLENBQUMsQ0FBQztnQkFFckcsSUFBSSxZQUFZLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQztnQkFFMUMsSUFBRyxZQUFZLEVBQUU7b0JBQ2IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDckUsT0FBTyxHQUFHLFlBQVksQ0FBQztpQkFFMUI7cUJBQU07b0JBR0gsT0FBTyxDQUFDLElBQUksQ0FBQywyREFBMkQsQ0FBQyxDQUFDO2lCQUM3RTthQUVKO1lBRUQsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGdCQUFnQjtnQkFDekMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFcEYsQ0FBQyxDQUFDO2FBQ0QsRUFBRSxDQUFDLFNBQVMsRUFBQyxDQUFDLGdCQUFxQixFQUFFLEVBQUU7WUFDcEMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDO2FBQ0QsRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDLGdCQUFxQixFQUFFLEVBQUU7WUFDekMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDL0MsR0FBRyxDQUFDLElBQUksQ0FBQyxzQ0FBc0MsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsU0FBUyxHQUFHLGlCQUFPLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRGLENBQUMsQ0FBQzthQUNELEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxnQkFBcUIsRUFBRSxFQUFFO1lBRXhDLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUNsRCxHQUFHLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBS2hFLEdBQUcsQ0FBQyxJQUFJLENBQUMsc0RBQXNELEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRXRJLElBQUksTUFBTSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztZQUVyQyxJQUFJLGVBQWUsR0FBRyxhQUFLLENBQUMsbUJBQW1CLENBQUM7Z0JBQzVDLElBQUksRUFBRSxDQUFDO2dCQUNQLEdBQUcsRUFBRSxDQUFDO2dCQUNOLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxXQUFXO2dCQUNyQyxNQUFNLEVBQUUsa0JBQWtCLENBQUMsWUFBWTthQUMxQyxDQUFDLENBQUM7WUFNSCxJQUFJLFFBQVEsR0FBRyxhQUFLLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFaEUsSUFBSSxTQUFTLEdBQUcsYUFBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRWpGLElBQUksVUFBVSxHQUFHLGFBQUssQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUlwRixJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBRW5ILEdBQUcsQ0FBQyxJQUFJLENBQUMseUJBQXlCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFFNUUsSUFBSSxPQUFPLENBQUM7WUFFWixJQUFHLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBRS9DLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztnQkFFN0MsT0FBTyxHQUFHLFVBQVUsQ0FBQztnQkFFckIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUVqRDtpQkFBTTtnQkFTSCxHQUFHLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7Z0JBRXpDLElBQUksNkJBQTZCLEdBQUcsSUFBSSw2QkFBNkIsRUFBRSxDQUFDO2dCQUV4RSxJQUFJLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFM0QsSUFBSSxTQUFTLEdBQUcsSUFBSSxxQkFBUyxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUV0RCxJQUFJLFlBQVksR0FBRyw2QkFBNkIsQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLGVBQWUsRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFFbkcsR0FBRyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFFbEYsT0FBTyxHQUFHLFlBQVksQ0FBQztnQkFFdkIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQzthQUVuRDtZQUVELGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxnQkFBZ0I7a0JBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXhGLENBQUMsQ0FBQzthQUNELEVBQUUsQ0FBQyxXQUFXLEVBQUMsQ0FBQyxnQkFBcUIsRUFBRSxFQUFFO1lBQ3RDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO0lBRVgsQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQXVCLEVBQ3ZCLGVBQXFCLEVBQ3JCLE9BQWEsRUFDYixFQUFVLEVBQ1YsTUFBbUI7UUFFakMsSUFBSSxZQUFZLEdBQUcsSUFBSSwyQkFBWSxDQUFDO1lBQ2hDLElBQUk7WUFDSixlQUFlO1lBQ2YsT0FBTztZQUNQLEVBQUU7WUFDRixNQUFNO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsSUFBRyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMvQjtRQUVELE9BQU8sWUFBWSxDQUFDO0lBRXhCLENBQUM7SUFHRCwwQkFBMEIsQ0FBQyxnQkFBcUI7UUFFNUMsSUFBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7WUFFOUMsSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFFcEYsWUFBWSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUM7WUFFakMsSUFBRyxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNkLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUNBQWlDLEVBQUUsWUFBWSxDQUFDLENBQUM7Z0JBSTFELFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBRXBEO1NBRUo7SUFFTCxDQUFDO0lBSU8sMEJBQTBCLENBQUMsT0FBb0IsRUFBRSxVQUFnQixFQUFFLDJCQUFtQztRQUUxRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDaEQsNkJBQWEsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3RELDZCQUFhLENBQUMsYUFBYSxDQUFDLDJCQUEyQixFQUFFLDZCQUE2QixDQUFDLENBQUM7UUFPeEYsR0FBRyxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQU1qRyxJQUFJLENBQUUsT0FBTyxDQUFDLGFBQWEsRUFBRTtZQUN6QixNQUFNLEdBQUcsR0FBRywwQkFBMEIsQ0FBQztZQUN2QyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsYUFBYyxDQUFDLGdCQUFnQixDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFFakcsTUFBTSxLQUFLLEdBQ0wsS0FBSyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQzthQUNmLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sS0FBSyxPQUFPLENBQUM7YUFDdEMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBc0IsQ0FBQyxDQUFDO1FBSTdELEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVwRixNQUFNLGdCQUFnQixHQUFXLEVBQUUsQ0FBQztRQUVwQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBRWhCLE1BQU0sT0FBTyxHQUFHLGFBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUU1QyxJQUFJLGFBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxFQUFFO2dCQUN0QyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDbEM7UUFFTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDSCxVQUFVO1lBQ1YsZ0JBQWdCO1NBQ25CLENBQUE7SUFFTCxDQUFDO0lBT0QsZ0JBQWdCLENBQUMsZ0JBQXFCO1FBRWxDLElBQUksS0FBSyxHQUFHO1lBQ1IsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzNFLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5RSxDQUFDO1FBT0YsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRW5FLE9BQU8sRUFBQyxDQUFDLEVBQUUsQ0FBQyxFQUFDLENBQUM7SUFFbEIsQ0FBQztJQUdELGtCQUFrQixDQUFDLENBQVMsRUFBRSxDQUFTLEVBQUUsTUFBbUI7UUFFeEQsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUM3QixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRzVCLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFJMUMsQ0FBQztJQUVELG9CQUFvQixDQUFDLElBQVUsRUFBRSxNQUFtQjtRQUdoRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBR3JELE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDO0lBRTdDLENBQUM7SUFFRCx1QkFBdUIsQ0FBQyxnQkFBcUI7UUFHekMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGVBQWUsR0FBRyxhQUFLLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkcsQ0FBQztDQUVKO0FBclpELHNDQXFaQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Qm94TW92ZUV2ZW50fSBmcm9tICcuL0JveE1vdmVFdmVudCc7XG5pbXBvcnQge0JveE9wdGlvbnN9IGZyb20gJy4vQm94T3B0aW9ucyc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi8uLi9SZWN0cyc7XG5pbXBvcnQge1JlY3R9IGZyb20gJy4uLy4uL1JlY3QnO1xuaW1wb3J0IHtPYmplY3RzfSBmcm9tICcuLi8uLi91dGlsL09iamVjdHMnO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJy4uLy4uL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICcuLi8uLi9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7UmVjdEVkZ2VzfSBmcm9tICcuLi8uLi9wYWdlbWFya3MvY29udHJvbGxlci9pbnRlcmFjdC9lZGdlcy9SZWN0RWRnZXMnO1xuaW1wb3J0IHtPcHRpb25hbH0gZnJvbSAnLi4vLi4vdXRpbC90cy9PcHRpb25hbCc7XG5pbXBvcnQge0RyYWdSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvcn0gZnJvbSAnLi4vLi4vcGFnZW1hcmtzL2NvbnRyb2xsZXIvaW50ZXJhY3QvZHJhZy9EcmFnUmVjdEFkamFjZW5jeUNhbGN1bGF0b3InO1xuXG4vLyBpbXBvcnQgaW50ZXJhY3QgZnJvbSAnaW50ZXJhY3Rqcyc7XG5cbi8vIFRPRE86IHRoZSBpbnRlcmFjdGpzIHR5cGVzY3JpcHQgYmluZGluZ3MgaW4gb3VyIHZlcnNpb24gYXJlIGluY29tcGF0aWJsZVxuLy8gd2l0aFxuLy8gb3VyIHR5cGVzY3JpcHQgY29uZmlnIGJlY2F1c2Ugd2UgZGlzYWxsb3cgaW1wbGljaXR5IGFueS4gIEFwcGFyZW50bHlcbi8vIGludGVyYWN0anMgZml4ZWQgdGhpcyBCVVQgdGhlIGZpeCBkb2Vzbid0IHNlZW0gdG8gYmUgaW4gdGhlIDEuMy54IHNlcmllcy5cblxuLy8gaW1wb3J0IHt9IGZyb20gJ2ludGVyYWN0anMnO1xuY29uc3QgaW50ZXJhY3QgPSByZXF1aXJlKCdpbnRlcmFjdGpzJyk7XG4vLyBpbXBvcnQgKiBhcyBpbnRlcmFjdCBmcm9tICdpbnRlcmFjdGpzJztcblxuY29uc3Qge1Jlc2l6ZVJlY3RBZGphY2VuY3lDYWxjdWxhdG9yfSA9IHJlcXVpcmUoXCIuLi8uLi9wYWdlbWFya3MvY29udHJvbGxlci9pbnRlcmFjdC9yZXNpemUvUmVzaXplUmVjdEFkamFjZW5jeUNhbGN1bGF0b3JcIik7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuLyoqXG4gKiBBIGdlbmVyaWMgY29udHJvbGxlciBmb3IgZHJhZ2dpbmcgYm94ZXMgKGRpdnMpIHdoaWNoIGFyZSByZXNpemVhYmxlIGFuZCBjYW5cbiAqIGJlIGRyYWdnZWQgd2l0aGluIGEgY29udGFpbmVyIGFuZCBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQuXG4gKi9cbmV4cG9ydCBjbGFzcyBCb3hDb250cm9sbGVyIHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FsbGJhY2s6IChldmVudDogQm94TW92ZUV2ZW50KSA9PiB2b2lkO1xuXG4gICAgY29uc3RydWN0b3IoY2FsbGJhY2s6IChldmVudDogQm94TW92ZUV2ZW50KSA9PiB2b2lkKSB7XG4gICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjaztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVnaXN0ZXIob3B0czogQm94T3B0aW9ucykge1xuXG4gICAgICAgIGNvbnN0IGJveE9wdGlvbnMgPSBuZXcgQm94T3B0aW9ucyhvcHRzKTtcblxuICAgICAgICAvLyBUT0RPOiBhc3NlcnQgdGhhdCB0aGUgYm94ZXMgZm9yIHRoZSBzZWxlY3RvciBhcmUgQUxSRUFEWSBhYnNvbHV0ZWx5XG4gICAgICAgIC8vIHBvc2l0aW9uZWQgYmVmb3JlIHdlIGFjY2VwdCB0aGVtIGFuZCB0aGV5IGFyZSBkb25lIHVzaW5nIHN0eWxlXG4gICAgICAgIC8vIGF0dHJpYnV0ZXMgYmVjYXVzZSB3ZSdyZSBpbmNvbXBhdGlibGUgd2l0aCB0aGVtIG90aGVyd2lzZS5cblxuICAgICAgICBjb25zdCByZXN0cmljdGlvbkVsZW1lbnQgPVxuICAgICAgICAgICAgT3B0aW9uYWwub2YoYm94T3B0aW9ucy5yZXN0cmljdGlvbkVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgIC5nZXRPckVsc2UoYm94T3B0aW9ucy50YXJnZXQucGFyZW50RWxlbWVudCEpO1xuXG4gICAgICAgIGludGVyYWN0KGJveE9wdGlvbnMudGFyZ2V0KVxuICAgICAgICAgICAgLmRyYWdnYWJsZSg8YW55PiB7XG5cbiAgICAgICAgICAgICAgICBpbmVydGlhOiBmYWxzZSxcbiAgICAgICAgICAgICAgICByZXN0cmljdDoge1xuICAgICAgICAgICAgICAgICAgICByZXN0cmljdGlvbjogcmVzdHJpY3Rpb25FbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICBvdXRlcjogJ3BhcmVudCcsXG5cbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudFJlY3Q6IHsgdG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IDEsIHJpZ2h0OiAxIH1cbiAgICAgICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAgICAgcmVzdHJpY3RFZGdlczoge1xuICAgICAgICAgICAgICAgICAgICBvdXRlcjogJ3BhcmVudCcsXG4gICAgICAgICAgICAgICAgICAgIC8vIG91dGVyOiBjb21wdXRlUmVzdHJpY3Rpb24sXG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5yZXNpemFibGUoIDxhbnk+IHtcblxuICAgICAgICAgICAgICAgIC8vIHJlc2l6ZSBmcm9tIGFsbCBlZGdlcyBhbmQgY29ybmVyc1xuICAgICAgICAgICAgICAgIGVkZ2VzOiB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0OiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBib3R0b206IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHRvcDogdHJ1ZVxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICAvLyBLZWVwIHRoZSBlZGdlcyBpbnNpZGUgdGhlIHBhcmVudC4gdGhpcyBpcyBuZWVkZWQgb3IgZWxzZSB0aGVcbiAgICAgICAgICAgICAgICAvLyBib3VuZCBzdHJldGNoZXMgc2xpZ2h0bHkgYmV5b25kIHRoZSBjb250YWluZXIuXG4gICAgICAgICAgICAgICAgcmVzdHJpY3RFZGdlczoge1xuICAgICAgICAgICAgICAgICAgICBvdXRlcjogcmVzdHJpY3Rpb25FbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICAvLyBvdXRlcjogY29tcHV0ZVJlc3RyaWN0aW9uLFxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICByZXN0cmljdDoge1xuICAgICAgICAgICAgICAgICAgICByZXN0cmljdGlvbjogcmVzdHJpY3Rpb25FbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICAvLyByZXN0cmljdGlvbjogY29tcHV0ZVJlc3RyaWN0aW9uXG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgIC8vIG1pbmltdW0gc2l6ZVxuICAgICAgICAgICAgICAgIHJlc3RyaWN0U2l6ZToge1xuICAgICAgICAgICAgICAgICAgICBtaW46IHsgd2lkdGg6IDUwLCBoZWlnaHQ6IDUwIH0sXG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgIGluZXJ0aWE6IGZhbHNlLFxuXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdkcmFnc3RhcnQnLCAoaW50ZXJhY3Rpb25FdmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY2FwdHVyZVN0YXJ0VGFyZ2V0UmVjdChpbnRlcmFjdGlvbkV2ZW50KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub24oJ2RyYWdtb3ZlJywgKGludGVyYWN0aW9uRXZlbnQ6IGFueSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgLy8gbG9nLmluZm8oXCI9PT09PT09PT09PT09PT09PT09PT1cIilcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhcImRyYWdtb3ZlOiBldmVudDogXCIsIGV2ZW50KTtcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhcImRyYWdtb3ZlOiBldmVudC5pbnRlcmFjdGlvbi5teVRpbWVzdGFtcDogXCIsXG4gICAgICAgICAgICAgICAgLy8gZXZlbnQuaW50ZXJhY3Rpb24ubXlUaW1lc3RhbXApOyBsb2cuaW5mbyhcImRyYWdtb3ZlOlxuICAgICAgICAgICAgICAgIC8vIGV2ZW50LnRhcmdldDogXCIsIGV2ZW50LnRhcmdldCk7IGxvZy5pbmZvKFwiZHJhZ21vdmU6XG4gICAgICAgICAgICAgICAgLy8gZXZlbnQucmVzdHJpY3Q6IFwiLCBldmVudC5yZXN0cmljdCk7IGxvZy5pbmZvKGBkcmFnbW92ZTpcbiAgICAgICAgICAgICAgICAvLyBldmVudC5keDogJHtldmVudC5keH0gYW5kIGV2ZW50LmR5OiAke2V2ZW50LmR5fWApO1xuICAgICAgICAgICAgICAgIC8vIGxvZy5pbmZvKGBkcmFnbW92ZTogZXZlbnQueDA6ICR7ZXZlbnQueDB9IGFuZCBldmVudC55MDpcbiAgICAgICAgICAgICAgICAvLyAke2V2ZW50LnkwfWApOyBsb2cuaW5mbyhgZHJhZ21vdmU6IGV2ZW50LmNsaWVudFg6XG4gICAgICAgICAgICAgICAgLy8gJHtldmVudC5jbGllbnRYfSBhbmQgZXZlbnQuY2xpZW50WTogJHtldmVudC5jbGllbnRZfWApO1xuICAgICAgICAgICAgICAgIC8vIGxvZy5pbmZvKGBkcmFnbW92ZTogZXZlbnQuY2xpZW50WDA6ICR7ZXZlbnQuY2xpZW50WDB9IGFuZFxuICAgICAgICAgICAgICAgIC8vIGV2ZW50LmNsaWVudFkwOiAke2V2ZW50LmNsaWVudFkwfWApO1xuXG4gICAgICAgICAgICAgICAgaWYgKCEgaW50ZXJhY3Rpb25FdmVudC5jdXJyZW50VGFyZ2V0LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gd2UndmUgYmVlbiByZW1vdmVkIGZyb20gdGhlIERPTSBidXQgd2UncmUgc3RpbGwgZ2V0dGluZ1xuICAgICAgICAgICAgICAgICAgICAvLyBkcmFnIGV2ZW50cyBzbyB3ZSBzaG91bGQgeWllbGQuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBpbnRlcmFjdGlvbkV2ZW50LnRhcmdldDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RyaWN0aW9uUmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgICAgICBsZWZ0OiAwLFxuICAgICAgICAgICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiByZXN0cmljdGlvbkVsZW1lbnQub2Zmc2V0V2lkdGgsXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogcmVzdHJpY3Rpb25FbGVtZW50Lm9mZnNldEhlaWdodFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gdGhpcy5fY29tcHV0ZU9yaWdpblhZKGludGVyYWN0aW9uRXZlbnQpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UmVjdCA9IFJlY3RzLmZyb21FbGVtZW50U3R5bGUodGFyZ2V0KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdGVkQm94ZXMgPSB0aGlzLl9jYWxjdWxhdGVJbnRlcnNlY3RlZEJveGVzKGludGVyYWN0aW9uRXZlbnQuY3VycmVudFRhcmdldCwgUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdCh7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQ6IG9yaWdpbi54LFxuICAgICAgICAgICAgICAgICAgICB0b3A6IG9yaWdpbi55LFxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogdGFyZ2V0UmVjdC53aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB0YXJnZXRSZWN0LmhlaWdodFxuICAgICAgICAgICAgICAgIH0pLCBib3hPcHRpb25zLmludGVyc2VjdGVkRWxlbWVudHNTZWxlY3Rvcik7XG5cbiAgICAgICAgICAgICAgICBsZXQgYm94UmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgICAgICBsZWZ0OiBvcmlnaW4ueCxcbiAgICAgICAgICAgICAgICAgICAgdG9wOiBvcmlnaW4ueSxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRhcmdldFJlY3Qud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGFyZ2V0UmVjdC5oZWlnaHRcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmKGludGVyc2VjdGVkQm94ZXMuaW50ZXJzZWN0ZWRSZWN0cy5sZW5ndGggPT09IDApIHtcblxuICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIk5PVCBJTlRFUlNFQ1RFRFwiKTtcblxuICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIk1vdmluZyB0byBvcmlnaW46IFwiICsgSlNPTi5zdHJpbmdpZnkob3JpZ2luKSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUYXJnZXRFbGVtZW50KG9yaWdpbi54LCBvcmlnaW4ueSwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oXCJJTlRFUlNFQ1RFRD09PT09PT09PT0gXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBwcmltYXJ5UmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogb3JpZ2luLngsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3A6IG9yaWdpbi55LFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRhcmdldFJlY3Qud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRhcmdldFJlY3QuaGVpZ2h0XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBpbnRlcnNlY3RlZFJlY3QgPSBpbnRlcnNlY3RlZEJveGVzLmludGVyc2VjdGVkUmVjdHNbMF07XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGFkamFjZW5jeSA9IERyYWdSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvci5jYWxjdWxhdGUocHJpbWFyeVJlY3QsIGludGVyc2VjdGVkUmVjdCwgcmVzdHJpY3Rpb25SZWN0KTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgYWRqdXN0ZWRSZWN0ID0gYWRqYWNlbmN5LmFkanVzdGVkUmVjdDtcblxuICAgICAgICAgICAgICAgICAgICBpZihhZGp1c3RlZFJlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21vdmVUYXJnZXRFbGVtZW50KGFkanVzdGVkUmVjdC5sZWZ0LCBhZGp1c3RlZFJlY3QudG9wLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYm94UmVjdCA9IGFkanVzdGVkUmVjdDtcblxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIGJ1dCBsb2cgaXQgaWYgdGhlcmUgaXMgYVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnVnLlxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiQ2FuJ3QgbW92ZSBkdWUgdG8gbm8gdmFsaWQgYWRqdXN0ZWRSZWN0IHdlIGNhbiB3b3JrIHdpdGguXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLmxhc3RCb3hNb3ZlRXZlbnQgPVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9maXJlQm94TW92ZUV2ZW50KFwiZHJhZ1wiLCByZXN0cmljdGlvblJlY3QsIGJveFJlY3QsIHRhcmdldC5pZCwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbignZHJhZ2VuZCcsKGludGVyYWN0aW9uRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZpcmVDb21wbGV0ZWRCb3hNb3ZlRXZlbnQoaW50ZXJhY3Rpb25FdmVudCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdyZXNpemVzdGFydCcsIChpbnRlcmFjdGlvbkV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jYXB0dXJlU3RhcnRUYXJnZXRSZWN0KGludGVyYWN0aW9uRXZlbnQpO1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplc3RhcnQ6IGludGVyYWN0aW9uRXZlbnQucmVjdDogXCIgKyBKU09OLnN0cmluZ2lmeShpbnRlcmFjdGlvbkV2ZW50LnJlY3QsIG51bGwsIFwiICBcIikpO1xuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRSZWN0ID0gT2JqZWN0cy5kdXBsaWNhdGUoaW50ZXJhY3Rpb25FdmVudC5yZWN0KTtcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbigncmVzaXplbW92ZScsIChpbnRlcmFjdGlvbkV2ZW50OiBhbnkpID0+IHtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogZXZlbnQ6IFwiLCBpbnRlcmFjdGlvbkV2ZW50KTtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhcInJlc2l6ZW1vdmU6IGV2ZW50LnRhcmdldDogXCIsIGludGVyYWN0aW9uRXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhcInJlc2l6ZW1vdmU6IGV2ZW50LnJlc3RyaWN0OiBcIixcbiAgICAgICAgICAgICAgICAvLyBpbnRlcmFjdGlvbkV2ZW50LnJlc3RyaWN0KTsgbG9nLmluZm8oXCJyZXNpemVtb3ZlOlxuICAgICAgICAgICAgICAgIC8vIGludGVyYWN0aW9uRXZlbnQucmVjdDogXCIgK1xuICAgICAgICAgICAgICAgIC8vIEpTT04uc3RyaW5naWZ5KGludGVyYWN0aW9uRXZlbnQucmVjdCwgbnVsbCwgXCIgIFwiKSk7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJyZXNpemVtb3ZlOiBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0UmVjdDogXCIgKyBKU09OLnN0cmluZ2lmeShpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0UmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gaW50ZXJhY3Rpb25FdmVudC50YXJnZXQ7XG5cbiAgICAgICAgICAgICAgICBsZXQgcmVzdHJpY3Rpb25SZWN0ID0gUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdCh7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAsXG4gICAgICAgICAgICAgICAgICAgIHRvcDogMCxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHJlc3RyaWN0aW9uRWxlbWVudC5vZmZzZXRXaWR0aCxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiByZXN0cmljdGlvbkVsZW1lbnQub2Zmc2V0SGVpZ2h0XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyB0aGUgdGVtcFJlY3QgaXMgdGhlIHJlY3QgdGhhdCB0aGUgdXNlciBoYXMgYXR0ZW1wdGVkIHRvIGRyYXdcbiAgICAgICAgICAgICAgICAvLyBidXQgd2hpY2ggd2UgaGF2ZSBub3QgeWV0IGFjY2VwdGVkIGFuZCBpcyBjb250cm9sbGVkIGJ5XG4gICAgICAgICAgICAgICAgLy8gaW50ZXJhY3QuanNcblxuICAgICAgICAgICAgICAgIGxldCB0ZW1wUmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QoaW50ZXJhY3Rpb25FdmVudC5yZWN0KTtcblxuICAgICAgICAgICAgICAgIGxldCBkZWx0YVJlY3QgPSBSZWN0cy5zdWJ0cmFjdCh0ZW1wUmVjdCwgaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydFJlY3QpO1xuXG4gICAgICAgICAgICAgICAgbGV0IHJlc2l6ZVJlY3QgPSBSZWN0cy5hZGQoaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydFRhcmdldFJlY3QsIGRlbHRhUmVjdCk7XG5cbiAgICAgICAgICAgICAgICAvLyBiZWZvcmUgd2UgcmVzaXplLCB2ZXJpZnkgdGhhdCB3ZSBDQU4gcmVzaXplLi5cblxuICAgICAgICAgICAgICAgIGxldCBpbnRlcnNlY3RlZEJveGVzID0gdGhpcy5fY2FsY3VsYXRlSW50ZXJzZWN0ZWRCb3hlcyh0YXJnZXQsIHJlc2l6ZVJlY3QsIGJveE9wdGlvbnMuaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yKTtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogZGVsdGFSZWN0OiBcIiArIEpTT04uc3RyaW5naWZ5KGRlbHRhUmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgYm94UmVjdDtcblxuICAgICAgICAgICAgICAgIGlmKGludGVyc2VjdGVkQm94ZXMuaW50ZXJzZWN0ZWRSZWN0cy5sZW5ndGggPT09IDApIHtcblxuICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIlJlc2l6aW5nIGluIG5vbi1pbnRlcnNlY3RlZCBtb2RlXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGJveFJlY3QgPSByZXNpemVSZWN0O1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2l6ZVRhcmdldEVsZW1lbnQocmVzaXplUmVjdCwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IGl0cycgYWxzbyBwb3NzaWJsZSB0byByZXNpemUgc21hbGxlciB0aGFuIHRoZVxuICAgICAgICAgICAgICAgICAgICAvLyBtaW5TaXplIHdlIGRlZmluZWQgYWJvdmUuLi5cblxuICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogd2hlbiBpbnRlcnNlY3RlZCwgaWYgd2UgZHJhZyBkb3duLCB0aGUgcmVjdFxuICAgICAgICAgICAgICAgICAgICAvLyB2YW5pc2hlcy4uLiAgRklYTUU6IHB1bGxpbmcgaXQgbGVmdCB3aGlsZSBpbnRlcnNlY3RlZFxuICAgICAgICAgICAgICAgICAgICAvLyBhbHNvIG1ha2VzIGl0IHZhbmlzaC4uLlxuXG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiUmVzaXppbmcgaW4gaW50ZXJzZWN0ZWQgbW9kZVwiKTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzaXplUmVjdEFkamFjZW5jeUNhbGN1bGF0b3IgPSBuZXcgUmVzaXplUmVjdEFkamFjZW5jeUNhbGN1bGF0b3IoKTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgaW50ZXJzZWN0ZWRSZWN0ID0gaW50ZXJzZWN0ZWRCb3hlcy5pbnRlcnNlY3RlZFJlY3RzWzBdO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCByZWN0RWRnZXMgPSBuZXcgUmVjdEVkZ2VzKGludGVyYWN0aW9uRXZlbnQuZWRnZXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBhZGp1c3RlZFJlY3QgPSByZXNpemVSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvci5jYWxjdWxhdGUocmVzaXplUmVjdCwgaW50ZXJzZWN0ZWRSZWN0LCByZWN0RWRnZXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogYWRqdXN0ZWRSZWN0OiBcIiArIEpTT04uc3RyaW5naWZ5KGFkanVzdGVkUmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgYm94UmVjdCA9IGFkanVzdGVkUmVjdDtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNpemVUYXJnZXRFbGVtZW50KGFkanVzdGVkUmVjdCwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24ubGFzdEJveE1vdmVFdmVudFxuICAgICAgICAgICAgICAgICAgICA9IHRoaXMuX2ZpcmVCb3hNb3ZlRXZlbnQoXCJyZXNpemVcIiwgcmVzdHJpY3Rpb25SZWN0LCBib3hSZWN0LCB0YXJnZXQuaWQsIHRhcmdldCk7XG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub24oJ3Jlc2l6ZWVuZCcsKGludGVyYWN0aW9uRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZpcmVDb21wbGV0ZWRCb3hNb3ZlRXZlbnQoaW50ZXJhY3Rpb25FdmVudCk7XG4gICAgICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIF9maXJlQm94TW92ZUV2ZW50KHR5cGU6ICdkcmFnJyB8ICdyZXNpemUnLFxuICAgICAgICAgICAgICAgICAgICAgIHJlc3RyaWN0aW9uUmVjdDogUmVjdCxcbiAgICAgICAgICAgICAgICAgICAgICBib3hSZWN0OiBSZWN0LFxuICAgICAgICAgICAgICAgICAgICAgIGlkOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGxldCBib3hNb3ZlRXZlbnQgPSBuZXcgQm94TW92ZUV2ZW50KHtcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICByZXN0cmljdGlvblJlY3QsXG4gICAgICAgICAgICBib3hSZWN0LFxuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICB0YXJnZXQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmKHRoaXMuY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2soYm94TW92ZUV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBib3hNb3ZlRXZlbnQ7XG5cbiAgICB9XG5cblxuICAgIF9maXJlQ29tcGxldGVkQm94TW92ZUV2ZW50KGludGVyYWN0aW9uRXZlbnQ6IGFueSkge1xuXG4gICAgICAgIGlmKGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24ubGFzdEJveE1vdmVFdmVudCkge1xuXG4gICAgICAgICAgICBsZXQgYm94TW92ZUV2ZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5sYXN0Qm94TW92ZUV2ZW50KTtcblxuICAgICAgICAgICAgYm94TW92ZUV2ZW50LnN0YXRlID0gXCJjb21wbGV0ZWRcIjtcblxuICAgICAgICAgICAgaWYodGhpcy5jYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiRmlyaW5nIGNvbXBsZXRlZCBCb3hNb3ZlRXZlbnQ6IFwiLCBib3hNb3ZlRXZlbnQpO1xuXG4gICAgICAgICAgICAgICAgLy8gZm9yIHNvbWUgcmVhc29uLCB3aXRob3V0IGEgdGltZW91dCwgdGhlIGNvbnRyb2xsZXIganVzdCBzZWVtc1xuICAgICAgICAgICAgICAgIC8vIHRvIGxvY2sgdXAuXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmNhbGxiYWNrKGJveE1vdmVFdmVudCksIDEpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICovXG4gICAgcHJpdmF0ZSBfY2FsY3VsYXRlSW50ZXJzZWN0ZWRCb3hlcyhlbGVtZW50OiBIVE1MRWxlbWVudCwgcmVzaXplUmVjdDogUmVjdCwgaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yOiBzdHJpbmcpIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoZWxlbWVudCwgXCJlbGVtZW50XCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwocmVzaXplUmVjdCwgXCJyZXNpemVSZWN0XCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yLCBcImludGVyc2VjdGVkRWxlbWVudHNTZWxlY3RvclwiKTtcblxuXG4gICAgICAgIC8vIC8vIFRoaXMgaXMgd2hlcmUgd2UgYXJlIE5PVywgbm93IHdoZXJlIHdlIGFyZSBHT0lORyB0byBiZS5cbiAgICAgICAgLy8gbGV0IGVsZW1lbnRSZWN0ID0gUmVjdHMuZnJvbUVsZW1lbnRTdHlsZShlbGVtZW50KTtcblxuICAgICAgICAvLyBsb2cuaW5mbyhgeDogJHt4fTogeTogJHt5fWApO1xuICAgICAgICBsb2cuaW5mbyhcIl9jYWxjdWxhdGVJbnRlcnNlY3RlZEJveGVzOiByZXNpemVSZWN0IGlzOiBcIiArIEpTT04uc3RyaW5naWZ5KHJlc2l6ZVJlY3QsIG51bGwsIFwiICBcIikpO1xuXG4gICAgICAgIC8vIFRPRE86IGl0IGxvb2tzIGxpa2UgdGhlcmUncyBhbiBpc3N1ZSB3aXRoIHBhcmVudEVsZW1lbnQgYmVpbmcgbWlzc2luZ1xuICAgICAgICAvLyBoZXJlLiAgSWYgdGhlIHBhcmVudEVsZW1lbnQgaXMgbWlzc2luZyBJIHByb2JhYmx5IG5lZWQgdG8gaWdub3JlIHRoZVxuICAgICAgICAvLyBpbnRlcnNlY3RlZCBib3hlcz9cblxuICAgICAgICBpZiAoISBlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IFwiRWxlbWVudCBub3Qgd2l0aGluIERPTTogXCI7XG4gICAgICAgICAgICBsb2cuZXJyb3IobXNnLCBlbGVtZW50KTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaW50ZXJzZWN0ZWRFbGVtZW50cyA9IGVsZW1lbnQucGFyZW50RWxlbWVudCEucXVlcnlTZWxlY3RvckFsbChpbnRlcnNlY3RlZEVsZW1lbnRzU2VsZWN0b3IpO1xuXG4gICAgICAgIGNvbnN0IGJveGVzOiBIVE1MRWxlbWVudFtdXG4gICAgICAgICAgICA9IEFycmF5LmZyb20oaW50ZXJzZWN0ZWRFbGVtZW50cylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihjdXJyZW50ID0+IGN1cnJlbnQgIT09IGVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoY3VycmVudCA9PiBjdXJyZW50IGFzIEhUTUxFbGVtZW50KTtcblxuICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCBvdXIgYm94ZXMgYXJlbid0IHRoZSBzYW1lIElEIGFzIHRoZSBlbGVtZW50LiB3ZSBjYW5cbiAgICAgICAgLy8gcmVtb3ZlIHRoaXMgd2hlbiB3ZSBnbyB0byBwcm9kdWN0aW9uXG4gICAgICAgIGJveGVzLmZvckVhY2goY3VycmVudCA9PiBjdXJyZW50LmdldEF0dHJpYnV0ZShcImlkXCIpICE9PSBlbGVtZW50LmdldEF0dHJpYnV0ZShcImlkXCIpKTtcblxuICAgICAgICBjb25zdCBpbnRlcnNlY3RlZFJlY3RzOiBSZWN0W10gPSBbXTtcblxuICAgICAgICBib3hlcy5mb3JFYWNoKGJveCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGJveFJlY3QgPSBSZWN0cy5mcm9tRWxlbWVudFN0eWxlKGJveCk7XG5cbiAgICAgICAgICAgIGlmIChSZWN0cy5pbnRlcnNlY3QoYm94UmVjdCwgcmVzaXplUmVjdCkpIHtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3RlZFJlY3RzLnB1c2goYm94UmVjdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlc2l6ZVJlY3QsXG4gICAgICAgICAgICBpbnRlcnNlY3RlZFJlY3RzXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGludGVyYWN0aW9uRXZlbnRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9jb21wdXRlT3JpZ2luWFkoaW50ZXJhY3Rpb25FdmVudDogYW55KSB7XG5cbiAgICAgICAgbGV0IGRlbHRhID0ge1xuICAgICAgICAgICAgeDogaW50ZXJhY3Rpb25FdmVudC5wYWdlWCAtIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRDb29yZHMucGFnZS54LFxuICAgICAgICAgICAgeTogaW50ZXJhY3Rpb25FdmVudC5wYWdlWSAtIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRDb29yZHMucGFnZS55XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbG9nLmluZm8oYGRyYWdtb3ZlOiBkZWx0YS54OiAke2RlbHRhLnh9IGFuZCBkZWx0YS55OiAke2RlbHRhLnl9YCk7XG4gICAgICAgIC8vIGxvZy5pbmZvKGBkcmFnbW92ZTogaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydENvb3Jkcy5wYWdlOiBgXG4gICAgICAgIC8vICsgSlNPTi5zdHJpbmdpZnkoaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydENvb3Jkcy5wYWdlKSApO1xuICAgICAgICAvLyBsb2cuaW5mbyhgZHJhZ21vdmU6IHRlc3REZWx0YTogYCArIEpTT04uc3RyaW5naWZ5KGRlbHRhKSk7XG5cbiAgICAgICAgbGV0IHggPSBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0VGFyZ2V0UmVjdC5sZWZ0ICsgZGVsdGEueDtcbiAgICAgICAgbGV0IHkgPSBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0VGFyZ2V0UmVjdC50b3AgKyBkZWx0YS55O1xuXG4gICAgICAgIHJldHVybiB7eCwgeX07XG5cbiAgICB9XG5cblxuICAgIF9tb3ZlVGFyZ2V0RWxlbWVudCh4OiBudW1iZXIsIHk6IG51bWJlciwgdGFyZ2V0OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIHRhcmdldC5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7XG4gICAgICAgIHRhcmdldC5zdHlsZS50b3AgPSBgJHt5fXB4YDtcblxuICAgICAgICAvLyB1cGRhdGUgdGhlIHBvc2l0aW9uIGF0dHJpYnV0ZXNcbiAgICAgICAgdGFyZ2V0LnNldEF0dHJpYnV0ZSgnZGF0YS14JywgYCR7eH1gKTtcbiAgICAgICAgdGFyZ2V0LnNldEF0dHJpYnV0ZSgnZGF0YS15JywgYCR7eX1gKTtcblxuICAgICAgICAvL3VwZGF0ZVRhcmdldFRleHQodGFyZ2V0KTtcblxuICAgIH1cblxuICAgIF9yZXNpemVUYXJnZXRFbGVtZW50KHJlY3Q6IFJlY3QsIHRhcmdldDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICAvLyBmaXJzdCBtb3ZlIGl0IHRoZSBzYW1lIHdheSBhcyBpZiBpdCB3ZXJlIGRyYWdnZWRcbiAgICAgICAgdGhpcy5fbW92ZVRhcmdldEVsZW1lbnQocmVjdC5sZWZ0LCByZWN0LnRvcCwgdGFyZ2V0KTtcblxuICAgICAgICAvLyBub3cgc2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0XG4gICAgICAgIHRhcmdldC5zdHlsZS53aWR0aCAgPSBgJHtyZWN0LndpZHRofXB4YDtcbiAgICAgICAgdGFyZ2V0LnN0eWxlLmhlaWdodCA9IGAke3JlY3QuaGVpZ2h0fXB4YDtcblxuICAgIH1cblxuICAgIF9jYXB0dXJlU3RhcnRUYXJnZXRSZWN0KGludGVyYWN0aW9uRXZlbnQ6IGFueSkge1xuICAgICAgICAvLyB0aGlzIG1vZGlmaWVzIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24gYnkgc2lkZSBlZmZlY3Qgd2hpY2ggSVxuICAgICAgICAvLyBkb24ndCBsaWtlLlxuICAgICAgICBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0VGFyZ2V0UmVjdCA9IFJlY3RzLmZyb21FbGVtZW50U3R5bGUoaW50ZXJhY3Rpb25FdmVudC50YXJnZXQpO1xuICAgIH1cblxufVxuIl19