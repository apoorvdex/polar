"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const Elements_1 = require("../util/Elements");
const ContextMenuType_1 = require("./ContextMenuType");
const MatchingSelector_1 = require("./MatchingSelector");
const AnnotationDescriptors_1 = require("../metadata/AnnotationDescriptors");
const Logger_1 = require("../logger/Logger");
const TriggerEvent_1 = require("./TriggerEvent");
const DocDescriptor_1 = require("../metadata/DocDescriptor");
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const Functions_1 = require("../util/Functions");
const BrowserContextMenus_1 = require("./browser/BrowserContextMenus");
const log = Logger_1.Logger.create();
class ContextMenuController {
    constructor(model) {
        this.model = model;
        if (electron_1.ipcRenderer) {
            electron_1.ipcRenderer.on('context-menu-command', (event, arg) => {
            });
        }
    }
    start() {
        log.info("Starting ContextMenuController");
        BrowserContextMenus_1.BrowserContextMenus.create();
        document.querySelectorAll(".page").forEach((targetElement) => {
            this.registerPageContextMenuListener(targetElement);
        });
    }
    registerPageContextMenuListener(targetElement) {
        targetElement.addEventListener('contextmenu', (event) => {
            this.onContextMenuHandler(event, [".text-highlight",
                ".area-highlight",
                ".pagemark",
                ".page"]);
        });
    }
    registerDefaultContextMenuListener(targetElement) {
        targetElement.addEventListener('contextmenu', (event) => {
            this.onContextMenuHandler(event, ["*"]);
        });
    }
    onContextMenuHandler(event, annotationSelectors) {
        const matchingSelectors = ContextMenuController.elementsFromEventMatchingSelectors(event, annotationSelectors);
        const contextMenuTypes = [];
        Functions_1.forDict(matchingSelectors, (selector, current) => {
            if (current.elements.length > 0) {
                contextMenuTypes.push(ContextMenuController.toContextMenuType(current.selector));
            }
        });
        const docDescriptor = new DocDescriptor_1.DocDescriptor({
            fingerprint: this.model.docMeta.docInfo.fingerprint
        });
        log.info("Creating context menu for contextMenuTypes: ", contextMenuTypes);
        const pageElement = Elements_1.Elements.untilRoot(event.target, ".page");
        const docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        const pageNum = docFormat.getPageNumFromPageElement(pageElement);
        const eventTargetOffset = Elements_1.Elements.getRelativeOffsetRect(event.target, pageElement);
        const pageOffset = {
            x: eventTargetOffset.left + event.offsetX,
            y: eventTargetOffset.top + event.offsetY
        };
        const triggerEvent = TriggerEvent_1.TriggerEvent.create({
            point: {
                x: event.pageX,
                y: event.pageY
            },
            points: {
                page: {
                    x: event.pageX,
                    y: event.pageY
                },
                client: {
                    x: event.clientX,
                    y: event.clientY
                },
                offset: {
                    x: event.offsetX,
                    y: event.offsetY
                },
                pageOffset
            },
            pageNum,
            contextMenuTypes,
            matchingSelectors,
            docDescriptor
        });
        BrowserContextMenus_1.BrowserContextMenus.trigger(triggerEvent, event);
    }
    static withActivePagemarks(closure) {
        const elements = Array.from(document.querySelectorAll(".pagemark"));
        const elementStyleRestores = [];
        for (const element of elements) {
            elementStyleRestores.push({
                element, pointerEvents: element.style.pointerEvents
            });
            element.style.pointerEvents = 'auto';
        }
        const result = closure();
        for (const restore of elementStyleRestores) {
            restore.element.style.pointerEvents = restore.pointerEvents;
        }
        return result;
    }
    static elementsFromEvent(event) {
        if (event.target instanceof HTMLElement) {
            const point = { x: event.clientX, y: event.clientY };
            const doc = event.target.ownerDocument;
            if (doc) {
                return this.withActivePagemarks(() => {
                    return doc.elementsFromPoint(point.x, point.y);
                });
            }
        }
        return [];
    }
    static toContextMenuType(selector) {
        let result = selector.toUpperCase();
        result = result.replace(".", "");
        result = result.replace("-", "_");
        return ContextMenuType_1.ContextMenuTypes.fromString(result);
    }
    static elementsFromEventMatchingSelectors(event, selectors) {
        const result = {};
        selectors.forEach(selector => {
            result[selector] = new MatchingSelector_1.MatchingSelector(selector, [], []);
        });
        const elements = ContextMenuController.elementsFromEvent(event);
        elements.forEach((element) => {
            selectors.forEach(selector => {
                if (element.matches(selector)) {
                    const matchingSelector = result[selector];
                    matchingSelector.elements.push(element);
                    const annotationDescriptor = AnnotationDescriptors_1.AnnotationDescriptors.createFromElement(element);
                    if (annotationDescriptor) {
                        matchingSelector.annotationDescriptors.push(annotationDescriptor);
                    }
                }
            });
        });
        return result;
    }
}
exports.ContextMenuController = ContextMenuController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGV4dE1lbnVDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29udGV4dE1lbnVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXFDO0FBRXJDLCtDQUEwQztBQUMxQyx1REFBb0U7QUFDcEUseURBQW9EO0FBQ3BELDZFQUF3RTtBQUN4RSw2Q0FBd0M7QUFDeEMsaURBQTRDO0FBQzVDLDZEQUF3RDtBQUN4RCxvRUFBK0Q7QUFDL0QsaURBQTBDO0FBRTFDLHVFQUFrRTtBQUdsRSxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFTNUIsTUFBYSxxQkFBcUI7SUFJOUIsWUFBWSxLQUFZO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksc0JBQVcsRUFBRTtZQUViLHNCQUFXLENBQUMsRUFBRSxDQUFDLHNCQUFzQixFQUFFLENBQUMsS0FBVSxFQUFFLEdBQVEsRUFBRSxFQUFFO1lBS2hFLENBQUMsQ0FBQyxDQUFDO1NBRU47SUFDTCxDQUFDO0lBRU0sS0FBSztRQUtSLEdBQUcsQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUUzQyx5Q0FBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUU3QixRQUFRLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsYUFBYSxFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDLCtCQUErQixDQUFlLGFBQWEsQ0FBQyxDQUFDO1FBQ3RFLENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQztJQUVPLCtCQUErQixDQUFDLGFBQTBCO1FBRTlELGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUVwRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxFQUFFLENBQUUsaUJBQWlCO2dCQUNqQixpQkFBaUI7Z0JBQ2pCLFdBQVc7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LENBQUMsQ0FBQztRQUVILE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7Q0FFSjtBQTdPRCxzREE2T0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lwY1JlbmRlcmVyfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQge01vZGVsfSBmcm9tICcuLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge0VsZW1lbnRzfSBmcm9tICcuLi91dGlsL0VsZW1lbnRzJztcbmltcG9ydCB7Q29udGV4dE1lbnVUeXBlLCBDb250ZXh0TWVudVR5cGVzfSBmcm9tICcuL0NvbnRleHRNZW51VHlwZSc7XG5pbXBvcnQge01hdGNoaW5nU2VsZWN0b3J9IGZyb20gJy4vTWF0Y2hpbmdTZWxlY3Rvcic7XG5pbXBvcnQge0Fubm90YXRpb25EZXNjcmlwdG9yc30gZnJvbSAnLi4vbWV0YWRhdGEvQW5ub3RhdGlvbkRlc2NyaXB0b3JzJztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICcuLi9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7VHJpZ2dlckV2ZW50fSBmcm9tICcuL1RyaWdnZXJFdmVudCc7XG5pbXBvcnQge0RvY0Rlc2NyaXB0b3J9IGZyb20gJy4uL21ldGFkYXRhL0RvY0Rlc2NyaXB0b3InO1xuaW1wb3J0IHtEb2NGb3JtYXRGYWN0b3J5fSBmcm9tICcuLi9kb2Nmb3JtYXQvRG9jRm9ybWF0RmFjdG9yeSc7XG5pbXBvcnQge2ZvckRpY3R9IGZyb20gJy4uL3V0aWwvRnVuY3Rpb25zJztcbmltcG9ydCB7RWxlY3Ryb25Db250ZXh0TWVudXN9IGZyb20gJy4vZWxlY3Ryb24vRWxlY3Ryb25Db250ZXh0TWVudXMnO1xuaW1wb3J0IHtCcm93c2VyQ29udGV4dE1lbnVzfSBmcm9tICcuL2Jyb3dzZXIvQnJvd3NlckNvbnRleHRNZW51cyc7XG5pbXBvcnQge0Jyb3dzZXJDb250ZXh0TWVudX0gZnJvbSAnLi9icm93c2VyL0Jyb3dzZXJDb250ZXh0TWVudSc7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuLyoqXG4gKiBIYW5kbGVzIGxpc3RlbmluZyBmb3IgY29udGV4dCBtZW51cyBhbmQgdGhlbiBjYWxsaW5nIGJhY2sgdGhlIHByb3BlciBoYW5kbGVyLlxuICpcbiAqIElQQyBtZXNzYWdlczpcbiAqXG4gKiBjb250ZXh0LW1lbnUtY3JlYXRlLWZsYXNoY2FyZDogb3BlbiB0aGUgJ2NyZWF0ZSBmbGFzaGNhcmQnIG1vZGFsLlxuICovXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVDb250cm9sbGVyIHtcblxuICAgIHByaXZhdGUgbW9kZWw6IE1vZGVsO1xuXG4gICAgY29uc3RydWN0b3IobW9kZWw6IE1vZGVsKSB7XG4gICAgICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcblxuICAgICAgICBpZiAoaXBjUmVuZGVyZXIpIHtcblxuICAgICAgICAgICAgaXBjUmVuZGVyZXIub24oJ2NvbnRleHQtbWVudS1jb21tYW5kJywgKGV2ZW50OiBhbnksIGFyZzogYW55KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBJIGRvbid0IHRoaW5rIHdlIG5lZWQgdG8gbGlzdGVuIHRvIHRoZXNlIGhlcmUgYnV0IHJhdGhlciBpbiB0aGVcbiAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBjb250cm9sbGVycy5cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBiZSByZWZhY3RvcmVkIHRvIG1ha2UgaXQgdGVzdGFibGUgd2l0aCBqc2RvbSBvbmNlXG4gICAgICAgIC8vIEkgZ2V0IGl0IHdvcmtpbmcuXG5cbiAgICAgICAgbG9nLmluZm8oXCJTdGFydGluZyBDb250ZXh0TWVudUNvbnRyb2xsZXJcIik7XG5cbiAgICAgICAgQnJvd3NlckNvbnRleHRNZW51cy5jcmVhdGUoKTtcblxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnBhZ2VcIikuZm9yRWFjaCgodGFyZ2V0RWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWdpc3RlclBhZ2VDb250ZXh0TWVudUxpc3RlbmVyKDxIVE1MRWxlbWVudD4gdGFyZ2V0RWxlbWVudCk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWdpc3RlclBhZ2VDb250ZXh0TWVudUxpc3RlbmVyKHRhcmdldEVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgdGFyZ2V0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjb250ZXh0bWVudScsIChldmVudCkgPT4ge1xuXG4gICAgICAgICAgICB0aGlzLm9uQ29udGV4dE1lbnVIYW5kbGVyKGV2ZW50LCBbIFwiLnRleHQtaGlnaGxpZ2h0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLmFyZWEtaGlnaGxpZ2h0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLnBhZ2VtYXJrXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLnBhZ2VcIl0gKTtcblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgcmVnaXN0ZXJEZWZhdWx0Q29udGV4dE1lbnVMaXN0ZW5lcih0YXJnZXRFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIHRhcmdldEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZXZlbnQpID0+IHtcblxuICAgICAgICAgICAgdGhpcy5vbkNvbnRleHRNZW51SGFuZGxlcihldmVudCwgWyBcIipcIiBdICk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ29udGV4dE1lbnVIYW5kbGVyKGV2ZW50OiBNb3VzZUV2ZW50LCBhbm5vdGF0aW9uU2VsZWN0b3JzOiBzdHJpbmdbXSkge1xuXG4gICAgICAgIGNvbnN0IG1hdGNoaW5nU2VsZWN0b3JzXG4gICAgICAgICAgICA9IENvbnRleHRNZW51Q29udHJvbGxlci5lbGVtZW50c0Zyb21FdmVudE1hdGNoaW5nU2VsZWN0b3JzKGV2ZW50LCBhbm5vdGF0aW9uU2VsZWN0b3JzICk7XG5cbiAgICAgICAgY29uc3QgY29udGV4dE1lbnVUeXBlczogQ29udGV4dE1lbnVUeXBlW10gPSBbXTtcblxuICAgICAgICBmb3JEaWN0KG1hdGNoaW5nU2VsZWN0b3JzLCAoc2VsZWN0b3I6IHN0cmluZywgY3VycmVudDogTWF0Y2hpbmdTZWxlY3RvcikgPT4ge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnQuZWxlbWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnRleHRNZW51VHlwZXMucHVzaChDb250ZXh0TWVudUNvbnRyb2xsZXIudG9Db250ZXh0TWVudVR5cGUoY3VycmVudC5zZWxlY3RvcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkb2NEZXNjcmlwdG9yID0gbmV3IERvY0Rlc2NyaXB0b3Ioe1xuICAgICAgICAgICAgZmluZ2VycHJpbnQ6IHRoaXMubW9kZWwuZG9jTWV0YS5kb2NJbmZvLmZpbmdlcnByaW50XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiQ3JlYXRpbmcgY29udGV4dCBtZW51IGZvciBjb250ZXh0TWVudVR5cGVzOiBcIiwgY29udGV4dE1lbnVUeXBlcyk7XG5cbiAgICAgICAgY29uc3QgcGFnZUVsZW1lbnQgPSBFbGVtZW50cy51bnRpbFJvb3QoPEhUTUxFbGVtZW50PiBldmVudC50YXJnZXQsIFwiLnBhZ2VcIik7XG5cbiAgICAgICAgY29uc3QgZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VOdW0gPSBkb2NGb3JtYXQuZ2V0UGFnZU51bUZyb21QYWdlRWxlbWVudChwYWdlRWxlbWVudCk7XG5cbiAgICAgICAgY29uc3QgZXZlbnRUYXJnZXRPZmZzZXQgPSBFbGVtZW50cy5nZXRSZWxhdGl2ZU9mZnNldFJlY3QoPEhUTUxFbGVtZW50PiBldmVudC50YXJnZXQsIHBhZ2VFbGVtZW50KTtcblxuICAgICAgICAvLyBjb21wdXRlIHRoZSBvZmZzZXQgb2YgdGhlIGV2ZW50IHJlbGF0aXZlIHRvIHRoZSBwYWdlIHdlJ3JlXG4gICAgICAgIC8vIHZpZXdpbmdcbiAgICAgICAgY29uc3QgcGFnZU9mZnNldCA9IHtcblxuICAgICAgICAgICAgeDogZXZlbnRUYXJnZXRPZmZzZXQubGVmdCArIGV2ZW50Lm9mZnNldFgsXG4gICAgICAgICAgICB5OiBldmVudFRhcmdldE9mZnNldC50b3AgKyBldmVudC5vZmZzZXRZXG5cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB0cmlnZ2VyRXZlbnQgPSBUcmlnZ2VyRXZlbnQuY3JlYXRlKHtcbiAgICAgICAgICAgIHBvaW50OiB7XG4gICAgICAgICAgICAgICAgeDogZXZlbnQucGFnZVgsXG4gICAgICAgICAgICAgICAgeTogZXZlbnQucGFnZVlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwb2ludHM6IHtcbiAgICAgICAgICAgICAgICBwYWdlOiB7XG4gICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50LnBhZ2VYLFxuICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5wYWdlWVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50LmNsaWVudFgsXG4gICAgICAgICAgICAgICAgICAgIHk6IGV2ZW50LmNsaWVudFlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9mZnNldDoge1xuICAgICAgICAgICAgICAgICAgICB4OiBldmVudC5vZmZzZXRYLFxuICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5vZmZzZXRZXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBwYWdlT2Zmc2V0XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcGFnZU51bSxcbiAgICAgICAgICAgIGNvbnRleHRNZW51VHlwZXMsXG4gICAgICAgICAgICBtYXRjaGluZ1NlbGVjdG9ycyxcbiAgICAgICAgICAgIGRvY0Rlc2NyaXB0b3JcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gRWxlY3Ryb25Db250ZXh0TWVudXMudHJpZ2dlcih0cmlnZ2VyRXZlbnQpO1xuXG4gICAgICAgIEJyb3dzZXJDb250ZXh0TWVudXMudHJpZ2dlcih0cmlnZ2VyRXZlbnQsIGV2ZW50KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBhZ2VtYXJrcyBoYXZlIHBvaW50ZXItZXZlbnRzOiBub25lIGFuZCB0aGV5IGRvbid0IHNob3cgdXAgd2hlbiB1c2luZ1xuICAgICAqIGVsZW1lbnRzRnJvbVBvaW50IHNvIHdlIGhhdmUgdG8gdGVtcG9yYXJpbHkgZW5hYmxlIHRoZW0uXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgd2l0aEFjdGl2ZVBhZ2VtYXJrczxUPihjbG9zdXJlOiAoKSA9PiBUKSB7XG5cbiAgICAgICAgaW50ZXJmYWNlIEVsZW1lbnRTdHlsZVJlc3RvcmUge1xuICAgICAgICAgICAgcmVhZG9ubHkgZWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgICByZWFkb25seSBwb2ludGVyRXZlbnRzOiBzdHJpbmcgfCBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZWxlbWVudHMgPVxuICAgICAgICAgICAgPEhUTUxFbGVtZW50W10+IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5wYWdlbWFya1wiKSk7XG5cbiAgICAgICAgY29uc3QgZWxlbWVudFN0eWxlUmVzdG9yZXM6IEVsZW1lbnRTdHlsZVJlc3RvcmVbXSA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBlbGVtZW50cykge1xuXG4gICAgICAgICAgICBlbGVtZW50U3R5bGVSZXN0b3Jlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBlbGVtZW50LCBwb2ludGVyRXZlbnRzOiBlbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHNcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNsb3N1cmUoKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHJlc3RvcmUgb2YgZWxlbWVudFN0eWxlUmVzdG9yZXMpIHtcbiAgICAgICAgICAgIHJlc3RvcmUuZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gcmVzdG9yZS5wb2ludGVyRXZlbnRzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuXG4gICAgcHVibGljIHN0YXRpYyBlbGVtZW50c0Zyb21FdmVudChldmVudDogTW91c2VFdmVudCkge1xuXG4gICAgICAgIC8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzE0MTc2OTg4L3doeS1pcy1kb2N1bWVudC1lbGVtZW50ZnJvbXBvaW50LWFmZmVjdGVkLWJ5LXBvaW50ZXItZXZlbnRzLW5vbmVcblxuICAgICAgICBpZiAoZXZlbnQudGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICAgICAgLy8gdGhlIHBvaW50IG11c3QgYmUgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0XG4gICAgICAgICAgICBjb25zdCBwb2ludCA9IHt4OiBldmVudC5jbGllbnRYLCB5OiBldmVudC5jbGllbnRZfTtcblxuICAgICAgICAgICAgY29uc3QgZG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQ7XG5cbiAgICAgICAgICAgIGlmIChkb2MpIHtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndpdGhBY3RpdmVQYWdlbWFya3MoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gPEhUTUxFbGVtZW50W10+IGRvYy5lbGVtZW50c0Zyb21Qb2ludChwb2ludC54LCBwb2ludC55KTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gW107XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHRvQ29udGV4dE1lbnVUeXBlKHNlbGVjdG9yOiBzdHJpbmcpOiBDb250ZXh0TWVudVR5cGUge1xuICAgICAgICBsZXQgcmVzdWx0ID0gc2VsZWN0b3IudG9VcHBlckNhc2UoKTtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoXCIuXCIsIFwiXCIpO1xuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShcIi1cIiwgXCJfXCIpO1xuICAgICAgICByZXR1cm4gQ29udGV4dE1lbnVUeXBlcy5mcm9tU3RyaW5nKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgcmVzdWx0IGJ5IGxvb2tpbmcgYXQgYWxsIHRoZSBldmVudHMsIGFuZCBhbGwgdGhlIHNlbGVjdG9ycyxcbiAgICAgKiBidWlsZGluZyB1cCBhbiBpbmRleCBvZiBtYXRjaGluZyBlbGVtZW50cyBhdCB0aGUgcG9zaXRpb24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKiBAcGFyYW0gc2VsZWN0b3JzXG4gICAgICovXG4gICAgIHB1YmxpYyBzdGF0aWMgZWxlbWVudHNGcm9tRXZlbnRNYXRjaGluZ1NlbGVjdG9ycyhldmVudDogTW91c2VFdmVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yczogc3RyaW5nW10pOiBNYXRjaGluZ1NlbGVjdG9yTWFwIHtcblxuICAgICAgICBjb25zdCByZXN1bHQ6IE1hdGNoaW5nU2VsZWN0b3JNYXAgPSB7fTtcblxuICAgICAgICBzZWxlY3RvcnMuZm9yRWFjaChzZWxlY3RvciA9PiB7XG4gICAgICAgICAgICByZXN1bHRbc2VsZWN0b3JdID0gbmV3IE1hdGNoaW5nU2VsZWN0b3Ioc2VsZWN0b3IsIFtdLCBbXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGVsZW1lbnRzID0gQ29udGV4dE1lbnVDb250cm9sbGVyLmVsZW1lbnRzRnJvbUV2ZW50KGV2ZW50KTtcblxuICAgICAgICBlbGVtZW50cy5mb3JFYWNoKChlbGVtZW50OiBIVE1MRWxlbWVudCkgPT4ge1xuXG4gICAgICAgICAgICBzZWxlY3RvcnMuZm9yRWFjaChzZWxlY3RvciA9PiB7XG5cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tYXRjaGVzKHNlbGVjdG9yKSkge1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoaW5nU2VsZWN0b3IgPSByZXN1bHRbc2VsZWN0b3JdO1xuXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoaW5nU2VsZWN0b3IuZWxlbWVudHMucHVzaChlbGVtZW50KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhbm5vdGF0aW9uRGVzY3JpcHRvciA9IEFubm90YXRpb25EZXNjcmlwdG9ycy5jcmVhdGVGcm9tRWxlbWVudChlbGVtZW50KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoYW5ub3RhdGlvbkRlc2NyaXB0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoaW5nU2VsZWN0b3IuYW5ub3RhdGlvbkRlc2NyaXB0b3JzLnB1c2goYW5ub3RhdGlvbkRlc2NyaXB0b3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG5cbi8vIG5vaW5zcGVjdGlvbiBUc0xpbnRcbmV4cG9ydCB0eXBlIE1hdGNoaW5nU2VsZWN0b3JNYXAgPSB7W2tleTogc3RyaW5nXTogTWF0Y2hpbmdTZWxlY3Rvcn07XG4iXX0=