"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("../Preconditions");
const Rects_1 = require("../Rects");
const $ = require('jquery');
class Elements {
    static getRelativeOffsetRect(element, parentElement) {
        Preconditions_1.Preconditions.assertNotNull(element, "element");
        if (!parentElement) {
            parentElement = element.ownerDocument.documentElement;
        }
        const offsetRect = { left: 0, top: 0, width: 0, height: 0 };
        function toInt(value) {
            if (isNaN(value)) {
                return 0;
            }
            return value;
        }
        offsetRect.width = toInt(element.offsetWidth);
        offsetRect.height = toInt(element.offsetHeight);
        while (element !== null) {
            if (element === parentElement) {
                break;
            }
            offsetRect.left += toInt(element.offsetLeft);
            offsetRect.top += toInt(element.offsetTop);
            element = element.offsetParent;
        }
        return Rects_1.Rects.createFromBasicRect(offsetRect);
    }
    static createWrapperElementHTML(innerHTML) {
        const div = document.createElement("div");
        div.innerHTML = innerHTML;
        return div;
    }
    static createElementHTML(html, tagName = 'div') {
        const div = document.createElement(tagName);
        div.innerHTML = html;
        return div.firstChild;
    }
    static offset(element) {
        const result = {
            left: element.offsetLeft,
            top: element.offsetTop,
            width: element.offsetWidth,
            height: element.offsetHeight,
            right: 0,
            bottom: 0
        };
        result.right = result.left + result.width;
        result.bottom = result.top + result.height;
        return Rects_1.Rects.validate(Rects_1.Rects.createFromBasicRect(result));
    }
    static requireClass(element, clazz) {
        const classValue = element.getAttribute("class");
        if (!classValue || classValue.indexOf(clazz) === -1) {
            throw new Error("Element does not have the proper class: " + clazz);
        }
    }
    static untilRoot(element, selector) {
        if (!element) {
            throw new Error("element required");
        }
        if (!selector) {
            throw new Error("selector required");
        }
        if (element.matches(selector)) {
            return element;
        }
        if (element.parentElement == null) {
            return null;
        }
        return Elements.untilRoot(element.parentElement, selector);
    }
    static calculateVisibilityForDiv(div) {
        if (div == null) {
            throw Error("Not given a div");
        }
        const windowHeight = $(window).height();
        const docScroll = $(document).scrollTop();
        const divPosition = $(div).offset().top;
        const divHeight = $(div).height();
        const hiddenBefore = docScroll - divPosition;
        const hiddenAfter = (divPosition + divHeight) - (docScroll + windowHeight);
        if ((docScroll > divPosition + divHeight) || (divPosition > docScroll + windowHeight)) {
            return 0;
        }
        else {
            let result = 100;
            if (hiddenBefore > 0) {
                result -= (hiddenBefore * 100) / divHeight;
            }
            if (hiddenAfter > 0) {
                result -= (hiddenAfter * 100) / divHeight;
            }
            return result;
        }
    }
    static getScrollParent(element) {
        if (!element) {
            return undefined;
        }
        const scrollHeight = element.scrollHeight;
        const clientHeight = element.clientHeight;
        if (scrollHeight > clientHeight) {
            return element;
        }
        else {
            return this.getScrollParent(element.parentElement);
        }
    }
}
exports.Elements = Elements;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWxlbWVudHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJFbGVtZW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUErQztBQUMvQyxvQ0FBK0I7QUFHL0IsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTVCLE1BQWEsUUFBUTtJQWVWLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxPQUFvQixFQUFFLGFBQTJCO1FBRWpGLDZCQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUUsYUFBYSxFQUFFO1lBQ2pCLGFBQWEsR0FBRyxPQUFPLENBQUMsYUFBYyxDQUFDLGVBQWdCLENBQUM7U0FDM0Q7UUFFRCxNQUFNLFVBQVUsR0FBRyxFQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUMsQ0FBQztRQUUxRCxTQUFTLEtBQUssQ0FBQyxLQUFhO1lBQ3hCLElBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFHO2dCQUNoQixPQUFPLENBQUMsQ0FBQzthQUNaO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQztRQUVELFVBQVUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM5QyxVQUFVLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFaEQsT0FBTyxPQUFPLEtBQUssSUFBSSxFQUFFO1lBRXJCLElBQUksT0FBTyxLQUFLLGFBQWEsRUFBRTtnQkFDM0IsTUFBTTthQUNUO1lBRUQsVUFBVSxDQUFDLElBQUksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLFVBQVUsQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxT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QUVKO0FBM01ELDRCQTJNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UHJlY29uZGl0aW9uc30gZnJvbSAnLi4vUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi9SZWN0cyc7XG5pbXBvcnQge1JlY3R9IGZyb20gJy4uL1JlY3QnO1xuXG5jb25zdCAkID0gcmVxdWlyZSgnanF1ZXJ5Jyk7XG5cbmV4cG9ydCBjbGFzcyBFbGVtZW50cyB7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIENvbXB1dGUgdGhlIG9mZnNldCByZWxhdGl2ZSB0byBhbm90aGVyIHBhcmVudCBlbGVtZW50LiAgVGhpcyBjYW4gYmUgdXNlZFxuICAgICAqIHRvIGNvbXB1dGUgdGhlIGFic29sdXRlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgb24gYSBwYWdlLlxuICAgICAqXG4gICAgICogQHBhcmFtIGVsZW1lbnRcbiAgICAgKiBAcGFyYW0gW3BhcmVudEVsZW1lbnRdIHtIVE1MRWxlbWVudH0gcmVsYXRpdmUgdG8gdGhpcyBwYXJlbnRFbGVtZW50LlxuICAgICAqICAgICAgICBCeSBkZWZhdWx0IHdlIGFyZSByZWxhdGl2ZSB0byB0aGUgZG9jdW1lbnQgcm9vdCAoZG9jdW1lbnRFbGVtZW50KS5cbiAgICAgKiBAcmV0dXJuIHtSZWN0fVxuICAgICAqL1xuXG4gICAgLy8gRklYTUU6IHRoaXMgc2hvdWxkIGJlIGdldFBhZ2VPZmZzZXRSZWN0IGFuZCBoYXZlIGFcbiAgICAvLyByZWxhdGl2ZVRvUGFyZW50RWxlbWVudCB3aGljaCBpcyBvcHRpb25hbC5cbiAgICBwdWJsaWMgc3RhdGljIGdldFJlbGF0aXZlT2Zmc2V0UmVjdChlbGVtZW50OiBIVE1MRWxlbWVudCwgcGFyZW50RWxlbWVudD86IEhUTUxFbGVtZW50KTogUmVjdCB7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKGVsZW1lbnQsIFwiZWxlbWVudFwiKTtcblxuICAgICAgICBpZiAoISBwYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5vd25lckRvY3VtZW50IS5kb2N1bWVudEVsZW1lbnQhO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb2Zmc2V0UmVjdCA9IHtsZWZ0OiAwLCB0b3A6IDAsIHdpZHRoOiAwLCBoZWlnaHQ6IDB9O1xuXG4gICAgICAgIGZ1bmN0aW9uIHRvSW50KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgICAgIGlmICggaXNOYU4odmFsdWUpICkge1xuICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgb2Zmc2V0UmVjdC53aWR0aCA9IHRvSW50KGVsZW1lbnQub2Zmc2V0V2lkdGgpO1xuICAgICAgICBvZmZzZXRSZWN0LmhlaWdodCA9IHRvSW50KGVsZW1lbnQub2Zmc2V0SGVpZ2h0KTtcblxuICAgICAgICB3aGlsZSAoZWxlbWVudCAhPT0gbnVsbCkge1xuXG4gICAgICAgICAgICBpZiAoZWxlbWVudCA9PT0gcGFyZW50RWxlbWVudCkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvZmZzZXRSZWN0LmxlZnQgKz0gdG9JbnQoZWxlbWVudC5vZmZzZXRMZWZ0KTtcbiAgICAgICAgICAgIG9mZnNldFJlY3QudG9wICs9IHRvSW50KGVsZW1lbnQub2Zmc2V0VG9wKTtcblxuICAgICAgICAgICAgLy8gVE86IERvIEkgaGF2ZSB0byBmYWN0b3IgaW4gc2Nyb2xsVG9wIGhlcmUuLiB0aGlzIGlzIGluc2FuZS5cbiAgICAgICAgICAgIC8vIEkgdGhpbmsgdGhpcyBpc24ndCB0cnVlLi4uIEkgdGhpbmsgdGhlIHByb2JsZW0gaXMgdGhhdCB0aGUgcGFnZVxuICAgICAgICAgICAgLy8gcG9zaXRpb24gY2hhbmdlcyBXUlQgc2Nyb2xsaW5nLlxuXG4gICAgICAgICAgICAvLyBvZmZzZXRSZWN0LmxlZnQgKz0gdG9JbnQoZWxlbWVudC5zY3JvbGxMZWZ0KTtcbiAgICAgICAgICAgIC8vIG9mZnNldFJlY3QudG9wICs9IHRvSW50KGVsZW1lbnQuc2Nyb2xsVG9wKTtcblxuICAgICAgICAgICAgZWxlbWVudCA9IDxIVE1MRWxlbWVudD4gZWxlbWVudC5vZmZzZXRQYXJlbnQ7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KG9mZnNldFJlY3QpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGl2IGZyb20gdGhlIGdpdmVuIGlubmVySFRNTCBhbmQgcmV0dXJuIGl0IHdpdGggYSB3cmFwcGVyLlxuICAgICAqXG4gICAgICogQHBhcmFtIGlubmVySFRNTFxuICAgICAqIEByZXR1cm4ge0hUTUxEaXZFbGVtZW50fVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlV3JhcHBlckVsZW1lbnRIVE1MKGlubmVySFRNTDogc3RyaW5nKSB7XG5cbiAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgZGl2LmlubmVySFRNTCA9IGlubmVySFRNTDtcblxuICAgICAgICByZXR1cm4gZGl2O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGVsZW1lbnQgZm9yIHRoZSBnaXZlbiBIVE1MIGFuZCByZXR1cm4gdGhlIGVsZW1lbnQgaW5zdGFuY2VcbiAgICAgKlxuICAgICAqIEBwYXJhbSBodG1sIFRoZSBIVE1MIGVsZW1lbnQgdG8gY3JlYXRlXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVFbGVtZW50SFRNTChodG1sOiBzdHJpbmcsIHRhZ05hbWUgPSAnZGl2JyApOiBIVE1MRWxlbWVudCB7XG5cbiAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTtcbiAgICAgICAgZGl2LmlubmVySFRNTCA9IGh0bWw7XG5cbiAgICAgICAgcmV0dXJuIDxIVE1MRWxlbWVudD4gZGl2LmZpcnN0Q2hpbGQhO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBvZmZzZXQoZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgICAgICBsZWZ0OiBlbGVtZW50Lm9mZnNldExlZnQsXG4gICAgICAgICAgICB0b3A6IGVsZW1lbnQub2Zmc2V0VG9wLFxuICAgICAgICAgICAgd2lkdGg6IGVsZW1lbnQub2Zmc2V0V2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IGVsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgICAgICBib3R0b206IDBcbiAgICAgICAgfTtcblxuICAgICAgICByZXN1bHQucmlnaHQgPSByZXN1bHQubGVmdCArIHJlc3VsdC53aWR0aDtcbiAgICAgICAgcmVzdWx0LmJvdHRvbSA9IHJlc3VsdC50b3AgKyByZXN1bHQuaGVpZ2h0O1xuXG4gICAgICAgIHJldHVybiBSZWN0cy52YWxpZGF0ZShSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHJlc3VsdCkpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVxdWlyZSB0aGF0IHRoZSBlbGVtZW50IGhhdmUgdGhlIGdpdmVuIGNsYXNzbmFtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlcXVpcmVDbGFzcyhlbGVtZW50OiBIVE1MRWxlbWVudCwgY2xheno6IHN0cmluZykge1xuXG4gICAgICAgIGNvbnN0IGNsYXNzVmFsdWUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShcImNsYXNzXCIpO1xuXG4gICAgICAgIGlmICggISBjbGFzc1ZhbHVlIHx8IGNsYXNzVmFsdWUuaW5kZXhPZihjbGF6eikgPT09IC0xKSB7XG5cbiAgICAgICAgICAgIC8vIGVsZW1lbnQgaXNuJ3QgdGhlIHByb3BlciBjbGFzcyB3ZSdyZSBleHBlY3RpbmcuXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFbGVtZW50IGRvZXMgbm90IGhhdmUgdGhlIHByb3BlciBjbGFzczogXCIgKyBjbGF6eik7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogS2VlcCBzZWFyY2hpbmcgcGFyZW50IG5vdGVzIHVudGlsIHdlIGZpbmQgYW4gZWxlbWVudCBtYXRjaGluZyB0aGVcbiAgICAgKiBzZWxlY3Rvciwgb3IgcmV0dXJuIG51bGwgd2hlbiBvbmUgd2FzIG5vdCBmb3VuZC5cbiAgICAgKlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdW50aWxSb290KGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzZWxlY3Rvcjogc3RyaW5nKTogYW55IHtcblxuICAgICAgICAvLyBUT0RPOiByZWZhY3RvciB0aGlzIGZvciB0eXBlc2NyaXB0XG5cbiAgICAgICAgaWYgKCFlbGVtZW50KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJlbGVtZW50IHJlcXVpcmVkXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFzZWxlY3Rvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwic2VsZWN0b3IgcmVxdWlyZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZWxlbWVudC5tYXRjaGVzKHNlbGVjdG9yKSkge1xuICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZWxlbWVudC5wYXJlbnRFbGVtZW50ID09IG51bGwpIHtcbiAgICAgICAgICAgIC8vIHdlIGhhdmUgaGl0IHRoZSByb290LlxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gRWxlbWVudHMudW50aWxSb290KGVsZW1lbnQucGFyZW50RWxlbWVudCwgc2VsZWN0b3IpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjYWxjdWxhdGVWaXNpYmlsaXR5Rm9yRGl2KGRpdjogSFRNTEVsZW1lbnQpOiBudW1iZXIge1xuXG4gICAgICAgIGlmIChkaXYgPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJOb3QgZ2l2ZW4gYSBkaXZcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aW5kb3dIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCk7XG4gICAgICAgIGNvbnN0IGRvY1Njcm9sbCA9ICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpO1xuICAgICAgICBjb25zdCBkaXZQb3NpdGlvbiA9ICQoZGl2KS5vZmZzZXQoKS50b3A7XG4gICAgICAgIGNvbnN0IGRpdkhlaWdodCA9ICQoZGl2KS5oZWlnaHQoKTtcblxuICAgICAgICBjb25zdCBoaWRkZW5CZWZvcmUgPSBkb2NTY3JvbGwgLSBkaXZQb3NpdGlvbjtcbiAgICAgICAgY29uc3QgaGlkZGVuQWZ0ZXIgPSAoZGl2UG9zaXRpb24gKyBkaXZIZWlnaHQpIC0gKGRvY1Njcm9sbCArIHdpbmRvd0hlaWdodCk7XG5cbiAgICAgICAgaWYgKChkb2NTY3JvbGwgPiBkaXZQb3NpdGlvbiArIGRpdkhlaWdodCkgfHwgKGRpdlBvc2l0aW9uID4gZG9jU2Nyb2xsICsgd2luZG93SGVpZ2h0KSkge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gMTAwO1xuXG4gICAgICAgICAgICBpZiAoaGlkZGVuQmVmb3JlID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCAtPSAoaGlkZGVuQmVmb3JlICogMTAwKSAvIGRpdkhlaWdodDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGhpZGRlbkFmdGVyID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCAtPSAoaGlkZGVuQWZ0ZXIgKiAxMDApIC8gZGl2SGVpZ2h0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldFNjcm9sbFBhcmVudChlbGVtZW50OiBFbGVtZW50IHwgbnVsbCB8IHVuZGVmaW5lZCk6IEVsZW1lbnQgfCB1bmRlZmluZWQge1xuXG4gICAgICAgIGlmICghZWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IGVsZW1lbnQuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICBjb25zdCBjbGllbnRIZWlnaHQgPSBlbGVtZW50LmNsaWVudEhlaWdodDtcblxuICAgICAgICBpZiAoc2Nyb2xsSGVpZ2h0ID4gY2xpZW50SGVpZ2h0KSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcInNjcm9sbCBwYXJlbnQgYmFzZWQgb246IFwiLCB7c2Nyb2xsSGVpZ2h0LCBjbGllbnRIZWlnaHR9KTtcbiAgICAgICAgICAgIHJldHVybiBlbGVtZW50O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxQYXJlbnQoZWxlbWVudC5wYXJlbnRFbGVtZW50KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG59XG4iXX0=