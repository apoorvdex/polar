"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Dictionaries_1 = require("./Dictionaries");
const Reducers_1 = require("./Reducers");
const Multimap_1 = require("./Multimap");
const Arrays_1 = require("./Arrays");
class HitMap {
    constructor() {
        this.index = {};
    }
    registerHit(key, delta = 1) {
        const entry = Dictionaries_1.Dictionaries.computeIfAbsent(this.index, key, () => {
            return { key, value: 0 };
        });
        return entry.value += delta;
    }
    registerHits(...keys) {
        for (const key of keys) {
            this.registerHit(key);
        }
    }
    toMap() {
        return Object.freeze(Object.assign({}, this.index));
    }
    toArray() {
        return Object.freeze(Object.values(this.index));
    }
    toLiteralMap() {
        const result = {};
        for (const key of Object.keys(this.index)) {
            result[key] = this.index[key].value;
        }
        return result;
    }
    toRanked() {
        return Object.values(this.toMap())
            .sort((a, b) => b.value - a.value);
    }
    toPercRanked(total) {
        const ranked = this.toRanked();
        if (total === undefined) {
            total = Object.values(ranked)
                .map(current => current.value)
                .reduce(Reducers_1.Reducers.SUM, 0);
        }
        let idx = 1;
        return ranked.map(current => {
            return {
                idx: idx++,
                key: current.key,
                hits: current.value,
                perc: Math.floor((current.value / total) * 100)
            };
        });
    }
}
exports.HitMap = HitMap;
class SampledHitMap {
    constructor() {
        this.hitMap = new HitMap();
        this.multiMap = new Multimap_1.ArrayListMultimap();
    }
    registerHit(key, value) {
        this.hitMap.registerHit(key);
        this.multiMap.put(key, value);
    }
    toPercRanked(nrSamples, total) {
        const ranked = this.hitMap.toRanked();
        if (total === undefined) {
            total = Object.values(ranked)
                .map(current => current.value)
                .reduce(Reducers_1.Reducers.SUM, 0);
        }
        let idx = 1;
        return ranked.map(current => {
            const samples = Arrays_1.Arrays.head(Arrays_1.Arrays.shuffle(...this.multiMap.get(current.key)), nrSamples);
            return {
                idx: idx++,
                key: current.key,
                hits: current.value,
                perc: Math.floor((current.value / total) * 100),
                samples
            };
        });
    }
}
exports.SampledHitMap = SampledHitMap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGl0TWFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiSGl0TWFwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQTRDO0FBQzVDLHlDQUFvQztBQUNwQyx5Q0FBdUQ7QUFDdkQscUNBQWdDO0FBS2hDLE1BQWEsTUFBTTtJQUFuQjtRQUVZLFVBQUssR0FBOEIsRUFBRSxDQUFDO0lBa0ZsRCxDQUFDO0lBaEZVLFdBQVcsQ0FBQyxHQUFXLEVBQUUsUUFBZ0IsQ0FBQztRQUU3QyxNQUFNLEtBQUssR0FBRywyQkFBWSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7WUFDN0QsT0FBTyxFQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFDLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDO0lBRWhDLENBQUM7SUFFTSxZQUFZLENBQUMsR0FBRyxJQUFjO1FBRWpDLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekI7SUFFTCxDQUFDO0lBTU0sS0FBSztRQUNSLE9BQU8sTUFBTSxDQUFDLE1BQU0sbUJBQUssSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFFTSxPQUFPO1FBQ1YsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUtNLFlBQVk7UUFFZixNQUFNLE1BQU0sR0FBZSxFQUFFLENBQUM7UUFFOUIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN2QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtB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QUFDLENBQUM7SUFFUCxDQUFDO0NBRUo7QUFoREQsc0NBZ0RDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEaWN0aW9uYXJpZXN9IGZyb20gXCIuL0RpY3Rpb25hcmllc1wiO1xuaW1wb3J0IHtSZWR1Y2Vyc30gZnJvbSBcIi4vUmVkdWNlcnNcIjtcbmltcG9ydCB7QXJyYXlMaXN0TXVsdGltYXAsIE11bHRpbWFwfSBmcm9tICcuL011bHRpbWFwJztcbmltcG9ydCB7QXJyYXlzfSBmcm9tIFwiLi9BcnJheXNcIjtcblxuLyoqXG4gKiBLZWVwcyB0cmFjayBvZiBoaXRzIGZvciBhIGdpdmVuIGtleS4uLlxuICovXG5leHBvcnQgY2xhc3MgSGl0TWFwIHtcblxuICAgIHByaXZhdGUgaW5kZXg6IHtba2V5OiBzdHJpbmddOiBIaXRFbnRyeX0gPSB7fTtcblxuICAgIHB1YmxpYyByZWdpc3RlckhpdChrZXk6IHN0cmluZywgZGVsdGE6IG51bWJlciA9IDEpOiBudW1iZXIge1xuXG4gICAgICAgIGNvbnN0IGVudHJ5ID0gRGljdGlvbmFyaWVzLmNvbXB1dGVJZkFic2VudCh0aGlzLmluZGV4LCBrZXksICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7a2V5LCB2YWx1ZTogMH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBlbnRyeS52YWx1ZSArPSBkZWx0YTtcblxuICAgIH1cblxuICAgIHB1YmxpYyByZWdpc3RlckhpdHMoLi4ua2V5czogc3RyaW5nW10pIHtcblxuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVySGl0KGtleSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRoZSBoaXQgaW5kZXggYXMgYSBtYXAuXG4gICAgICovXG4gICAgcHVibGljIHRvTWFwKCk6IFJlYWRvbmx5PHtba2V5OiBzdHJpbmddOiBIaXRFbnRyeX0+IHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoey4uLnRoaXMuaW5kZXh9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9BcnJheSgpOiBSZWFkb25seUFycmF5PEhpdEVudHJ5PiB7XG4gICAgICAgIHJldHVybiBPYmplY3QuZnJlZXplKE9iamVjdC52YWx1ZXModGhpcy5pbmRleCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIG1hcCBvZiBrZXkgdG8gaGl0cyB3aXRob3V0IGFuIGVudHJ5IG9iamVjdC5cbiAgICAgKi9cbiAgICBwdWJsaWMgdG9MaXRlcmFsTWFwKCk6IExpdGVyYWxNYXAge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogTGl0ZXJhbE1hcCA9IHt9O1xuXG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHRoaXMuaW5kZXgpKSB7XG4gICAgICAgICAgICByZXN1bHRba2V5XSA9IHRoaXMuaW5kZXhba2V5XS52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIEhpdE1hcCBlbnRyaWVzIHJhbmtlZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgdG9SYW5rZWQoKTogUmVhZG9ubHlBcnJheTxIaXRFbnRyeT4ge1xuXG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMudG9NYXAoKSlcbiAgICAgICAgICAgIC5zb3J0KChhLCBiKSA9PiBiLnZhbHVlIC0gYS52YWx1ZSk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgdG9QZXJjUmFua2VkKHRvdGFsPzogbnVtYmVyKTogUmVhZG9ubHlBcnJheTxQZXJjUmFua2VkRW50cnk+IHtcblxuICAgICAgICBjb25zdCByYW5rZWQgPSB0aGlzLnRvUmFua2VkKCk7XG5cbiAgICAgICAgaWYgKHRvdGFsID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRvdGFsID0gT2JqZWN0LnZhbHVlcyhyYW5rZWQpXG4gICAgICAgICAgICAgICAgLm1hcChjdXJyZW50ID0+IGN1cnJlbnQudmFsdWUpXG4gICAgICAgICAgICAgICAgLnJlZHVjZShSZWR1Y2Vycy5TVU0sIDApO1xuXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaWR4ID0gMTtcbiAgICAgICAgcmV0dXJuIHJhbmtlZC5tYXAoY3VycmVudCA9PiB7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWR4OiBpZHgrKyxcbiAgICAgICAgICAgICAgICBrZXk6IGN1cnJlbnQua2V5LFxuICAgICAgICAgICAgICAgIGhpdHM6IGN1cnJlbnQudmFsdWUsXG4gICAgICAgICAgICAgICAgcGVyYzogTWF0aC5mbG9vcigoY3VycmVudC52YWx1ZSAvIHRvdGFsISkgICogMTAwKVxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9KTtcblxuICAgIH1cblxufVxuXG4vKipcbiAqIEEgSGl0TWFwIGltcGwgdGhhdCB1c2VzIGEgTXVsdGltYXAgdG8ga2VlcCB0aGUgdmFsdWVzIGFzIHdlbGwgZm9yIHJlcG9ydGluZy5cbiAqL1xuZXhwb3J0IGNsYXNzIFNhbXBsZWRIaXRNYXA8Vj4ge1xuXG4gICAgcHJpdmF0ZSBoaXRNYXAgPSBuZXcgSGl0TWFwKCk7XG5cbiAgICBwcml2YXRlIG11bHRpTWFwOiBNdWx0aW1hcDxzdHJpbmcsIFY+ID0gbmV3IEFycmF5TGlzdE11bHRpbWFwKCk7XG5cbiAgICBwdWJsaWMgcmVnaXN0ZXJIaXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBWKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaGl0TWFwLnJlZ2lzdGVySGl0KGtleSk7XG4gICAgICAgIHRoaXMubXVsdGlNYXAucHV0KGtleSwgdmFsdWUpO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbnJTYW1wbGVzIHRoZSBtYXggc2FtcGxlcyBwZXIgZW50cnkuXG4gICAgICogQHBhcmFtIHRvdGFsXG4gICAgICovXG4gICAgcHVibGljIHRvUGVyY1JhbmtlZChuclNhbXBsZXM6IG51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsPzogbnVtYmVyKTogUmVhZG9ubHlBcnJheTxTYW1wbGVkUGVyY1JhbmtlZEVudHJ5PFY+PiB7XG5cbiAgICAgICAgY29uc3QgcmFua2VkID0gdGhpcy5oaXRNYXAudG9SYW5rZWQoKTtcblxuICAgICAgICBpZiAodG90YWwgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdG90YWwgPSBPYmplY3QudmFsdWVzKHJhbmtlZClcbiAgICAgICAgICAgICAgICAubWFwKGN1cnJlbnQgPT4gY3VycmVudC52YWx1ZSlcbiAgICAgICAgICAgICAgICAucmVkdWNlKFJlZHVjZXJzLlNVTSwgMCk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpZHggPSAxO1xuICAgICAgICByZXR1cm4gcmFua2VkLm1hcChjdXJyZW50ID0+IHtcblxuICAgICAgICAgICAgY29uc3Qgc2FtcGxlcyA9XG4gICAgICAgICAgICAgICAgQXJyYXlzLmhlYWQoXG4gICAgICAgICAgICAgICAgICAgIEFycmF5cy5zaHVmZmxlKC4uLnRoaXMubXVsdGlNYXAuZ2V0KGN1cnJlbnQua2V5KSksIG5yU2FtcGxlcyk7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWR4OiBpZHgrKyxcbiAgICAgICAgICAgICAgICBrZXk6IGN1cnJlbnQua2V5LFxuICAgICAgICAgICAgICAgIGhpdHM6IGN1cnJlbnQudmFsdWUsXG4gICAgICAgICAgICAgICAgcGVyYzogTWF0aC5mbG9vcigoY3VycmVudC52YWx1ZSAvIHRvdGFsISkgICogMTAwKSxcbiAgICAgICAgICAgICAgICBzYW1wbGVzXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBIaXRFbnRyeSB7XG4gICAga2V5OiBzdHJpbmc7XG4gICAgdmFsdWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZXJjUmFua2VkRW50cnkge1xuICAgIHJlYWRvbmx5IGlkeDogbnVtYmVyO1xuICAgIHJlYWRvbmx5IGtleTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IGhpdHM6IG51bWJlcjtcbiAgICByZWFkb25seSBwZXJjOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2FtcGxlZFBlcmNSYW5rZWRFbnRyeTxWPiBleHRlbmRzIFBlcmNSYW5rZWRFbnRyeSB7XG4gICAgcmVhZG9ubHkgc2FtcGxlczogUmVhZG9ubHlBcnJheTxWPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMaXRlcmFsTWFwIHtcbiAgICBba2V5OiBzdHJpbmddOiBudW1iZXI7XG59XG5cbiJdfQ==