"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("../../../../logger/Logger");
const DocFormatFactory_1 = require("../../../../docformat/DocFormatFactory");
const Component_1 = require("../../../../components/Component");
const Functions_1 = require("../../../../util/Functions");
const Dimensions_1 = require("../../../../util/Dimensions");
const AreaHighlight_1 = require("../../../../metadata/AreaHighlight");
const AnnotationRects_1 = require("../../../../metadata/AnnotationRects");
const AreaHighlightRect_1 = require("../../../../metadata/AreaHighlightRect");
const AreaHighlightRects_1 = require("../../../../metadata/AreaHighlightRects");
const BoxController_1 = require("../../../../boxes/controller/BoxController");
const BoxOptions_1 = require("../../../../boxes/controller/BoxOptions");
const log = Logger_1.Logger.create();
class AreaHighlightComponent extends Component_1.Component {
    constructor() {
        super();
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
    }
    init(annotationEvent) {
        this.annotationEvent = annotationEvent;
        this.areaHighlight = annotationEvent.value;
        this.boxController = new BoxController_1.BoxController(boxMoveEvent => this.onBoxMoved(boxMoveEvent));
    }
    onBoxMoved(boxMoveEvent) {
        const annotationRect = AnnotationRects_1.AnnotationRects.createFromPositionedRect(boxMoveEvent.boxRect, boxMoveEvent.restrictionRect);
        const areaHighlightRect = new AreaHighlightRect_1.AreaHighlightRect(annotationRect);
        if (boxMoveEvent.state === "completed") {
            const annotationEvent = this.annotationEvent;
            this.areaHighlight = new AreaHighlight_1.AreaHighlight(this.areaHighlight);
            this.areaHighlight.rects["0"] = areaHighlightRect;
            log.debug("New areaHighlight: ", JSON.stringify(this.areaHighlight, null, "  "));
            delete annotationEvent.pageMeta.areaHighlights[this.areaHighlight.id];
            annotationEvent.pageMeta.areaHighlights[this.areaHighlight.id] = this.areaHighlight;
        }
        else {
        }
    }
    render() {
        this.destroy();
        const annotationEvent = this.annotationEvent;
        const areaHighlight = this.areaHighlight;
        const boxController = this.boxController;
        log.debug("render()");
        const docMeta = annotationEvent.docMeta;
        const pageMeta = annotationEvent.pageMeta;
        const docInfo = docMeta.docInfo;
        const pageElement = this.docFormat.getPageElementFromPageNum(pageMeta.pageInfo.num);
        const dimensionsElement = pageElement.querySelector(".canvasWrapper, .iframeWrapper");
        const containerElement = pageElement;
        const pageDimensions = new Dimensions_1.Dimensions({
            width: dimensionsElement.clientWidth,
            height: dimensionsElement.clientHeight
        });
        Functions_1.forDict(areaHighlight.rects, (key, rect) => {
            const areaHighlightRect = AreaHighlightRects_1.AreaHighlightRects.createFromRect(rect);
            const overlayRect = areaHighlightRect.toDimensions(pageDimensions);
            log.debug("Rendering annotation at: " + JSON.stringify(overlayRect, null, "  "));
            const id = this.createID();
            let highlightElement = document.getElementById(id);
            if (highlightElement === null) {
                highlightElement = document.createElement("div");
                highlightElement.setAttribute("id", id);
                containerElement.insertBefore(highlightElement, containerElement.firstChild);
                log.debug("Creating box controller for highlightElement: ", highlightElement);
                boxController.register(new BoxOptions_1.BoxOptions({
                    target: highlightElement,
                    restrictionElement: dimensionsElement,
                    intersectedElementsSelector: ".area-highlight"
                }));
            }
            highlightElement.setAttribute("data-type", "area-highlight");
            highlightElement.setAttribute("data-doc-fingerprint", docInfo.fingerprint);
            highlightElement.setAttribute("data-area-highlight-id", areaHighlight.id);
            highlightElement.setAttribute("data-annotation-id", areaHighlight.id);
            highlightElement.setAttribute("data-page-num", `${pageMeta.pageInfo.num}`);
            highlightElement.setAttribute("data-annotation-type", "area-highlight");
            highlightElement.setAttribute("data-annotation-id", areaHighlight.id);
            highlightElement.setAttribute("data-annotation-page-num", `${pageMeta.pageInfo.num}`);
            highlightElement.setAttribute("data-annotation-doc-fingerprint", docInfo.fingerprint);
            highlightElement.className = `area-highlight annotation area-highlight-${areaHighlight.id}`;
            highlightElement.style.position = "absolute";
            highlightElement.style.backgroundColor = `yellow`;
            highlightElement.style.opacity = `0.5`;
            highlightElement.style.left = `${overlayRect.left}px`;
            highlightElement.style.top = `${overlayRect.top}px`;
            highlightElement.style.width = `${overlayRect.width}px`;
            highlightElement.style.height = `${overlayRect.height}px`;
            highlightElement.style.border = `1px solid #c6c6c6`;
            highlightElement.style.zIndex = '1';
        });
    }
    createID() {
        return `area-highlight-${this.areaHighlight.id}`;
    }
    destroy() {
        const selector = `.area-highlight-${this.areaHighlight.id}`;
        const elements = document.querySelectorAll(selector);
        log.debug(`Found N elements for selector ${selector}: ` + elements.length);
        elements.forEach(highlightElement => {
            highlightElement.parentElement.removeChild(highlightElement);
        });
    }
}
exports.AreaHighlightComponent = AreaHighlightComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJlYUhpZ2hsaWdodENvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFyZWFIaWdobGlnaHRDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzREFBaUQ7QUFFakQsNkVBQXdFO0FBQ3hFLGdFQUEyRDtBQUMzRCwwREFBbUQ7QUFFbkQsNERBQXVEO0FBQ3ZELHNFQUFpRTtBQUdqRSwwRUFBcUU7QUFDckUsOEVBQXlFO0FBQ3pFLGdGQUEyRTtBQUMzRSw4RUFBeUU7QUFDekUsd0VBQW1FO0FBS25FLE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFhLHNCQUF1QixTQUFRLHFCQUFTO0lBUWpEO1FBQ0ksS0FBSyxFQUFFLENBQUM7UUFFUixJQUFJLENBQUMsU0FBUyxHQUFHLG1DQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXBELENBQUM7SUFLTSxJQUFJLENBQUMsZUFBZ0M7UUFJeEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDO1FBRTNDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSw2QkFBYSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBRTFGLENBQUM7SUFLTyxVQUFVLENBQUMsWUFBMEI7UUFTekMsTUFBTSxjQUFjLEdBQUcsaUNBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUN0QixZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFNUYsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLHFDQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBS2hFLElBQUksWUFBWSxDQUFDLEtBQUssS0FBSyxXQUFXLEVBQUU7WUFFcEMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWdCLENBQUM7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LEdBQUcsV0FBVyxDQUFDLElBQUksSUFBSSxDQUFDO1lBQ3RELGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7WUFFcEQsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxHQUFHLFdBQVcsQ0FBQyxLQUFLLElBQUksQ0FBQztZQUN4RCxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDO1lBRTFELGdCQUFnQixDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsbUJBQW1CLENBQUM7WUFFcEQsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7UUFFeEMsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBS08sUUFBUTtRQUNaLE9BQU8sa0JBQWtCLElBQUksQ0FBQyxhQUFjLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDdEQsQ0FBQztJQUtNLE9BQU87UUFFVixNQUFNLFFBQVEsR0FBRyxtQkFBbUIsSUFBSSxDQUFDLGFBQWMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3RCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFckQsR0FBRyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsUUFBUSxJQUFJLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTNFLFFBQVEsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUNoQyxnQkFBZ0IsQ0FBQyxhQUFjLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbEUsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0NBRUo7QUFoTUQsd0RBZ01DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMb2dnZXJ9IGZyb20gXCIuLi8uLi8uLi8uLi9sb2dnZXIvTG9nZ2VyXCI7XG5cbmltcG9ydCB7RG9jRm9ybWF0RmFjdG9yeX0gZnJvbSBcIi4uLy4uLy4uLy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5XCI7XG5pbXBvcnQge0NvbXBvbmVudH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBvbmVudHMvQ29tcG9uZW50XCI7XG5pbXBvcnQge2ZvckRpY3R9IGZyb20gXCIuLi8uLi8uLi8uLi91dGlsL0Z1bmN0aW9uc1wiO1xuaW1wb3J0IHtSZWN0c30gZnJvbSBcIi4uLy4uLy4uLy4uL1JlY3RzXCI7XG5pbXBvcnQge0RpbWVuc2lvbnN9IGZyb20gXCIuLi8uLi8uLi8uLi91dGlsL0RpbWVuc2lvbnNcIjtcbmltcG9ydCB7QXJlYUhpZ2hsaWdodH0gZnJvbSBcIi4uLy4uLy4uLy4uL21ldGFkYXRhL0FyZWFIaWdobGlnaHRcIjtcbmltcG9ydCB7QXJlYUhpZ2hsaWdodHN9IGZyb20gXCIuLi8uLi8uLi8uLi9tZXRhZGF0YS9BcmVhSGlnaGxpZ2h0c1wiO1xuaW1wb3J0IHtBbm5vdGF0aW9uUmVjdH0gZnJvbSBcIi4uLy4uLy4uLy4uL21ldGFkYXRhL0Fubm90YXRpb25SZWN0XCI7XG5pbXBvcnQge0Fubm90YXRpb25SZWN0c30gZnJvbSBcIi4uLy4uLy4uLy4uL21ldGFkYXRhL0Fubm90YXRpb25SZWN0c1wiO1xuaW1wb3J0IHtBcmVhSGlnaGxpZ2h0UmVjdH0gZnJvbSBcIi4uLy4uLy4uLy4uL21ldGFkYXRhL0FyZWFIaWdobGlnaHRSZWN0XCI7XG5pbXBvcnQge0FyZWFIaWdobGlnaHRSZWN0c30gZnJvbSBcIi4uLy4uLy4uLy4uL21ldGFkYXRhL0FyZWFIaWdobGlnaHRSZWN0c1wiO1xuaW1wb3J0IHtCb3hDb250cm9sbGVyfSBmcm9tIFwiLi4vLi4vLi4vLi4vYm94ZXMvY29udHJvbGxlci9Cb3hDb250cm9sbGVyXCI7XG5pbXBvcnQge0JveE9wdGlvbnN9IGZyb20gXCIuLi8uLi8uLi8uLi9ib3hlcy9jb250cm9sbGVyL0JveE9wdGlvbnNcIjtcbmltcG9ydCB7RG9jRm9ybWF0fSBmcm9tIFwiLi4vLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdFwiO1xuaW1wb3J0IHtBbm5vdGF0aW9uRXZlbnR9IGZyb20gJy4uLy4uLy4uLy4uL2Fubm90YXRpb25zL2NvbXBvbmVudHMvQW5ub3RhdGlvbkV2ZW50JztcbmltcG9ydCB7Qm94TW92ZUV2ZW50fSBmcm9tICcuLi8uLi8uLi8uLi9ib3hlcy9jb250cm9sbGVyL0JveE1vdmVFdmVudCc7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuZXhwb3J0IGNsYXNzIEFyZWFIaWdobGlnaHRDb21wb25lbnQgZXh0ZW5kcyBDb21wb25lbnQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBkb2NGb3JtYXQ6IERvY0Zvcm1hdDtcblxuICAgIHByaXZhdGUgYW5ub3RhdGlvbkV2ZW50PzogQW5ub3RhdGlvbkV2ZW50O1xuICAgIHByaXZhdGUgYXJlYUhpZ2hsaWdodD86IEFyZWFIaWdobGlnaHQ7XG4gICAgcHJpdmF0ZSBib3hDb250cm9sbGVyPzogQm94Q29udHJvbGxlcjtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQE92ZXJyaWRlXG4gICAgICovXG4gICAgcHVibGljIGluaXQoYW5ub3RhdGlvbkV2ZW50OiBBbm5vdGF0aW9uRXZlbnQpIHtcblxuICAgICAgICAvLyBUT0RPOiB3ZSBzaG91bGQgYSBzcGVjaWZpYyBldmVudCBjbGFzcyBmb3IgdGhpcyBkYXRhIHdoaWNoIGlzXG4gICAgICAgIC8vIGNhcHR1cmVkIHdpdGhpbiBhIGhpZ2hlciBsZXZlbCBhbm5vdGF0aW9uRXZlbnQuXG4gICAgICAgIHRoaXMuYW5ub3RhdGlvbkV2ZW50ID0gYW5ub3RhdGlvbkV2ZW50O1xuICAgICAgICB0aGlzLmFyZWFIaWdobGlnaHQgPSBhbm5vdGF0aW9uRXZlbnQudmFsdWU7XG5cbiAgICAgICAgdGhpcy5ib3hDb250cm9sbGVyID0gbmV3IEJveENvbnRyb2xsZXIoYm94TW92ZUV2ZW50ID0+IHRoaXMub25Cb3hNb3ZlZChib3hNb3ZlRXZlbnQpKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgcHJpdmF0ZSBvbkJveE1vdmVkKGJveE1vdmVFdmVudDogQm94TW92ZUV2ZW50KSB7XG5cbiAgICAgICAgLy8gVE9ETzogYWN0dWFsbHkgSSB0aGluayB0aGlzIGJlbG9uZ3MgaW4gdGhlIGNvbnRyb2xsZXIuLi4gbm90IHRoZSB2aWV3XG5cbiAgICAgICAgLy8gVE9ETzogcmVmYWN0b3IgLyB0aGlzIGNvZGUgaXMgc2hhcmVkIHdpdGggdGhlXG4gICAgICAgIC8vIEFic3RyYWN0UGFnZW1hcmtDb21wb25lbnRcblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkJveCBtb3ZlZCB0bzogXCIsIGJveE1vdmVFdmVudCk7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvblJlY3QgPSBBbm5vdGF0aW9uUmVjdHMuY3JlYXRlRnJvbVBvc2l0aW9uZWRSZWN0KGJveE1vdmVFdmVudC5ib3hSZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJveE1vdmVFdmVudC5yZXN0cmljdGlvblJlY3QpO1xuXG4gICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHRSZWN0ID0gbmV3IEFyZWFIaWdobGlnaHRSZWN0KGFubm90YXRpb25SZWN0KTtcblxuICAgICAgICAvLyBGSVhNRTogdGhlIGxhc3RVcGRhdGVkIGhlcmUgaXNuJ3QgYmVpbmcgdXBkYXRlZC4gSSdtIGdvaW5nIHRvXG4gICAgICAgIC8vIGhhdmUgdG8gY2hhbmdlIHRoZSBzZXR0ZXJzIEkgdGhpbmsuLlxuXG4gICAgICAgIGlmIChib3hNb3ZlRXZlbnQuc3RhdGUgPT09IFwiY29tcGxldGVkXCIpIHtcblxuICAgICAgICAgICAgY29uc3QgYW5ub3RhdGlvbkV2ZW50ID0gdGhpcy5hbm5vdGF0aW9uRXZlbnQhO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzbid0IGhhbmRsZWQgcHJvcGVybHkgYmVjYXVzZSB3ZSBjcmVhdGUgYSBORVcgcmVjdFxuICAgICAgICAgICAgLy8gd2l0aCB0aGUgZXhpc3RpbmcgdmFsdWVzLi4uXG5cbiAgICAgICAgICAgIHRoaXMuYXJlYUhpZ2hsaWdodCA9IG5ldyBBcmVhSGlnaGxpZ2h0KHRoaXMuYXJlYUhpZ2hsaWdodCk7XG4gICAgICAgICAgICB0aGlzLmFyZWFIaWdobGlnaHQucmVjdHNbXCIwXCJdID0gPGFueT4gYXJlYUhpZ2hsaWdodFJlY3Q7XG5cbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIk5ldyBhcmVhSGlnaGxpZ2h0OiBcIiwgSlNPTi5zdHJpbmdpZnkodGhpcy5hcmVhSGlnaGxpZ2h0LCBudWxsLCBcIiAgXCIpKTtcblxuICAgICAgICAgICAgZGVsZXRlIGFubm90YXRpb25FdmVudC5wYWdlTWV0YS5hcmVhSGlnaGxpZ2h0c1t0aGlzLmFyZWFIaWdobGlnaHQuaWRdO1xuICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnBhZ2VNZXRhLmFyZWFIaWdobGlnaHRzW3RoaXMuYXJlYUhpZ2hsaWdodC5pZF0gPSB0aGlzLmFyZWFIaWdobGlnaHQ7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIG5vb3BcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQE92ZXJyaWRlXG4gICAgICovXG4gICAgcHVibGljIHJlbmRlcigpIHtcblxuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcblxuICAgICAgICBjb25zdCBhbm5vdGF0aW9uRXZlbnQgPSB0aGlzLmFubm90YXRpb25FdmVudCE7XG4gICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHQgPSB0aGlzLmFyZWFIaWdobGlnaHQhO1xuICAgICAgICBjb25zdCBib3hDb250cm9sbGVyID0gdGhpcy5ib3hDb250cm9sbGVyITtcblxuICAgICAgICBsb2cuZGVidWcoXCJyZW5kZXIoKVwiKTtcblxuICAgICAgICBjb25zdCBkb2NNZXRhID0gYW5ub3RhdGlvbkV2ZW50LmRvY01ldGE7XG4gICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gYW5ub3RhdGlvbkV2ZW50LnBhZ2VNZXRhO1xuICAgICAgICBjb25zdCBkb2NJbmZvID0gZG9jTWV0YS5kb2NJbmZvO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VFbGVtZW50ID0gdGhpcy5kb2NGb3JtYXQuZ2V0UGFnZUVsZW1lbnRGcm9tUGFnZU51bShwYWdlTWV0YS5wYWdlSW5mby5udW0pO1xuICAgICAgICBjb25zdCBkaW1lbnNpb25zRWxlbWVudCA9IHBhZ2VFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuY2FudmFzV3JhcHBlciwgLmlmcmFtZVdyYXBwZXJcIikhO1xuXG4gICAgICAgIC8vIHRoZSBjb250YWluZXIgbXVzdCBBTFdBWVMgYmUgdGhlIHBhZ2VFbGVtZW50IGJlY2F1c2UgaWYgd2UgdXNlIGFueVxuICAgICAgICAvLyBvdGhlciBjb250YWluZXIgUERGLmpzIGJyZWFrcy5cbiAgICAgICAgY29uc3QgY29udGFpbmVyRWxlbWVudCA9IHBhZ2VFbGVtZW50O1xuXG4gICAgICAgIGNvbnN0IHBhZ2VEaW1lbnNpb25zID0gbmV3IERpbWVuc2lvbnMoe1xuICAgICAgICAgICAgd2lkdGg6IGRpbWVuc2lvbnNFbGVtZW50LmNsaWVudFdpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBkaW1lbnNpb25zRWxlbWVudC5jbGllbnRIZWlnaHRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZm9yRGljdChhcmVhSGlnaGxpZ2h0LnJlY3RzLCAoa2V5LCByZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHRSZWN0ID0gQXJlYUhpZ2hsaWdodFJlY3RzLmNyZWF0ZUZyb21SZWN0KHJlY3QpO1xuXG4gICAgICAgICAgICBjb25zdCBvdmVybGF5UmVjdCA9IGFyZWFIaWdobGlnaHRSZWN0LnRvRGltZW5zaW9ucyhwYWdlRGltZW5zaW9ucyk7XG5cbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIlJlbmRlcmluZyBhbm5vdGF0aW9uIGF0OiBcIiArIEpTT04uc3RyaW5naWZ5KG92ZXJsYXlSZWN0LCBudWxsLCBcIiAgXCIpKTtcblxuICAgICAgICAgICAgY29uc3QgaWQgPSB0aGlzLmNyZWF0ZUlEKCk7XG5cbiAgICAgICAgICAgIGxldCBoaWdobGlnaHRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xuXG4gICAgICAgICAgICBpZiAoaGlnaGxpZ2h0RWxlbWVudCA9PT0gbnVsbCApIHtcblxuICAgICAgICAgICAgICAgIC8vIG9ubHkgY3JlYXRlIHRoZSBwYWdlbWFyayBpZiBpdCdzIG1pc3NpbmcuXG4gICAgICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJpZFwiLCBpZCk7XG5cbiAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtZW50Lmluc2VydEJlZm9yZShoaWdobGlnaHRFbGVtZW50LCBjb250YWluZXJFbGVtZW50LmZpcnN0Q2hpbGQpO1xuXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKFwiQ3JlYXRpbmcgYm94IGNvbnRyb2xsZXIgZm9yIGhpZ2hsaWdodEVsZW1lbnQ6IFwiLCBoaWdobGlnaHRFbGVtZW50KTtcblxuICAgICAgICAgICAgICAgIGJveENvbnRyb2xsZXIucmVnaXN0ZXIobmV3IEJveE9wdGlvbnMoe1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IGhpZ2hsaWdodEVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgIHJlc3RyaWN0aW9uRWxlbWVudDogZGltZW5zaW9uc0VsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdGVkRWxlbWVudHNTZWxlY3RvcjogXCIuYXJlYS1oaWdobGlnaHRcIlxuICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBhIGxvdCBvZiB0aGlzIGNvZGUgaXMgc2hhcmVkIHdpdGggcGFnZW1hcmtzLlxuXG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtdHlwZVwiLCBcImFyZWEtaGlnaGxpZ2h0XCIpO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWRvYy1maW5nZXJwcmludFwiLCBkb2NJbmZvLmZpbmdlcnByaW50KTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hcmVhLWhpZ2hsaWdodC1pZFwiLCBhcmVhSGlnaGxpZ2h0LmlkKTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLWlkXCIsIGFyZWFIaWdobGlnaHQuaWQpO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLXBhZ2UtbnVtXCIsIGAke3BhZ2VNZXRhLnBhZ2VJbmZvLm51bX1gKTtcblxuICAgICAgICAgICAgLy8gYW5ub3RhdGlvbiBkZXNjcmlwdG9yIG1ldGFkYXRhLlxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24tdHlwZVwiLCBcImFyZWEtaGlnaGxpZ2h0XCIpO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24taWRcIiwgYXJlYUhpZ2hsaWdodC5pZCk7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtYW5ub3RhdGlvbi1wYWdlLW51bVwiLCBgJHtwYWdlTWV0YS5wYWdlSW5mby5udW19YCk7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtYW5ub3RhdGlvbi1kb2MtZmluZ2VycHJpbnRcIiwgZG9jSW5mby5maW5nZXJwcmludCk7XG5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuY2xhc3NOYW1lID0gYGFyZWEtaGlnaGxpZ2h0IGFubm90YXRpb24gYXJlYS1oaWdobGlnaHQtJHthcmVhSGlnaGxpZ2h0LmlkfWA7XG5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGB5ZWxsb3dgO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gYDAuNWA7XG5cbiAgICAgICAgICAgIC8vIGlmKHRoaXMuZG9jRm9ybWF0Lm5hbWUgPT09IFwicGRmXCIpIHtcbiAgICAgICAgICAgIC8vICAgICAvLyB0aGlzIGlzIG9ubHkgbmVlZGVkIGZvciBQREYgYW5kIHdlIG1pZ2h0IGJlIGFibGUgdG8gdXNlIGFcbiAgICAgICAgICAgIC8vIHRyYW5zZm9ybSAvLyBpbiB0aGUgZnV0dXJlIHdoaWNoIHdvdWxkIGJlIGVhc2llci4gbGV0XG4gICAgICAgICAgICAvLyBjdXJyZW50U2NhbGUgPSB0aGlzLmRvY0Zvcm1hdC5jdXJyZW50U2NhbGUoKTsgb3ZlcmxheVJlY3QgPVxuICAgICAgICAgICAgLy8gUmVjdHMuc2NhbGUob3ZlcmxheVJlY3QsIGN1cnJlbnRTY2FsZSk7IH1cblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zdHlsZS5sZWZ0ID0gYCR7b3ZlcmxheVJlY3QubGVmdH1weGA7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLnRvcCA9IGAke292ZXJsYXlSZWN0LnRvcH1weGA7XG5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc3R5bGUud2lkdGggPSBgJHtvdmVybGF5UmVjdC53aWR0aH1weGA7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke292ZXJsYXlSZWN0LmhlaWdodH1weGA7XG5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc3R5bGUuYm9yZGVyID0gYDFweCBzb2xpZCAjYzZjNmM2YDtcblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zdHlsZS56SW5kZXggPSAnMSc7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSB1bmlxdWUgRE9NIElEIGZvciB0aGlzIHBhZ2VtYXJrLlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlSUQoKSB7XG4gICAgICAgIHJldHVybiBgYXJlYS1oaWdobGlnaHQtJHt0aGlzLmFyZWFIaWdobGlnaHQhLmlkfWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQE92ZXJyaWRlXG4gICAgICovXG4gICAgcHVibGljIGRlc3Ryb3koKSB7XG5cbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBgLmFyZWEtaGlnaGxpZ2h0LSR7dGhpcy5hcmVhSGlnaGxpZ2h0IS5pZH1gO1xuICAgICAgICBjb25zdCBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpO1xuXG4gICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgTiBlbGVtZW50cyBmb3Igc2VsZWN0b3IgJHtzZWxlY3Rvcn06IGAgKyBlbGVtZW50cy5sZW5ndGgpO1xuXG4gICAgICAgIGVsZW1lbnRzLmZvckVhY2goaGlnaGxpZ2h0RWxlbWVudCA9PiB7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnBhcmVudEVsZW1lbnQhLnJlbW92ZUNoaWxkKGhpZ2hsaWdodEVsZW1lbnQpO1xuICAgICAgICB9KTtcblxuICAgIH1cblxufVxuIl19