"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("../logger/Logger");
const BaseWebRequestsListener_1 = require("./BaseWebRequestsListener");
const RequestState_1 = require("./RequestState");
const ProgressCalculator_1 = require("../util/ProgressCalculator");
const log = Logger_1.Logger.create();
class PendingWebRequestsListener extends BaseWebRequestsListener_1.BaseWebRequestsListener {
    constructor() {
        super();
        this.pendingRequests = {};
        this.eventListeners = [];
        this.requestState = new RequestState_1.RequestState();
        this.startedRequests = {};
        this.finishedRequests = {};
    }
    onWebRequestEvent(event) {
        setTimeout(() => {
            this.processWebRequestEvent(event);
        }, 0);
    }
    processWebRequestEvent(event) {
        const { name, details, callback } = event;
        let pendingChange = null;
        if (name === "onBeforeRequest") {
            this.pendingRequests[details.id] = details;
            this.startedRequests[details.id] = {
                event: name,
                id: details.id,
                url: details.url
            };
            pendingChange = "INCREMENTED";
            this.requestState.markStarted(details.id, details.url, name);
        }
        if (name === "onCompleted" ||
            name === "onErrorOccurred" ||
            name === "onBeforeRedirect" ||
            name === "onAuthRequired") {
            delete this.pendingRequests[details.id];
            this.finishedRequests[details.id] = {
                event: name,
                id: details.id,
                url: details.url
            };
            pendingChange = "DECREMENTED";
            this.requestState.markFinished(details.id, details.url, name);
        }
        const started = Object.keys(this.startedRequests).length;
        const finished = Object.keys(this.finishedRequests).length;
        const pending = started - finished;
        if (pendingChange) {
            log.info(`Pending state ${pendingChange} for request id=${details.id} to ${pending} on ${name} for URL: ${details.url}`);
        }
        const progress = ProgressCalculator_1.ProgressCalculator.calculate(finished, started);
        if (pending < 5) {
            log.debug("The following pending requests remain: \n", this.pendingRequests);
        }
        if (pending < 0) {
            const msg = `Pending request count is negative: ${pending} (started=${started}, finished=${finished})`;
            log.warn(msg);
        }
        log.debug(`Pending requests on ${name}: `, {
            pending,
            started,
            finished,
            progress
        });
        this.dispatchEventListeners({
            name,
            details,
            pending,
            started,
            finished,
            progress
        });
        if (callback) {
            callback({ cancel: false });
        }
    }
    addEventListener(eventListener) {
        this.eventListeners.push(eventListener);
    }
    dispatchEventListeners(event) {
        this.eventListeners.forEach(eventListener => {
            eventListener(event);
        });
    }
}
exports.PendingWebRequestsListener = PendingWebRequestsListener;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVuZGluZ1dlYlJlcXVlc3RzTGlzdGVuZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQZW5kaW5nV2ViUmVxdWVzdHNMaXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZDQUF3QztBQUN4Qyx1RUFBa0U7QUFDbEUsaURBQTRDO0FBQzVDLG1FQUE4RDtBQUU5RCxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFNNUIsTUFBYSwwQkFBMkIsU0FBUSxpREFBdUI7SUFxQm5FO1FBRUksS0FBSyxFQUFFLENBQUM7UUFsQkosb0JBQWUsR0FBd0IsRUFBRSxDQUFDO1FBSzFDLG1CQUFjLEdBQWlDLEVBQUUsQ0FBQztRQUtsRCxpQkFBWSxHQUFHLElBQUksMkJBQVksRUFBRSxDQUFDO1FBRWxDLG9CQUFlLEdBQXdCLEVBQUUsQ0FBQztRQUUxQyxxQkFBZ0IsR0FBd0IsRUFBRSxDQUFDO0lBT25ELENBQUM7SUFNTSxpQkFBaUIsQ0FBQyxLQUE0QjtRQUVqRCxVQUFVLENBQUMsR0FBRyxFQUFFO1lBRVosSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXZDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVWLENBQUM7SUFFTSxzQkFBc0IsQ0FBQyxLQUE0QjtRQUl0RCxNQUFNLEVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUMsR0FBRyxLQUFLLENBQUM7UUFzQnhDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQztRQVN6QixJQUFJLElBQUksS0FBSyxpQkFBaUIsRUFBRTtZQUc1QixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUM7WUFFM0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUc7Z0JBRS9CLEtBQUssRUFBRSxJQUFJO2dCQUNYLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtn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ZXN0RXZlbnQsIElXZWJSZXF1ZXN0RGV0YWlsc30gZnJvbSAnLi9XZWJSZXF1ZXN0UmVhY3Rvcic7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAnLi4vbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge0Jhc2VXZWJSZXF1ZXN0c0xpc3RlbmVyfSBmcm9tICcuL0Jhc2VXZWJSZXF1ZXN0c0xpc3RlbmVyJztcbmltcG9ydCB7UmVxdWVzdFN0YXRlfSBmcm9tICcuL1JlcXVlc3RTdGF0ZSc7XG5pbXBvcnQge1Byb2dyZXNzQ2FsY3VsYXRvcn0gZnJvbSAnLi4vdXRpbC9Qcm9ncmVzc0NhbGN1bGF0b3InO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbi8qKlxuICogVHJhY2tzIHRoZSBudW1iZXIgb2YgcGVuZGluZyByZXF1ZXN0cy5cbiAqXG4gKi9cbmV4cG9ydCBjbGFzcyBQZW5kaW5nV2ViUmVxdWVzdHNMaXN0ZW5lciBleHRlbmRzIEJhc2VXZWJSZXF1ZXN0c0xpc3RlbmVyIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBhY3R1YWwgZXZlbnRzIHdlJ3ZlIHNlZW4gZm9yIHRyYWNraW5nIHB1cnBvc2VzLlxuICAgICAqL1xuICAgIHByaXZhdGUgcGVuZGluZ1JlcXVlc3RzOiB7W2lkOiBudW1iZXJdOiBhbnl9ID0ge307XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlcmVkIGV2ZW50IGxpc3RlbmVycyB0aGF0IHdlIHdvdWxkIG5lZWQgdG8gZGlzcGF0Y2guXG4gICAgICovXG4gICAgcHJpdmF0ZSBldmVudExpc3RlbmVyczogUGVuZGluZ1dlYlJlcXVlc3RzQ2FsbGJhY2tbXSA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogS2VlcHMgdHJhY2sgb2YgbWV0YWRhdGEgZm9yIGVhY2ggcmVxdWVzdCB0byBoZWxwIGRldGVjdCBlcnJvcnMuXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXF1ZXN0U3RhdGUgPSBuZXcgUmVxdWVzdFN0YXRlKCk7XG5cbiAgICBwcml2YXRlIHN0YXJ0ZWRSZXF1ZXN0czoge1tpZDogbnVtYmVyXTogYW55fSA9IHt9O1xuXG4gICAgcHJpdmF0ZSBmaW5pc2hlZFJlcXVlc3RzOiB7W2lkOiBudW1iZXJdOiBhbnl9ID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcblxuICAgICAgICBzdXBlcigpO1xuXG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsZWQgd2hlbiB3ZSByZWNlaXZlIGFuIGV2ZW50LiAgQWxsIHRoZSBldmVudHMgZ2l2ZSB1cyBhICdkZXRhaWxzJ1xuICAgICAqIG9iamVjdCBhYm91dCB0aGUgcmVxdWVzdC5cbiAgICAgKi9cbiAgICBwdWJsaWMgb25XZWJSZXF1ZXN0RXZlbnQoZXZlbnQ6IElOYW1lZFdlYlJlcXVlc3RFdmVudCkge1xuXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NXZWJSZXF1ZXN0RXZlbnQoZXZlbnQpO1xuXG4gICAgICAgIH0sIDApO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHByb2Nlc3NXZWJSZXF1ZXN0RXZlbnQoZXZlbnQ6IElOYW1lZFdlYlJlcXVlc3RFdmVudCkge1xuXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBldmVudCBkYXRhOiAke2V2ZW50Lm5hbWV9XFx0JHtldmVudC5kZXRhaWxzLmlkfVxcdCR7ZXZlbnQuZGV0YWlscy51cmx9XFx0JHtldmVudC5kZXRhaWxzLnJlc291cmNlVHlwZX1cXHQke2V2ZW50LmRldGFpbHMud2ViQ29udGVudHNJZH1gKTtcblxuICAgICAgICBjb25zdCB7bmFtZSwgZGV0YWlscywgY2FsbGJhY2t9ID0gZXZlbnQ7XG5cbiAgICAgICAgLy8gV0FSTklORzogdGhpcyBjb2RlIGJlaGF2ZXMgVkVSWSBzdHJhbmdlbHkgYW5kIHdlIERPIE5PVCByZWNlaXZlIGV2ZW50c1xuICAgICAgICAvLyBpbiB0aGUgcHJvcGVyIG9yZGVyIGZvciBzb21lIHJlYXNvbi4gIEkgd291bGQgZXhwZWN0IHRvIHJlY2VpdmUgdGhlbVxuICAgICAgICAvLyBpbiB0aGUgbG9naWNhbCBvcmRlciBkZXRhaWxlZCBoZXJlOlxuICAgICAgICAvL1xuICAgICAgICAvLyBodHRwczovL2RldmVsb3Blci5jaHJvbWUuY29tL2V4dGVuc2lvbnMvd2ViUmVxdWVzdFxuICAgICAgICAvL1xuICAgICAgICAvLyBidXQgd2UgYWN0dWFsbHkgcmVjZWl2ZSB0aGVtIG91dCBvZiBvcmRlci5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHRoZSBwZW5kaW5nIHJlcXVlc3QgY291bnQgY2FuIGdvIHRvIG5lZ2F0aXZlIHVudGlsXG4gICAgICAgIC8vIGl0IGdvZXMgcG9zaXRpdmUuIEkgc3VzcGVjdCB0aGF0IHRoZXkncmUgdXNpbmcgc29tZSBzb3J0IG9mIG11bHRpLWNvcmVcbiAgICAgICAgLy8gb3IgdW5mYWlyIHF1ZXVlIHN5c3RlbSB0aGF0IHJlLW9yZGVycyB0aGUgZXZlbnRzIGJlZm9yZSBJIHNlZSBpdCBvclxuICAgICAgICAvLyB0aGlzIGNvZGUgaXMgZXhlY3V0aW5nIGFjcm9zcyBtdWx0aXBsZSB0aHJlYWRzIG9uIG11bHRpcGxlIGNvcmVzIGFuZFxuICAgICAgICAvLyB0aGUgZGF0YSBpcyBiZWluZyBoYW5kbGVkIGJhbGFuY2VkIGFjcm9zcyBjb3JlcyB3aGljaCBpcyB3aHkgd2Ugc2VlXG4gICAgICAgIC8vIG9yZGVyaW5nIGlzc3Vlcy5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gSSd2ZSBhZGRlZCBzb21lIGxvZ2dpbmcgdG8gdGhlIGNvZGUgc28gd2UgY2FuIHRyYWNlIHRoaXMgYnV0IGl0J3NcbiAgICAgICAgLy8gcmF0aGVyIGRpZmZpY3VsdCB0byBkZWFsIHdpdGggYmVjYXVzZSBhIHJlYWwgYnV0IGNvdWxkIGhhcHBlblxuICAgICAgICAvLyBhcm91bmQgZHJvcHBlZCBtZXNzYWdlcyBidXQgd2Ugd291bGRuJ3Qgbm90aWNlIHRoYXQgd2hlcmUgbmVnYXRpdmVcbiAgICAgICAgLy8gY291bnRzIGNvdWxkIGNhdGNoIGl0LlxuXG4gICAgICAgIGxldCBwZW5kaW5nQ2hhbmdlID0gbnVsbDtcblxuXG4gICAgICAgIC8vIFdBUk46IEkgZG9uJ3QgdGhpbmsgaW5jcmVtZW50ICsgZGVjcmVtZW50IHdvcmsgaGVyZSBhcyBJIHN1c3BlY3RcbiAgICAgICAgLy8gbXVsdGlwbGUgdGhyZWFkcyBhcmUgY2FsbGluZyB1cyBzbyB3ZSdyZSBoYXZpbmcgdG8ga2VlcCByZXF1ZXN0c1xuICAgICAgICAvLyBpbiBtYXBzIHdoaWNoIHdhc3RlcyBhIGJpdCBtb3JlIG1lbW9yeS4gSSBzdXNwZWN0IHdlIGhhdmUgb25lIHRocmVhZFxuICAgICAgICAvLyBwZXIgaWZyYW1lLiAgRWl0aGVyIHdheSB1c2luZyBkaWN0aW9uYXJpZXMgYXZvaWRlZCBhIC0xIHBlbmRpbmdcbiAgICAgICAgLy8gY291bnQuXG5cbiAgICAgICAgaWYgKG5hbWUgPT09IFwib25CZWZvcmVSZXF1ZXN0XCIpIHtcbiAgICAgICAgICAgIC8vIGFmdGVyIHRoaXMgcmVxdWVzdCB0aGUgcGVuZGluZyB3aWxsIGJlIGluY3JlbWVudGVkLlxuXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c1tkZXRhaWxzLmlkXSA9IGRldGFpbHM7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhcnRlZFJlcXVlc3RzW2RldGFpbHMuaWRdID0ge1xuICAgICAgICAgICAgICAgIC8vIHRoZSBldmVudCB1c2VkIHRvIG1hcmsgdGhlIHJlcXVlc3Qgc3RhcnRlZFxuICAgICAgICAgICAgICAgIGV2ZW50OiBuYW1lLFxuICAgICAgICAgICAgICAgIGlkOiBkZXRhaWxzLmlkLFxuICAgICAgICAgICAgICAgIHVybDogZGV0YWlscy51cmxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHBlbmRpbmdDaGFuZ2UgPSBcIklOQ1JFTUVOVEVEXCI7XG5cbiAgICAgICAgICAgIHRoaXMucmVxdWVzdFN0YXRlLm1hcmtTdGFydGVkKGRldGFpbHMuaWQsIGRldGFpbHMudXJsLCBuYW1lKTtcblxuICAgICAgICB9XG5cblxuICAgICAgICAvLyBOT1RFIG9uRXJyb3JPY2N1cnJlZCBpcyBhIGZhaWwgdGhyb3VnaCBmb3IgbWFueSBvZiB0aGVzZSBJIHRoaW5rLlxuICAgICAgICBpZiAobmFtZSA9PT0gXCJvbkNvbXBsZXRlZFwiIHx8XG4gICAgICAgICAgICBuYW1lID09PSBcIm9uRXJyb3JPY2N1cnJlZFwiIHx8XG4gICAgICAgICAgICBuYW1lID09PSBcIm9uQmVmb3JlUmVkaXJlY3RcIiB8fFxuICAgICAgICAgICAgbmFtZSA9PT0gXCJvbkF1dGhSZXF1aXJlZFwiKSB7XG5cbiAgICAgICAgICAgIC8vIHRoaXMgcmVxdWVzdCBoYXMgYWxyZWFkeSBjb21wbGV0ZWQgc28gaXMgbm90IGNvbnNpZGVyZWQgYWdhaW5zdFxuICAgICAgICAgICAgLy8gcGVuZGluZyBhbnkgbG9uZ2VyXG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnBlbmRpbmdSZXF1ZXN0c1tkZXRhaWxzLmlkXTtcblxuICAgICAgICAgICAgdGhpcy5maW5pc2hlZFJlcXVlc3RzW2RldGFpbHMuaWRdID0ge1xuICAgICAgICAgICAgICAgIC8vIHRoZSBuYW1lIG9mIHRoZSBldmVudCB0aGF0IHdlIHVzZWQgdG8gbWFyayBmaW5pc2hlZC5cbiAgICAgICAgICAgICAgICBldmVudDogbmFtZSxcbiAgICAgICAgICAgICAgICBpZDogZGV0YWlscy5pZCxcbiAgICAgICAgICAgICAgICB1cmw6IGRldGFpbHMudXJsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBwZW5kaW5nQ2hhbmdlID0gXCJERUNSRU1FTlRFRFwiO1xuXG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RTdGF0ZS5tYXJrRmluaXNoZWQoZGV0YWlscy5pZCwgZGV0YWlscy51cmwsIG5hbWUpO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIHRvdGFsIG51bWJlciBvZiByZXF1ZXN0cyB0aGF0IGhhdmUgYmVlbiBzdGFydGVkLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3Qgc3RhcnRlZCA9IE9iamVjdC5rZXlzKHRoaXMuc3RhcnRlZFJlcXVlc3RzKS5sZW5ndGg7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSB0b3RhbCBudW1iZXIgb2YgZmluaXNoZWQgcmVxdWVzdHMgKGVpdGhlciBjb21wbGV0ZWQsIG9yIGZhaWxlZClcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge251bWJlcn1cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IGZpbmlzaGVkID0gT2JqZWN0LmtleXModGhpcy5maW5pc2hlZFJlcXVlc3RzKS5sZW5ndGg7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBudW1iZXIgb2YgcGVuZGluZyByZXF1ZXN0cyB0aGF0IGhhdmUgbm90IHlldCBmaW5pc2hlZC5cbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge251bWJlcn1cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHBlbmRpbmcgPSBzdGFydGVkIC0gZmluaXNoZWQ7XG5cbiAgICAgICAgaWYgKHBlbmRpbmdDaGFuZ2UpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBQZW5kaW5nIHN0YXRlICR7cGVuZGluZ0NoYW5nZX0gZm9yIHJlcXVlc3QgaWQ9JHtkZXRhaWxzLmlkfSB0byAke3BlbmRpbmd9IG9uICR7bmFtZX0gZm9yIFVSTDogJHtkZXRhaWxzLnVybH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgY3VycmVudCBwcm9ncmVzcyBmb3IgdGhlIHBhZ2UgZnJvbSAwIHRvIDEwMC5cbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge251bWJlcn1cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gUHJvZ3Jlc3NDYWxjdWxhdG9yLmNhbGN1bGF0ZShmaW5pc2hlZCwgc3RhcnRlZCk7XG5cbiAgICAgICAgaWYgKHBlbmRpbmcgPCA1KSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoXCJUaGUgZm9sbG93aW5nIHBlbmRpbmcgcmVxdWVzdHMgcmVtYWluOiBcXG5cIiwgdGhpcy5wZW5kaW5nUmVxdWVzdHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBlbmRpbmcgPCAwKSB7XG4gICAgICAgICAgICBjb25zdCBtc2cgPSBgUGVuZGluZyByZXF1ZXN0IGNvdW50IGlzIG5lZ2F0aXZlOiAke3BlbmRpbmd9IChzdGFydGVkPSR7c3RhcnRlZH0sIGZpbmlzaGVkPSR7ZmluaXNoZWR9KWA7XG4gICAgICAgICAgICBsb2cud2Fybihtc2cpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETzogd2UgcmVtb3ZlZCBsb2dnaW5nIHRoZSBmdWxsIGRldGFpbHMgb2JqZWN0IGJlY2F1c2UgdGhlXG4gICAgICAgIC8vIHVwbG9hZERhdGEgd2FzIGp1c3QgdG9vIG11Y2ggY29udGVudC5cblxuICAgICAgICBsb2cuZGVidWcoYFBlbmRpbmcgcmVxdWVzdHMgb24gJHtuYW1lfTogYCwge1xuICAgICAgICAgICAgcGVuZGluZyxcbiAgICAgICAgICAgIHN0YXJ0ZWQsXG4gICAgICAgICAgICBmaW5pc2hlZCxcbiAgICAgICAgICAgIHByb2dyZXNzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudExpc3RlbmVycyh7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgZGV0YWlscyxcbiAgICAgICAgICAgIHBlbmRpbmcsXG4gICAgICAgICAgICBzdGFydGVkLFxuICAgICAgICAgICAgZmluaXNoZWQsXG4gICAgICAgICAgICBwcm9ncmVzc1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgIC8vIHRoZSBjYWxsYmFjayBhbHdheXMgaGFzIHRvIGJlIHVzZWQgb3IgdGhlIHJlcXVlc3RzIHdpbGwgYmVcbiAgICAgICAgICAgIC8vIGNhbmNlbGxlZC5cbiAgICAgICAgICAgIGNhbGxiYWNrKHtjYW5jZWw6IGZhbHNlfSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGV2ZW50TGlzdGVuZXIge0Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRFdmVudExpc3RlbmVyKGV2ZW50TGlzdGVuZXI6IFBlbmRpbmdXZWJSZXF1ZXN0c0NhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lcnMucHVzaChldmVudExpc3RlbmVyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGlzcGF0Y2hFdmVudExpc3RlbmVycyhldmVudDogUGVuZGluZ1dlYlJlcXVlc3RzRXZlbnQpIHtcbiAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycy5mb3JFYWNoKGV2ZW50TGlzdGVuZXIgPT4ge1xuICAgICAgICAgICAgZXZlbnRMaXN0ZW5lcihldmVudCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxufVxuXG5leHBvcnQgdHlwZSBQZW5kaW5nV2ViUmVxdWVzdHNDYWxsYmFjayA9IChldmVudDogUGVuZGluZ1dlYlJlcXVlc3RzRXZlbnQpID0+IHZvaWQ7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVuZGluZ1dlYlJlcXVlc3RzRXZlbnQge1xuXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IGRldGFpbHM6IElXZWJSZXF1ZXN0RGV0YWlscztcbiAgICByZWFkb25seSBwZW5kaW5nOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgc3RhcnRlZDogbnVtYmVyO1xuICAgIHJlYWRvbmx5IGZpbmlzaGVkOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgcHJvZ3Jlc3M6IG51bWJlcjtcblxufVxuIl19