"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("../../Preconditions");
const Optional_1 = require("../../util/ts/Optional");
const Logger_1 = require("../../logger/Logger");
const Strings_1 = require("../../util/Strings");
const Objects_1 = require("../../util/Objects");
const log = Logger_1.Logger.create();
class AggregateParser {
    constructor() {
        this.delegates = [
            new TwitterCardParser(),
            new OGCardParser()
        ];
    }
    parse(doc) {
        const results = this.delegates.map(current => {
            try {
                return current.parse(doc);
            }
            catch (e) {
                log.error("Unable to parse doc: ", e);
                return createNullContentMeta();
            }
        });
        const result = createNullContentMeta();
        for (const key of Objects_1.Objects.typedKeys(result)) {
            result[key] = this.first(current => current[key], ...results);
        }
        return result;
    }
    first(converter, ...contentMeta) {
        const results = contentMeta.map(current => converter(current))
            .map(current => Strings_1.Strings.filterEmpty(current));
        return Optional_1.Optional.first(...results).getOrUndefined();
    }
}
class ContentMetas {
    static parse(doc) {
        return this.parser.parse(doc);
    }
}
ContentMetas.parser = new AggregateParser();
exports.ContentMetas = ContentMetas;
class TwitterCardParser {
    parse(doc) {
        const result = createNullContentMeta();
        result.title = metaValue(doc, 'twitter:title').getOrUndefined();
        result.description = metaValue(doc, 'twitter:description').getOrUndefined();
        return result;
    }
}
class OGCardParser {
    parse(doc) {
        const result = createNullContentMeta();
        result.title = metaValue(doc, 'article:title').getOrUndefined();
        result.description = metaValue(doc, 'article:description').getOrUndefined();
        return result;
    }
}
function createNullContentMeta() {
    const result = {
        title: undefined,
        description: undefined
    };
    return result;
}
function metaValue(doc, name) {
    const optionalMetaElement = meta(doc, name);
    if (!optionalMetaElement.isPresent()) {
        return Optional_1.Optional.empty();
    }
    const metaElement = optionalMetaElement.get();
    let content = metaElement.getAttribute("content");
    if (Preconditions_1.isPresent(content)) {
        return Optional_1.Optional.of(content);
    }
    content = metaElement.getAttribute("value");
    return Optional_1.Optional.of(content);
}
function meta(doc, name) {
    let match = doc.querySelector(`meta[name=${name}]`);
    if (!match) {
        match = doc.querySelector(`meta[property=${name}]`);
    }
    if (!match) {
        match = doc.querySelector(`meta[itemprop=${name}]`);
    }
    return Optional_1.Optional.of(match);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGVudE1ldGFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29udGVudE1ldGFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsdURBQThDO0FBQzlDLHFEQUFnRDtBQUNoRCxnREFBMkM7QUFDM0MsZ0RBQTJDO0FBQzNDLGdEQUEyQztBQUUzQyxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFNUIsTUFBTSxlQUFlO0lBQXJCO1FBRXFCLGNBQVMsR0FBd0I7WUFDOUMsSUFBSSxpQkFBaUIsRUFBRTtZQUN2QixJQUFJLFlBQVksRUFBRTtTQUlyQixDQUFDO0lBd0NOLENBQUM7SUF0Q1UsS0FBSyxDQUFDLEdBQWE7UUFHdEIsTUFBTSxPQUFPLEdBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFFekIsSUFBSTtnQkFDQSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDN0I7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFFUixHQUFHLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN0QyxPQUFPLHFCQUFxQixFQUFFLENBQUM7YUFDbEM7UUFFTCxDQUFDLENBQUMsQ0FBQztRQUdQLE1BQU0sTUFBTSxHQUFHLHFCQUFxQixFQUFFLENBQUM7UUFFdkMsS0FBSyxNQUFNLEdBQUcsSUFBSSxpQkFBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN6QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFFbEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxTQUEyRCxFQUMzRCxHQUFHLFdBQTBCO1FBRXZDLE1B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R0FBRyxDQUFDLENBQUM7S0FDdkQ7SUFFRCxPQUFPLG1CQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbnRlbnRNZXRhfSBmcm9tIFwiLi9Db250ZW50TWV0YVwiO1xuaW1wb3J0IHtpc1ByZXNlbnR9IGZyb20gJy4uLy4uL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtPcHRpb25hbH0gZnJvbSBcIi4uLy4uL3V0aWwvdHMvT3B0aW9uYWxcIjtcbmltcG9ydCB7TG9nZ2VyfSBmcm9tIFwiLi4vLi4vbG9nZ2VyL0xvZ2dlclwiO1xuaW1wb3J0IHtTdHJpbmdzfSBmcm9tIFwiLi4vLi4vdXRpbC9TdHJpbmdzXCI7XG5pbXBvcnQge09iamVjdHN9IGZyb20gXCIuLi8uLi91dGlsL09iamVjdHNcIjtcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5jbGFzcyBBZ2dyZWdhdGVQYXJzZXIgaW1wbGVtZW50cyBDb250ZW50TWV0YVBhcnNlciB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlbGVnYXRlczogQ29udGVudE1ldGFQYXJzZXJbXSA9IFtcbiAgICAgICAgbmV3IFR3aXR0ZXJDYXJkUGFyc2VyKCksXG4gICAgICAgIG5ldyBPR0NhcmRQYXJzZXIoKVxuXG4gICAgICAgIC8vIFRPRE8gc3VwcG9ydCBoYXRvbSwgbWljcm9kYXRhXG5cbiAgICBdO1xuXG4gICAgcHVibGljIHBhcnNlKGRvYzogRG9jdW1lbnQpOiBSZWFkb25seTxDb250ZW50TWV0YT4ge1xuXG4gICAgICAgIC8vIHBhcnNlIHRoZSBkb2MgdXNpbmcgZXZlcnkgcGFyc2VyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPVxuICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZXMubWFwKGN1cnJlbnQgPT4ge1xuXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQucGFyc2UoZG9jKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGFsbG93IHRoZXNlIHRvIHRocm93IGV4Y2VwdGlvbnMuLi5cbiAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKFwiVW5hYmxlIHRvIHBhcnNlIGRvYzogXCIsIGUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlTnVsbENvbnRlbnRNZXRhKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAvLyBub3cgdGFrZSB0aGUgcmVzdWx0cyBhbmQgbWVyZ2UgdGhlbS5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gY3JlYXRlTnVsbENvbnRlbnRNZXRhKCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0cy50eXBlZEtleXMocmVzdWx0KSkge1xuICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzLmZpcnN0KGN1cnJlbnQgPT4gY3VycmVudFtrZXldLCAuLi5yZXN1bHRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGZpcnN0KGNvbnZlcnRlcjogKGNvbnRlbnRNZXRhOiBDb250ZW50TWV0YSkgPT4gc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgLi4uY29udGVudE1ldGE6IENvbnRlbnRNZXRhW10pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPVxuICAgICAgICAgICAgY29udGVudE1ldGEubWFwKGN1cnJlbnQgPT4gY29udmVydGVyKGN1cnJlbnQpKVxuICAgICAgICAgICAgICAgICAgICAgICAubWFwKGN1cnJlbnQgPT4gU3RyaW5ncy5maWx0ZXJFbXB0eShjdXJyZW50KSk7XG5cbiAgICAgICAgcmV0dXJuIE9wdGlvbmFsLmZpcnN0KC4uLnJlc3VsdHMpLmdldE9yVW5kZWZpbmVkKCk7XG5cbiAgICB9XG5cbn1cblxuZXhwb3J0IGNsYXNzIENvbnRlbnRNZXRhcyB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBwYXJzZXIgPSBuZXcgQWdncmVnYXRlUGFyc2VyKCk7XG5cbiAgICAvKipcbiAgICAgKiBQYXJzZSBtZXRhZGF0YSBmcm9tIHRoZSBnaXZlbiBkb2N1bWVudC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHBhcnNlKGRvYzogRG9jdW1lbnQpOiBSZWFkb25seTxDb250ZW50TWV0YT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZXIucGFyc2UoZG9jKTtcbiAgICB9XG5cbn1cblxuaW50ZXJmYWNlIENvbnRlbnRNZXRhUGFyc2VyIHtcblxuICAgIHBhcnNlKGRvYzogRG9jdW1lbnQpOiBSZWFkb25seTxDb250ZW50TWV0YT47XG5cbn1cblxuXG5jbGFzcyBUd2l0dGVyQ2FyZFBhcnNlciBpbXBsZW1lbnRzIENvbnRlbnRNZXRhUGFyc2VyIHtcblxuICAgIHB1YmxpYyBwYXJzZShkb2M6IERvY3VtZW50KTogQ29udGVudE1ldGEge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBjcmVhdGVOdWxsQ29udGVudE1ldGEoKTtcblxuICAgICAgICByZXN1bHQudGl0bGUgPSBtZXRhVmFsdWUoZG9jLCAndHdpdHRlcjp0aXRsZScpLmdldE9yVW5kZWZpbmVkKCk7XG4gICAgICAgIHJlc3VsdC5kZXNjcmlwdGlvbiA9IG1ldGFWYWx1ZShkb2MsICd0d2l0dGVyOmRlc2NyaXB0aW9uJykuZ2V0T3JVbmRlZmluZWQoKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxufVxuXG5jbGFzcyBPR0NhcmRQYXJzZXIgaW1wbGVtZW50cyBDb250ZW50TWV0YVBhcnNlciB7XG5cbiAgICBwdWJsaWMgcGFyc2UoZG9jOiBEb2N1bWVudCk6IENvbnRlbnRNZXRhIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gY3JlYXRlTnVsbENvbnRlbnRNZXRhKCk7XG5cbiAgICAgICAgcmVzdWx0LnRpdGxlID0gbWV0YVZhbHVlKGRvYywgJ2FydGljbGU6dGl0bGUnKS5nZXRPclVuZGVmaW5lZCgpO1xuICAgICAgICByZXN1bHQuZGVzY3JpcHRpb24gPSBtZXRhVmFsdWUoZG9jLCAnYXJ0aWNsZTpkZXNjcmlwdGlvbicpLmdldE9yVW5kZWZpbmVkKCk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbn1cblxuXG5mdW5jdGlvbiBjcmVhdGVOdWxsQ29udGVudE1ldGEoKTogQ29udGVudE1ldGEge1xuXG4gICAgY29uc3QgcmVzdWx0OiBDb250ZW50TWV0YSA9IHtcbiAgICAgICAgdGl0bGU6IHVuZGVmaW5lZCxcbiAgICAgICAgZGVzY3JpcHRpb246IHVuZGVmaW5lZFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuXG59XG5cbmZ1bmN0aW9uIG1ldGFWYWx1ZShkb2M6IERvY3VtZW50LCBuYW1lOiBzdHJpbmcpOiBPcHRpb25hbDxzdHJpbmc+IHtcblxuICAgIGNvbnN0IG9wdGlvbmFsTWV0YUVsZW1lbnQgPSBtZXRhKGRvYywgbmFtZSk7XG5cbiAgICBpZiAoISBvcHRpb25hbE1ldGFFbGVtZW50LmlzUHJlc2VudCgpKSB7XG4gICAgICAgIHJldHVybiBPcHRpb25hbC5lbXB0eSgpO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldGFFbGVtZW50ID0gb3B0aW9uYWxNZXRhRWxlbWVudC5nZXQoKTtcblxuICAgIGxldCBjb250ZW50ID0gbWV0YUVsZW1lbnQuZ2V0QXR0cmlidXRlKFwiY29udGVudFwiKTtcblxuICAgIGlmIChpc1ByZXNlbnQoY29udGVudCkpIHtcbiAgICAgICAgcmV0dXJuIE9wdGlvbmFsLm9mKGNvbnRlbnQpO1xuICAgIH1cblxuICAgIGNvbnRlbnQgPSBtZXRhRWxlbWVudC5nZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiKTtcblxuICAgIHJldHVybiBPcHRpb25hbC5vZihjb250ZW50KTtcblxufVxuXG5cbmZ1bmN0aW9uIG1ldGEoZG9jOiBEb2N1bWVudCwgbmFtZTogc3RyaW5nKTogT3B0aW9uYWw8RWxlbWVudD4ge1xuXG4gICAgbGV0IG1hdGNoID0gZG9jLnF1ZXJ5U2VsZWN0b3IoYG1ldGFbbmFtZT0ke25hbWV9XWApO1xuXG4gICAgaWYgKCFtYXRjaCApIHtcbiAgICAgICAgbWF0Y2ggPSBkb2MucXVlcnlTZWxlY3RvcihgbWV0YVtwcm9wZXJ0eT0ke25hbWV9XWApO1xuICAgIH1cblxuICAgIGlmICghbWF0Y2ggKSB7XG4gICAgICAgIG1hdGNoID0gZG9jLnF1ZXJ5U2VsZWN0b3IoYG1ldGFbaXRlbXByb3A9JHtuYW1lfV1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gT3B0aW9uYWwub2YobWF0Y2gpO1xuXG59XG5cbiJdfQ==