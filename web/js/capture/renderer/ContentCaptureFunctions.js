"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function configureBrowser(windowDimensions) {
    const ENABLE_VH_HANDLING = true;
    const VH_HANDLING_REQUIRE_CHILDREN = false;
    const VH_HANDLING_STRATEGY = 'auto';
    function defineProperty(target, key, value) {
        console.log(`Defining ${key} as: ${value} on: `, target);
        try {
            Object.defineProperty(target, key, {
                get: () => {
                    return value;
                }
            });
        }
        catch (e) {
            console.warn(`Unable to define ${key}`, e);
        }
    }
    function configureBrowserWindowSize(windowDimensions) {
        console.log("Configuring browser window size...");
        const definitions = [
            { key: "width", value: windowDimensions.width },
            { key: "availWidth", value: windowDimensions.width },
            { key: "height", value: windowDimensions.height },
            { key: "availHeight", value: windowDimensions.height }
        ];
        for (const definition of definitions) {
            defineProperty(window.screen, definition.key, definition.value);
        }
        defineProperty(window, 'outerWidth', windowDimensions.width);
        defineProperty(window, 'outerHeight', windowDimensions.height);
    }
    function writeStyles(id, cssText) {
        const styleElement = document.createElement('style');
        styleElement.type = 'text/css';
        styleElement.id = id;
        styleElement.innerHTML = cssText;
        document.getElementsByTagName('head')[0].appendChild(styleElement);
    }
    function defineMaxHeightStylesheet(rule) {
        const cssText = `
        ${rule} {
            max-height: 400px;        
        }
        `;
        writeStyles('polar-vh-max-height', cssText);
    }
    function isVHProp(name, value) {
        const regex = /^[0-9]+VH$/gi;
        const val = value || "";
        return val.match(regex) !== null;
    }
    function isVHRule(rule) {
        const height = rule.style.height || "";
        const minHeight = rule.style.minHeight || "";
        return isVHProp('height', height) || isVHProp('min-height', minHeight);
    }
    function defineAutoStylesheetForVH(rule) {
        function defineStyle(cssPropertyValue, cssPropertyName) {
            if (isVHProp(cssPropertyName, cssPropertyValue)) {
                console.log(`Defining CSS auto style for: ${cssPropertyName}`);
                const cssText = `
                ${rule.selectorText} {
                    ${cssPropertyName}: auto !important;        
                }
                `;
                writeStyles(`polar-vh-auto-${cssPropertyName}`, cssText);
            }
        }
        defineStyle(rule.style.minHeight, 'min-height');
        defineStyle(rule.style.height, 'height');
    }
    function configureWhiteBackground() {
        const cssText = `
        html, body {
            background-color: #FFF;        
        }
        `;
        writeStyles('polar-white-background', cssText);
        console.log("Configured white background");
    }
    function configureMaxVerticalHeight() {
        if (!ENABLE_VH_HANDLING) {
            console.log("VH truncation disabled");
            return;
        }
        console.log("Configuring max vertical height...");
        for (const stylesheet of Array.from(document.styleSheets)) {
            const rules = stylesheet.rules;
            for (const rule of rules) {
                if (rule.style && isVHRule(rule)) {
                    console.log(`Found VH rule to override (follows): ${rule.selectorText}`);
                    const matchingElements = document.querySelectorAll(rule.selectorText);
                    let elementsQualify = true;
                    if (VH_HANDLING_REQUIRE_CHILDREN) {
                        for (const matchingElement of Array.from(matchingElements)) {
                            if (matchingElement.childNodes.length > 0) {
                                console.log("Selector does not quality for as it has child nodes");
                                elementsQualify = false;
                                break;
                            }
                        }
                    }
                    if (elementsQualify) {
                        console.log("Handling VH with strategy: " + VH_HANDLING_STRATEGY);
                        if (VH_HANDLING_STRATEGY === 'max-height') {
                            defineMaxHeightStylesheet(rule.selectorText);
                        }
                        else {
                            defineAutoStylesheetForVH(rule);
                        }
                    }
                }
            }
        }
    }
    function configureSelectionCSS() {
        const cssText = `
            ::selection {
                background-color: rgb(180, 216, 252) !important;
                color: #111111 !important;
            }
        `;
        writeStyles(`polar-css-selection`, cssText);
    }
    try {
        configureBrowserWindowSize(windowDimensions);
        configureMaxVerticalHeight();
        configureSelectionCSS();
    }
    catch (e) {
        console.error("Failed to execute script: ", e);
    }
}
exports.configureBrowser = configureBrowser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGVudENhcHR1cmVGdW5jdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDb250ZW50Q2FwdHVyZUZ1bmN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVdBLFNBQWdCLGdCQUFnQixDQUFDLGdCQUE2QjtJQUUxRCxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQztJQUVoQyxNQUFNLDRCQUE0QixHQUFZLEtBQUssQ0FBQztJQUVwRCxNQUFNLG9CQUFvQixHQUEwQixNQUFNLENBQUM7SUFFM0QsU0FBUyxjQUFjLENBQUMsTUFBVyxFQUFFLEdBQVcsRUFBRSxLQUFVO1FBRXhELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLFFBQVEsS0FBSyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFekQsSUFBSTtZQUNBLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtnQkFDL0IsR0FBRyxFQUFFLEdBQUcsRUFBRTtvQkFDTixPQUFPLEtBQUssQ0FBQztnQkFDakIsQ0FBQzthQUNKLENBQUMsQ0FBQztTQUNOO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixPQUFPLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM5QztJQUVMLENBQUM7SUFHRCxTQUFTLDBCQUEwQixDQUFDLGdCQUE2QjtRQUU3RCxPQUFPLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFNbEQsTUFBTSxXQUFXLEdBQUc7WUFDaEIsRUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFRLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUM7WUFDbkQsRUFBQyxHQUFHLEVBQUUsWUFBWSxFQUFHLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUM7WUFDbkQsRUFBQyxHQUFHLEVBQUUsUUFBUSxFQUFPLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUM7WUFDcEQs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QUM7eUJBQ25DO3FCQUNKO2lCQUVKO2FBRUo7U0FFSjtJQUVMLENBQUM7SUFFRCxTQUFTLHFCQUFxQjtRQUUxQixNQUFNLE9BQU8sR0FBRzs7Ozs7U0FLZixDQUFDO1FBRUYsV0FBVyxDQUFDLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRWhELENBQUM7SUFFRCxJQUFJO1FBR0EsMEJBQTBCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUM3QywwQkFBMEIsRUFBRSxDQUFDO1FBQzdCLHFCQUFxQixFQUFFLENBQUM7S0FFM0I7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbEQ7QUFFTCxDQUFDO0FBek5ELDRDQXlOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SURpbWVuc2lvbnN9IGZyb20gJy4uLy4uL3V0aWwvRGltZW5zaW9ucyc7XG5cbi8vIGRlY2xhcmUgdmFyIHdpbmRvdzogYW55O1xuXG4vLyBUT0RPOiBwYXNzIGluIG1vcmUgYXJndW1lbnRzIGhlcmUgaW5jbHVkaW5nIHRoZSBjYXB0dXJlIG9wdGlvbnMgdGhhdCBhcmVcbi8vIGN1cnJlbnRseSBzZXQgYnkgdGhlIHVzZXIuICBUaGlzIHdheSB3ZSBjb3VsZCBkaXNhYmxlIGZlYXR1cmVzIGxpa2UgdGhlXG4vLyB2ZXJ0aWNhbCBoZWlnaHQgZGV0ZWN0aW9uIGFuZCB3ZSBjb3VsZCBhbHNvIGVuYWJsZSBmZWF0dXJlcyBsaWtlIGFkIGJsb2NraW5nXG4vLyBidXQgcmlnaHQgbm93IHRoZSBhZCBibG9ja2luZyB3b3JrcyBhcyBwYXJ0IG9mIHRoZSBDQVBUVVJFIHN0YWdlLCBub3QgdGhlXG4vLyBwcmV2aWV3IHN0YWdlLlxuXG4vKiogQEVsZWN0cm9uUmVuZGVyZXJDb250ZXh0ICovXG5leHBvcnQgZnVuY3Rpb24gY29uZmlndXJlQnJvd3Nlcih3aW5kb3dEaW1lbnNpb25zOiBJRGltZW5zaW9ucykge1xuXG4gICAgY29uc3QgRU5BQkxFX1ZIX0hBTkRMSU5HID0gdHJ1ZTtcblxuICAgIGNvbnN0IFZIX0hBTkRMSU5HX1JFUVVJUkVfQ0hJTERSRU46IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIGNvbnN0IFZIX0hBTkRMSU5HX1NUUkFURUdZOiAnYXV0bycgfCAnbWF4LWhlaWdodCcgPSAnYXV0byc7XG5cbiAgICBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0eSh0YXJnZXQ6IGFueSwga2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcblxuICAgICAgICBjb25zb2xlLmxvZyhgRGVmaW5pbmcgJHtrZXl9IGFzOiAke3ZhbHVlfSBvbjogYCwgdGFyZ2V0KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBVbmFibGUgdG8gZGVmaW5lICR7a2V5fWAsIGUpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvLyBub2luc3BlY3Rpb24gVHNMaW50XG4gICAgZnVuY3Rpb24gY29uZmlndXJlQnJvd3NlcldpbmRvd1NpemUod2luZG93RGltZW5zaW9uczogSURpbWVuc2lvbnMpIHtcblxuICAgICAgICBjb25zb2xlLmxvZyhcIkNvbmZpZ3VyaW5nIGJyb3dzZXIgd2luZG93IHNpemUuLi5cIik7XG5cbiAgICAgICAgLy8gVE9ETzogc2VlIGlmIEkgaGF2ZSBhbHJlYWR5IHJlZGVmaW5lZCBpdC4gIHRoZSBzZWNvbmQgdGltZSBmYWlsc1xuICAgICAgICAvLyBiZWNhdXNlIEkgY2FuJ3QgcmVkZWZpbmUgYSBwcm9wZXJ0eS4gIEkgZG9uJ3QgdGhpbmsgdGhlcmUgaXMgYSB3YXlcbiAgICAgICAgLy8gdG8gZmluZCBvdXQgaWYgaXQncyBhbHJlYWR5IGRlZmluZWQgdGhvdWdoLlxuXG4gICAgICAgIGNvbnN0IGRlZmluaXRpb25zID0gW1xuICAgICAgICAgICAge2tleTogXCJ3aWR0aFwiLCAgICAgICB2YWx1ZTogd2luZG93RGltZW5zaW9ucy53aWR0aH0sXG4gICAgICAgICAgICB7a2V5OiBcImF2YWlsV2lkdGhcIiwgIHZhbHVlOiB3aW5kb3dEaW1lbnNpb25zLndpZHRofSxcbiAgICAgICAgICAgIHtrZXk6IFwiaGVpZ2h0XCIsICAgICAgdmFsdWU6IHdpbmRvd0RpbWVuc2lvbnMuaGVpZ2h0fSxcbiAgICAgICAgICAgIHtrZXk6IFwiYXZhaWxIZWlnaHRcIiwgdmFsdWU6IHdpbmRvd0RpbWVuc2lvbnMuaGVpZ2h0fVxuICAgICAgICBdO1xuXG4gICAgICAgIGZvciAoY29uc3QgZGVmaW5pdGlvbiBvZiBkZWZpbml0aW9ucykge1xuICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkod2luZG93LnNjcmVlbiwgZGVmaW5pdGlvbi5rZXksIGRlZmluaXRpb24udmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVmaW5lUHJvcGVydHkod2luZG93LCAnb3V0ZXJXaWR0aCcsIHdpbmRvd0RpbWVuc2lvbnMud2lkdGgpO1xuICAgICAgICBkZWZpbmVQcm9wZXJ0eSh3aW5kb3csICdvdXRlckhlaWdodCcsIHdpbmRvd0RpbWVuc2lvbnMuaGVpZ2h0KTtcblxuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gd3JpdGVTdHlsZXMoaWQ6IHN0cmluZywgY3NzVGV4dDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHN0eWxlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG4gICAgICAgIHN0eWxlRWxlbWVudC50eXBlID0gJ3RleHQvY3NzJztcbiAgICAgICAgc3R5bGVFbGVtZW50LmlkID0gaWQ7XG4gICAgICAgIHN0eWxlRWxlbWVudC5pbm5lckhUTUwgPSBjc3NUZXh0O1xuICAgICAgICAvLyBGSVhNRTogdGhpcyBpcyBicm9rZW4gcmlnaHQgbm93IGFuZCB3ZSBoYXZlIHRvIGNvbXB1dGUgdGhlIHJpZ2h0IGhlYWQgbG9jYXRpb25cbiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzdHlsZUVsZW1lbnQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGRlZmluZU1heEhlaWdodFN0eWxlc2hlZXQocnVsZTogc3RyaW5nKSB7XG5cbiAgICAgICAgLy8gVE9ETzogSSBuZWVkIHRvIGNvbnNpZGVyIGlmIGl0J3Mgbm90IGp1c3QgYmV0dGVyIHRvIG1lYXN1cmUgdGhlXG4gICAgICAgIC8vIHZpZXdwb3J0IGhlaWdodCBhbmQgcmVwbGFjZSBpdCBteXNlbGYuICBJdCBpcyBwcm9iYWJseSBhIGJhZCBpZGVhXG4gICAgICAgIC8vIHNvIHNldCB0aGlzIHRvbyBzbWFsbCBhbmQgd2lsbCBicmVhayBpbiBhIGxvdCBvZiB1c2UgY2FzZXMuXG5cbiAgICAgICAgY29uc3QgY3NzVGV4dCA9IGBcbiAgICAgICAgJHtydWxlfSB7XG4gICAgICAgICAgICBtYXgtaGVpZ2h0OiA0MDBweDsgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIGA7XG5cbiAgICAgICAgd3JpdGVTdHlsZXMoJ3BvbGFyLXZoLW1heC1oZWlnaHQnLCBjc3NUZXh0KTtcblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzVkhQcm9wKG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IG51bGwpIHtcblxuICAgICAgICBjb25zdCByZWdleCA9IC9eWzAtOV0rVkgkL2dpO1xuXG4gICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlIHx8IFwiXCI7XG5cbiAgICAgICAgcmV0dXJuIHZhbC5tYXRjaChyZWdleCkgIT09IG51bGw7XG5cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBpc1ZIUnVsZShydWxlOiBDU1NTdHlsZVJ1bGUpIHtcblxuICAgICAgICBjb25zdCBoZWlnaHQ6IHN0cmluZyA9IHJ1bGUuc3R5bGUuaGVpZ2h0IHx8IFwiXCI7XG4gICAgICAgIGNvbnN0IG1pbkhlaWdodDogc3RyaW5nID0gcnVsZS5zdHlsZS5taW5IZWlnaHQgfHwgXCJcIjtcblxuICAgICAgICByZXR1cm4gaXNWSFByb3AoJ2hlaWdodCcsIGhlaWdodCkgfHwgaXNWSFByb3AoJ21pbi1oZWlnaHQnLCBtaW5IZWlnaHQpO1xuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZGVmaW5lQXV0b1N0eWxlc2hlZXRGb3JWSChydWxlOiBDU1NTdHlsZVJ1bGUpIHtcblxuICAgICAgICAvLyBUT0RPOiBJIG5lZWQgdG8gY29uc2lkZXIgaWYgaXQncyBub3QganVzdCBiZXR0ZXIgdG8gbWVhc3VyZSB0aGVcbiAgICAgICAgLy8gdmlld3BvcnQgaGVpZ2h0IGFuZCByZXBsYWNlIGl0IG15c2VsZi4gIEl0IGlzIHByb2JhYmx5IGEgYmFkIGlkZWFcbiAgICAgICAgLy8gc28gc2V0IHRoaXMgdG9vIHNtYWxsIGFuZCB3aWxsIGJyZWFrIGluIGEgbG90IG9mIHVzZSBjYXNlcy5cblxuICAgICAgICBmdW5jdGlvbiBkZWZpbmVTdHlsZShjc3NQcm9wZXJ0eVZhbHVlOiBzdHJpbmcgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3NQcm9wZXJ0eU5hbWU6IHN0cmluZykge1xuXG4gICAgICAgICAgICBpZiAoaXNWSFByb3AoY3NzUHJvcGVydHlOYW1lLCBjc3NQcm9wZXJ0eVZhbHVlKSkge1xuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYERlZmluaW5nIENTUyBhdXRvIHN0eWxlIGZvcjogJHtjc3NQcm9wZXJ0eU5hbWV9YCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gYFxuICAgICAgICAgICAgICAgICR7cnVsZS5zZWxlY3RvclRleHR9IHtcbiAgICAgICAgICAgICAgICAgICAgJHtjc3NQcm9wZXJ0eU5hbWV9OiBhdXRvICFpbXBvcnRhbnQ7ICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYDtcblxuICAgICAgICAgICAgICAgIHdyaXRlU3R5bGVzKGBwb2xhci12aC1hdXRvLSR7Y3NzUHJvcGVydHlOYW1lfWAsIGNzc1RleHQpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGRlZmluZVN0eWxlKHJ1bGUuc3R5bGUubWluSGVpZ2h0LCAnbWluLWhlaWdodCcpO1xuICAgICAgICBkZWZpbmVTdHlsZShydWxlLnN0eWxlLmhlaWdodCwgJ2hlaWdodCcpO1xuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY29uZmlndXJlV2hpdGVCYWNrZ3JvdW5kKCkge1xuICAgICAgICBjb25zdCBjc3NUZXh0ID0gYFxuICAgICAgICBodG1sLCBib2R5IHtcbiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNGRkY7ICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBgO1xuXG4gICAgICAgIHdyaXRlU3R5bGVzKCdwb2xhci13aGl0ZS1iYWNrZ3JvdW5kJywgY3NzVGV4dCk7XG5cbiAgICAgICAgY29uc29sZS5sb2coXCJDb25maWd1cmVkIHdoaXRlIGJhY2tncm91bmRcIik7XG5cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjb25maWd1cmVNYXhWZXJ0aWNhbEhlaWdodCgpIHtcblxuICAgICAgICBpZiAoISBFTkFCTEVfVkhfSEFORExJTkcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVkggdHJ1bmNhdGlvbiBkaXNhYmxlZFwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ29uZmlndXJpbmcgbWF4IHZlcnRpY2FsIGhlaWdodC4uLlwiKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHN0eWxlc2hlZXQgb2YgQXJyYXkuZnJvbShkb2N1bWVudC5zdHlsZVNoZWV0cykpIHtcblxuICAgICAgICAgICAgY29uc3QgcnVsZXM6IENTU1N0eWxlUnVsZVtdID0gKDxhbnk+IHN0eWxlc2hlZXQpLnJ1bGVzO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgcnVsZXMpIHtcblxuICAgICAgICAgICAgICAgIGlmIChydWxlLnN0eWxlICYmIGlzVkhSdWxlKHJ1bGUpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEZvdW5kIFZIIHJ1bGUgdG8gb3ZlcnJpZGUgKGZvbGxvd3MpOiAke3J1bGUuc2VsZWN0b3JUZXh0fWApO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vdyB2ZXJpZnkgdGhhdCB0aGUgZWxlbWVudHMgd2Ugd291bGQgYmxvY2sgcXVhbGl0eS5cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaGluZ0VsZW1lbnRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChydWxlLnNlbGVjdG9yVGV4dCk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGVsZW1lbnRzUXVhbGlmeSA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKFZIX0hBTkRMSU5HX1JFUVVJUkVfQ0hJTERSRU4pIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBtYXRjaGluZ0VsZW1lbnQgb2YgQXJyYXkuZnJvbShtYXRjaGluZ0VsZW1lbnRzKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGluZ0VsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2VsZWN0b3IgZG9lcyBub3QgcXVhbGl0eSBmb3IgYXMgaXQgaGFzIGNoaWxkIG5vZGVzXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50c1F1YWxpZnkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudHNRdWFsaWZ5KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSGFuZGxpbmcgVkggd2l0aCBzdHJhdGVneTogXCIgKyBWSF9IQU5ETElOR19TVFJBVEVHWSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChWSF9IQU5ETElOR19TVFJBVEVHWSA9PT0gJ21heC1oZWlnaHQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5lTWF4SGVpZ2h0U3R5bGVzaGVldChydWxlLnNlbGVjdG9yVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluZUF1dG9TdHlsZXNoZWV0Rm9yVkgocnVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNvbmZpZ3VyZVNlbGVjdGlvbkNTUygpIHtcblxuICAgICAgICBjb25zdCBjc3NUZXh0ID0gYFxuICAgICAgICAgICAgOjpzZWxlY3Rpb24ge1xuICAgICAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHJnYigxODAsIDIxNiwgMjUyKSAhaW1wb3J0YW50O1xuICAgICAgICAgICAgICAgIGNvbG9yOiAjMTExMTExICFpbXBvcnRhbnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIGA7XG5cbiAgICAgICAgd3JpdGVTdHlsZXMoYHBvbGFyLWNzcy1zZWxlY3Rpb25gLCBjc3NUZXh0KTtcblxuICAgIH1cblxuICAgIHRyeSB7XG5cbiAgICAgICAgLy8gY29uZmlndXJlV2hpdGVCYWNrZ3JvdW5kKCk7XG4gICAgICAgIGNvbmZpZ3VyZUJyb3dzZXJXaW5kb3dTaXplKHdpbmRvd0RpbWVuc2lvbnMpO1xuICAgICAgICBjb25maWd1cmVNYXhWZXJ0aWNhbEhlaWdodCgpO1xuICAgICAgICBjb25maWd1cmVTZWxlY3Rpb25DU1MoKTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBleGVjdXRlIHNjcmlwdDogXCIsIGUpO1xuICAgIH1cblxufVxuXG5cblxuXG4iXX0=