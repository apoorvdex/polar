"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Pagemarks_1 = require("../../../metadata/Pagemarks");
const Logger_1 = require("../../../logger/Logger");
const Component_1 = require("../../../components/Component");
const DocFormatFactory_1 = require("../../../docformat/DocFormatFactory");
const AnnotationRects_1 = require("../../../metadata/AnnotationRects");
const PagemarkRect_1 = require("../../../metadata/PagemarkRect");
const Preconditions_1 = require("../../../Preconditions");
const Styles_1 = require("../../../util/Styles");
const Optional_1 = require("../../../util/ts/Optional");
const Rects_1 = require("../../../Rects");
const BoxController_1 = require("../../../boxes/controller/BoxController");
const PagemarkMode_1 = require("../../../metadata/PagemarkMode");
const DocMetas_1 = require("../../../metadata/DocMetas");
const log = Logger_1.Logger.create();
const ENABLE_BOX_CONTROLLER = true;
class AbstractPagemarkComponent extends Component_1.Component {
    constructor(type) {
        super();
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        this.type = type;
        this.options = {
            templateElement: undefined,
            placementElement: undefined
        };
    }
    init(annotationEvent) {
        this.annotationEvent = annotationEvent;
        this.pagemark = annotationEvent.value;
        this.pagemarkBoxController = new BoxController_1.BoxController((boxMoveEvent) => this.onBoxMoved(boxMoveEvent));
    }
    onBoxMoved(boxMoveEvent) {
        log.info("Box moved to: ", boxMoveEvent);
        const annotationRect = AnnotationRects_1.AnnotationRects.createFromPositionedRect(boxMoveEvent.boxRect, boxMoveEvent.restrictionRect);
        const rect = new PagemarkRect_1.PagemarkRect(annotationRect);
        if (boxMoveEvent.state === "completed") {
            log.info("Box move completed.  Updating to trigger persistence.");
            const annotationEvent = this.annotationEvent;
            const pageNum = annotationEvent.pageMeta.pageInfo.num;
            const docMeta = annotationEvent.docMeta;
            const pageMeta = DocMetas_1.DocMetas.getPageMeta(docMeta, pageNum);
            this.pagemark = pageMeta.pagemarks[this.pagemark.id];
            const newPagemark = Object.assign({}, this.pagemark);
            newPagemark.percentage = rect.toPercentage();
            newPagemark.rect = rect;
            log.info("New pagemark: ", JSON.stringify(this.pagemark, null, "  "));
            Pagemarks_1.Pagemarks.updatePagemark(annotationEvent.docMeta, pageNum, newPagemark);
            this.pagemark = newPagemark;
        }
        else {
            log.info("New pagemark: ", JSON.stringify(this.pagemark, null, "  "));
        }
        log.info("New pagemarkRect: ", this.pagemark.rect);
    }
    render() {
        const container = this.annotationEvent.container;
        Preconditions_1.Preconditions.assertNotNull(container, "container");
        if (!this.pagemark) {
            throw new Error("Pagemark is required");
        }
        if (!this.pagemark.percentage) {
            throw new Error("Pagemark has no percentage");
        }
        let templateElement = this.options.templateElement;
        let placementElement = this.options.placementElement;
        if (!templateElement) {
            templateElement = container.element;
        }
        if (!placementElement) {
            placementElement = container.element.querySelector(".canvasWrapper, .iframeWrapper");
            log.debug("Using a default placementElement from selector: ", placementElement);
        }
        Preconditions_1.Preconditions.assertNotNull(templateElement, "templateElement");
        Preconditions_1.Preconditions.assertNotNull(placementElement, "placementElement");
        log.info("Using templateElement: ", templateElement);
        log.info("Using placementElement: ", placementElement);
        const id = this.createID();
        let pagemarkElement = document.getElementById(id);
        if (pagemarkElement === null) {
            pagemarkElement = document.createElement("div");
            pagemarkElement.setAttribute("id", id);
            placementElement.parentElement.insertBefore(pagemarkElement, placementElement);
            if (ENABLE_BOX_CONTROLLER) {
                log.info("Creating box controller for pagemarkElement: ", pagemarkElement);
                this.pagemarkBoxController.register({
                    target: pagemarkElement,
                    restrictionElement: placementElement,
                    intersectedElementsSelector: ".pagemark"
                });
            }
        }
        const annotationEvent = this.annotationEvent;
        pagemarkElement.setAttribute("data-pagemark-id", this.pagemark.id);
        pagemarkElement.setAttribute("data-annotation-id", this.pagemark.id);
        pagemarkElement.setAttribute("data-annotation-type", "pagemark");
        pagemarkElement.setAttribute("data-annotation-doc-fingerprint", annotationEvent.docMeta.docInfo.fingerprint);
        pagemarkElement.setAttribute("data-annotation-page-num", `${annotationEvent.pageMeta.pageInfo.num}`);
        pagemarkElement.setAttribute("data-type", "pagemark");
        pagemarkElement.setAttribute("data-doc-fingerprint", annotationEvent.docMeta.docInfo.fingerprint);
        pagemarkElement.setAttribute("data-page-num", `${annotationEvent.pageMeta.pageInfo.num}`);
        pagemarkElement.className = "pagemark annotation";
        const pagemarkColor = this.toPagemarkColor();
        pagemarkElement.style.backgroundColor = pagemarkColor.backgroundColor;
        pagemarkElement.style.opacity = "" + pagemarkColor.opacity;
        pagemarkElement.style.position = "absolute";
        const placementRect = this.createPlacementRect(placementElement);
        const pagemarkRect = this.toOverlayRect(placementRect, this.pagemark);
        if (this.type === 'primary') {
            if (pagemarkElement.children.length === 0) {
                this.createInternalDiv(pagemarkElement);
            }
        }
        pagemarkElement.style.left = `${pagemarkRect.left}px`;
        pagemarkElement.style.top = `${pagemarkRect.top}px`;
        pagemarkElement.style.width = `${pagemarkRect.width}px`;
        pagemarkElement.style.height = `${pagemarkRect.height}px`;
        pagemarkElement.style.zIndex = '9';
        pagemarkElement.style.pointerEvents = 'none';
    }
    createInternalDiv(pagemarkElement) {
        const createInternalDiv = () => {
            const internalDiv = document.createElement('div');
            internalDiv.style.pointerEvents = 'auto';
            internalDiv.style.position = 'absolute';
            return internalDiv;
        };
        const createHorizontalInternalDiv = () => {
            const internalDiv = createInternalDiv();
            internalDiv.style.width = '100%';
            internalDiv.style.height = '2mm';
            return internalDiv;
        };
        const createVerticalInternalDiv = () => {
            const internalDiv = createInternalDiv();
            internalDiv.style.width = '2mm';
            internalDiv.style.height = '100%';
            return internalDiv;
        };
        const createInternalDivs = () => {
            const left = createVerticalInternalDiv();
            left.style.left = '0';
            left.style.top = '0';
            const right = createVerticalInternalDiv();
            right.style.right = '0';
            right.style.top = '0';
            const top = createHorizontalInternalDiv();
            top.style.left = '0';
            top.style.top = '0';
            const bottom = createHorizontalInternalDiv();
            bottom.style.bottom = '0';
            bottom.style.left = '0';
            return [left, right, top, bottom];
        };
        const internalDivs = createInternalDivs();
        let pointerEvents = 'auto';
        const doChangePointerEvents = (newValue) => {
            if (pointerEvents !== newValue) {
                pagemarkElement.style.pointerEvents = newValue;
                pointerEvents = newValue;
            }
        };
        for (const internalDiv of internalDivs) {
            internalDiv.addEventListener('mouseenter', (event) => {
                doChangePointerEvents('auto');
                event.preventDefault();
            });
            internalDiv.addEventListener('mouseleave', (event) => {
                doChangePointerEvents('none');
                event.preventDefault();
            });
            pagemarkElement.appendChild(internalDiv);
        }
    }
    toPagemarkColor() {
        class PagemarkColors {
        }
        PagemarkColors.BLUE = {
            backgroundColor: "#00CCFF",
            opacity: 0.3
        };
        PagemarkColors.LIGHTBLUE = {
            backgroundColor: "#00CCFF",
            opacity: 0.15
        };
        PagemarkColors.GREY = {
            backgroundColor: "rgb(125, 125, 125)",
            opacity: 0.3
        };
        if (!this.pagemark) {
            return PagemarkColors.BLUE;
        }
        if (!this.pagemark.mode) {
            return PagemarkColors.BLUE;
        }
        switch (this.pagemark.mode) {
            case PagemarkMode_1.PagemarkMode.IGNORED:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.TABLE_OF_CONTENTS:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.APPENDEX:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.REFERENCES:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.PRE_READ:
                return PagemarkColors.LIGHTBLUE;
            default:
                return PagemarkColors.BLUE;
        }
    }
    destroy() {
        const pagemarkElement = document.getElementById(this.createID());
        if (pagemarkElement) {
            pagemarkElement.innerHTML = '';
            if (pagemarkElement.parentElement) {
                pagemarkElement.parentElement.removeChild(pagemarkElement);
            }
        }
    }
    createPlacementRect(placementElement) {
        const positioning = Styles_1.Styles.positioning(placementElement);
        const positioningPX = Styles_1.Styles.positioningToPX(positioning);
        const result = {
            left: Optional_1.Optional.of(positioningPX.left).getOrElse(placementElement.offsetLeft),
            top: Optional_1.Optional.of(positioningPX.top).getOrElse(placementElement.offsetTop),
            width: Optional_1.Optional.of(positioningPX.width).getOrElse(placementElement.offsetWidth),
            height: Optional_1.Optional.of(positioningPX.height).getOrElse(placementElement.offsetHeight),
        };
        return Rects_1.Rects.createFromBasicRect(result);
    }
    createID() {
        return `${this.type}-pagemark-${this.pagemark.id}`;
    }
    toOverlayRect(placementRect, pagemark) {
        const pagemarkRect = new PagemarkRect_1.PagemarkRect(pagemark.rect);
        const overlayRect = pagemarkRect.toDimensions(placementRect.dimensions);
        return Rects_1.Rects.createFromBasicRect({
            left: overlayRect.left + placementRect.left,
            top: overlayRect.top + placementRect.top,
            width: overlayRect.width,
            height: overlayRect.height,
        });
    }
}
exports.AbstractPagemarkComponent = AbstractPagemarkComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWJzdHJhY3RQYWdlbWFya0NvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFic3RyYWN0UGFnZW1hcmtDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyREFBc0Q7QUFDdEQsbURBQThDO0FBQzlDLDZEQUF3RDtBQUN4RCwwRUFBcUU7QUFJckUsdUVBQWtFO0FBQ2xFLGlFQUE0RDtBQUM1RCwwREFBcUQ7QUFDckQsaURBQTRDO0FBQzVDLHdEQUFtRDtBQUNuRCwwQ0FBcUM7QUFFckMsMkVBQXNFO0FBQ3RFLGlFQUE0RDtBQUM1RCx5REFBb0Q7QUFFcEQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQU0scUJBQXFCLEdBQUcsSUFBSSxDQUFDO0FBRW5DLE1BQWEseUJBQTBCLFNBQVEscUJBQVM7SUFpQnBELFlBQVksSUFBMkI7UUFDbkMsS0FBSyxFQUFFLENBQUM7UUFFUixJQUFJLENBQUMsU0FBUyxHQUFHLG1DQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWhELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDWCxlQUFlLEVBQUUsU0FBUztZQUMxQixnQkFBZ0IsRUFBRSxTQUFTO1NBQzlCLENBQUM7SUFFTixDQUFDO0lBS00sSUFBSSxDQUFDLGVBQWdDO1FBRXhDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxRQUFRLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQztRQUV0QyxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSw2QkFBYSxDQUFDLENBQUMsWUFBaUIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBRXpHLENBQUM7SUFNTSxVQUFVLENBQUMsWUFBaUI7UUFRL0IsR0FBRyxDQUFDLElBQUksQ0FBQyxn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QUFRLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDO1lBQ3pFLEtBQUssRUFBRSxtQkFBUSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQztZQUMvRSxNQUFNLEVBQUUsbUJBQVEsQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUM7U0FDckYsQ0FBQztRQUVGLE9BQU8sYUFBSyxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRTdDLENBQUM7SUFLTyxRQUFRO1FBQ1osT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLGFBQWEsSUFBSSxDQUFDLFFBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUN4RCxDQUFDO0lBS08sYUFBYSxDQUFDLGFBQW1CLEVBQUUsUUFBa0I7UUFFekQsTUFBTSxZQUFZLEdBQUcsSUFBSSwyQkFBWSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVyRCxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUl4RSxPQUFPLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQztZQUM3QixJQUFJLEVBQUUsV0FBVyxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSTtZQUMzQyxHQUFHLEVBQUUsV0FBVyxDQUFDLEdBQUcsR0FBRyxhQUFhLENBQUMsR0FBRztZQUN4QyxLQUFLLEVBQUUsV0FBVyxDQUFDLEtBQUs7WUFDeEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1NBQzdCLENBQUMsQ0FBQztJQUVQLENBQUM7Q0FFSjtBQWxjRCw4REFrY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1BhZ2VtYXJrc30gZnJvbSBcIi4uLy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrc1wiO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJy4uLy4uLy4uL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtDb21wb25lbnR9IGZyb20gJy4uLy4uLy4uL2NvbXBvbmVudHMvQ29tcG9uZW50JztcbmltcG9ydCB7RG9jRm9ybWF0RmFjdG9yeX0gZnJvbSAnLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdEZhY3RvcnknO1xuaW1wb3J0IHtEb2NGb3JtYXR9IGZyb20gJy4uLy4uLy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXQnO1xuaW1wb3J0IHtBbm5vdGF0aW9uRXZlbnR9IGZyb20gJy4uLy4uLy4uL2Fubm90YXRpb25zL2NvbXBvbmVudHMvQW5ub3RhdGlvbkV2ZW50JztcbmltcG9ydCB7UGFnZW1hcmt9IGZyb20gJy4uLy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrJztcbmltcG9ydCB7QW5ub3RhdGlvblJlY3RzfSBmcm9tICcuLi8uLi8uLi9tZXRhZGF0YS9Bbm5vdGF0aW9uUmVjdHMnO1xuaW1wb3J0IHtQYWdlbWFya1JlY3R9IGZyb20gJy4uLy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrUmVjdCc7XG5pbXBvcnQge1ByZWNvbmRpdGlvbnN9IGZyb20gJy4uLy4uLy4uL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtTdHlsZXN9IGZyb20gJy4uLy4uLy4uL3V0aWwvU3R5bGVzJztcbmltcG9ydCB7T3B0aW9uYWx9IGZyb20gJy4uLy4uLy4uL3V0aWwvdHMvT3B0aW9uYWwnO1xuaW1wb3J0IHtSZWN0c30gZnJvbSAnLi4vLi4vLi4vUmVjdHMnO1xuaW1wb3J0IHtSZWN0fSBmcm9tICcuLi8uLi8uLi9SZWN0JztcbmltcG9ydCB7Qm94Q29udHJvbGxlcn0gZnJvbSBcIi4uLy4uLy4uL2JveGVzL2NvbnRyb2xsZXIvQm94Q29udHJvbGxlclwiO1xuaW1wb3J0IHtQYWdlbWFya01vZGV9IGZyb20gJy4uLy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrTW9kZSc7XG5pbXBvcnQge0RvY01ldGFzfSBmcm9tIFwiLi4vLi4vLi4vbWV0YWRhdGEvRG9jTWV0YXNcIjtcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5jb25zdCBFTkFCTEVfQk9YX0NPTlRST0xMRVIgPSB0cnVlO1xuXG5leHBvcnQgY2xhc3MgQWJzdHJhY3RQYWdlbWFya0NvbXBvbmVudCBleHRlbmRzIENvbXBvbmVudCB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdHlwZSBvZiB0aGUgcGFnZW1hcmsgKHByaW1hcnkgb3IgdGh1bWJuYWlsKVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHlwZTogUGFnZW1hcmtDb21wb25lbnRUeXBlO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBkb2NGb3JtYXQ6IERvY0Zvcm1hdDtcblxuICAgIHByaXZhdGUgcGFnZW1hcms/OiBQYWdlbWFyaztcblxuICAgIHByaXZhdGUgYW5ub3RhdGlvbkV2ZW50PzogQW5ub3RhdGlvbkV2ZW50O1xuXG4gICAgcHJpdmF0ZSBwYWdlbWFya0JveENvbnRyb2xsZXI6IGFueTtcblxuICAgIHByb3RlY3RlZCBvcHRpb25zOiBFbGVtZW50T3B0aW9ucztcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFBhZ2VtYXJrQ29tcG9uZW50VHlwZSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgICAgIHRoaXMudHlwZSA9IHR5cGU7XG5cbiAgICAgICAgdGhpcy5vcHRpb25zID0ge1xuICAgICAgICAgICAgdGVtcGxhdGVFbGVtZW50OiB1bmRlZmluZWQsXG4gICAgICAgICAgICBwbGFjZW1lbnRFbGVtZW50OiB1bmRlZmluZWRcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqL1xuICAgIHB1YmxpYyBpbml0KGFubm90YXRpb25FdmVudDogQW5ub3RhdGlvbkV2ZW50KSB7XG5cbiAgICAgICAgdGhpcy5hbm5vdGF0aW9uRXZlbnQgPSBhbm5vdGF0aW9uRXZlbnQ7XG4gICAgICAgIHRoaXMucGFnZW1hcmsgPSBhbm5vdGF0aW9uRXZlbnQudmFsdWU7XG5cbiAgICAgICAgdGhpcy5wYWdlbWFya0JveENvbnRyb2xsZXIgPSBuZXcgQm94Q29udHJvbGxlcigoYm94TW92ZUV2ZW50OiBhbnkpID0+IHRoaXMub25Cb3hNb3ZlZChib3hNb3ZlRXZlbnQpKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGJveE1vdmVFdmVudCB7Qm94TW92ZUV2ZW50fVxuICAgICAqL1xuICAgIHB1YmxpYyBvbkJveE1vdmVkKGJveE1vdmVFdmVudDogYW55KSB7XG5cbiAgICAgICAgLy8gVE9ETzogYWN0dWFsbHkgSSB0aGluayB0aGlzIGJlbG9uZ3MgaW4gdGhlIGNvbnRyb2xsZXIuLi4gbm90IHRoZSB2aWV3XG4gICAgICAgIC8vXG4gICAgICAgIC8vXG5cbiAgICAgICAgLy8gVE9ETzogcmVtb3ZlIHRoZSBwYWdlbWFyaywgdGhlbiByZWNyZWF0ZSBpdC4uLlxuXG4gICAgICAgIGxvZy5pbmZvKFwiQm94IG1vdmVkIHRvOiBcIiwgYm94TW92ZUV2ZW50KTtcblxuICAgICAgICAvLyBib3hSZWN0LCBjb250YWluZXJSZWN0LCBwYWdlUmVjdC4uLlxuXG4gICAgICAgIGNvbnN0IGFubm90YXRpb25SZWN0ID0gQW5ub3RhdGlvblJlY3RzLmNyZWF0ZUZyb21Qb3NpdGlvbmVkUmVjdChib3hNb3ZlRXZlbnQuYm94UmVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJveE1vdmVFdmVudC5yZXN0cmljdGlvblJlY3QpO1xuXG4gICAgICAgIGNvbnN0IHJlY3QgPSBuZXcgUGFnZW1hcmtSZWN0KGFubm90YXRpb25SZWN0KTtcblxuICAgICAgICAvLyBGSVhNRTogdGhlIGxhc3RVcGRhdGVkIGhlcmUgaXNuJ3QgYmVpbmcgdXBkYXRlZC4gSSdtIGdvaW5nIHRvXG4gICAgICAgIC8vIGhhdmUgdG8gY2hhbmdlIHRoZSBzZXR0ZXJzIEkgdGhpbmsuLlxuXG4gICAgICAgIGlmIChib3hNb3ZlRXZlbnQuc3RhdGUgPT09IFwiY29tcGxldGVkXCIpIHtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJCb3ggbW92ZSBjb21wbGV0ZWQuICBVcGRhdGluZyB0byB0cmlnZ2VyIHBlcnNpc3RlbmNlLlwiKTtcblxuICAgICAgICAgICAgY29uc3QgYW5ub3RhdGlvbkV2ZW50ID0gdGhpcy5hbm5vdGF0aW9uRXZlbnQhO1xuICAgICAgICAgICAgY29uc3QgcGFnZU51bSA9IGFubm90YXRpb25FdmVudC5wYWdlTWV0YS5wYWdlSW5mby5udW07XG4gICAgICAgICAgICBjb25zdCBkb2NNZXRhID0gYW5ub3RhdGlvbkV2ZW50LmRvY01ldGE7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gRG9jTWV0YXMuZ2V0UGFnZU1ldGEoZG9jTWV0YSwgcGFnZU51bSk7XG5cbiAgICAgICAgICAgIC8vIHJlLXJlYWQgdGhlIGN1cnJlbnQgcGFnZW1hcmsgZnJvbSB0aGUgbW9kZWxcbiAgICAgICAgICAgIHRoaXMucGFnZW1hcmsgPSBwYWdlTWV0YS5wYWdlbWFya3NbdGhpcy5wYWdlbWFyayEuaWRdO1xuXG4gICAgICAgICAgICBjb25zdCBuZXdQYWdlbWFyayA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMucGFnZW1hcmspO1xuICAgICAgICAgICAgbmV3UGFnZW1hcmsucGVyY2VudGFnZSA9IHJlY3QudG9QZXJjZW50YWdlKCk7XG4gICAgICAgICAgICBuZXdQYWdlbWFyay5yZWN0ID0gcmVjdDtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJOZXcgcGFnZW1hcms6IFwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLnBhZ2VtYXJrLCBudWxsLCBcIiAgXCIpKTtcbiAgICAgICAgICAgIFBhZ2VtYXJrcy51cGRhdGVQYWdlbWFyayhhbm5vdGF0aW9uRXZlbnQuZG9jTWV0YSwgcGFnZU51bSwgbmV3UGFnZW1hcmspO1xuXG4gICAgICAgICAgICB0aGlzLnBhZ2VtYXJrID0gbmV3UGFnZW1hcms7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKFwiTmV3IHBhZ2VtYXJrOiBcIiwgSlNPTi5zdHJpbmdpZnkodGhpcy5wYWdlbWFyaywgbnVsbCwgXCIgIFwiKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsb2cuaW5mbyhcIk5ldyBwYWdlbWFya1JlY3Q6IFwiLCB0aGlzLnBhZ2VtYXJrIS5yZWN0KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHJlbmRlcigpIHtcblxuICAgICAgICAvLyBUT0RPOiBwbGFjZW1lbkVsZW1lbnQgc2hvdWxkIGJlIGNhbGxlZCBjb250YWluZXJFbGVtZW50XG5cbiAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIGhhdmUgcGFnZW1hcmtSZWN0IGFuZCBwb3NpdGlvbmVkUGFnZW1hcmtSZWN0IHRvb1xuXG4gICAgICAgIC8vIFRPRE86IHNlZSBvZiB0ZW1wbGF0ZUVsZW1lbnQgYW5kIHBsYWNlbWVudEVsZW1lbnQgYXJlIGFsd2F5cyB0aGVcbiAgICAgICAgLy8gICAgICAgc2FtZSBub3cuICBUaGV5IG1pZ2h0IGJlLlxuXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC0gdGhlIG9wdGlvbnMgYnVpbGRpbmcgY2FuJ3QgYmUgcmVsaWFibHkgdGVzdGVkXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC0gdGhlcmUgYXJlIHRvbyBtYW55IHdheXMgdG8gY29tcHV0ZSB0aGUgb3B0aW9uc1xuICAgICAgICAvL1xuICAgICAgICAvLyAtIHdlIFBMQUNFIHRoZSBlbGVtZW50IGFzIHBhcnQgb2YgdGhpcyBmdW5jdGlvbi4gIEhhdmUgYSBzZWNvbmRhcnlcbiAgICAgICAgLy8gICB3YXkgdG8ganVzdCBDUkVBVEUgdGhlIGVsZW1lbnQgc28gdGhhdCB3ZSBjYW4gdGVzdCB0aGUgc2V0dGluZ3NcbiAgICAgICAgLy8gICBwcm9wZXJseS5cblxuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmFubm90YXRpb25FdmVudCEuY29udGFpbmVyO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoY29udGFpbmVyLCBcImNvbnRhaW5lclwiKTtcblxuICAgICAgICBpZiAoIXRoaXMucGFnZW1hcmspIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhZ2VtYXJrIGlzIHJlcXVpcmVkXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLnBhZ2VtYXJrLnBlcmNlbnRhZ2UpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhZ2VtYXJrIGhhcyBubyBwZXJjZW50YWdlXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRlbXBsYXRlRWxlbWVudCA9IHRoaXMub3B0aW9ucy50ZW1wbGF0ZUVsZW1lbnQ7XG4gICAgICAgIGxldCBwbGFjZW1lbnRFbGVtZW50ID0gdGhpcy5vcHRpb25zLnBsYWNlbWVudEVsZW1lbnQ7XG5cbiAgICAgICAgaWYgKCF0ZW1wbGF0ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRlbXBsYXRlRWxlbWVudCA9IGNvbnRhaW5lci5lbGVtZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEgcGxhY2VtZW50RWxlbWVudCkge1xuICAgICAgICAgICAgLy8gVE9ETzogbW92ZSB0aGlzIHRvIHRoZSBwcm9wZXIgY29tcG9uZW50XG4gICAgICAgICAgICBwbGFjZW1lbnRFbGVtZW50ID0gPEhUTUxFbGVtZW50PiBjb250YWluZXIuZWxlbWVudC5xdWVyeVNlbGVjdG9yKFwiLmNhbnZhc1dyYXBwZXIsIC5pZnJhbWVXcmFwcGVyXCIpO1xuICAgICAgICAgICAgLy8gVE9ETzogd2UgbmVlZCB0byBjb2RlIHRoaXMgZGlyZWN0bHkgaW50byB0aGUgY2FsbGVyXG4gICAgICAgICAgICBsb2cuZGVidWcoXCJVc2luZyBhIGRlZmF1bHQgcGxhY2VtZW50RWxlbWVudCBmcm9tIHNlbGVjdG9yOiBcIiwgcGxhY2VtZW50RWxlbWVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwodGVtcGxhdGVFbGVtZW50LCBcInRlbXBsYXRlRWxlbWVudFwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKHBsYWNlbWVudEVsZW1lbnQsIFwicGxhY2VtZW50RWxlbWVudFwiKTtcblxuICAgICAgICBsb2cuaW5mbyhcIlVzaW5nIHRlbXBsYXRlRWxlbWVudDogXCIsIHRlbXBsYXRlRWxlbWVudCk7XG4gICAgICAgIGxvZy5pbmZvKFwiVXNpbmcgcGxhY2VtZW50RWxlbWVudDogXCIsIHBsYWNlbWVudEVsZW1lbnQpO1xuXG4gICAgICAgIC8vIGEgdW5pcXVlIElEIGluIHRoZSBET00gZm9yIHRoaXMgZWxlbWVudC5cbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLmNyZWF0ZUlEKCk7XG5cbiAgICAgICAgbGV0IHBhZ2VtYXJrRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcblxuICAgICAgICBpZiAocGFnZW1hcmtFbGVtZW50ID09PSBudWxsICkge1xuICAgICAgICAgICAgLy8gb25seSBjcmVhdGUgdGhlIHBhZ2VtYXJrIGlmIGl0J3MgbWlzc2luZy5cbiAgICAgICAgICAgIHBhZ2VtYXJrRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiaWRcIiwgaWQpO1xuXG4gICAgICAgICAgICBwbGFjZW1lbnRFbGVtZW50LnBhcmVudEVsZW1lbnQhLmluc2VydEJlZm9yZShwYWdlbWFya0VsZW1lbnQsIHBsYWNlbWVudEVsZW1lbnQpO1xuXG4gICAgICAgICAgICBpZiAoRU5BQkxFX0JPWF9DT05UUk9MTEVSKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJDcmVhdGluZyBib3ggY29udHJvbGxlciBmb3IgcGFnZW1hcmtFbGVtZW50OiBcIiwgcGFnZW1hcmtFbGVtZW50KTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhZ2VtYXJrQm94Q29udHJvbGxlci5yZWdpc3Rlcih7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldDogcGFnZW1hcmtFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICByZXN0cmljdGlvbkVsZW1lbnQ6IHBsYWNlbWVudEVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdGVkRWxlbWVudHNTZWxlY3RvcjogXCIucGFnZW1hcmtcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhbm5vdGF0aW9uRXZlbnQgPSB0aGlzLmFubm90YXRpb25FdmVudCE7XG5cbiAgICAgICAgLy8gc2V0IGEgcGFnZW1hcmstaWQgaW4gdGhlIERPTSBzbyB0aGF0IHdlIGNhbiB3b3JrIHdpdGggaXQgd2hlbiB3ZSB1c2VcbiAgICAgICAgLy8gdGhlIGNvbnRleHQgbWVudSwgZXRjLlxuICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGR1cGxpY2F0ZWQgY29kZSBhY3Jvc3MgdGhyZWUgcGxhY2VzLi4gYWxsIG1ham9yXG4gICAgICAgIC8vIGFubm90YXRpb24gY29tcG9uZW50cy5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtcGFnZW1hcmstaWRcIiwgdGhpcy5wYWdlbWFyay5pZCk7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24taWRcIiwgdGhpcy5wYWdlbWFyay5pZCk7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24tdHlwZVwiLCBcInBhZ2VtYXJrXCIpO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLWRvYy1maW5nZXJwcmludFwiLCBhbm5vdGF0aW9uRXZlbnQuZG9jTWV0YS5kb2NJbmZvLmZpbmdlcnByaW50KTtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtYW5ub3RhdGlvbi1wYWdlLW51bVwiLCBgJHthbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEucGFnZUluZm8ubnVtfWApO1xuXG5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtdHlwZVwiLCBcInBhZ2VtYXJrXCIpO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1kb2MtZmluZ2VycHJpbnRcIiwgYW5ub3RhdGlvbkV2ZW50LmRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCk7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLXBhZ2UtbnVtXCIsIGAke2Fubm90YXRpb25FdmVudC5wYWdlTWV0YS5wYWdlSW5mby5udW19YCk7XG5cblxuICAgICAgICAvLyBtYWtlIHN1cmUgd2UgaGF2ZSBhIHJlbGlhYmxlIENTUyBjbGFzc25hbWUgdG8gd29yayB3aXRoLlxuICAgICAgICBwYWdlbWFya0VsZW1lbnQuY2xhc3NOYW1lID0gXCJwYWdlbWFyayBhbm5vdGF0aW9uXCI7XG5cbiAgICAgICAgLy8gcGFnZW1hcmsuc3R5bGUuYmFja2dyb3VuZENvbG9yPVwicmdiKDE5OCwgMTk4LCAxOTgpXCI7XG5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtDb2xvciA9IHRoaXMudG9QYWdlbWFya0NvbG9yKCk7XG5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHBhZ2VtYXJrQ29sb3IuYmFja2dyb3VuZENvbG9yO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUub3BhY2l0eSA9IFwiXCIgKyBwYWdlbWFya0NvbG9yLm9wYWNpdHk7XG5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuXG4gICAgICAgIC8vIFRPRE86IHdlIGRvbid0IGFjdHVhbGx5IG5lZWQgdGhlIHBsYWNlbWVudCByZWN0Li4ganVzdCB0aGUgZGltZW5zaW9uc1xuICAgICAgICAvLyBvZiB0aGUgY29udGFpbmVyLlxuICAgICAgICBjb25zdCBwbGFjZW1lbnRSZWN0ID0gdGhpcy5jcmVhdGVQbGFjZW1lbnRSZWN0KHBsYWNlbWVudEVsZW1lbnQpO1xuICAgICAgICBjb25zdCBwYWdlbWFya1JlY3QgPSB0aGlzLnRvT3ZlcmxheVJlY3QocGxhY2VtZW50UmVjdCwgdGhpcy5wYWdlbWFyayk7XG5cbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ3ByaW1hcnknKSB7XG5cbiAgICAgICAgICAgIGlmIChwYWdlbWFya0VsZW1lbnQuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVJbnRlcm5hbERpdihwYWdlbWFya0VsZW1lbnQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICAvLyBUT0RPOiB3aGF0IEkgbmVlZCBpcyBhIGdlbmVyaWMgd2F5IHRvIGNvdmVyIGFuIGVsZW1lbnQgYW5kIHBsYWNlXG4gICAgICAgIC8vIHNvbWV0aGluZyBvbiB0b3Agb2YgaXQgbm8gbWF0dGVyIHdoYXQgcG9zaXRpb25pbmcgc3RyYXRlZ3kgaXQgdXNlcy5cblxuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUubGVmdCA9IGAke3BhZ2VtYXJrUmVjdC5sZWZ0fXB4YDtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLnRvcCA9IGAke3BhZ2VtYXJrUmVjdC50b3B9cHhgO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUud2lkdGggPSBgJHtwYWdlbWFya1JlY3Qud2lkdGh9cHhgO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gYCR7cGFnZW1hcmtSZWN0LmhlaWdodH1weGA7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zdHlsZS56SW5kZXggPSAnOSc7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGludGVybmFsIGRpdiB0aGF0IGFsbG93cyB1cyB0byB0dXJuIG9mZiBwb2ludGVyLWV2ZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlSW50ZXJuYWxEaXYocGFnZW1hcmtFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIC8vIEZJWE1FOiB0aGlzIHdvcmtzIEJVRyB3ZSBoYXZlIGEgcHJvYmxlbSBub3cgd2l0aCB0aGUgY29udGV4dCBtZW51XG4gICAgICAgIC8vIG5vdCBzaG93aW5nIHRoYXQgdGhlIHBhZ2VtYXJrIGlzIHNlbGVjdGVkLi4uICBJIHRoaW5rIEkgaGF2ZSB0byB1c2VcbiAgICAgICAgLy8gZWxlbWVudHNBdFBvaW50IHRvIHJlY29uc3RydWN0IHRoYXQgdGhpcyBpcyBvbiBhIHBhZ2VtYXJrLlxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZUludGVybmFsRGl2ID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBpbnRlcm5hbERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgICAgICAgICAvLyBpbnRlcm5hbERpdi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAncGluayc7XG4gICAgICAgICAgICBpbnRlcm5hbERpdi5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nO1xuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuXG4gICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxEaXY7XG5cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBjcmVhdGVIb3Jpem9udGFsSW50ZXJuYWxEaXYgPSAoKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGludGVybmFsRGl2ID0gY3JlYXRlSW50ZXJuYWxEaXYoKTtcblxuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUud2lkdGggPSAnMTAwJSc7XG4gICAgICAgICAgICBpbnRlcm5hbERpdi5zdHlsZS5oZWlnaHQgPSAnMm1tJztcblxuICAgICAgICAgICAgcmV0dXJuIGludGVybmFsRGl2O1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY3JlYXRlVmVydGljYWxJbnRlcm5hbERpdiA9ICgpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgaW50ZXJuYWxEaXYgPSBjcmVhdGVJbnRlcm5hbERpdigpO1xuXG4gICAgICAgICAgICBpbnRlcm5hbERpdi5zdHlsZS53aWR0aCA9ICcybW0nO1xuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnO1xuXG4gICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxEaXY7XG5cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBjcmVhdGVJbnRlcm5hbERpdnMgPSAoKSA9PiB7XG5cbiAgICAgICAgICAgIC8vIFRPRE86IHRoaXMgY291bGQgYmUgY2xlYW5lZCB1cCBhIGJpdCBieSBwYXNzaW5nIHBvc2l0aW9uIGRpcmVjdGx5XG5cbiAgICAgICAgICAgIGNvbnN0IGxlZnQgPSBjcmVhdGVWZXJ0aWNhbEludGVybmFsRGl2KCk7XG4gICAgICAgICAgICBsZWZ0LnN0eWxlLmxlZnQgPSAnMCc7XG4gICAgICAgICAgICBsZWZ0LnN0eWxlLnRvcCA9ICcwJztcblxuICAgICAgICAgICAgY29uc3QgcmlnaHQgPSBjcmVhdGVWZXJ0aWNhbEludGVybmFsRGl2KCk7XG4gICAgICAgICAgICByaWdodC5zdHlsZS5yaWdodCA9ICcwJztcbiAgICAgICAgICAgIHJpZ2h0LnN0eWxlLnRvcCA9ICcwJztcblxuICAgICAgICAgICAgY29uc3QgdG9wID0gY3JlYXRlSG9yaXpvbnRhbEludGVybmFsRGl2KCk7XG4gICAgICAgICAgICB0b3Auc3R5bGUubGVmdCA9ICcwJztcbiAgICAgICAgICAgIHRvcC5zdHlsZS50b3AgPSAnMCc7XG5cbiAgICAgICAgICAgIGNvbnN0IGJvdHRvbSA9IGNyZWF0ZUhvcml6b250YWxJbnRlcm5hbERpdigpO1xuICAgICAgICAgICAgYm90dG9tLnN0eWxlLmJvdHRvbSA9ICcwJztcbiAgICAgICAgICAgIGJvdHRvbS5zdHlsZS5sZWZ0ID0gJzAnO1xuXG4gICAgICAgICAgICByZXR1cm4gWyBsZWZ0LCByaWdodCwgdG9wLCBib3R0b21dO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgaW50ZXJuYWxEaXZzID0gY3JlYXRlSW50ZXJuYWxEaXZzKCk7XG5cbiAgICAgICAgdHlwZSBQb2ludGVyRXZlbnRzID0gJ2F1dG8nIHwgJ25vbmUnO1xuXG4gICAgICAgIGxldCBwb2ludGVyRXZlbnRzOiBQb2ludGVyRXZlbnRzID0gJ2F1dG8nO1xuXG4gICAgICAgIGNvbnN0IGRvQ2hhbmdlUG9pbnRlckV2ZW50cyA9IChuZXdWYWx1ZTogUG9pbnRlckV2ZW50cykgPT4ge1xuXG4gICAgICAgICAgICBpZiAocG9pbnRlckV2ZW50cyAhPT0gbmV3VmFsdWUpIHtcbiAgICAgICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHMgPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAoY29uc3QgaW50ZXJuYWxEaXYgb2YgaW50ZXJuYWxEaXZzKSB7XG5cbiAgICAgICAgICAgIGludGVybmFsRGl2LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBkb0NoYW5nZVBvaW50ZXJFdmVudHMoJ2F1dG8nKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGludGVybmFsRGl2LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBkb0NoYW5nZVBvaW50ZXJFdmVudHMoJ25vbmUnKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHBhZ2VtYXJrRWxlbWVudC5hcHBlbmRDaGlsZChpbnRlcm5hbERpdik7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0b1BhZ2VtYXJrQ29sb3IoKSB7XG5cbiAgICAgICAgY2xhc3MgUGFnZW1hcmtDb2xvcnMge1xuXG4gICAgICAgICAgICBwdWJsaWMgc3RhdGljIEJMVUUgPSB7XG4gICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBcIiMwMENDRkZcIixcbiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjNcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHB1YmxpYyBzdGF0aWMgTElHSFRCTFVFID0ge1xuICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogXCIjMDBDQ0ZGXCIsXG4gICAgICAgICAgICAgICAgb3BhY2l0eTogMC4xNVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcHVibGljIHN0YXRpYyBHUkVZID0ge1xuICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogXCJyZ2IoMTI1LCAxMjUsIDEyNSlcIixcbiAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjNcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIHRoaXMucGFnZW1hcmspIHtcbiAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5CTFVFO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLnBhZ2VtYXJrLm1vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5CTFVFO1xuICAgICAgICB9XG5cbiAgICAgICAgc3dpdGNoICh0aGlzLnBhZ2VtYXJrLm1vZGUpIHtcblxuICAgICAgICAgICAgY2FzZSBQYWdlbWFya01vZGUuSUdOT1JFRDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuR1JFWTtcblxuICAgICAgICAgICAgY2FzZSBQYWdlbWFya01vZGUuVEFCTEVfT0ZfQ09OVEVOVFM6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFBhZ2VtYXJrQ29sb3JzLkdSRVk7XG5cbiAgICAgICAgICAgIGNhc2UgUGFnZW1hcmtNb2RlLkFQUEVOREVYOlxuICAgICAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5HUkVZO1xuXG4gICAgICAgICAgICBjYXNlIFBhZ2VtYXJrTW9kZS5SRUZFUkVOQ0VTOlxuICAgICAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5HUkVZO1xuXG4gICAgICAgICAgICBjYXNlIFBhZ2VtYXJrTW9kZS5QUkVfUkVBRDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuTElHSFRCTFVFO1xuXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5CTFVFO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIHB1YmxpYyBkZXN0cm95KCkge1xuXG4gICAgICAgIGNvbnN0IHBhZ2VtYXJrRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuY3JlYXRlSUQoKSk7XG5cbiAgICAgICAgaWYgKHBhZ2VtYXJrRWxlbWVudCkge1xuXG4gICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQuaW5uZXJIVE1MID0gJyc7XG5cbiAgICAgICAgICAgIGlmIChwYWdlbWFya0VsZW1lbnQucGFyZW50RWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHBhZ2VtYXJrRWxlbWVudC5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHBhZ2VtYXJrRWxlbWVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVQbGFjZW1lbnRSZWN0KHBsYWNlbWVudEVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgY29uc3QgcG9zaXRpb25pbmcgPSBTdHlsZXMucG9zaXRpb25pbmcocGxhY2VtZW50RWxlbWVudCk7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uaW5nUFggPSBTdHlsZXMucG9zaXRpb25pbmdUb1BYKHBvc2l0aW9uaW5nKTtcblxuICAgICAgICAvLyBUT0RPOiB0aGlzIGNvdWxkIGJlIGNsZWFuZWQgdXAgYSBiaXQuLi5cblxuICAgICAgICAvLyBGSVhNRTogdGhlIG9mZnNldFdpZHRoIGRvZXMgbm90IHByb3Blcmx5IGhhdmUgdGhlIHdpZHRoIGFwcGxpZWQgdG9cbiAgICAgICAgLy8gaXQgZm9yIHNvbWUgcmVhc29uIHdoZW4gc2NhbGUgaXMgYmVpbmcgdXNlZC4gIGdldEJvdW5kaW5nQ2xpZW50UmVjdFxuICAgICAgICAvLyB3b3JrcyB0aG91Z2guXG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgbGVmdDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC5sZWZ0KS5nZXRPckVsc2UocGxhY2VtZW50RWxlbWVudC5vZmZzZXRMZWZ0KSxcbiAgICAgICAgICAgIHRvcDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC50b3ApLmdldE9yRWxzZShwbGFjZW1lbnRFbGVtZW50Lm9mZnNldFRvcCksXG4gICAgICAgICAgICB3aWR0aDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC53aWR0aCkuZ2V0T3JFbHNlKHBsYWNlbWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLFxuICAgICAgICAgICAgaGVpZ2h0OiBPcHRpb25hbC5vZihwb3NpdGlvbmluZ1BYLmhlaWdodCkuZ2V0T3JFbHNlKHBsYWNlbWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSxcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdChyZXN1bHQpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgdW5pcXVlIERPTSBJRCBmb3IgdGhpcyBwYWdlbWFyay5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZUlEKCkge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy50eXBlfS1wYWdlbWFyay0ke3RoaXMucGFnZW1hcmshLmlkfWA7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogSSBoYXZlIHRvIGltcHJvdmUgdGhpcyBncmFtbWFyLi4uIHBsYWNlbWVudCwgcG9zaXRpb25lZCwgZXRjLi5cbiAgICAvLyB3aGljaCBvbmUgaXMgd2hpY2guXG5cbiAgICBwcml2YXRlIHRvT3ZlcmxheVJlY3QocGxhY2VtZW50UmVjdDogUmVjdCwgcGFnZW1hcms6IFBhZ2VtYXJrKSB7XG5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtSZWN0ID0gbmV3IFBhZ2VtYXJrUmVjdChwYWdlbWFyay5yZWN0KTtcblxuICAgICAgICBjb25zdCBvdmVybGF5UmVjdCA9IHBhZ2VtYXJrUmVjdC50b0RpbWVuc2lvbnMocGxhY2VtZW50UmVjdC5kaW1lbnNpb25zKTtcblxuICAgICAgICAvLyB3ZSBoYXZlIHRvIGFwcGx5IHRoZSBvcmlnaW5hbCBwbGFjZW1lbnRSZWN0IHRvcCBhbmQgbGVmdCBzbyBpdCdzXG4gICAgICAgIC8vIHBsYWNlZCBhcyBhIHByb3BlciBvdmVybGF5XG4gICAgICAgIHJldHVybiBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHtcbiAgICAgICAgICAgIGxlZnQ6IG92ZXJsYXlSZWN0LmxlZnQgKyBwbGFjZW1lbnRSZWN0LmxlZnQsXG4gICAgICAgICAgICB0b3A6IG92ZXJsYXlSZWN0LnRvcCArIHBsYWNlbWVudFJlY3QudG9wLFxuICAgICAgICAgICAgd2lkdGg6IG92ZXJsYXlSZWN0LndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBvdmVybGF5UmVjdC5oZWlnaHQsXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRWxlbWVudE9wdGlvbnMge1xuICAgIHRlbXBsYXRlRWxlbWVudD86IEhUTUxFbGVtZW50O1xuICAgIHBsYWNlbWVudEVsZW1lbnQ/OiBIVE1MRWxlbWVudDtcbn1cblxudHlwZSBQYWdlbWFya0NvbXBvbmVudFR5cGUgPSAncHJpbWFyeScgfCAndGh1bWJuYWlsJztcblxuaW50ZXJmYWNlIFBhZ2VtYXJrQ29sb3Ige1xuICAgIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICAgIG9wYWNpdHk6IG51bWJlcjtcbn1cbiJdfQ==