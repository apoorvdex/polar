"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DocFormatFactory_1 = require("../../docformat/DocFormatFactory");
const AnnotationPointers_1 = require("../../annotations/AnnotationPointers");
const Logger_1 = require("../../logger/Logger");
const Pagemarks_1 = require("../../metadata/Pagemarks");
const PagemarkRects_1 = require("../../metadata/PagemarkRects");
const PagemarkMode_1 = require("../../metadata/PagemarkMode");
const Rects_1 = require("../../Rects");
const Optional_1 = require("../../util/ts/Optional");
const RendererAnalytics_1 = require("../../ga/RendererAnalytics");
const DocMetas_1 = require("../../metadata/DocMetas");
const log = Logger_1.Logger.create();
class PagemarkController {
    constructor(model) {
        this.model = model;
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
    }
    start() {
        window.addEventListener("message", event => this.onMessageReceived(event), false);
    }
    onMessageReceived(event) {
        log.info("Received message: ", event);
        const triggerEvent = event.data;
        switch (event.data.type) {
            case "create-pagemark":
                this.onCreatePagemark(triggerEvent);
                break;
            case "delete-pagemark":
                this.onDeletePagemark(triggerEvent);
                break;
            case "set-pagemark-mode-pre-read":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.PRE_READ);
                break;
            case "set-pagemark-mode-read":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.READ);
                break;
            case "set-pagemark-mode-ignored":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.IGNORED);
                break;
            case "set-pagemark-mode-table-of-contents":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.TABLE_OF_CONTENTS);
                break;
            case "set-pagemark-mode-table-of-appendix":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.APPENDEX);
                break;
            case "set-pagemark-mode-table-of-references":
                this.onSetPagemarkMode(triggerEvent, PagemarkMode_1.PagemarkMode.REFERENCES);
                break;
        }
    }
    onCreatePagemark(triggerEvent) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'user', action: 'created-pagemark' });
        let elements = document.elementsFromPoint(triggerEvent.points.client.x, triggerEvent.points.client.y);
        elements = elements.filter(element => element.matches(".page"));
        if (elements.length === 1) {
            const pageElement = elements[0];
            log.info("Creating box on pageElement: ", pageElement);
            const pageNum = this.docFormat.getPageNumFromPageElement(pageElement);
            const pageElementPoint = triggerEvent.points.pageOffset;
            const boxRect = Rects_1.Rects.createFromBasicRect({
                left: pageElementPoint.x,
                top: pageElementPoint.y,
                width: 300,
                height: 300
            });
            log.info("Placing box at: ", boxRect);
            const containerRect = Rects_1.Rects.createFromBasicRect({
                left: 0,
                top: 0,
                width: pageElement.offsetWidth,
                height: pageElement.offsetHeight
            });
            const pagemarkRect = PagemarkRects_1.PagemarkRects.createFromPositionedRect(boxRect, containerRect);
            const pagemark = Pagemarks_1.Pagemarks.create({ rect: pagemarkRect });
            Pagemarks_1.Pagemarks.updatePagemark(this.model.docMeta, pageNum, pagemark);
            log.info("Using pagemarkRect: ", pagemarkRect);
        }
        else {
            log.warn("Wrong number of elements selected: " + elements.length);
        }
    }
    onDeletePagemark(triggerEvent) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'user', action: 'deleted-pagemark' });
        log.info("Deleting pagemark: ", triggerEvent);
        const pagemarkIDRef = this.toPagemarkID(triggerEvent);
        if (pagemarkIDRef) {
            Pagemarks_1.Pagemarks.deletePagemark(this.model.docMeta, pagemarkIDRef.pageNum, pagemarkIDRef.id);
        }
    }
    onSetPagemarkMode(triggerEvent, mode) {
        log.info("Setting pagemark mode: ", mode);
        const pagemarkIDRef = this.toPagemarkID(triggerEvent);
        if (pagemarkIDRef) {
            const pageNum = pagemarkIDRef.pageNum;
            const pageMeta = DocMetas_1.DocMetas.getPageMeta(this.model.docMeta, pageNum);
            const pagemark = pageMeta.pagemarks[pagemarkIDRef.id];
            if (pagemark) {
                const pagemarkPTR = {
                    ref: {
                        pageNum,
                        pagemark
                    },
                    batch: pagemark.batch,
                };
                Pagemarks_1.Pagemarks.replacePagemark(this.model.docMeta, pagemarkPTR, { mode });
            }
        }
    }
    toPagemarkID(triggerEvent) {
        const annotationPointers = AnnotationPointers_1.AnnotationPointers.toAnnotationPointers(".pagemark", triggerEvent);
        log.info("Working with annotationPointers: ", annotationPointers);
        return Optional_1.Optional.first(...annotationPointers).map(annotationPointer => {
            const pageMeta = this.model.docMeta.getPageMeta(annotationPointer.pageNum);
            return {
                pageNum: annotationPointer.pageNum,
                id: annotationPointer.id
            };
        }).getOrUndefined();
    }
}
exports.PagemarkController = PagemarkController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFnZW1hcmtDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUGFnZW1hcmtDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsdUVBQWtFO0FBR2xFLDZFQUF3RTtBQUN4RSxnREFBMkM7QUFDM0Msd0RBQWdFO0FBQ2hFLGdFQUEyRDtBQUMzRCw4REFBeUQ7QUFDekQsdUNBQWtDO0FBQ2xDLHFEQUFnRDtBQUNoRCxrRUFBNkQ7QUFFN0Qsc0RBQWlEO0FBRWpELE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFhLGtCQUFrQjtJQVUzQixZQUFZLEtBQVk7UUFDcEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxtQ0FBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwRCxDQUFDO0lBRU0sS0FBSztRQUVSLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdEYsQ0FBQztJQUVPLGlCQUFpQixDQUFDLEtBQVU7UUFFaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV0QyxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBRWhDLFFBQVEsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFFckIsS0FBSyxpQkFBaUI7Z0JBQ2xCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDcEMsTUFBTTtZQUVWLEtBQUssaUJBQWlCO2dCQUNsQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ3BDLE1BQU07WUFFVixLQUFLLDRCQUE0QjtnQkFDN0IsSUFBSSxDQUFDLGlC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S0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO2lCQUV4QixDQUFDO2dCQUVGLHFCQUFTLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxFQUFDLElBQUksRUFBQyxDQUFDLENBQUM7YUFFdEU7U0FFSjtJQUdMLENBQUM7SUFDTyxZQUFZLENBQUMsWUFBMEI7UUFFM0MsTUFBTSxrQkFBa0IsR0FDbEIsdUNBQWtCLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXpFLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUVsRSxPQUFPLG1CQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsRUFBRTtZQUNqRSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFM0UsT0FBTztnQkFDSCxPQUFPLEVBQUUsaUJBQWlCLENBQUMsT0FBTztnQkFDbEMsRUFBRSxFQUFFLGlCQUFpQixDQUFDLEVBQUU7YUFDM0IsQ0FBQztRQUVOLENBQUMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBRXhCLENBQUM7Q0FHSjtBQXhNRCxnREF3TUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZGVsfSBmcm9tICcuLi8uLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge0RvY0Zvcm1hdEZhY3Rvcnl9IGZyb20gJy4uLy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5JztcbmltcG9ydCB7RG9jRm9ybWF0fSBmcm9tICcuLi8uLi9kb2Nmb3JtYXQvRG9jRm9ybWF0JztcbmltcG9ydCB7VHJpZ2dlckV2ZW50fSBmcm9tICcuLi8uLi9jb250ZXh0bWVudS9UcmlnZ2VyRXZlbnQnO1xuaW1wb3J0IHtBbm5vdGF0aW9uUG9pbnRlcnN9IGZyb20gJy4uLy4uL2Fubm90YXRpb25zL0Fubm90YXRpb25Qb2ludGVycyc7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAnLi4vLi4vbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge1BhZ2VtYXJrUFRSLCBQYWdlbWFya3N9IGZyb20gJy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrcyc7XG5pbXBvcnQge1BhZ2VtYXJrUmVjdHN9IGZyb20gJy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrUmVjdHMnO1xuaW1wb3J0IHtQYWdlbWFya01vZGV9IGZyb20gJy4uLy4uL21ldGFkYXRhL1BhZ2VtYXJrTW9kZSc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi8uLi9SZWN0cyc7XG5pbXBvcnQge09wdGlvbmFsfSBmcm9tICcuLi8uLi91dGlsL3RzL09wdGlvbmFsJztcbmltcG9ydCB7UmVuZGVyZXJBbmFseXRpY3N9IGZyb20gJy4uLy4uL2dhL1JlbmRlcmVyQW5hbHl0aWNzJztcbmltcG9ydCB7UGFnZW1hcmtJRFJlZn0gZnJvbSAnLi4vLi4vbWV0YWRhdGEvUGFnZW1hcmsnO1xuaW1wb3J0IHtEb2NNZXRhc30gZnJvbSAnLi4vLi4vbWV0YWRhdGEvRG9jTWV0YXMnO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBQYWdlbWFya0NvbnRyb2xsZXIge1xuXG4gICAgcHJpdmF0ZSBtb2RlbDogTW9kZWw7XG5cbiAgICBwcml2YXRlIGRvY0Zvcm1hdDogRG9jRm9ybWF0O1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbW9kZWwge01vZGVsfVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG1vZGVsOiBNb2RlbCkge1xuICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7XG4gICAgICAgIHRoaXMuZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwgZXZlbnQgPT4gdGhpcy5vbk1lc3NhZ2VSZWNlaXZlZChldmVudCksIGZhbHNlKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgb25NZXNzYWdlUmVjZWl2ZWQoZXZlbnQ6IGFueSkge1xuXG4gICAgICAgIGxvZy5pbmZvKFwiUmVjZWl2ZWQgbWVzc2FnZTogXCIsIGV2ZW50KTtcblxuICAgICAgICBjb25zdCB0cmlnZ2VyRXZlbnQgPSBldmVudC5kYXRhO1xuXG4gICAgICAgIHN3aXRjaCAoZXZlbnQuZGF0YS50eXBlKSB7XG5cbiAgICAgICAgICAgIGNhc2UgXCJjcmVhdGUtcGFnZW1hcmtcIjpcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ3JlYXRlUGFnZW1hcmsodHJpZ2dlckV2ZW50KTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBcImRlbGV0ZS1wYWdlbWFya1wiOlxuICAgICAgICAgICAgICAgIHRoaXMub25EZWxldGVQYWdlbWFyayh0cmlnZ2VyRXZlbnQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwic2V0LXBhZ2VtYXJrLW1vZGUtcHJlLXJlYWRcIjpcbiAgICAgICAgICAgICAgICB0aGlzLm9uU2V0UGFnZW1hcmtNb2RlKHRyaWdnZXJFdmVudCwgUGFnZW1hcmtNb2RlLlBSRV9SRUFEKTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBcInNldC1wYWdlbWFyay1tb2RlLXJlYWRcIjpcbiAgICAgICAgICAgICAgICB0aGlzLm9uU2V0UGFnZW1hcmtNb2RlKHRyaWdnZXJFdmVudCwgUGFnZW1hcmtNb2RlLlJFQUQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwic2V0LXBhZ2VtYXJrLW1vZGUtaWdub3JlZFwiOlxuICAgICAgICAgICAgICAgIHRoaXMub25TZXRQYWdlbWFya01vZGUodHJpZ2dlckV2ZW50LCBQYWdlbWFya01vZGUuSUdOT1JFRCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgXCJzZXQtcGFnZW1hcmstbW9kZS10YWJsZS1vZi1jb250ZW50c1wiOlxuICAgICAgICAgICAgICAgIHRoaXMub25TZXRQYWdlbWFya01vZGUodHJpZ2dlckV2ZW50LCBQYWdlbWFya01vZGUuVEFCTEVfT0ZfQ09OVEVOVFMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwic2V0LXBhZ2VtYXJrLW1vZGUtdGFibGUtb2YtYXBwZW5kaXhcIjpcbiAgICAgICAgICAgICAgICB0aGlzLm9uU2V0UGFnZW1hcmtNb2RlKHRyaWdnZXJFdmVudCwgUGFnZW1hcmtNb2RlLkFQUEVOREVYKTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBcInNldC1wYWdlbWFyay1tb2RlLXRhYmxlLW9mLXJlZmVyZW5jZXNcIjpcbiAgICAgICAgICAgICAgICB0aGlzLm9uU2V0UGFnZW1hcmtNb2RlKHRyaWdnZXJFdmVudCwgUGFnZW1hcmtNb2RlLlJFRkVSRU5DRVMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgb25DcmVhdGVQYWdlbWFyayh0cmlnZ2VyRXZlbnQ6IFRyaWdnZXJFdmVudCkge1xuXG4gICAgICAgIFJlbmRlcmVyQW5hbHl0aWNzLmV2ZW50KHtjYXRlZ29yeTogJ3VzZXInLCBhY3Rpb246ICdjcmVhdGVkLXBhZ2VtYXJrJ30pO1xuXG4gICAgICAgIC8vIGNvbnZlcnQgdGhlIHBvaW50IG9uIHRoZSBwYWdlIGFuZCB0aGVuIHNhdmUgaXQgaW50byB0aGVcbiAgICAgICAgLy8gbW9kZWwvZG9jTWV0YS4uLiB0aGUgdmlldyB3aWxsIGRvIHRoZSByZXN0LlxuXG4gICAgICAgIC8vIEZJWE1FIG1pZ3JhdGUgdGhpcyB0byBBbm5vdGF0aW9uUmVjdHMgbm93IGFzIHRoaXMgc2hhcmVzIGEgbG90IG9mXG4gICAgICAgIC8vIGNvZGUgaGVyZS4uLlxuXG4gICAgICAgIGxldCBlbGVtZW50cyA9IGRvY3VtZW50LmVsZW1lbnRzRnJvbVBvaW50KHRyaWdnZXJFdmVudC5wb2ludHMuY2xpZW50LngsIHRyaWdnZXJFdmVudC5wb2ludHMuY2xpZW50LnkpO1xuXG4gICAgICAgIGVsZW1lbnRzID0gZWxlbWVudHMuZmlsdGVyKGVsZW1lbnQgPT4gZWxlbWVudC5tYXRjaGVzKFwiLnBhZ2VcIikpO1xuXG4gICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDEpIHtcblxuICAgICAgICAgICAgY29uc3QgcGFnZUVsZW1lbnQgPSA8SFRNTEVsZW1lbnQ+IGVsZW1lbnRzWzBdO1xuXG4gICAgICAgICAgICBsb2cuaW5mbyhcIkNyZWF0aW5nIGJveCBvbiBwYWdlRWxlbWVudDogXCIsIHBhZ2VFbGVtZW50KTtcblxuICAgICAgICAgICAgY29uc3QgcGFnZU51bSA9IHRoaXMuZG9jRm9ybWF0LmdldFBhZ2VOdW1Gcm9tUGFnZUVsZW1lbnQocGFnZUVsZW1lbnQpO1xuXG4gICAgICAgICAgICAvLyBnZXQgdGhlIHBvaW50IHdpdGhpbiB0aGUgZWxlbWVudCBpdHNlbGYuLlxuICAgICAgICAgICAgY29uc3QgcGFnZUVsZW1lbnRQb2ludCA9IHRyaWdnZXJFdmVudC5wb2ludHMucGFnZU9mZnNldDtcblxuICAgICAgICAgICAgY29uc3QgYm94UmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgIGxlZnQ6IHBhZ2VFbGVtZW50UG9pbnQueCxcbiAgICAgICAgICAgICAgICB0b3A6IHBhZ2VFbGVtZW50UG9pbnQueSxcbiAgICAgICAgICAgICAgICB3aWR0aDogMzAwLFxuICAgICAgICAgICAgICAgIGhlaWdodDogMzAwXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJQbGFjaW5nIGJveCBhdDogXCIsIGJveFJlY3QpO1xuXG4gICAgICAgICAgICAvLyBnZXQgYSByZWN0IGZvciB0aGUgZWxlbWVudC4uLiB3ZSByZWFsbHkgb25seSBuZWVkIHRoZSBkaW1lbnNpb25zXG4gICAgICAgICAgICAvLyB0aG91Z2guLiBub3QgdGhlIHdpZHRoIGFuZCBoZWlnaHQuXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXJSZWN0ID0gUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdCh7XG4gICAgICAgICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICAgICAgd2lkdGg6IHBhZ2VFbGVtZW50Lm9mZnNldFdpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodDogcGFnZUVsZW1lbnQub2Zmc2V0SGVpZ2h0XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgcGFnZW1hcmtSZWN0ID0gUGFnZW1hcmtSZWN0cy5jcmVhdGVGcm9tUG9zaXRpb25lZFJlY3QoYm94UmVjdCwgY29udGFpbmVyUmVjdCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VtYXJrID0gUGFnZW1hcmtzLmNyZWF0ZSh7cmVjdDogcGFnZW1hcmtSZWN0fSk7XG5cbiAgICAgICAgICAgIFBhZ2VtYXJrcy51cGRhdGVQYWdlbWFyayh0aGlzLm1vZGVsLmRvY01ldGEsIHBhZ2VOdW0sIHBhZ2VtYXJrKTtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJVc2luZyBwYWdlbWFya1JlY3Q6IFwiLCBwYWdlbWFya1JlY3QpO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiBkbyB3ZSBzb21laG93IG5lZWQgdG8gZm9jdXMgdGhlIG5ldyBwYWdlbWFyay4uLlxuXG4gICAgICAgICAgICAvLyB0aGUgb25seSB3YXkgdG8gZG8gdGhpcyBpcyB0byB3YWl0IHVudGlsIHRoZSBjb21wb25lbnQgaXMgYWRkZWRcbiAgICAgICAgICAgIC8vIHRvIHRoZSBET00gYW5kIEkgdGhpbmsgd2UgY2FuIGRvIHRoaXMgYnkgYWRkaW5nIGFuIGV2ZW50XG4gICAgICAgICAgICAvLyBsaXN0ZW5lciB0aGF0IGp1c3QgZmlyZXMgb25jZSBhbmQgdGhlbiBjYWxsIGZvY3VzKCkgb24gdGhlXG4gICAgICAgICAgICAvLyBlbGVtZW50LlxuXG4gICAgICAgICAgICAvLyB1cGRhdGUgdGhlIERvY01ldGEgd2l0aCBhIHBhZ2VtYXJrIG9uIHRoaXMgcGFnZS4uXG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy53YXJuKFwiV3JvbmcgbnVtYmVyIG9mIGVsZW1lbnRzIHNlbGVjdGVkOiBcIiArIGVsZW1lbnRzLmxlbmd0aCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgb25EZWxldGVQYWdlbWFyayh0cmlnZ2VyRXZlbnQ6IFRyaWdnZXJFdmVudCkge1xuXG4gICAgICAgIFJlbmRlcmVyQW5hbHl0aWNzLmV2ZW50KHtjYXRlZ29yeTogJ3VzZXInLCBhY3Rpb246ICdkZWxldGVkLXBhZ2VtYXJrJ30pO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiRGVsZXRpbmcgcGFnZW1hcms6IFwiLCB0cmlnZ2VyRXZlbnQpO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VtYXJrSURSZWYgPSB0aGlzLnRvUGFnZW1hcmtJRCh0cmlnZ2VyRXZlbnQpO1xuXG4gICAgICAgIGlmIChwYWdlbWFya0lEUmVmKSB7XG4gICAgICAgICAgICBQYWdlbWFya3MuZGVsZXRlUGFnZW1hcmsodGhpcy5tb2RlbC5kb2NNZXRhLCBwYWdlbWFya0lEUmVmLnBhZ2VOdW0sIHBhZ2VtYXJrSURSZWYuaWQpO1xuICAgICAgICB9XG5cbiAgICB9XG5cblxuICAgIHByaXZhdGUgb25TZXRQYWdlbWFya01vZGUodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQsIG1vZGU6IFBhZ2VtYXJrTW9kZSkge1xuXG4gICAgICAgIGxvZy5pbmZvKFwiU2V0dGluZyBwYWdlbWFyayBtb2RlOiBcIiwgbW9kZSk7XG5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtJRFJlZiA9IHRoaXMudG9QYWdlbWFya0lEKHRyaWdnZXJFdmVudCk7XG5cbiAgICAgICAgaWYgKHBhZ2VtYXJrSURSZWYpIHtcblxuICAgICAgICAgICAgY29uc3QgcGFnZU51bSA9IHBhZ2VtYXJrSURSZWYucGFnZU51bTtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gRG9jTWV0YXMuZ2V0UGFnZU1ldGEodGhpcy5tb2RlbC5kb2NNZXRhLCBwYWdlTnVtKTtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VtYXJrID0gcGFnZU1ldGEucGFnZW1hcmtzW3BhZ2VtYXJrSURSZWYuaWRdO1xuXG5cbiAgICAgICAgICAgIGlmIChwYWdlbWFyaykge1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcGFnZW1hcmtQVFI6IFBhZ2VtYXJrUFRSID0ge1xuXG4gICAgICAgICAgICAgICAgICAgIHJlZjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU51bSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VtYXJrXG4gICAgICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICAgICAgYmF0Y2g6IHBhZ2VtYXJrLmJhdGNoLFxuXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIFBhZ2VtYXJrcy5yZXBsYWNlUGFnZW1hcmsodGhpcy5tb2RlbC5kb2NNZXRhLCBwYWdlbWFya1BUUiwge21vZGV9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuXG4gICAgfVxuICAgIHByaXZhdGUgdG9QYWdlbWFya0lEKHRyaWdnZXJFdmVudDogVHJpZ2dlckV2ZW50KTogUGFnZW1hcmtJRFJlZiB8IHVuZGVmaW5lZCB7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvblBvaW50ZXJzXG4gICAgICAgICAgICA9IEFubm90YXRpb25Qb2ludGVycy50b0Fubm90YXRpb25Qb2ludGVycyhcIi5wYWdlbWFya1wiLCB0cmlnZ2VyRXZlbnQpO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiV29ya2luZyB3aXRoIGFubm90YXRpb25Qb2ludGVyczogXCIsIGFubm90YXRpb25Qb2ludGVycyk7XG5cbiAgICAgICAgcmV0dXJuIE9wdGlvbmFsLmZpcnN0KC4uLmFubm90YXRpb25Qb2ludGVycykubWFwKGFubm90YXRpb25Qb2ludGVyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gdGhpcy5tb2RlbC5kb2NNZXRhLmdldFBhZ2VNZXRhKGFubm90YXRpb25Qb2ludGVyLnBhZ2VOdW0pO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHBhZ2VOdW06IGFubm90YXRpb25Qb2ludGVyLnBhZ2VOdW0sXG4gICAgICAgICAgICAgICAgaWQ6IGFubm90YXRpb25Qb2ludGVyLmlkXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0pLmdldE9yVW5kZWZpbmVkKCk7XG5cbiAgICB9XG5cblxufVxuIl19