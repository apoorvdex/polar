"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const TraceListenerExecutor_1 = require("./TraceListenerExecutor");
const TraceEvent_1 = require("./TraceEvent");
const Preconditions_1 = require("../Preconditions");
const MutationType_1 = require("./MutationType");
const FunctionalInterface_1 = require("../util/FunctionalInterface");
const Reactor_1 = require("../reactor/Reactor");
const TraceListeners_1 = require("./TraceListeners");
const Paths_1 = require("../util/Paths");
const EVENT_NAME = "onMutation";
class TraceHandler {
    constructor(path, traceListeners, target, traceIdentifier, proxies) {
        this.path = Preconditions_1.Preconditions.assertNotNull(path, "path");
        this.target = Preconditions_1.Preconditions.assertNotNull(target, "target");
        this.traceIdentifier = Preconditions_1.Preconditions.assertNotNull(traceIdentifier, "traceIdentifier");
        this.proxies = Preconditions_1.Preconditions.assertNotNull(proxies, "proxies");
        this.reactor = new Reactor_1.Reactor();
        this.reactor.registerEvent(EVENT_NAME);
        this.addTraceListener(traceListeners);
    }
    addTraceListener(traceListeners, options = {}) {
        const traceListenerArray = [...TraceListeners_1.TraceListeners.asArray(traceListeners)];
        let eventName = EVENT_NAME;
        if (options.property) {
            eventName = `${eventName}:${options.property}`;
        }
        traceListenerArray.forEach(traceListener => {
            traceListener = FunctionalInterface_1.FunctionalInterface.create(EVENT_NAME, traceListener);
            this.reactor.addEventListener(eventName, (traceEvent) => {
                traceListener.onMutation(traceEvent);
            });
        });
        return new TraceListenerExecutor_1.TraceListenerExecutor(traceListenerArray, this);
    }
    getTraceListeners() {
        return this.reactor.getEventListeners(EVENT_NAME);
    }
    get(target, property, receiver) {
        switch (property) {
            case "__path":
                return this.path;
            case "__traceIdentifier":
                return this.traceIdentifier;
            case "__traceListeners":
                return this.getTraceListeners();
            default:
                return Reflect.get(target, property, receiver);
        }
    }
    set(target, property, value, receiver) {
        const traceListeners = this.reactor.getEventListeners(EVENT_NAME);
        if (typeof value === "object") {
            const pathPrefix = Paths_1.Paths.create(this.path, property);
            value = this.proxies.create(value, traceListeners, { pathPrefix });
        }
        const previousValue = target[property];
        const result = Reflect.set(target, property, value, receiver);
        const traceEvent = new TraceEvent_1.TraceEvent({
            path: this.path,
            mutationType: MutationType_1.MutationType.SET,
            target,
            property,
            value,
            previousValue
        });
        this.reactor.dispatchEvent(EVENT_NAME, traceEvent);
        return result;
    }
    deleteProperty(target, property) {
        const previousValue = target[property];
        const result = Reflect.deleteProperty(target, property);
        const traceEvent = new TraceEvent_1.TraceEvent({
            path: this.path,
            mutationType: MutationType_1.MutationType.DELETE,
            target,
            property,
            value: undefined,
            previousValue
        });
        this.reactor.dispatchEvent(EVENT_NAME, traceEvent);
        return result;
    }
}
exports.TraceHandler = TraceHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHJhY2VIYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVHJhY2VIYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsbUVBQThEO0FBQzlELDZDQUF3QztBQUN4QyxvREFBK0M7QUFDL0MsaURBQTRDO0FBQzVDLHFFQUFnRTtBQUNoRSxnREFBMkM7QUFDM0MscURBQWdEO0FBQ2hELHlDQUFvQztBQUdwQyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUM7QUFFaEMsTUFBYSxZQUFZO0lBd0JyQixZQUFZLElBQVksRUFDWixjQUErQixFQUMvQixNQUFXLEVBQ1gsZUFBdUIsRUFDdkIsT0FBZ0I7UUFFeEIsSUFBSSxDQUFDLElBQUksR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLE1BQU0sR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLGVBQWUsR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsT0FBTyxHQUFHLDZCQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUUvRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksaUJBQU8sRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUUxQyxDQUFDO0lBT00sZ0JBQWdCLENBQUMsY0FBK0MsRUFBRSxVQUFlLEVBQUU7UUFFdEYsTUFBTSxrQkFBa0IsR0FDQSxDQUFDLEdBQUcsK0JBQWMsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUVwRSxJQUFJLFNBQVMsR0FBRyxVQUFV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LGFBQWE7U0FDaEIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ25ELE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7Q0FFSjtBQXpKRCxvQ0F5SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1Byb3hpZXN9IGZyb20gXCIuL1Byb3hpZXNcIjtcblxuaW1wb3J0IHtUcmFjZUxpc3RlbmVyRXhlY3V0b3J9IGZyb20gXCIuL1RyYWNlTGlzdGVuZXJFeGVjdXRvclwiO1xuaW1wb3J0IHtUcmFjZUV2ZW50fSBmcm9tIFwiLi9UcmFjZUV2ZW50XCI7XG5pbXBvcnQge1ByZWNvbmRpdGlvbnN9IGZyb20gXCIuLi9QcmVjb25kaXRpb25zXCI7XG5pbXBvcnQge011dGF0aW9uVHlwZX0gZnJvbSBcIi4vTXV0YXRpb25UeXBlXCI7XG5pbXBvcnQge0Z1bmN0aW9uYWxJbnRlcmZhY2V9IGZyb20gXCIuLi91dGlsL0Z1bmN0aW9uYWxJbnRlcmZhY2VcIjtcbmltcG9ydCB7UmVhY3Rvcn0gZnJvbSBcIi4uL3JlYWN0b3IvUmVhY3RvclwiO1xuaW1wb3J0IHtUcmFjZUxpc3RlbmVyc30gZnJvbSBcIi4vVHJhY2VMaXN0ZW5lcnNcIjtcbmltcG9ydCB7UGF0aHN9IGZyb20gXCIuLi91dGlsL1BhdGhzXCI7XG5pbXBvcnQge1RyYWNlTGlzdGVuZXJ9IGZyb20gJy4vVHJhY2VMaXN0ZW5lcic7XG5cbmNvbnN0IEVWRU5UX05BTUUgPSBcIm9uTXV0YXRpb25cIjtcblxuZXhwb3J0IGNsYXNzIFRyYWNlSGFuZGxlciB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRhcmdldDogYW55O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHJhY2VJZGVudGlmaWVyOiBudW1iZXI7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3hpZXM6IFByb3hpZXM7XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSByZWFkb25seSByZWFjdG9yOiBSZWFjdG9yO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcGF0aCBUaGUgcGF0aCB0byB0aGlzIG9iamVjdC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmFjZUxpc3RlbmVycyBUaGUgbWFpbiBUcmFjZUxpc3RlbmVyXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdGFyZ2V0IFRoZSBvYmplY3QgdGhhdCBpcyB0aGUgdGFyZ2V0IG9mIHRoaXMgaGFuZGxlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmFjZUlkZW50aWZpZXIge251bWJlcn0gQSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhpcyBoYW5kbGVyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHByb3hpZXMge1Byb3hpZXN9IGNsYXNzIGZvciBjcmVhdGluZyBuZXcgdHJhY2VkIG9iamVjdHMuXG4gICAgICogUmVmZXJlbmNlZCBoZXJlIHRvIGF2b2lkIGN5Y2xpY2FsIGRlcGVuZGVuY2llcy5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihwYXRoOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgdHJhY2VMaXN0ZW5lcnM6IFRyYWNlTGlzdGVuZXJbXSxcbiAgICAgICAgICAgICAgICB0YXJnZXQ6IGFueSxcbiAgICAgICAgICAgICAgICB0cmFjZUlkZW50aWZpZXI6IG51bWJlcixcbiAgICAgICAgICAgICAgICBwcm94aWVzOiBQcm94aWVzKSB7XG5cbiAgICAgICAgdGhpcy5wYXRoID0gUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKHBhdGgsIFwicGF0aFwiKTtcbiAgICAgICAgdGhpcy50YXJnZXQgPSBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwodGFyZ2V0LCBcInRhcmdldFwiKTtcbiAgICAgICAgdGhpcy50cmFjZUlkZW50aWZpZXIgPSBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwodHJhY2VJZGVudGlmaWVyLCBcInRyYWNlSWRlbnRpZmllclwiKTtcbiAgICAgICAgdGhpcy5wcm94aWVzID0gUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKHByb3hpZXMsIFwicHJveGllc1wiKTtcblxuICAgICAgICB0aGlzLnJlYWN0b3IgPSBuZXcgUmVhY3RvcigpO1xuICAgICAgICB0aGlzLnJlYWN0b3IucmVnaXN0ZXJFdmVudChFVkVOVF9OQU1FKTtcbiAgICAgICAgdGhpcy5hZGRUcmFjZUxpc3RlbmVyKHRyYWNlTGlzdGVuZXJzKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGxpc3RlbmVyIHRvIGEgc3BlY2lmaWMgb2JqZWN0LiBCeSBkZWZhdWx0IHdlIHJldHVybiBhbGwgZXZlbnRzIGJ1dFxuICAgICAqIHlvdSBjYW4gYWxzbyBuYXJyb3cgaXQgZG93biB0byBhIHNwZWNpZmljIHByb3BlcnR5IGJ5IHNwZWNpZnlpbmcgYSBnaXZlblxuICAgICAqIHByb3BlcnR5IHRvIG1vbml0b3IuXG4gICAgICovXG4gICAgcHVibGljIGFkZFRyYWNlTGlzdGVuZXIodHJhY2VMaXN0ZW5lcnM6IFRyYWNlTGlzdGVuZXIgfCBUcmFjZUxpc3RlbmVyW10sIG9wdGlvbnM6IGFueSA9IHt9KSB7XG5cbiAgICAgICAgY29uc3QgdHJhY2VMaXN0ZW5lckFycmF5OiBUcmFjZUxpc3RlbmVyW11cbiAgICAgICAgICAgID0gPFRyYWNlTGlzdGVuZXJbXT4gWy4uLlRyYWNlTGlzdGVuZXJzLmFzQXJyYXkodHJhY2VMaXN0ZW5lcnMpXTtcblxuICAgICAgICBsZXQgZXZlbnROYW1lID0gRVZFTlRfTkFNRTtcblxuICAgICAgICBpZiAob3B0aW9ucy5wcm9wZXJ0eSkge1xuICAgICAgICAgICAgZXZlbnROYW1lID0gYCR7ZXZlbnROYW1lfToke29wdGlvbnMucHJvcGVydHl9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyYWNlTGlzdGVuZXJBcnJheS5mb3JFYWNoKHRyYWNlTGlzdGVuZXIgPT4ge1xuXG4gICAgICAgICAgICB0cmFjZUxpc3RlbmVyID0gRnVuY3Rpb25hbEludGVyZmFjZS5jcmVhdGUoRVZFTlRfTkFNRSwgdHJhY2VMaXN0ZW5lcik7XG5cbiAgICAgICAgICAgIHRoaXMucmVhY3Rvci5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgKHRyYWNlRXZlbnQ6IFRyYWNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0cmFjZUxpc3RlbmVyLm9uTXV0YXRpb24odHJhY2VFdmVudCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFRyYWNlTGlzdGVuZXJFeGVjdXRvcih0cmFjZUxpc3RlbmVyQXJyYXksIHRoaXMpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGdldFRyYWNlTGlzdGVuZXJzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZWFjdG9yLmdldEV2ZW50TGlzdGVuZXJzKEVWRU5UX05BTUUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQodGFyZ2V0OiBhbnksIHByb3BlcnR5OiBzdHJpbmcsIHJlY2VpdmVyOiBhbnkpIHtcblxuICAgICAgICBzd2l0Y2ggKHByb3BlcnR5KSB7XG5cbiAgICAgICAgICAgIC8vIHByb3ZpZGUgc29tZSBkZWZhdWx0IC8gaGlkZGVuIGZpZWxkcyB0aGF0IGNhbiBiZSB1c2VkIGZvciBkZWJ1Z1xuICAgICAgICAgICAgLy8gcmVhc29ucy5cblxuICAgICAgICAgICAgY2FzZSBcIl9fcGF0aFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGg7XG5cbiAgICAgICAgICAgIGNhc2UgXCJfX3RyYWNlSWRlbnRpZmllclwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYWNlSWRlbnRpZmllcjtcblxuICAgICAgICAgICAgY2FzZSBcIl9fdHJhY2VMaXN0ZW5lcnNcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUcmFjZUxpc3RlbmVycygpO1xuXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcik7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBzZXQodGFyZ2V0OiBhbnksIHByb3BlcnR5OiBzdHJpbmcsIHZhbHVlOiBhbnksIHJlY2VpdmVyOiBhbnkpIHtcblxuICAgICAgICAvLyBUT0RPOiBiZWZvcmUgd2UgY2hhbmdlIHRoZSB2YWx1ZSwgYWxzbyB0cmFjZSB0aGUgbmV3IGlucHV0IHZhbHVlc1xuICAgICAgICAvLyBpZiB3ZSBhcmUgZ2l2ZW4gYW4gb2JqZWN0LlxuXG4gICAgICAgIGNvbnN0IHRyYWNlTGlzdGVuZXJzID0gdGhpcy5yZWFjdG9yLmdldEV2ZW50TGlzdGVuZXJzKEVWRU5UX05BTUUpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcblxuICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBwcm94eSB0aGlzIG9iamVjdCBzaW5jZSBpdCB3b3VsZCBtZWFuIGFkZGluZyBhIG5ld1xuICAgICAgICAgICAgLy8gc3ViLWdyYXBoIHRoYXQgaXNuJ3QgdHJhY2VkLlxuXG4gICAgICAgICAgICBjb25zdCBwYXRoUHJlZml4ID0gUGF0aHMuY3JlYXRlKHRoaXMucGF0aCwgcHJvcGVydHkpO1xuXG4gICAgICAgICAgICB2YWx1ZSA9ICg8YW55PiB0aGlzLnByb3hpZXMpLmNyZWF0ZSh2YWx1ZSwgdHJhY2VMaXN0ZW5lcnMsIHtwYXRoUHJlZml4fSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByZXZpb3VzVmFsdWUgPSB0YXJnZXRbcHJvcGVydHldO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3Quc2V0KHRhcmdldCwgcHJvcGVydHksIHZhbHVlLCByZWNlaXZlcik7XG5cbiAgICAgICAgY29uc3QgdHJhY2VFdmVudCA9IG5ldyBUcmFjZUV2ZW50KHtcbiAgICAgICAgICAgIHBhdGg6IHRoaXMucGF0aCxcbiAgICAgICAgICAgIG11dGF0aW9uVHlwZTogTXV0YXRpb25UeXBlLlNFVCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgIHByb3BlcnR5LFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICBwcmV2aW91c1ZhbHVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMucmVhY3Rvci5kaXNwYXRjaEV2ZW50KEVWRU5UX05BTUUsIHRyYWNlRXZlbnQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZVByb3BlcnR5KHRhcmdldDogYW55LCBwcm9wZXJ0eTogc3RyaW5nKSB7XG5cbiAgICAgICAgY29uc3QgcHJldmlvdXNWYWx1ZSA9IHRhcmdldFtwcm9wZXJ0eV07XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gUmVmbGVjdC5kZWxldGVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5KTtcblxuICAgICAgICBjb25zdCB0cmFjZUV2ZW50ID0gbmV3IFRyYWNlRXZlbnQoe1xuICAgICAgICAgICAgcGF0aDogdGhpcy5wYXRoLFxuICAgICAgICAgICAgbXV0YXRpb25UeXBlOiBNdXRhdGlvblR5cGUuREVMRVRFLFxuICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgcHJvcGVydHksXG4gICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgcHJldmlvdXNWYWx1ZVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnJlYWN0b3IuZGlzcGF0Y2hFdmVudChFVkVOVF9OQU1FLCB0cmFjZUV2ZW50KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxufVxuIl19