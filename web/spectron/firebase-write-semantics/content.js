"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const SpectronRenderer_1 = require("../../js/test/SpectronRenderer");
const firebase = __importStar(require("../../js/firebase/lib/firebase"));
const Firestore_1 = require("../../js/firebase/Firestore");
const Hashcodes_1 = require("../../js/Hashcodes");
const Promises_1 = require("../../js/util/Promises");
const FirebaseRunner_1 = require("../../js/firebase/FirebaseRunner");
const PolarDataDir_1 = require("../../js/test/PolarDataDir");
const Strings_1 = require("../../js/util/Strings");
const AsyncWorkQueue_1 = require("../../js/util/AsyncWorkQueue");
const FirestoreQueryCursor_1 = require("../../js/firebase/FirestoreQueryCursor");
mocha.setup('bdd');
mocha.timeout(10000);
SpectronRenderer_1.SpectronRenderer.run((state) => __awaiter(this, void 0, void 0, function* () {
    new FirebaseRunner_1.FirebaseRunner(state).run(() => __awaiter(this, void 0, void 0, function* () {
        yield PolarDataDir_1.PolarDataDir.useFreshDirectory('.test-firebase-write-semantics');
        describe('Firebase Write Semantics', function () {
            it("Test receiving large snapshots", function () {
                return __awaiter(this, void 0, void 0, function* () {
                    const collectionName = "debug_large_snapshots4";
                    const doWrites = false;
                    const doTest = true;
                    const nrWrites = 5000;
                    const firestore = yield Firestore_1.Firestore.getInstance();
                    const uid = firebase.auth().currentUser.uid;
                    if (doWrites) {
                        const work = [];
                        const asyncWorkQueue = new AsyncWorkQueue_1.AsyncWorkQueue(work);
                        for (let idx = 0; idx < nrWrites; idx++) {
                            const id = Hashcodes_1.Hashcodes.createID({ idx });
                            const data = Strings_1.Strings.lpad('', 'x', 4096);
                            const doc = {
                                foo: data,
                                bar: data,
                                id,
                                uid
                            };
                            const ref = firestore
                                .collection(collectionName)
                                .doc(id);
                            work.push(() => __awaiter(this, void 0, void 0, function* () {
                                yield ref.set(doc);
                                console.log("Wrote doc: " + idx);
                            }));
                        }
                        yield asyncWorkQueue.execute();
                        console.log("Done writes ... ");
                    }
                    if (doTest) {
                        const cursor = new FirestoreQueryCursor_1.FirestoreQueryCursor(collectionName, { fieldPath: 'uid', opStr: '==', value: uid });
                        const before = Date.now();
                        let total = 0;
                        while (cursor.hasNext()) {
                            console.log("Fetching cursor...");
                            const querySnapshot = yield cursor.next();
                            console.log("Fetching cursor...done");
                            total += querySnapshot.size;
                            console.log("FIXME: fethced N records: " + total);
                        }
                        console.log("Total cursor query duration: " + (Date.now() - before));
                    }
                });
            });
            xit("Write a basic doc", function () {
                return __awaiter(this, void 0, void 0, function* () {
                    const collectionName = "debug";
                    const iter = 1543071938802;
                    const doWrites = false;
                    console.log("Using iter: " + iter);
                    const firestore = yield Firestore_1.Firestore.getInstance();
                    const metadataTraces = [];
                    const perDocMetadataTraces = [];
                    const onSnapshot = (snapshot) => {
                        console.log("FIXME onSnapshot: ===============================");
                        console.log("FIXME onSnapshot snapshot: ", snapshot);
                        console.log("FIXME: onSnapshot: We have N docs: " + snapshot.docs.length);
                        console.log("FIXME: onSnapshot: We have N docChanges: " + snapshot.docChanges().length);
                        console.log("FIXME: onSnapshot: docs: ", snapshot.docs);
                        console.log("FIXME: onSnapshot: NR docChanges: ", snapshot.docChanges().length);
                        console.log("FIXME: onSnapshot: docChanges: ", snapshot.docChanges());
                        for (const docChange of snapshot.docChanges()) {
                            console.log("FIXME id: ", docChange.doc.id);
                            const metadataTrace = {
                                id: docChange.doc.id,
                                fromCache: snapshot.metadata.fromCache,
                                hasPendingWrites: snapshot.metadata.hasPendingWrites,
                                doc: docChange.doc.data()
                            };
                            console.log("FIXME onSnapshot/docChange docChange: ", docChange);
                            console.log("FIXME onSnapshot/docChange metadataTrace: ", metadataTrace);
                            metadataTraces.push(metadataTrace);
                        }
                    };
                    yield firestore
                        .collection(collectionName)
                        .where('iter', '==', iter)
                        .onSnapshot({ includeMetadataChanges: true }, snapshot => onSnapshot(snapshot));
                    if (doWrites) {
                        const id0 = Hashcodes_1.Hashcodes.createRandomID();
                        const id1 = Hashcodes_1.Hashcodes.createRandomID();
                        console.log("FIXME: id0: " + id0);
                        console.log("FIXME: id1: " + id1);
                        const nrWrites = 10;
                        for (const id of [id0]) {
                            for (let idx = 0; idx < nrWrites; idx++) {
                                console.log("FIXME: writing with id: " + id);
                                const doc = {
                                    foo: "bar",
                                    version: idx,
                                    iter
                                };
                                const ref = firestore.collection(collectionName).doc(id);
                                let snapshotVersion = 0;
                                ref.onSnapshot({ includeMetadataChanges: true }, snapshot => {
                                    console.log("FIXME999999: got per doc snapshot: ", snapshot);
                                    console.log("FIXME999999: : fromCache: ", snapshot.metadata.fromCache);
                                    console.log("FIXME999999: : hasPendingWrites: ", snapshot.metadata.hasPendingWrites);
                                    const metadataTrace = {
                                        id: snapshot.id,
                                        fromCache: snapshot.metadata.fromCache,
                                        hasPendingWrites: snapshot.metadata.hasPendingWrites,
                                        doc: snapshot.data(),
                                        snapshotVersion: snapshotVersion++
                                    };
                                    perDocMetadataTraces.push(metadataTrace);
                                });
                                yield ref.set(doc);
                            }
                        }
                    }
                    else {
                        console.log("Skipping writes");
                    }
                    yield Promises_1.Promises.waitFor(5000);
                    console.log("metadataTraces: ", metadataTraces);
                    console.log("perDocMetadataTraces: ", perDocMetadataTraces);
                });
            });
        });
    }));
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxRUFBdUY7QUFHdkYseUVBQTJEO0FBTzNELDJEQUFzRDtBQUN0RCxrREFBNkM7QUFDN0MscURBQWdEO0FBRWhELHFFQUFnRTtBQUdoRSw2REFBd0Q7QUFDeEQsbURBQThDO0FBQzlDLGlFQUEyRTtBQUMzRSxpRkFBNEU7QUFHNUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNuQixLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRXJCLG1DQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFPLEtBQUssRUFBRSxFQUFFO0lBRWpDLElBQUksK0JBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBUyxFQUFFO1FBRXJDLE1BQU0sMkJBQVksQ0FBQyxpQkFBaUIsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRXZFLFFBQVEsQ0FBQywwQkFBMEIsRUFBRTtZQUVqQyxFQUFFLENBQUMsZ0NBQWdDLEVBQUU7O29CQUVqQyxNQUFNLGNBQWMsR0FBRyx3QkFBd0IsQ0FBQztvQkFDaEQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDO29CQUN2QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUM7b0JBRXBCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQztvQkFFdEIsTUFBTSxTQUFTLEdBQUcsTUFBTSxxQkFBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUVoRCxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFHLENBQUMsV0FBWSxDQUFDLEdBQUcsQ0FBQztvQkFFOUMsSUFBSSxRQUFRLEVBQUU7d0JBRVYsTUFBTSxJQUFJLEdBQW9CLEVBQUUsQ0FBQzt3QkFDakMsTUFBTSxjQUFjLEdBQUcsSUFBSSwrQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUVo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Q3ZFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO29DQUVyRixNQUFNLGFBQWEsR0FBa0I7d0NBQ2pDLEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRTt3Q0FDZixTQUFTLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxTQUFTO3dDQUN0QyxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsUUFBUSxDQUFDLGdCQUFnQjt3Q0FDcEQsR0FBRyxFQUFFLFFBQVEsQ0FBQyxJQUFJLEVBQUU7d0NBQ3BCLGVBQWUsRUFBRSxlQUFlLEVBQUU7cUNBQ3JDLENBQUM7b0NBS0Ysb0JBQW9CLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dDQUU3QyxDQUFDLENBQUMsQ0FBQztnQ0FFSCxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7NkJBRXRCO3lCQUVKO3FCQUVKO3lCQUFNO3dCQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztxQkFDbEM7b0JBR0QsTUFBTSxtQkFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFFN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxjQUFjLENBQUMsQ0FBQztvQkFDaEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO2dCQUVoRSxDQUFDO2FBQUEsQ0FBQyxDQUFDO1FBRVAsQ0FBQyxDQUFDLENBQUM7SUFHUCxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBRVAsQ0FBQyxDQUFBLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U3BlY3Ryb25SZW5kZXJlciwgU3BlY3Ryb25SZW5kZXJlclN0YXRlfSBmcm9tICcuLi8uLi9qcy90ZXN0L1NwZWN0cm9uUmVuZGVyZXInO1xuaW1wb3J0IHtGaXJlYmFzZX0gZnJvbSAnLi4vLi4vanMvZmlyZWJhc2UvRmlyZWJhc2UnO1xuaW1wb3J0IHtGaXJlYmFzZVVJQXV0aH0gZnJvbSAnLi4vLi4vanMvZmlyZWJhc2UvRmlyZWJhc2VVSUF1dGgnO1xuaW1wb3J0ICogYXMgZmlyZWJhc2UgZnJvbSAnLi4vLi4vanMvZmlyZWJhc2UvbGliL2ZpcmViYXNlJztcbmltcG9ydCB7RWxlbWVudHN9IGZyb20gJy4uLy4uL2pzL3V0aWwvRWxlbWVudHMnO1xuaW1wb3J0IHtEaXNrRGF0YXN0b3JlfSBmcm9tICcuLi8uLi9qcy9kYXRhc3RvcmUvRGlza0RhdGFzdG9yZSc7XG5pbXBvcnQge0RlZmF1bHRQZXJzaXN0ZW5jZUxheWVyfSBmcm9tICcuLi8uLi9qcy9kYXRhc3RvcmUvRGVmYXVsdFBlcnNpc3RlbmNlTGF5ZXInO1xuaW1wb3J0IHtNb2NrRG9jTWV0YXN9IGZyb20gJy4uLy4uL2pzL21ldGFkYXRhL0RvY01ldGFzJztcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiY2hhaVwiO1xuaW1wb3J0IHtEYXRhc3RvcmVUZXN0ZXJ9IGZyb20gJy4uLy4uL2pzL2RhdGFzdG9yZS9EYXRhc3RvcmVUZXN0ZXInO1xuaW1wb3J0IHtGaXJlc3RvcmV9IGZyb20gJy4uLy4uL2pzL2ZpcmViYXNlL0ZpcmVzdG9yZSc7XG5pbXBvcnQge0hhc2hjb2Rlc30gZnJvbSAnLi4vLi4vanMvSGFzaGNvZGVzJztcbmltcG9ydCB7UHJvbWlzZXN9IGZyb20gJy4uLy4uL2pzL3V0aWwvUHJvbWlzZXMnO1xuaW1wb3J0IHtGaXJlYmFzZURhdGFzdG9yZX0gZnJvbSAnLi4vLi4vanMvZGF0YXN0b3JlL0ZpcmViYXNlRGF0YXN0b3JlJztcbmltcG9ydCB7RmlyZWJhc2VSdW5uZXJ9IGZyb20gJy4uLy4uL2pzL2ZpcmViYXNlL0ZpcmViYXNlUnVubmVyJztcbmltcG9ydCB7RGF0YXN0b3Jlc30gZnJvbSAnLi4vLi4vanMvZGF0YXN0b3JlL0RhdGFzdG9yZXMnO1xuaW1wb3J0IHtQZXJzaXN0ZW5jZUxheWVyc30gZnJvbSAnLi4vLi4vanMvZGF0YXN0b3JlL1BlcnNpc3RlbmNlTGF5ZXJzJztcbmltcG9ydCB7UG9sYXJEYXRhRGlyfSBmcm9tICcuLi8uLi9qcy90ZXN0L1BvbGFyRGF0YURpcic7XG5pbXBvcnQge1N0cmluZ3N9IGZyb20gJy4uLy4uL2pzL3V0aWwvU3RyaW5ncyc7XG5pbXBvcnQge0FzeW5jRnVuY3Rpb24sIEFzeW5jV29ya1F1ZXVlfSBmcm9tICcuLi8uLi9qcy91dGlsL0FzeW5jV29ya1F1ZXVlJztcbmltcG9ydCB7RmlyZXN0b3JlUXVlcnlDdXJzb3J9IGZyb20gJy4uLy4uL2pzL2ZpcmViYXNlL0ZpcmVzdG9yZVF1ZXJ5Q3Vyc29yJztcbmltcG9ydCB7UHJlY29uZGl0aW9uc30gZnJvbSAnLi4vLi4vanMvUHJlY29uZGl0aW9ucyc7XG5cbm1vY2hhLnNldHVwKCdiZGQnKTtcbm1vY2hhLnRpbWVvdXQoMTAwMDApO1xuXG5TcGVjdHJvblJlbmRlcmVyLnJ1bihhc3luYyAoc3RhdGUpID0+IHtcblxuICAgIG5ldyBGaXJlYmFzZVJ1bm5lcihzdGF0ZSkucnVuKGFzeW5jICgpID0+IHtcblxuICAgICAgICBhd2FpdCBQb2xhckRhdGFEaXIudXNlRnJlc2hEaXJlY3RvcnkoJy50ZXN0LWZpcmViYXNlLXdyaXRlLXNlbWFudGljcycpO1xuXG4gICAgICAgIGRlc2NyaWJlKCdGaXJlYmFzZSBXcml0ZSBTZW1hbnRpY3MnLCBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgaXQoXCJUZXN0IHJlY2VpdmluZyBsYXJnZSBzbmFwc2hvdHNcIiwgYXN5bmMgZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZSA9IFwiZGVidWdfbGFyZ2Vfc25hcHNob3RzNFwiO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRvV3JpdGVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY29uc3QgZG9UZXN0ID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG5yV3JpdGVzID0gNTAwMDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGZpcmVzdG9yZSA9IGF3YWl0IEZpcmVzdG9yZS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgdWlkID0gZmlyZWJhc2UuYXV0aCgpIS5jdXJyZW50VXNlciEudWlkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRvV3JpdGVzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29yazogQXN5bmNGdW5jdGlvbltdID0gW107XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzeW5jV29ya1F1ZXVlID0gbmV3IEFzeW5jV29ya1F1ZXVlKHdvcmspO1xuXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGlkeCA9IDA7IGlkeCA8IG5yV3JpdGVzOyBpZHgrKykge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IEhhc2hjb2Rlcy5jcmVhdGVJRCh7aWR4fSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBTdHJpbmdzLmxwYWQoJycsICd4JywgNDA5Nik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvYyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb286IGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFyOiBkYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpZFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmID0gZmlyZXN0b3JlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmRvYyhpZCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmsucHVzaChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVmLnNldChkb2MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiV3JvdGUgZG9jOiBcIiAgKyBpZHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jV29ya1F1ZXVlLmV4ZWN1dGUoKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRvbmUgd3JpdGVzIC4uLiBcIik7XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZG9UZXN0KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZG9lc24ndCBtYXR0ZXIgdGhlIHNpemUgb2YgdGhlIG51bWJlciBvZiB3cml0ZXMuLi4gd2UgZ2V0XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoZW0gQUxMIGF0IG9uY2UgaXQgc2VlbXMgLi4uIGJ1dCBsZXQncyB3cml0ZSBtb3JlIGRhdGEuXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IG9rLi4gaGVyZSBpcyBob3cgdGhpcyB3b3JrczpcblxuICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZXJlIGlzIE5PIGRhdGEgaW5pdGlhbGx5ICwgd2UgZ2V0IGl0IEFMTCBhdCBvbmNlIGluXG4gICAgICAgICAgICAgICAgICAgIC8vIG9uZSBiaWcgc25hcHNob3QuLiB3ZSBkbyBOT1QgZ2V0IGEgc25hcHNob3Qgd2l0aCBmcm9tQ2FjaGU9ZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBOT1QgZG9hYmxlIGFzIHdlJ3JlIGdvaWduIHRvIGdldCBhbGwgdGhlIGRhdGEgYWxsIGF0XG4gICAgICAgICAgICAgICAgICAgIC8vIG9uY2UuLi5cbiAgICAgICAgICAgICAgICAgICAgLy9cblxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGN1cnNvciA9IG5ldyBGaXJlc3RvcmVRdWVyeUN1cnNvcihjb2xsZWN0aW9uTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtmaWVsZFBhdGg6ICd1aWQnLCBvcFN0cjogJz09JywgdmFsdWU6IHVpZH0sXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7Z2V0T3B0aW9uczoge3NvdXJjZTogJ3NlcnZlcid9fSk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3Vyc29yID0gbmV3IEZpcmVzdG9yZVF1ZXJ5Q3Vyc29yKGNvbGxlY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2ZpZWxkUGF0aDogJ3VpZCcsIG9wU3RyOiAnPT0nLCB2YWx1ZTogdWlkfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmVmb3JlID0gRGF0ZS5ub3coKTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgdG90YWwgPSAwO1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3Vyc29yLmhhc05leHQoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGZXRjaGluZyBjdXJzb3IuLi5cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWVyeVNuYXBzaG90ID0gYXdhaXQgY3Vyc29yLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRmV0Y2hpbmcgY3Vyc29yLi4uZG9uZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsICs9IHF1ZXJ5U25hcHNob3Quc2l6ZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRTogZmV0aGNlZCBOIHJlY29yZHM6IFwiICsgdG90YWwpO1xuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRvdGFsIGN1cnNvciBxdWVyeSBkdXJhdGlvbjogXCIgKyAoRGF0ZS5ub3coKSAtIGJlZm9yZSkpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGJlZm9yZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgICAgIC8vIC8vIDEuNXNlY29uZHMgZnJvbSBjYWNoZSBhbmQgMy42cyB3aXRob3V0IGNhY2hlIHdoZW4gb3BlcmF0aW5nIGZyb20gYSBkaXJ0eSBjYWNoZVxuICAgICAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICAgICAvLyAvLyB3aXRoIGNsZWFuIGNhY2hlIGl0J3MgNi42IHNlY29uZHMuLlxuICAgICAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICAgICAvLyBhd2FpdCBmaXJlc3RvcmVcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIC5jb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lKVxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgLm9uU25hcHNob3Qoe2luY2x1ZGVNZXRhZGF0YUNoYW5nZXM6IHRydWV9LCBzbmFwc2hvdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coXCJHb3Qgc25hcHNob3Q6ID09PT09PT09PT09PT1cIiwgc25hcHNob3QpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUubG9nKFwiVG90YWwgZG9jcyBpbiBzbmFwc2hvdDogXCIsIHNuYXBzaG90LnNpemUpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUubG9nKFwiRnJvbSBjYWNoZTogXCIsIHNuYXBzaG90Lm1ldGFkYXRhLmZyb21DYWNoZSk7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coXCJUb3RhbCBzbmFwc2hvdCBkdXJhdGlvbjogXCIgKyAoRGF0ZS5ub3coKSAtIGJlZm9yZSkpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB4aXQoXCJXcml0ZSBhIGJhc2ljIGRvY1wiLCBhc3luYyBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb25OYW1lID0gXCJkZWJ1Z1wiO1xuICAgICAgICAgICAgICAgIC8vIGNvbnN0IGl0ZXIgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZXIgPSAxNTQzMDcxOTM4ODAyO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRvV3JpdGVzID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVzaW5nIGl0ZXI6IFwiICsgaXRlcik7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBmaXJlc3RvcmUgPSBhd2FpdCBGaXJlc3RvcmUuZ2V0SW5zdGFuY2UoKTtcblxuICAgICAgICAgICAgICAgIGludGVyZmFjZSBNZXRhZGF0YVRyYWNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHkgZnJvbUNhY2hlOiBib29sZWFuO1xuICAgICAgICAgICAgICAgICAgICByZWFkb25seSBkb2M6IGFueTtcbiAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHkgaGFzUGVuZGluZ1dyaXRlczogYm9vbGVhbjtcbiAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHkgc25hcHNob3RWZXJzaW9uPzogbnVtYmVyO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhVHJhY2VzOiBNZXRhZGF0YVRyYWNlW10gPSBbXTtcbiAgICAgICAgICAgICAgICBjb25zdCBwZXJEb2NNZXRhZGF0YVRyYWNlczogTWV0YWRhdGFUcmFjZVtdID0gW107XG5cbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkZJWE1FOiBmcm9tQ2FjaGVcIixcbiAgICAgICAgICAgICAgICAvLyBzbmFwc2hvdC5tZXRhZGF0YS5mcm9tQ2FjaGUsIHNuYXBzaG90Lm1ldGFkYXRhLFxuICAgICAgICAgICAgICAgIC8vIHNuYXBzaG90KTtcblxuXG4gICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9maXJlYmFzZS5nb29nbGUuY29tL2RvY3MvcmVmZXJlbmNlL2pzL2ZpcmViYXNlLmZpcmVzdG9yZS5TbmFwc2hvdE1ldGFkYXRhXG4gICAgICAgICAgICAgICAgLy8gZnJvbUNhY2hlIGJvb2xlYW4gIFRydWUgaWYgdGhlIHNuYXBzaG90IHdhcyBjcmVhdGVkIGZyb21cbiAgICAgICAgICAgICAgICAvLyBjYWNoZWQgZGF0YSByYXRoZXIgdGhhbiBndWFyYW50ZWVkIHVwLXRvLWRhdGUgc2VydmVyIGRhdGEuXG4gICAgICAgICAgICAgICAgLy8gSWYgeW91ciBsaXN0ZW5lciBoYXMgb3B0ZWQgaW50byBtZXRhZGF0YSB1cGRhdGVzICh2aWFcbiAgICAgICAgICAgICAgICAvLyBTbmFwc2hvdExpc3Rlbk9wdGlvbnMpIHlvdSB3aWxsIHJlY2VpdmUgYW5vdGhlciBzbmFwc2hvdFxuICAgICAgICAgICAgICAgIC8vIHdpdGggZnJvbUNhY2hlIHNldCB0byBmYWxzZSBvbmNlIHRoZSBjbGllbnQgaGFzIHJlY2VpdmVkXG4gICAgICAgICAgICAgICAgLy8gdXAtdG8tZGF0ZSBkYXRhIGZyb20gdGhlIGJhY2tlbmQuICBoYXNQZW5kaW5nV3JpdGVzIGJvb2xlYW5cbiAgICAgICAgICAgICAgICAvLyBUcnVlIGlmIHRoZSBzbmFwc2hvdCBpbmNsdWRlcyBsb2NhbCB3cml0ZXMgKHNldCgpIG9yXG4gICAgICAgICAgICAgICAgLy8gdXBkYXRlKCkgY2FsbHMpIHRoYXQgaGF2ZW4ndCBiZWVuIGNvbW1pdHRlZCB0byB0aGUgYmFja2VuZFxuICAgICAgICAgICAgICAgIC8vIHlldC4gIElmIHlvdXIgbGlzdGVuZXIgaGFzIG9wdGVkIGludG8gbWV0YWRhdGEgdXBkYXRlcyB2aWFcbiAgICAgICAgICAgICAgICAvLyBTbmFwc2hvdExpc3Rlbk9wdGlvbnMsIHlvdSByZWNlaXZlIGFub3RoZXIgc25hcHNob3Qgd2l0aCBoYXNQZW5kaW5nV3JpdGVzIHNldCB0byBmYWxzZSBvbmNlIHRoZSB3cml0ZXMgaGF2ZSBiZWVuIGNvbW1pdHRlZCB0byB0aGUgYmFja2VuZC5cblxuICAgICAgICAgICAgICAgIGNvbnN0IG9uU25hcHNob3QgPSAoc25hcHNob3Q6IGZpcmViYXNlLmZpcmVzdG9yZS5RdWVyeVNuYXBzaG90KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRSBvblNuYXBzaG90OiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XCIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUUgb25TbmFwc2hvdCBzbmFwc2hvdDogXCIsIHNuYXBzaG90KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZJWE1FOiBvblNuYXBzaG90OiBXZSBoYXZlIE4gZG9jczogXCIgKyBzbmFwc2hvdC5kb2NzLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUU6IG9uU25hcHNob3Q6IFdlIGhhdmUgTiBkb2NDaGFuZ2VzOiBcIiArIHNuYXBzaG90LmRvY0NoYW5nZXMoKS5sZW5ndGgpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUU6IG9uU25hcHNob3Q6IGRvY3M6IFwiLCBzbmFwc2hvdC5kb2NzKTtcblxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUU6IG9uU25hcHNob3Q6IE5SIGRvY0NoYW5nZXM6IFwiLCBzbmFwc2hvdC5kb2NDaGFuZ2VzKCkubGVuZ3RoKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZJWE1FOiBvblNuYXBzaG90OiBkb2NDaGFuZ2VzOiBcIiwgc25hcHNob3QuZG9jQ2hhbmdlcygpKTtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGRvY0NoYW5nZSBvZiBzbmFwc2hvdC5kb2NDaGFuZ2VzKCkpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRSBpZDogXCIsIGRvY0NoYW5nZS5kb2MuaWQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXRhZGF0YVRyYWNlOiBNZXRhZGF0YVRyYWNlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkb2NDaGFuZ2UuZG9jLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21DYWNoZTogc25hcHNob3QubWV0YWRhdGEuZnJvbUNhY2hlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1BlbmRpbmdXcml0ZXM6IHNuYXBzaG90Lm1ldGFkYXRhLmhhc1BlbmRpbmdXcml0ZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jOiBkb2NDaGFuZ2UuZG9jLmRhdGEoKVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRSBvblNuYXBzaG90L2RvY0NoYW5nZSBkb2NDaGFuZ2U6IFwiLCBkb2NDaGFuZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRSBvblNuYXBzaG90L2RvY0NoYW5nZSBtZXRhZGF0YVRyYWNlOiBcIiwgbWV0YWRhdGFUcmFjZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhVHJhY2VzLnB1c2gobWV0YWRhdGFUcmFjZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IGZpcmVzdG9yZVxuICAgICAgICAgICAgICAgICAgICAuY29sbGVjdGlvbihjb2xsZWN0aW9uTmFtZSlcbiAgICAgICAgICAgICAgICAgICAgLndoZXJlKCdpdGVyJywgJz09JywgaXRlcilcbiAgICAgICAgICAgICAgICAgICAgLm9uU25hcHNob3Qoe2luY2x1ZGVNZXRhZGF0YUNoYW5nZXM6IHRydWV9LCBzbmFwc2hvdCA9PiBvblNuYXBzaG90KHNuYXBzaG90KSk7XG5cblxuICAgICAgICAgICAgICAgIGlmIChkb1dyaXRlcykge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vdyBhZGQgc29tZSByZWNvcmRzXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkMCA9IEhhc2hjb2Rlcy5jcmVhdGVSYW5kb21JRCgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpZDEgPSBIYXNoY29kZXMuY3JlYXRlUmFuZG9tSUQoKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZJWE1FOiBpZDA6IFwiICsgaWQwKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRTogaWQxOiBcIiArIGlkMSk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbnJXcml0ZXMgPSAxMDtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIFtpZDBdKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGlkeCA9IDA7IGlkeCA8IG5yV3JpdGVzOyBpZHgrKykge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGSVhNRTogd3JpdGluZyB3aXRoIGlkOiBcIiArIGlkKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvYyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9vOiBcImJhclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uOiBpZHgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmID0gZmlyZXN0b3JlLmNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpLmRvYyhpZCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogb2suLiB0aGUgTE9DQUwgdmVyc2lvbiBpc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICBmcm9tQ2FjaGU9PXRydWUgJiYgaGFzUGVuZGluZ1dyaXRlcyA9PSB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgd2hlbiBmdWxseSB3cml0dGVuIHRvIHRoZSBzZXJ2ZXIgd2UgaGF2ZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZyb21DYWNoZT09dHJ1ZSAmJiBoYXNQZW5kaW5nV3JpdGVzID09IHRydWVcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzbmFwc2hvdFZlcnNpb24gPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IEkgZW52ZXIgcmVjZWl2ZSBhIHNuYXBzaG90IG9mIHRoZSBpbml0aWFsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmVyc2lvbiBzYXlpbmcgdGhhdCBpdCBkb2VzIG5vdCBleGlzdC4uLlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IHdoeSBkbyBJIGdldCBhbiBFWFRSQSBjYWxsYmFjaz9cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiB3ZSBjb3VsZCBjYWxsIGdldCh7c291cmNlOiAnY2FjaGUnfSkgaGVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIG1ha2UgdGhpcyBvcGVyYXRlIGZhc3RlciBJIHRoaW5rIGJ1dCB3aGF0IGlmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGxvY2FsIHZlcnNpb24gaXNuJ3QgMTAwJSBpbiBzeW5jIHdpdGggdGhlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3RlIHZlcnNpb24gYW5kIHdlIGRvIG5vdCwgeWV0LCBoYXZlIHRoZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxhdGVzdCBjb3B5LlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmLm9uU25hcHNob3Qoe2luY2x1ZGVNZXRhZGF0YUNoYW5nZXM6IHRydWV9LCBzbmFwc2hvdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUU5OTk5OTk6IGdvdCBwZXIgZG9jIHNuYXBzaG90OiBcIiwgc25hcHNob3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZJWE1FOTk5OTk5OiA6IGZyb21DYWNoZTogXCIsIHNuYXBzaG90Lm1ldGFkYXRhLmZyb21DYWNoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRklYTUU5OTk5OTk6IDogaGFzUGVuZGluZ1dyaXRlczogXCIsIHNuYXBzaG90Lm1ldGFkYXRhLmhhc1BlbmRpbmdXcml0ZXMpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhVHJhY2U6IE1ldGFkYXRhVHJhY2UgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogc25hcHNob3QuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tQ2FjaGU6IHNuYXBzaG90Lm1ldGFkYXRhLmZyb21DYWNoZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1BlbmRpbmdXcml0ZXM6IHNuYXBzaG90Lm1ldGFkYXRhLmhhc1BlbmRpbmdXcml0ZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2M6IHNuYXBzaG90LmRhdGEoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBzaG90VmVyc2lvbjogc25hcHNob3RWZXJzaW9uKytcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkZJWE1FMzMzMzMzMzMzMzMzMzMjIyMjIyMjIzMzMzMzMzMzOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgXCIgKyBtZXRhZGF0YVRyYWNlLnNuYXBzaG90VmVyc2lvbilcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJEb2NNZXRhZGF0YVRyYWNlcy5wdXNoKG1ldGFkYXRhVHJhY2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByZWYuc2V0KGRvYyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlNraXBwaW5nIHdyaXRlc1wiKTtcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgIGF3YWl0IFByb21pc2VzLndhaXRGb3IoNTAwMCk7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIm1ldGFkYXRhVHJhY2VzOiBcIiwgbWV0YWRhdGFUcmFjZXMpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGVyRG9jTWV0YWRhdGFUcmFjZXM6IFwiLCBwZXJEb2NNZXRhZGF0YVRyYWNlcyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG5cbiAgICB9KTtcblxufSk7XG4iXX0=